{
  "version": 3,
  "sources": ["../../../js/core/utils.js", "../../../js/core/config.js", "../../../js/core/db.js", "../../../js/auth/session.js", "../../../js/features/providers.js", "../../../js/features/automod.js", "../../../js/features/posts.js", "../../../js/features/tagcloud_scroll.js", "../../../js/features/feed.js", "../../../js/core/notifications.js", "../../../js/core/changelog_modal.js", "../../../js/auth/auth.js", "../../../js/core/help.js", "../../../js/core/app_state.js", "../../../js/features/oembed.js", "../../../js/features/yt_title_parse.js", "../../../js/core/header.js", "../../../js/core/app.js", "../../../js/auth/prefs.js", "../../../js/views/overlays.js", "../../../js/views/main_view.js", "../../../js/features/queue.js", "../../../js/features/import_export.js", "../../../js/views/main_view_feed.js", "../../../js/views/main_view_profile.js", "../../../js/core/constants.js", "../../../js/views/main_view_compose.js", "../../../js/views/main_view_refresh.js", "../../../js/views/login_view.js", "../../../js/views/login_prompts.js", "../../../js/features/actions.js", "../../../js/core/notify_helpers.js", "../../../js/views/profile.js", "../../../js/core/supabase_client.js", "../../../js/auth/theme.js", "../../../js/auth/keyboard.js", "../../../js/features/seed.js"],
  "sourcesContent": ["// Simple email format validation\r\nexport function isValidEmailFormat(email) {\r\n  // Basic regex for demonstration; adjust as needed for stricter validation\r\n  return /^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$/.test(email);\r\n}\r\nexport const $ = (sel, root=document) => root.querySelector(sel);\r\nexport function $$(a, b){\r\n  if(!b) return Array.from(document.querySelectorAll(a));\r\n  const root = (typeof a === 'string') ? document.querySelector(a) : a;\r\n  return Array.from(root ? root.querySelectorAll(b) : []);\r\n}\r\nexport const raf = (fn) => requestAnimationFrame(fn);\r\nexport const debounce = (fn, ms=200) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };\r\nexport const safeClone = (o)=> (typeof structuredClone === 'function' ? structuredClone(o) : JSON.parse(JSON.stringify(o)));\r\n\r\nexport const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36);\r\n\r\nexport const esc = s => String(s).replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#039;' }[m]));\r\n\r\nexport const fmtTime = ts => {\r\n  const d = new Date(ts);\r\n  const diff = Date.now() - ts;\r\n  const sec = Math.round(diff/1000);\r\n  const min = Math.round(sec/60);\r\n  const hr  = Math.round(min/60);\r\n  const day = Math.round(hr/24);\r\n  if(sec < 45) return 'just now';\r\n  if(min < 60) return `${min}m ago`;\r\n  if(hr < 24)  return `${hr}h ago`;\r\n  if(day < 7)  return `${day}d ago`;\r\n  return d.toLocaleString();\r\n};\r\n\r\nexport const liveSay = (msg) => { const n = $('#live'); if(n) n.textContent = msg; };\r\n\r\nexport function copyText(t){\r\n  if(navigator.clipboard && location.protocol !== 'file:'){\r\n    return navigator.clipboard.writeText(t);\r\n  } else {\r\n    const ta = document.createElement('textarea');\r\n    ta.value = t; document.body.appendChild(ta);\r\n    ta.select(); ta.setSelectionRange(0, 99999);\r\n    const ok = document.execCommand && document.execCommand('copy');\r\n    ta.remove();\r\n    return ok ? Promise.resolve() : Promise.reject();\r\n  }\r\n}\r\n\r\nexport function toast(anchor, msg, warn){\r\n  const note = document.createElement('div');\r\n  note.className = 'notice small';\r\n  note.textContent = msg;\r\n  if(warn) note.classList.add('warn');\r\n  (anchor?.parentNode || document.body).insertBefore(note, anchor?.nextSibling || null);\r\n  setTimeout(()=> note.remove(), 1500);\r\n}\r\n\r\nexport function approxSize(str){\r\n  const bytes = new Blob([str]).size;\r\n  if(bytes < 1024) return bytes+' B';\r\n  if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB';\r\n  return (bytes/1024/1024).toFixed(2)+' MB';\r\n}\r\nexport function fmtBytes(n){\r\n  if(n < 1024) return n+' B';\r\n  if(n < 1024*1024) return (n/1024).toFixed(1)+' KB';\r\n  if(n < 1024*1024*1024) return (n/1024/1024).toFixed(2)+' MB';\r\n  return (n/1024/1024/1024).toFixed(2)+' GB';\r\n}\r\n\r\nexport function applyAccent(color){\r\n  try{\r\n    document.documentElement.style.setProperty('--acc', color || '#8ab4ff');\r\n    const meta = document.querySelector('meta[name=\"theme-color\"]');\r\n    if(meta) meta.setAttribute('content', '#0b0d10');\r\n  }catch{}\r\n}\r\nexport function applyDensity(d){\r\n  document.documentElement.setAttribute('data-density', d || 'cozy');\r\n}", "// Toggle remote vs local storage\r\nexport const USE_SUPABASE = true;\r\n\r\n// Put your Supabase project creds here (these are safe to be public; enforce RLS).\r\nexport const SUPABASE_URL = 'https://ykwbnqaobcirrpunnkkn.supabase.co';\r\nexport const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrd2JucWFvYmNpcnJwdW5ua2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDcwMjcsImV4cCI6MjA3MTE4MzAyN30.qoZg10-v6rmqW6RZDj9SGYio_DblzSfP3RTPBMoJBuM';", "\r\nimport { safeClone } from './utils.js';\r\n\r\n// Expanded list of common disposable email domains (update as needed)\r\n// Source: https://github.com/disposable/disposable-email-domains (partial)\r\nconst DISPOSABLE_EMAIL_DOMAINS = [\r\n  'mailinator.com', '10minutemail.com', 'guerrillamail.com', 'tempmail.com',\r\n  'yopmail.com', 'trashmail.com', 'getnada.com', 'dispostable.com', 'maildrop.cc',\r\n  'fakeinbox.com', 'mintemail.com', 'mytemp.email', 'throwawaymail.com',\r\n  'sharklasers.com', 'spamgourmet.com', 'mailnesia.com', 'temp-mail.org',\r\n  'emailondeck.com', 'moakt.com', 'mailcatch.com', 'mailnull.com',\r\n  '33mail.com', 'mailtemp.net', 'tempail.com', 'tempmail.net', 'tempmailaddress.com',\r\n  'tempmailbox.com', 'tempmails.net', 'trashmail.de', 'maildrop.cc', 'disposablemail.com',\r\n  'spambog.com', 'spambog.de', 'spambog.ru', 'spambog.xyz', 'spambog.pl',\r\n  'spambog.com', 'spambog.de', 'spambog.ru', 'spambog.xyz', 'spambog.pl',\r\n  'spam4.me', 'spamex.com', 'spaml.com', 'spammail.de', 'spammail.net',\r\n  'spammail.org', 'spamobox.com', 'spamspot.com', 'spamwc.com',\r\n  // ...add more as needed\r\n];\r\n\r\n// Checks if the email domain or any of its parent domains is in the blocklist\r\nfunction isDisposableEmail(email) {\r\n  if (!email || typeof email !== 'string') return false;\r\n  const domain = email.split('@')[1]?.toLowerCase();\r\n  if (!domain) return false;\r\n  // Check direct match and parent domains (subdomain blocking)\r\n  const parts = domain.split('.');\r\n  for (let i = 0; i < parts.length - 1; i++) {\r\n    const checkDomain = parts.slice(i).join('.');\r\n    if (DISPOSABLE_EMAIL_DOMAINS.includes(checkDomain)) return true;\r\n  }\r\n  return false;\r\n}\r\n// bcrypt is loaded globally from CDN in index.html\r\n\r\nimport { SUPABASE_URL, SUPABASE_ANON_KEY, USE_SUPABASE } from './config.js';\r\n\r\nconst DB_KEY_V2 = 'TunedIn.space/db@v2';\r\nconst DB_KEY_V1 = 'TunedIn.space/v1';\r\n\r\nconst defaultDB = { users:[], posts:[], createdAt: Date.now(), version: 2 };\r\n\r\nclass LocalAdapter {\r\n  async deleteUser(id) {\r\n    await this.init();\r\n    const i = (this.cache.users || []).findIndex(u => u.id === id);\r\n    if (i < 0) return false;\r\n    this.cache.users.splice(i, 1);\r\n    // Optionally, delete user's posts too:\r\n    this.cache.posts = (this.cache.posts || []).filter(p => p.userId !== id);\r\n    await this._save();\r\n    return true;\r\n  }\r\n  constructor(){ this.cache = null; this.isRemote = false; }\r\n\r\n  async init(){\r\n    if(this.cache) return this.cache;\r\n    const v2 = localStorage.getItem(DB_KEY_V2);\r\n    if(v2){\r\n      try { this.cache = JSON.parse(v2); }\r\n      catch { this.cache = safeClone(defaultDB); }\r\n      return this.cache;\r\n    }\r\n    const v1 = localStorage.getItem(DB_KEY_V1);\r\n    if(v1){\r\n      try{\r\n        const old = JSON.parse(v1);\r\n        this.cache = { ...defaultDB, ...old, version:2 };\r\n        await this._save();\r\n      }catch{\r\n        this.cache = safeClone(defaultDB);\r\n      }\r\n      return this.cache;\r\n    }\r\n    this.cache = safeClone(defaultDB);\r\n    return this.cache;\r\n  }\r\n  getAll(){ return this.cache || defaultDB; }\r\n  async refresh(){ return this.cache; }\r\n  async _save(){ try{ localStorage.setItem(DB_KEY_V2, JSON.stringify(this.cache)); }catch{} }\r\n\r\n  async ensureUser(name, email, password) {\r\n    await this.init();\r\n    // Enforce required fields for local users\r\n    if (!email || !password || password.length < 6) {\r\n      throw new Error('Email and password (min 6 chars) are required.');\r\n    }\r\n    if (isDisposableEmail(email)) {\r\n      throw new Error('Disposable (temporary) email addresses are not allowed.');\r\n    }\r\n    let u = this.cache.users.find(x => x.name.toLowerCase() === name.toLowerCase() || (email && x.email === email));\r\n    if (!u) {\r\n      // Hash the password before storing\r\n      const salt = window.bcrypt.genSaltSync(10);\r\n      const hash = window.bcrypt.hashSync(password, salt);\r\n      u = {\r\n        id: crypto.randomUUID ? crypto.randomUUID() : 'u_' + Math.random().toString(36).slice(2),\r\n        name: name.trim(),\r\n        email: email,\r\n        password: hash, // store hash\r\n  about: '',\r\n  facebook: '',\r\n  instagram: '',\r\n  twitter: '',\r\n  bandcamp: '',\r\n  soundcloud: '',\r\n  youtube: '',\r\n  lastfm: '',\r\n        createdAt: Date.now()\r\n      };\r\n      this.cache.users.push(u); await this._save();\r\n    }\r\n    return u;\r\n  }\r\n\r\n  async loginUser(email, password) {\r\n    await this.init();\r\n    if (!email || !password || password.length < 6) return null;\r\n    const user = this.cache.users.find(u => u.email === email);\r\n    if (!user) return null;\r\n    // Only allow login if user has a non-empty password hash\r\n    if (!user.password || user.password.length < 6) return null;\r\n    // Compare password with hash\r\n  const isMatch = window.bcrypt.compareSync(password, user.password);\r\n    return isMatch ? user : null;\r\n  }\r\n  getUserById(id){ return (this.cache?.users || []).find(u=>u.id===id) || null; }\r\n\r\n  async createPost(p){ await this.init(); this.cache.posts.push(p); await this._save(); return p; }\r\n  async updatePost(id, patch){\r\n    await this.init();\r\n    const i = this.cache.posts.findIndex(x=>x.id===id);\r\n    if(i<0) return null;\r\n    this.cache.posts[i] = { ...this.cache.posts[i], ...patch };\r\n    await this._save();\r\n    return this.cache.posts[i];\r\n  }\r\n  async deletePost(id){\r\n    await this.init();\r\n    const i = this.cache.posts.findIndex(x=>x.id===id);\r\n    if(i<0) return;\r\n    this.cache.posts.splice(i,1);\r\n    await this._save();\r\n  }\r\n  async toggleLike(id, userId){\r\n    await this.init();\r\n    const p = this.cache.posts.find(x=>x.id===id);\r\n    if(!p) return null;\r\n    p.likes = p.likes || [];\r\n    const i = p.likes.indexOf(userId);\r\n    if(i>=0) p.likes.splice(i,1); else p.likes.push(userId);\r\n    await this._save();\r\n    return p;\r\n  }\r\n  async addComment(id, c){\r\n    await this.init();\r\n    const p = this.cache.posts.find(x=>x.id===id);\r\n    if(!p) return null;\r\n    p.comments = p.comments || [];\r\n    p.comments.push(c);\r\n    await this._save();\r\n    return p.comments;\r\n  }\r\n  async deleteComment(postId, commentId){\r\n    await this.init();\r\n    const p = this.cache.posts.find(x=>x.id===postId);\r\n    if(!p) return null;\r\n    p.comments = (p.comments || []).filter(c => c.id !== commentId);\r\n    await this._save();\r\n    return p.comments;\r\n  }\r\n\r\n  async updateUser(id, patch){\r\n    await this.init();\r\n    const i = (this.cache.users || []).findIndex(u => u.id === id);\r\n    if(i < 0) return null;\r\n    this.cache.users[i] = { ...this.cache.users[i], ...patch };\r\n    await this._save();\r\n    return this.cache.users[i];\r\n  }\r\n\r\n  async replaceAll(data){\r\n    this.cache = { version:2, createdAt: Date.now(), users: data.users||[], posts: data.posts||[] };\r\n    await this._save();\r\n  }\r\n  exportJSON(){\r\n    return JSON.stringify(this.cache || defaultDB, null, 2);\r\n  }\r\n}\r\n\r\nclass SupabaseAdapter {\r\n  async deleteUser(id) {\r\n    // Delete user posts first\r\n    const { error: postError } = await this.supabase.from('posts').delete().eq('user_id', id);\r\n    if (postError) console.error('deleteUser posts error', postError);\r\n    // Delete user\r\n    const { error: userError } = await this.supabase.from('users').delete().eq('id', id);\r\n    if (userError) console.error('deleteUser user error', userError);\r\n    await this.refresh();\r\n    return !userError;\r\n  }\r\n  constructor(url, key){\r\n    this.isRemote = true;\r\n    this.supabase = null;\r\n    this.cache = { ...defaultDB };\r\n    this.url = url;\r\n    this.key = key;\r\n  }\r\n  async init(){\r\n    if(!this.supabase){\r\n      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');\r\n      this.supabase = createClient(this.url, this.key);\r\n    }\r\n    await this.refresh();\r\n    return this.cache;\r\n  }\r\n  mapRowToPost(row){\r\n    return {\r\n      id: row.id,\r\n      userId: row.user_id,\r\n      title: row.title,\r\n      artist: row.artist,\r\n      url: row.url,\r\n      provider: row.provider || null,\r\n      tags: row.tags || [],\r\n      body: row.body || '',\r\n      likes: row.likes || [],\r\n      comments: row.comments || [],\r\n      createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now(),\r\n    };\r\n  }\r\n  mapPostToRow(p){\r\n    return {\r\n      id: p.id,\r\n      user_id: p.userId,\r\n      title: p.title,\r\n      artist: p.artist || null,\r\n      url: p.url,\r\n      provider: p.provider || null,\r\n      tags: p.tags || [],\r\n      body: p.body || null,\r\n      likes: p.likes || [],\r\n      comments: p.comments || [],\r\n      created_at: new Date(p.createdAt || Date.now()).toISOString(),\r\n    };\r\n  }\r\n  mapRowToUser(row){\r\n    return {\r\n      id: row.id,\r\n      name: row.name,\r\n      about: row.about || '',\r\n  facebook: row.facebook || '',\r\n  instagram: row.instagram || '',\r\n  twitter: row.twitter || '',\r\n  bandcamp: row.bandcamp || '',\r\n  soundcloud: row.soundcloud || '',\r\n  youtube: row.youtube || '',\r\n  lastfm: row.lastfm || '',\r\n      avatarUrl: row.avatarurl || '',\r\n      createdAt: row.created_at ? new Date(row.created_at).getTime() : Date.now()\r\n    };\r\n  }\r\n\r\n  async refresh(){\r\n    const [uRes, pRes] = await Promise.all([\r\n      this.supabase.from('users').select('*').order('created_at', { ascending: true }),\r\n      this.supabase.from('posts').select('*').order('created_at', { ascending: false }),\r\n    ]);\r\n    if(uRes.error) console.warn('Supabase users error', uRes.error);\r\n    if(pRes.error) console.warn('Supabase posts error', pRes.error);\r\n    const users = (uRes.data||[]).map(r=>this.mapRowToUser(r));\r\n    const posts = (pRes.data||[]).map(r=>this.mapRowToPost(r));\r\n    this.cache = { version:2, createdAt: this.cache.createdAt || Date.now(), users, posts };\r\n    return this.cache;\r\n  }\r\n  getAll(){ return this.cache; }\r\n\r\n  async ensureUser(name) {\r\n    // Always use the current authenticated user's UID as id\r\n    let userId = null;\r\n    if (this.supabase && this.supabase.auth && this.supabase.auth.getUser) {\r\n      const authUser = await this.supabase.auth.getUser();\r\n      userId = authUser?.data?.user?.id || authUser?.user?.id;\r\n    }\r\n    if (!userId) throw new Error('No authenticated user');\r\n    const existing = this.cache.users.find(u => u.id === userId || u.name.toLowerCase() === name.toLowerCase());\r\n    if (existing) return existing;\r\n    const user = {\r\n      id: userId,\r\n      name: name.trim(),\r\n      about: '',\r\n      createdAt: Date.now()\r\n    };\r\n    const { error } = await this.supabase.from('users').insert({\r\n      id: user.id, name: user.name, about: user.about, created_at: new Date(user.createdAt).toISOString()\r\n    });\r\n    if (error) console.warn('ensureUser insert failed', error);\r\n    this.cache.users.push(user);\r\n    return user;\r\n  }\r\n  getUserById(id){ return this.cache.users.find(u=>u.id===id) || null; }\r\n\r\n  async createPost(post){\r\n    // Always use the current authenticated user's UID as userId\r\n    let userId = null;\r\n    if (this.supabase && this.supabase.auth && this.supabase.auth.getUser) {\r\n      const authUser = await this.supabase.auth.getUser();\r\n      userId = authUser?.data?.user?.id || authUser?.user?.id;\r\n    }\r\n    if (!userId) throw new Error('No authenticated user');\r\n    const row = { ...this.mapPostToRow(post), user_id: userId };\r\n    const { error } = await this.supabase.from('posts').insert(row);\r\n    if(error) console.error('createPost error', error);\r\n    await this.refresh();\r\n    return this.cache.posts.find(p=>p.id===post.id);\r\n  }\r\n  async updatePost(id, patch){\r\n    const cur = this.cache.posts.find(p=>p.id===id);\r\n    if(!cur) return null;\r\n    const next = { ...cur, ...patch };\r\n    const row = this.mapPostToRow(next);\r\n    const { error } = await this.supabase.from('posts').update(row).eq('id', id);\r\n    if(error) console.error('updatePost error', error);\r\n    await this.refresh();\r\n    return this.cache.posts.find(p=>p.id===id);\r\n  }\r\n  async deletePost(id){\r\n    const { error } = await this.supabase.from('posts').delete().eq('id', id);\r\n    if(error) console.error('deletePost error', error);\r\n    await this.refresh();\r\n  }\r\n  async toggleLike(id, userId){\r\n    const cur = this.cache.posts.find(p=>p.id===id);\r\n    if(!cur) return null;\r\n    const likes = Array.isArray(cur.likes) ? [...cur.likes] : [];\r\n    const i = likes.indexOf(userId);\r\n    if(i>=0) likes.splice(i,1); else likes.push(userId);\r\n    const { error } = await this.supabase.from('posts').update({ likes }).eq('id', id);\r\n    if(error) console.error('toggleLike error', error);\r\n    await this.refresh();\r\n    return this.cache.posts.find(p=>p.id===id);\r\n  }\r\n  async addComment(id, c){\r\n    const cur = this.cache.posts.find(p=>p.id===id);\r\n    if(!cur) return null;\r\n    const comments = Array.isArray(cur.comments) ? [...cur.comments] : [];\r\n    comments.push(c);\r\n    const { error } = await this.supabase.from('posts').update({ comments }).eq('id', id);\r\n    if(error) console.error('addComment error', error);\r\n    await this.refresh();\r\n    const p = this.cache.posts.find(p=>p.id===id);\r\n    return p ? p.comments : comments;\r\n  }\r\n  async deleteComment(id, commentId){\r\n    const cur = this.cache.posts.find(p=>p.id===id);\r\n    if(!cur) return null;\r\n    const comments = (cur.comments || []).filter(c => c.id !== commentId);\r\n    const { error } = await this.supabase.from('posts').update({ comments }).eq('id', id);\r\n    if(error) console.error('deleteComment error', error);\r\n    await this.refresh();\r\n    const p = this.cache.posts.find(p=>p.id===id);\r\n    return p ? p.comments : comments;\r\n  }\r\n\r\n  async updateUser(id, patch){\r\n    // Always use the current authenticated user's UID for update\r\n    let userId = null;\r\n    if (this.supabase && this.supabase.auth && this.supabase.auth.getUser) {\r\n      const authUser = await this.supabase.auth.getUser();\r\n      userId = authUser?.data?.user?.id || authUser?.user?.id;\r\n    }\r\n    if (!userId) throw new Error('No authenticated user');\r\n    const update = {};\r\n  if (patch.name !== undefined) update.name = patch.name;\r\n  if (patch.about !== undefined) update.about = patch.about;\r\n  if (patch.avatarUrl !== undefined) update.avatarurl = patch.avatarUrl;\r\n  if (patch.facebook !== undefined) update.facebook = patch.facebook;\r\n  if (patch.instagram !== undefined) update.instagram = patch.instagram;\r\n  if (patch.twitter !== undefined) update.twitter = patch.twitter;\r\n  if (patch.bandcamp !== undefined) update.bandcamp = patch.bandcamp;\r\n  if (patch.soundcloud !== undefined) update.soundcloud = patch.soundcloud;\r\n  if (patch.youtube !== undefined) update.youtube = patch.youtube;\r\n  if (patch.lastfm !== undefined) update.lastfm = patch.lastfm;\r\n    if (Object.keys(update).length === 0) return this.getUserById(userId);\r\n    const { error } = await this.supabase.from('users').update(update).eq('id', userId);\r\n    if(error) console.error('updateUser error', error);\r\n    await this.refresh();\r\n    return this.getUserById(userId);\r\n  }\r\n\r\n  async replaceAll(data){\r\n    // Dangerous: clears all data. Intended for import/replace.\r\n    await this.supabase.from('posts').delete().neq('id','');\r\n    await this.supabase.from('users').delete().neq('id','');\r\n\r\n    const users = (data.users||[]).map(u => ({\r\n      id: u.id,\r\n      name: u.name,\r\n      about: u.about || null, // NEW\r\n      created_at: new Date(u.createdAt||Date.now()).toISOString()\r\n    }));\r\n    if(users.length){\r\n      const { error } = await this.supabase.from('users').upsert(users);\r\n      if(error) console.error('replaceAll users error', error);\r\n    }\r\n\r\n    const posts = (data.posts||[]).map(p => ({\r\n      ...this.mapPostToRow(p)\r\n    }));\r\n    if(posts.length){\r\n      const { error } = await this.supabase.from('posts').upsert(posts);\r\n      if(error) console.error('replaceAll posts error', error);\r\n    }\r\n\r\n    await this.refresh();\r\n  }\r\n  exportJSON(){\r\n    return JSON.stringify(this.cache, null, 2);\r\n  }\r\n}\r\n\r\nconst DB = (USE_SUPABASE && SUPABASE_URL && SUPABASE_ANON_KEY)\r\n  ? new SupabaseAdapter(SUPABASE_URL, SUPABASE_ANON_KEY)\r\n  : new LocalAdapter();\r\n\r\nexport default DB;", "export const SESSION_KEY = 'TunedIn.space/session@v1';\r\nexport const GUEST_KEY = 'TunedIn.space/guest@v1';\r\n\r\n// Only use sessionStorage for local/guest mode. Supabase manages its own session persistence.\r\nexport function getSession() {\r\n  // For local/guest mode only\r\n  try { return JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null'); } catch { return null; }\r\n}\r\nexport function setSession(s) { sessionStorage.setItem(SESSION_KEY, JSON.stringify(s)); }\r\nexport function clearSession() { sessionStorage.removeItem(SESSION_KEY); }\r\n\r\n// Guest mode can remain in localStorage (not sensitive)\r\nexport function isGuestMode() { return localStorage.getItem(GUEST_KEY) === '1'; }\r\nexport function setGuestMode(on) { if (on) localStorage.setItem(GUEST_KEY, '1'); else localStorage.removeItem(GUEST_KEY); }", "// --- Provider detection & embed building ---\r\n\r\nfunction safeURL(u) {\r\n  try { return new URL(u); } catch { return null; }\r\n}\r\n\r\nfunction isHTTPOrigin(origin) {\r\n  return typeof origin === 'string' && /^https?:\\/\\//i.test(origin);\r\n}\r\n\r\n// --- Modern robust provider detection ---\r\nexport function parseProvider(url) {\r\n  const u = (url || '').trim();\r\n  const l = u.toLowerCase();\r\n  const parsed = safeURL(u);\r\n\r\n  // Direct audio\r\n  if (/\\.(mp3|ogg|wav|m4a)(?:$|\\?)/i.test(l)) return { provider: 'audio', id: u };\r\n\r\n  // YouTube and Shorts\r\n  if (parsed && /(^|\\.)youtube\\.com$|(^|\\.)m\\.youtube\\.com$|(^|\\.)music\\.youtube\\.com$|(^|\\.)youtu\\.be$/.test(parsed.hostname)) {\r\n    const sp = parsed.searchParams;\r\n    const list = sp.get('list');\r\n    const path = parsed.pathname.replace(/\\/+$/, '');\r\n\r\n    // Extract video ID\r\n    let id = sp.get('v');\r\n    if (!id && /\\/shorts\\//i.test(path)) {\r\n      id = path.split('/').filter(Boolean).pop();\r\n    }\r\n    if (!id && /\\/embed\\//i.test(path)) {\r\n      id = path.split('/').filter(Boolean).pop();\r\n    }\r\n    if (!id && /youtu\\.be$/i.test(parsed.hostname)) {\r\n      id = path.split('/').filter(Boolean).shift();\r\n    }\r\n\r\n    // If video ID is present, always return video (even if playlist param exists)\r\n    if (id && /^[a-zA-Z0-9_-]{11}$/.test(id)) {\r\n      return { provider: 'youtube', id };\r\n    }\r\n    // Playlist detection (only if no video ID)\r\n    if (list) return { provider: 'youtube_playlist', id: list };\r\n  }\r\n\r\n  // Spotify\r\n  if (parsed && /(^|\\.)open\\.spotify\\.com$/.test(parsed.hostname)) {\r\n    const parts = parsed.pathname.split('/').filter(Boolean);\r\n    if (parts.length >= 2) {\r\n      const kind = parts[0].toLowerCase(); // track|album|playlist|episode|show\r\n      const id = parts[1];\r\n      if (/^(track|album|playlist|episode|show)$/i.test(kind) && id) {\r\n        return { provider: 'spotify', kind, id };\r\n      }\r\n    }\r\n  }\r\n\r\n  // Bandcamp (page or EmbeddedPlayer URL)\r\n  if (parsed && /bandcamp\\.com$/i.test(parsed.hostname) || /bandcamp\\.com$/i.test(l)) {\r\n    return { provider: 'bandcamp', id: u };\r\n  }\r\n\r\n  // SoundCloud\r\n  if (parsed && /(^|\\.)soundcloud\\.com$/.test(parsed.hostname) || /soundcloud\\.com/i.test(l)) {\r\n    return { provider: 'soundcloud', id: u };\r\n  }\r\n\r\n  // Fallback\r\n  return { provider: 'link', id: u };\r\n}\r\n\r\n// --- Robust embedder ---\r\nexport function buildEmbed(post, container, opts = {}) {\r\n  const p = post.provider || parseProvider(post.url || post.id || '');\r\n  const wrap = container;\r\n  // cleanup any previous listeners\r\n  try { wrap._cleanup && wrap._cleanup(); } catch {}\r\n  wrap._cleanup = null;\r\n  wrap.innerHTML = '';\r\n  const autoplay = !!opts.autoplay;\r\n\r\n  // YouTube video\r\n  if (p.provider === 'youtube') {\r\n    const origin = isHTTPOrigin(location.origin) ? location.origin : 'https://localhost';\r\n    const params = new URLSearchParams({\r\n      rel: '0',\r\n      modestbranding: '1',\r\n      playsinline: '1',\r\n      enablejsapi: '1',\r\n      origin,\r\n    });\r\n    if (autoplay) {\r\n      params.set('autoplay', '1');\r\n      // params.set('mute', '1'); // removed to allow sound on start\r\n    }\r\n    const src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(p.id)}?${params.toString()}`;\r\n\r\n    const ifr = document.createElement('iframe');\r\n    ifr.className = 'yt';\r\n    ifr.src = src;\r\n    ifr.frameBorder = '0';\r\n    ifr.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';\r\n    ifr.allowFullscreen = true;\r\n    ifr.loading = 'lazy';\r\n    ifr.referrerPolicy = 'strict-origin-when-cross-origin';\r\n    ifr.style.width = '100%';\r\n    ifr.style.aspectRatio = '16/9';\r\n\r\n    wrap.appendChild(ifr);\r\n\r\n    // Support queueNext on end using postMessage events\r\n    if (typeof opts.onEnded === 'function') {\r\n      const onMessage = (ev) => {\r\n        if (ev.source !== ifr.contentWindow) return;\r\n        let data = ev.data;\r\n        if (typeof data === 'string') {\r\n          try { data = JSON.parse(data); } catch {}\r\n        }\r\n        if (!data || typeof data !== 'object') return;\r\n\r\n        if (data.event === 'onStateChange' && data.info === 0) {\r\n          // ended\r\n          opts.onEnded();\r\n        }\r\n      };\r\n      const postListening = () => {\r\n        try {\r\n          ifr.contentWindow && ifr.contentWindow.postMessage(JSON.stringify({ event: 'listening', id: 1, channel: 'widget' }), '*');\r\n        } catch {}\r\n      };\r\n      window.addEventListener('message', onMessage);\r\n      ifr.addEventListener('load', postListening);\r\n      // also try after a tick\r\n      setTimeout(postListening, 500);\r\n\r\n      wrap._cleanup = () => {\r\n        window.removeEventListener('message', onMessage);\r\n      };\r\n    }\r\n    return;\r\n  }\r\n\r\n  // YouTube playlist\r\n  if (p.provider === 'youtube_playlist') {\r\n    const params = new URLSearchParams({ list: p.id, rel: '0', modestbranding: '1', playsinline: '1' });\r\n    if (autoplay) params.set('autoplay', '1');\r\n    const src = `https://www.youtube-nocookie.com/embed/videoseries?${params.toString()}`;\r\n    wrap.innerHTML = `\r\n      <iframe class=\"yt\" src=\"${src}\" frameborder=\"0\"\r\n        allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\r\n        allowfullscreen loading=\"lazy\" referrerpolicy=\"strict-origin-when-cross-origin\"\r\n        style=\"width:100%;aspect-ratio:16/9;\"></iframe>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  // Spotify\r\n  if (p.provider === 'spotify') {\r\n    const src = `https://open.spotify.com/embed/${p.kind}/${p.id}`;\r\n    wrap.innerHTML = `\r\n      <iframe class=\"sp\" src=\"${src}\" frameborder=\"0\"\r\n        allow=\"autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture\"\r\n        loading=\"lazy\" referrerpolicy=\"strict-origin-when-cross-origin\"\r\n        style=\"width:100%;min-height:80px;\"></iframe>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  // Bandcamp (universal embed)\r\n  if (p.provider === 'bandcamp') {\r\n    const url = post.url || p.id;\r\n    const embedUrl = `https://bandcamp.com/EmbeddedPlayer/?url=${encodeURIComponent(url)}&size=large&bgcol=ffffff&linkcol=0687f5&transparent=true`;\r\n    wrap.innerHTML = `\r\n      <iframe class=\"bc\" style=\"width:100%; min-height:120px; max-height:450px;\" frameborder=\"0\" allowtransparency=\"true\" allow=\"autoplay; encrypted-media\"\r\n        src=\"${embedUrl}\" loading=\"lazy\" referrerpolicy=\"strict-origin-when-cross-origin\"></iframe>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  // SoundCloud (direct iframe embed)\r\n  if (p.provider === 'soundcloud') {\r\n    // Extract the track or playlist URL\r\n    const url = post.url || p.id;\r\n    // Build the SoundCloud player embed URL\r\n    // See https://developers.soundcloud.com/docs/api/html5-widget#examples\r\n    const playerUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%230066cc&auto_play=${opts.autoplay ? 'true' : 'false'}&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`;\r\n    wrap.innerHTML = `\r\n      <iframe class=\"sc\" width=\"100%\" height=\"166\" scrolling=\"no\" frameborder=\"no\" allow=\"autoplay\"\r\n        src=\"${playerUrl}\"\r\n        style=\"width:100%; min-height:166px; max-height:450px;\"\r\n        loading=\"lazy\" referrerpolicy=\"strict-origin-when-cross-origin\"></iframe>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  // Direct audio\r\n  if (p.provider === 'audio') {\r\n    const audio = document.createElement('audio');\r\n    audio.controls = true;\r\n    audio.className = 'audio';\r\n    audio.src = p.id;\r\n    audio.preload = 'metadata';\r\n    audio.playsInline = true;\r\n    if (autoplay) setTimeout(() => { audio.play().catch(() => {}); }, 0);\r\n    audio.addEventListener('ended', () => { if (typeof opts.onEnded === 'function') opts.onEnded(); });\r\n    wrap.appendChild(audio);\r\n    return;\r\n  }\r\n\r\n  // Fallback: just a link\r\n  fallbackLink(post.url || p.id, wrap, 'Open link');\r\n}\r\n\r\nfunction fallbackLink(href, wrap, label) {\r\n  wrap.innerHTML = '';\r\n  const a = document.createElement('a');\r\n  a.href = href;\r\n  a.textContent = label;\r\n  a.target = '_blank';\r\n  a.rel = 'noopener noreferrer';\r\n  wrap.appendChild(a);\r\n}", "// automod.js - simple automoderation utilities\r\n\r\n// List of banned words/phrases and regex patterns (expanded)\r\nconst BANNED_PATTERNS = [\r\n  // Profanity and variants (word boundaries, leetspeak, spacing)\r\n  /\\bf+u+c+k+\\b/i,\r\n  /\\bs+h+i+t+\\b/i,\r\n  /\\bb+i+t+c+h+\\b/i,\r\n  /\\ba+s+s+h*o*l*e*\\b/i,\r\n  /\\bb+a+s+t+a*r*d+\\b/i,\r\n  /\\bd+i+c+k+\\b/i,\r\n  /\\bc+u+n+t+\\b/i,\r\n  /\\bp+i+s+s+\\b/i,\r\n  /\\bc+o+c+k+\\b/i,\r\n  /\\bp+u+s+s+y+\\b/i,\r\n  /\\bf+a+g+\\b/i,\r\n  /\\bs+l+u+t+\\b/i,\r\n  /\\bw+h*o+r*e*\\b/i,\r\n  // Hate speech / slurs (word boundaries)\r\n  /\\bn+i+g+g*(a|e*r*)\\b/i,\r\n  /\\bk+i+k+e+\\b/i,\r\n  /\\bc+h+i+n+k+\\b/i,\r\n  /\\bg+o+o+k+\\b/i,\r\n  /\\bs+p+i+c+\\b/i,\r\n  /\\bw+e+t+b+a+c+k+\\b/i,\r\n  /\\bf+a+g+g*o*t*\\b/i,\r\n  /\\bt+r+a+n+n*y*\\b/i,\r\n  /\\br+e+t+a+r+d+\\b/i,\r\n  /\\bd+y+k+e+\\b/i,\r\n  /\\bc+o+o+n+\\b/i,\r\n  // Spammy terms/phrases\r\n  /free\\s*money/i,\r\n  /work\\s*from\\s*home/i,\r\n  /viagra/i,\r\n  /cialis/i,\r\n  /loan/i,\r\n  /credit\\s*score/i,\r\n  /casino/i,\r\n  /betting/i,\r\n  // /porn/i, // Disabled: too broad, causes false positives (e.g., 'profile picture')\r\n  // /x{2,}/i, // Disabled: too broad, causes false positives (e.g., 'about me')\r\n  // Obvious spam patterns\r\n  /http:\\/\\/(bit\\.ly|tinyurl)/i,\r\n  /buy\\s*now/i,\r\n  /click\\s*here/i,\r\n  /subscribe/i,\r\n  /earn\\s*\\$/i,\r\n  // Placeholder for more\r\n  // /spamword1/i, // Placeholder, not used\r\n  // /offensiveword/i, // Placeholder, not used\r\n  // /badword/i // Placeholder, not used\r\n];\r\n\r\n// Normalize text for better matching (remove spaces, leetspeak, etc.)\r\nfunction normalize(text) {\r\n  // Only normalize leetspeak, not all spaces, to avoid over-matching benign phrases\r\n  return text\r\n    .toLowerCase()\r\n    .replace(/[0@]/g, 'o')\r\n    .replace(/[1!|]/g, 'i')\r\n    .replace(/[3]/g, 'e')\r\n    .replace(/[4]/g, 'a')\r\n    .replace(/[5]/g, 's')\r\n    .replace(/[7]/g, 't');\r\n    // .replace(/\\s+/g, ''); // Disabled: don't remove spaces, prevents false positives\r\n}\r\n\r\n// Returns true if content contains a banned word or pattern\r\nexport function containsBannedWords(text) {\r\n  if (!text) return false;\r\n  const norm = normalize(text);\r\n  return BANNED_PATTERNS.some(pattern => pattern.test(text) || pattern.test(norm));\r\n}\r\n\r\n// Improved spam detection\r\nexport function looksLikeSpam(text) {\r\n  if (!text) return false;\r\n  // Too many links\r\n  const linkCount = (text.match(/https?:\\/\\//g) || []).length;\r\n  if (linkCount > 4) return true; // allow up to 4 links\r\n  // Repeated characters or words checks disabled to avoid false positives for normal sentences\r\n  // Excessive non-ASCII or symbols\r\n  if ((text.match(/[^\\x00-\\x7F]/g) || []).length > 20) return true;\r\n  // Excessive length (more generous)\r\n  if (text.length > 1200) return true;\r\n  return false;\r\n}\r\n\r\n// Main moderation check: returns error message or null\r\nexport function checkPostModeration({ title, artist, body, tags }) {\r\n  if (\r\n    containsBannedWords(title) ||\r\n    containsBannedWords(artist) ||\r\n    containsBannedWords(body) ||\r\n    (tags && tags.some(containsBannedWords))\r\n  ) {\r\n    return 'Your post contains banned words.';\r\n  }\r\n  if (\r\n    looksLikeSpam(title) ||\r\n    looksLikeSpam(artist) ||\r\n    looksLikeSpam(body)\r\n  ) {\r\n    return 'Your post looks like spam.';\r\n  }\r\n  return null;\r\n}\r\n", "import { parseProvider } from './providers.js';\r\nimport { uid, esc, toast } from '../core/utils.js';\r\nimport { checkPostModeration, containsBannedWords, looksLikeSpam } from './automod.js';\r\n\r\nexport async function onCreatePost(e, state, DB, render) {\r\n  e.preventDefault();\r\n  const db = DB.getAll();\r\n  const me = state.user;\r\n  if (!me) { toast(document.getElementById('app'), 'login to post', true); return; }\r\n\r\n  // Restrict to 1 post per 24h\r\n  const now = Date.now();\r\n  const lastPost = db.posts\r\n    .filter(p => p.userId === me.id)\r\n    .sort((a, b) => b.createdAt - a.createdAt)[0];\r\n  if (lastPost && now - lastPost.createdAt < 24 * 60 * 60 * 1000) {\r\n    const timeLeft = 24 * 60 * 60 * 1000 - (now - lastPost.createdAt);\r\n    const hours = Math.floor(timeLeft / (60 * 60 * 1000));\r\n    const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));\r\n    const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);\r\n    const errorDiv = document.getElementById('postFormError');\r\n    if (errorDiv) errorDiv.textContent = `You can post again in ${hours}h ${minutes}m ${seconds}s.`;\r\n    return;\r\n  }\r\n\r\n\r\n  const title = document.getElementById('f_title').value.trim();\r\n  const artist = document.getElementById('f_artist').value.trim();\r\n  let url = document.getElementById('f_url').value.trim();\r\n  let body = document.getElementById('f_body').value.trim();\r\n  if (body.length > 200) body = body.slice(0, 200);\r\n  let tags = (document.getElementById('f_tags').value || '').trim();\r\n  const errorDiv = document.getElementById('postFormError');\r\n  if (errorDiv) errorDiv.textContent = '';\r\n  // Captcha check\r\n  const captchaBox = document.getElementById('captchaBox');\r\n  const captchaInput = document.getElementById('f_captcha');\r\n  if (captchaBox && captchaInput) {\r\n    const answer = captchaBox.dataset.answer;\r\n    if (captchaInput.value.trim() !== answer) {\r\n      if (errorDiv) errorDiv.textContent = 'Captcha incorrect. Please try again.';\r\n      captchaInput.value = '';\r\n      // Reset captcha\r\n      const evt = new Event('resetCaptcha');\r\n      document.getElementById('postForm').dispatchEvent(evt);\r\n      return;\r\n    }\r\n  }\r\n  if (!title || !url) return;\r\n\r\n  if (!tags) {\r\n    if (errorDiv) errorDiv.textContent = 'Please enter at least one tag.';\r\n    return;\r\n  }\r\n  if (!body) {\r\n    if (errorDiv) errorDiv.textContent = \"Don't be shy! Tell us what makes this track stand out.\";\r\n    return;\r\n  }\r\n\r\n  // Automoderation check (title, artist, body, tags)\r\n  let tagsArr = tags.split(/[#,\\s]+/g).map(t => t.trim().toLowerCase()).filter(Boolean).slice(0, 12);\r\n  // Deduplicate tags, preserve order\r\n  let seenTags = new Set();\r\n  tagsArr = tagsArr.filter(t => {\r\n    if (seenTags.has(t)) return false;\r\n    seenTags.add(t);\r\n    return true;\r\n  });\r\n  if (\r\n    containsBannedWords(title) ||\r\n    containsBannedWords(artist) ||\r\n    containsBannedWords(body) ||\r\n    tagsArr.some(containsBannedWords)\r\n  ) {\r\n    if (errorDiv) errorDiv.textContent = 'Your post contains banned words.';\r\n    return;\r\n  }\r\n  if (\r\n    looksLikeSpam(title) ||\r\n    looksLikeSpam(artist) ||\r\n    looksLikeSpam(body)\r\n  ) {\r\n    if (errorDiv) errorDiv.textContent = 'Your post looks like spam.';\r\n    return;\r\n  }\r\n\r\n  // Do not strip YouTube query params; preserve full video URLs\r\n\r\n  const provider = parseProvider(url);\r\n  tags = tagsArr;\r\n\r\n  const dup = db.posts.find(p =>\r\n    p.url.trim() === url ||\r\n    (p.provider && provider && p.provider.provider === provider.provider && p.provider.id === provider.id && p.provider.kind === provider.kind)\r\n  );\r\n  if (dup) {\r\n    // Remove any existing confirm popup\r\n    document.querySelectorAll('.comment-delete-confirm').forEach(el => el.remove());\r\n\r\n    // Create confirm popup (identical to comment/post delete)\r\n    const confirmDiv = document.createElement('div');\r\n    confirmDiv.className = 'comment-delete-confirm fadein';\r\n    confirmDiv.innerHTML = `\r\n      <div class=\"confirm-inner\">\r\n        <span><b>This link looks like a duplicate. Add anyway?</b></span>\r\n        <button class=\"btn small btn-danger confirm-yes\" tabindex=\"0\">OK</button>\r\n        <button class=\"btn small confirm-no\" tabindex=\"0\">Cancel</button>\r\n      </div>\r\n    `;\r\n    // Position near the submit button\r\n    const submitBtn = document.querySelector('#postForm button[type=\"submit\"]');\r\n    const rect = submitBtn ? submitBtn.getBoundingClientRect() : {left: window.innerWidth/2, bottom: window.innerHeight/2};\r\n    confirmDiv.style.position = 'absolute';\r\n    confirmDiv.style.zIndex = 10010;\r\n    let left = rect.left + window.scrollX;\r\n    const minWidth = 260;\r\n    if (left + minWidth > window.innerWidth - 8) {\r\n      left = window.innerWidth - minWidth - 8;\r\n    }\r\n    confirmDiv.style.left = left + 'px';\r\n    confirmDiv.style.top = (rect.bottom + window.scrollY + 4) + 'px';\r\n\r\n    document.body.appendChild(confirmDiv);\r\n\r\n    // Remove popup helper (with fadeout)\r\n    function removeConfirm() {\r\n      confirmDiv.classList.remove('fadein');\r\n      confirmDiv.classList.add('fadeout');\r\n      setTimeout(() => confirmDiv.remove(), 180);\r\n    }\r\n\r\n    // Confirm\r\n    confirmDiv.querySelector('.confirm-yes').onclick = () => {\r\n      removeConfirm();\r\n      // Continue with post creation\r\n      actuallyCreatePost();\r\n    };\r\n    // Cancel\r\n    confirmDiv.querySelector('.confirm-no').onclick = () => {\r\n      removeConfirm();\r\n      setTimeout(() => {\r\n        const el = document.getElementById('post-' + dup.id);\r\n        if (el) {\r\n          el.classList.add('highlight');\r\n          el.scrollIntoView({ block: 'start' });\r\n          setTimeout(() => el.classList.remove('highlight'), 1500);\r\n        }\r\n      }, 10);\r\n    };\r\n    // Keyboard accessibility\r\n    confirmDiv.onkeydown = (ev) => {\r\n      if (ev.key === 'Enter') {\r\n        confirmDiv.querySelector('.confirm-yes').click();\r\n      } else if (ev.key === 'Escape') {\r\n        removeConfirm();\r\n      }\r\n    };\r\n    setTimeout(() => {\r\n      confirmDiv.querySelector('.confirm-yes').focus();\r\n    }, 10);\r\n    setTimeout(() => {\r\n      function outside(ev) {\r\n        if (!confirmDiv.contains(ev.target)) {\r\n          removeConfirm();\r\n          document.removeEventListener('mousedown', outside);\r\n        }\r\n      }\r\n      document.addEventListener('mousedown', outside);\r\n    }, 0);\r\n\r\n    // Prevent default post creation\r\n    return;\r\n\r\n    // Helper to continue post creation if confirmed\r\n    function actuallyCreatePost() {\r\n      // ...existing code for post creation below...\r\n      const post = {\r\n        id: uid('p'),\r\n        userId: me.id,\r\n        title, artist, url,\r\n        provider,\r\n        tags,\r\n        body,\r\n        likes: [],\r\n        comments: [],\r\n        createdAt: Date.now()\r\n      };\r\n      DB.createPost(post).then(() => render());\r\n    }\r\n  }\r\n\r\n  const post = {\r\n    id: uid('p'),\r\n    userId: me.id,\r\n    title, artist, url,\r\n    provider,\r\n    tags,\r\n    body,\r\n    likes: [],\r\n    comments: [],\r\n    createdAt: Date.now()\r\n  };\r\n  await DB.createPost(post);\r\n\r\n  document.getElementById('f_title').value = '';\r\n  document.getElementById('f_artist').value = '';\r\n  document.getElementById('f_url').value = '';\r\n  document.getElementById('f_tags').value = '';\r\n  document.getElementById('f_body').value = '';\r\n  if (errorDiv) errorDiv.textContent = '';\r\n  const preview = document.getElementById('preview');\r\n  preview.classList.remove('active'); preview.innerHTML = '';\r\n  // Reset captcha after successful post\r\n  const evt = new Event('resetCaptcha');\r\n  document.getElementById('postForm').dispatchEvent(evt);\r\n\r\n  render();\r\n  setTimeout(() => {\r\n    const el = document.getElementById('post-' + post.id);\r\n    if (el) {\r\n      el.classList.add('highlight');\r\n      el.scrollIntoView({ block: 'start' });\r\n      setTimeout(() => el.classList.remove('highlight'), 1500);\r\n    }\r\n  }, 10);\r\n}\r\n\r\nexport function openEditInline(postId, state, DB, opts = {}) {\r\n  window.editingPostId = postId;\r\n  // Close comment panel if open for this post\r\n  const cbox = document.getElementById('cbox-' + postId);\r\n  if (cbox && cbox.classList.contains('active')) {\r\n    cbox.classList.remove('fade-in');\r\n    cbox.classList.add('fade-out');\r\n    setTimeout(() => {\r\n      cbox.classList.remove('active');\r\n      cbox.classList.remove('fade-out');\r\n      if (window.openCommentId == postId) window.openCommentId = null;\r\n    }, 180);\r\n  }\r\n  const db = DB.getAll();\r\n  const p = db.posts.find(x => x.id === postId);\r\n  if (!p) return;\r\n  if (!state.user || p.userId !== state.user.id) { toast(document.getElementById('app'), 'you can only edit your posts', true); return; }\r\n  const card = document.getElementById('post-' + postId);\r\n  if (!card) return;\r\n  const editBoxId = 'editbox-' + postId;\r\n  const opened = card.querySelector('#' + editBoxId);\r\n  if (opened) {\r\n    // Already open, do nothing\r\n    return;\r\n  }\r\n  const edit = document.createElement('div');\r\n  edit.className = 'box' + (opts.noAnimation ? '' : ' fade-in');\r\n  edit.id = editBoxId;\r\n  edit.style.marginTop = '8px';\r\n  edit.innerHTML = `\r\n    <div class=\"muted small\">edit post</div>\r\n    <form class=\"stack\" data-action=\"edit-form\" data-post=\"${p.id}\">\r\n    <input class=\"field\" name=\"title\" value=\"${esc(p.title)}\" required maxlength=\"120\" placeholder=\"Title (song or album)\"/>\r\n    <input class=\"field\" name=\"artist\" value=\"${esc(p.artist || '')}\" placeholder=\"Artist\"/>\r\n    <input class=\"field\" name=\"url\" value=\"${esc(p.url)}\" required readonly placeholder=\"Link (YouTube / Spotify / Bandcamp, etc)\"/>\r\n    <input class=\"field\" name=\"tags\" value=\"${esc((p.tags || []).join(' '))}\" placeholder=\"#Tags go here\"/>\r\n  <textarea class=\"field\" name=\"body\" rows=\"4\" maxlength=\"200\" oninput=\"this.nextElementSibling.textContent = this.value.length + '/200';\" placeholder=\"Share something about this track, a memory, or the vibe it gives you.\">${esc(p.body || '')}</textarea>\r\n  <div class=\"muted small\" style=\"text-align:right\">${(p.body||'').length}/200</div>\r\n      <div class=\"hstack\">\r\n        <button class=\"btn\" type=\"submit\">[ save ]</button>\r\n        <button class=\"btn btn-ghost\" type=\"button\" data-action=\"toggle-player\">[ preview ]</button>\r\n      </div>\r\n    </form>\r\n  `;\r\n  card.appendChild(edit);\r\n\r\n  // Save draft on every input\r\n  if (!window.editingPostDrafts) window.editingPostDrafts = {};\r\n  const form = edit.querySelector('form[data-action=\"edit-form\"]');\r\n  if (form) {\r\n    const saveDraft = () => {\r\n      window.editingPostDrafts[postId] = {\r\n        title: form.title?.value,\r\n        artist: form.artist?.value,\r\n        url: form.url?.value,\r\n        tags: form.tags?.value,\r\n        body: form.body?.value\r\n      };\r\n    };\r\n    form.addEventListener('input', saveDraft);\r\n    // Restore draft if present\r\n    const draft = window.editingPostDrafts[postId];\r\n    if (draft) {\r\n      if (draft.title !== undefined) form.title.value = draft.title;\r\n      if (draft.artist !== undefined) form.artist.value = draft.artist;\r\n      if (draft.url !== undefined) form.url.value = draft.url;\r\n      if (draft.tags !== undefined) form.tags.value = draft.tags;\r\n      if (draft.body !== undefined) form.body.value = draft.body;\r\n    }\r\n  }\r\n\r\n  // Attach to window for feed.js to call\r\n  if (!window.openEditInline) window.openEditInline = openEditInline;\r\n// Ensure editingPostId is cleared on save (form submit)\r\ndocument.addEventListener('submit', function(e) {\r\n  const form = e.target;\r\n  if (form && form.matches('form[data-action=\"edit-form\"]')) {\r\n    const postId = form.getAttribute('data-post');\r\n    if (window.editingPostId == postId) window.editingPostId = null;\r\n  }\r\n});\r\n}", "// Enable mouse drag-to-scroll for .tag-cloud on desktop\r\nexport function enableTagCloudDragScroll(tagCloud) {\r\n  if (!tagCloud) tagCloud = document.querySelector('.tag-cloud');\r\n  if (!tagCloud) return;\r\n  // Restore scroll position if saved\r\n  if (typeof window !== 'undefined' && typeof window._tagCloudScrollLeft === 'number') {\r\n    tagCloud.scrollLeft = window._tagCloudScrollLeft;\r\n    // Only restore once\r\n    delete window._tagCloudScrollLeft;\r\n  }\r\n// Attach to window for global use\r\nif (typeof window !== 'undefined') {\r\n  window.enableTagCloudDragScroll = enableTagCloudDragScroll;\r\n}\r\n  let isDown = false;\r\n  let startX, startY;\r\n  let scrollLeft;\r\n  let tagCloudRect;\r\n  let downTag = null;\r\n  let drag = false;\r\n  let pointerId = null;\r\n  const DRAG_THRESHOLD = 5; // px, same for all devices for consistency\r\n\r\n  function pointerDown(e) {\r\n    // Only left mouse button or single touch\r\n    if ((e.type === 'mousedown' && e.button !== 0) || (e.type === 'pointerdown' && e.pointerType === 'mouse' && e.button !== 0)) return;\r\n    isDown = true;\r\n    drag = false;\r\n    pointerId = e.pointerId || null;\r\n    tagCloud.classList.add('dragging');\r\n    tagCloudRect = tagCloud.getBoundingClientRect();\r\n    if (e.type.startsWith('touch')) {\r\n      startX = e.touches[0].clientX;\r\n      startY = e.touches[0].clientY;\r\n    } else {\r\n      startX = e.clientX;\r\n      startY = e.clientY;\r\n    }\r\n    scrollLeft = tagCloud.scrollLeft;\r\n    // Track tag under pointer down\r\n    let el = e.target;\r\n    if (el && el.classList && el.classList.contains('tag')) {\r\n      downTag = el;\r\n    } else if (el && el.closest && el.closest('.tag')) {\r\n      downTag = el.closest('.tag');\r\n    } else {\r\n      downTag = null;\r\n    }\r\n    e.preventDefault && e.preventDefault();\r\n  }\r\n\r\n  function pointerMove(e) {\r\n    if (!isDown) return;\r\n    let clientX, clientY;\r\n    if (e.type.startsWith('touch')) {\r\n      clientX = e.touches[0].clientX;\r\n      clientY = e.touches[0].clientY;\r\n    } else {\r\n      clientX = e.clientX;\r\n      clientY = e.clientY;\r\n    }\r\n    const dx = clientX - startX;\r\n    const dy = clientY - startY;\r\n    if (!drag && Math.sqrt(dx * dx + dy * dy) > DRAG_THRESHOLD) {\r\n      drag = true;\r\n    }\r\n    if (!tagCloudRect) tagCloudRect = tagCloud.getBoundingClientRect();\r\n    const x = clientX - tagCloudRect.left;\r\n    tagCloud.scrollLeft = scrollLeft - (x - (startX - tagCloudRect.left));\r\n    e.preventDefault && e.preventDefault();\r\n  }\r\n\r\n  function pointerUp(e) {\r\n    if (!isDown) return;\r\n    let clientX, clientY;\r\n    if (e.type.startsWith('touch')) {\r\n      clientX = (e.changedTouches && e.changedTouches[0].clientX) || startX;\r\n      clientY = (e.changedTouches && e.changedTouches[0].clientY) || startY;\r\n    } else {\r\n      clientX = e.clientX;\r\n      clientY = e.clientY;\r\n    }\r\n    const dx = clientX - startX;\r\n    const dy = clientY - startY;\r\n    // Only select if no drag and pointer up is on the same tag as pointer down\r\n    if (!drag && downTag) {\r\n      const el = document.elementFromPoint(clientX, clientY);\r\n      let tagEl = null;\r\n      if (el && el.classList && el.classList.contains('tag')) {\r\n        tagEl = el;\r\n      } else if (el && el.closest && el.closest('.tag')) {\r\n        tagEl = el.closest('.tag');\r\n      }\r\n        if (tagEl === downTag) {\r\n          // Toggle tag selection: if already selected, unselect\r\n          if (window && window.prefs && typeof window.prefs.filterTag !== 'undefined') {\r\n            const tag = tagEl.getAttribute('data-tag');\r\n            if (window.prefs.filterTag === tag) {\r\n              window.prefs.filterTag = '';\r\n              if (typeof window.renderApp === 'function') window.renderApp();\r\n              return;\r\n            } else {\r\n              window.prefs.filterTag = tag;\r\n            }\r\n          }\r\n          if (typeof window.onActionClick === 'function') {\r\n            const evt = new Event('click', { bubbles: true, cancelable: true });\r\n            Object.defineProperty(evt, 'target', { value: tagEl, enumerable: true });\r\n            window.onActionClick(evt, window.state, window.DB, window.renderApp);\r\n          } else {\r\n            tagEl.click();\r\n          }\r\n          if (typeof window.renderApp === 'function') {\r\n            window.renderApp();\r\n          }\r\n      }\r\n    }\r\n    isDown = false;\r\n    downTag = null;\r\n    drag = false;\r\n    pointerId = null;\r\n    tagCloud.classList.remove('dragging');\r\n    tagCloudRect = null;\r\n    e.preventDefault && e.preventDefault();\r\n  }\r\n\r\n  // Use pointer events if available, else fallback to mouse/touch\r\n  if (window.PointerEvent) {\r\n    tagCloud.addEventListener('pointerdown', pointerDown, { passive: false });\r\n    tagCloud.addEventListener('pointermove', pointerMove, { passive: false });\r\n    tagCloud.addEventListener('pointerup', pointerUp, { passive: false });\r\n    tagCloud.addEventListener('pointercancel', pointerUp, { passive: false });\r\n  } else {\r\n    tagCloud.addEventListener('mousedown', pointerDown, { passive: false });\r\n    document.addEventListener('mousemove', pointerMove, { passive: false });\r\n    document.addEventListener('mouseup', pointerUp, { passive: false });\r\n    tagCloud.addEventListener('touchstart', pointerDown, { passive: false });\r\n    tagCloud.addEventListener('touchmove', pointerMove, { passive: false });\r\n    tagCloud.addEventListener('touchend', pointerUp, { passive: false });\r\n    tagCloud.addEventListener('touchcancel', pointerUp, { passive: false });\r\n  }\r\n}\r\n", "import { esc, fmtTime, $ } from '../core/utils.js';\r\nimport { openEditInline } from './posts.js';\r\nimport { enableTagCloudDragScroll } from './tagcloud_scroll.js';\r\n\r\nfunction userName(id, state, DB) {\r\n  const db = DB.getAll();\r\n  const u = db.users.find(x => x.id === id);\r\n  if (u) return u.name;\r\n  if (state.user && state.user.id === id) return state.user.name || 'user';\r\n  return 'anon';\r\n}\r\n\r\nexport function getFilteredPosts(DB, prefs) {\r\n  const db = DB.getAll();\r\n  let posts = db.posts.slice();\r\n\r\n  if (prefs.filterTag) {\r\n    posts = posts.filter(p => (p.tags || []).includes(prefs.filterTag));\r\n  }\r\n  if (prefs.search) {\r\n    const q = prefs.search.toLowerCase();\r\n    posts = posts.filter(p => {\r\n      return (p.title || '').toLowerCase().includes(q)\r\n        || (p.artist || '').toLowerCase().includes(q)\r\n        || (p.tags || []).some(t => t.includes(q))\r\n        || (p.body || '').toLowerCase().includes(q);\r\n    });\r\n  }\r\n  if (prefs.sort === 'likes') {\r\n    posts.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0) || b.createdAt - a.createdAt);\r\n  } else if (prefs.sort === 'comments') {\r\n    posts.sort((a, b) => (b.comments?.length || 0) - (a.comments?.length || 0) || b.createdAt - a.createdAt);\r\n  } else {\r\n    posts.sort((a, b) => b.createdAt - a.createdAt);\r\n  }\r\n  return posts;\r\n}\r\n\r\nexport function renderCommentHTML(c, postId, state, DB) {\r\n  const canDel = state.user && c.userId === state.user.id;\r\n  const db = DB.getAll();\r\n  const u = db.users.find(x => x.id === c.userId) || null;\r\n  const uname = userName(c.userId, state, DB);\r\n  const avatarUrl = u && u.avatarUrl ? esc(u.avatarUrl) : '/assets/android-chrome-512x512.png';\r\n    return `<div class=\"comment small\" data-comment=\"${c.id}\" data-post=\"${postId}\">\r\n      <img class=\"avatar avatar-sm\" src=\"${avatarUrl}\" alt=\"avatar\" />\r\n      <span class=\"muted\">${fmtTime(c.createdAt)}</span> <b>${u ? `<a href=\"#\" data-action=\"view-user\" data-uid=\"${esc(u.id)}\">${esc(uname)}</a>` : esc(uname)}</b>: ${esc(c.text)}\r\n      ${canDel ? ` <button class=\"btn btn-ghost small\" data-action=\"delete-comment\" data-post=\"${postId}\" data-comment=\"${c.id}\">[ delete ]</button>` : ''}\r\n    </div>`;\r\n}\r\n\r\nexport function renderPostHTML(p, state, DB) {\r\n  const db = DB.getAll();\r\n  const user = db.users.find(u => u.id === p.userId);\r\n  const me = state.user;\r\n  const liked = me ? (p.likes || []).includes(me.id) : false;\r\n  const tgs = (p.tags || []).map(t =>\r\n    `<a href=\"#\" class=\"tag small\" data-action=\"filter-tag\" data-tag=\"${esc(t)}\">#${esc(t)}</a>`\r\n  ).join(' ');\r\n  const perma = `${location.origin ? (location.origin + location.pathname) : location.pathname}#post-${p.id}`;\r\n  const canEdit = !!(me && p.userId === me.id);\r\n  const likeCount = p.likes ? p.likes.length : 0;\r\n  const commentsCount = p.comments ? p.comments.length : 0;\r\n  const commentsHTML = (p.comments || []).map(c => renderCommentHTML(c, p.id, state, DB)).join('');\r\n\r\n  const authorAvatar = user && user.avatarUrl ? esc(user.avatarUrl) : '/assets/android-chrome-512x512.png';\r\n  // Only show 'by' before artist or username, not both\r\n  const artistHTML = p.artist ? `<span class=\"post-artist-twolines muted thin\">by ${esc(p.artist)}</span>` : '';\r\n  const userBy = p.artist ? '' : 'by ';\r\n  return `\r\n  <article class=\"post\" id=\"post-${p.id}\" data-post=\"${p.id}\" aria-label=\"${esc(p.title)}\">\r\n    <div class=\"post-header-twolines\">\r\n      <div class=\"post-title-twolines\">${esc(p.title)}${artistHTML}</div>\r\n      <div class=\"small meta-twolines\">\r\n        <a href=\"#\" data-action=\"view-user\" data-uid=\"${user ? esc(user.id) : ''}\">\r\n          <img class=\"avatar avatar-sm\" src=\"${authorAvatar}\" alt=\"avatar\" />\r\n        </a>\r\n        <span class=\"muted\">${userBy}${user ? `<a href=\\\"#\\\" data-action=\\\"view-user\\\" data-uid=\\\"${esc(user.id)}\\\">${esc(user.name)}</a>` : 'anon'}</span>\r\n    <span class=\"muted sep-slash\">/</span>\r\n  <span class=\"muted\" title=\"${(() => { const d = new Date(p.createdAt); let m = d.getMinutes(); m = m < 15 ? 0 : m < 45 ? 30 : 0; if (m === 0 && d.getMinutes() >= 45) d.setHours(d.getHours() + 1); d.setMinutes(m, 0, 0); return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); })()}\">${fmtTime(p.createdAt)}</span>\r\n  ${tgs ? `<span class=\"muted sep-slash\">/</span> <div class=\"tag-cloud post-tags-twolines\">${tgs}</div>` : ''}\r\n      </div>\r\n    </div>\r\n    ${p.body ? `<div class=\"sep\"></div><div>${esc(p.body)}</div>` : ''}\r\n    <div class=\"actions hstack\" style=\"margin-top:8px\">\r\n      <button class=\"btn\" data-action=\"toggle-player\">[ play ]</button>\r\n      <button class=\"btn ${liked ? 'like-on' : ''}\" data-action=\"like\" aria-pressed=\"${liked}\" title=\"like\">[ \u2665 ${likeCount} ]</button>\r\n      <button class=\"btn\" data-action=\"comment\" title=\"comments\">[ comments ${commentsCount} ]</button>\r\n      <button class=\"btn btn-ghost\" data-action=\"queue\" title=\"add to queue\">[ add to queue ]</button>\r\n      <button class=\"btn btn-ghost\" data-action=\"share\" data-perma=\"${esc(perma)}\" title=\"share/copy link\">[ share ]</button>\r\n      ${canEdit ? `\r\n        <button class=\"btn btn-ghost\" data-action=\"edit\" data-post=\"${p.id}\">[ edit ]</button>\r\n        <button class=\"btn btn-ghost\" data-action=\"delete\">[ delete ]</button>\r\n      ` : ''}\r\n    </div>\r\n    <div class=\"player\" id=\"player-${p.id}\" aria-label=\"player\"></div>\r\n    <div class=\"comment-box\" id=\"cbox-${p.id}\">\r\n      <div class=\"sep\"></div>\r\n      <div id=\"comments-${p.id}\">\r\n        ${commentsHTML}\r\n      </div>\r\n      ${state.user ? `\r\n        <form class=\"hstack\" data-action=\"comment-form\" data-post=\"${p.id}\">\r\n          <label class=\"sr-only\" for=\"c-${p.id}\">Write a comment</label>\r\n          <input class=\"field\" id=\"c-${p.id}\" placeholder=\"write a comment\u2026\" maxlength=\"500\" aria-label=\"Write a comment\" />\r\n          <button class=\"btn\">[ send ]</button>\r\n        </form>\r\n      ` : `<div class=\"muted small\">login to comment</div>`}\r\n    </div>\r\n  </article>\r\n  `;\r\n}\r\n\r\nexport function renderFeed(el, pager, state, DB, prefs) {\r\n  // --- Preserve open comment boxes and their input values ---\r\n  const openComments = Array.from(document.querySelectorAll('.comment-box.active')).map(box => box.id);\r\n  // Map of comment box id -> input value\r\n  const commentInputs = {};\r\n  openComments.forEach(id => {\r\n    const box = document.getElementById(id);\r\n    if (box) {\r\n      const inp = box.querySelector('input.field');\r\n      if (inp) commentInputs[id] = inp.value;\r\n    }\r\n  });\r\n\r\n  let posts = getFilteredPosts(DB, prefs);\r\n  // User filter support (from prefs or global)\r\n  const userId = prefs._userFilterId || window.filterPostsByUserId;\r\n  if (userId) {\r\n    posts = posts.filter(p => p.userId === userId);\r\n  }\r\n  const total = posts.length;\r\n  const start = 0;\r\n  const end = Math.min(state.page * state.pageSize, total);\r\n  const chunk = posts.slice(start, end);\r\n\r\n  if (total === 0) {\r\n    el.innerHTML = `<div class=\"notice small\">No posts yet. Add one on the right.</div>`;\r\n    pager.innerHTML = '';\r\n    return;\r\n  }\r\n  el.innerHTML = chunk.map(p => renderPostHTML(p, state, DB)).join('');\r\n\r\n  // --- Restore open comment boxes and their input values ---\r\n  openComments.forEach(id => {\r\n    const box = document.getElementById(id);\r\n    if (box) {\r\n      box.classList.add('active');\r\n      const inp = box.querySelector('input.field');\r\n      if (inp && commentInputs[id] !== undefined) inp.value = commentInputs[id];\r\n    }\r\n  });\r\n\r\n  // Save for edit restore\r\n  setFeedGlobals(state, DB);\r\n\r\n  // Restore edit panel if editingPostId is set\r\n  if (window.editingPostId) {\r\n    const card = document.getElementById('post-' + window.editingPostId);\r\n    const editBoxId = 'editbox-' + window.editingPostId;\r\n    const editPanel = document.getElementById(editBoxId);\r\n    if (card && editPanel && editPanel.parentNode !== card) {\r\n      // Move the existing edit panel back into the card (no animation, no re-creation)\r\n      card.appendChild(editPanel);\r\n    } else if (card && !editPanel) {\r\n      // If not present at all, create it (no animation on restore)\r\n      openEditInline(window.editingPostId, state, DB, { noAnimation: true });\r\n    }\r\n  }\r\n// Attach edit button handler globally (once)\r\nif (!window._editBtnHandlerAttached) {\r\n  document.addEventListener('click', function(e) {\r\n    const btn = e.target.closest('button[data-action=\"edit\"][data-post]');\r\n    if (btn) {\r\n      const postId = btn.getAttribute('data-post');\r\n      const card = document.getElementById('post-' + postId);\r\n      const editBoxId = 'editbox-' + postId;\r\n      const opened = card ? card.querySelector('#' + editBoxId) : null;\r\n      if (opened) {\r\n        // If already open, close it\r\n        opened.classList.remove('fade-in');\r\n        opened.classList.add('fade-out');\r\n        setTimeout(() => {\r\n          if (opened.parentNode) opened.parentNode.removeChild(opened);\r\n          if (window.editingPostId == postId) window.editingPostId = null;\r\n        }, 180);\r\n      } else {\r\n        openEditInline(postId, window._lastFeedState, window._lastFeedDB);\r\n      }\r\n      e.preventDefault();\r\n    }\r\n  });\r\n  window._editBtnHandlerAttached = true;\r\n}\r\n\r\n// Save last state/DB for edit restore\r\nfunction setFeedGlobals(state, DB) {\r\n  window._lastFeedState = state;\r\n  window._lastFeedDB = DB;\r\n}\r\n\r\n  if (end < total) {\r\n    pager.innerHTML = `<button class=\"btn btn-ghost\" data-action=\"load-more\">[ load more (${end}/${total}) ]</button>`;\r\n  } else {\r\n    pager.innerHTML = `<div class=\"small muted\">${total} loaded</div>`;\r\n  }\r\n\r\n  const h = (location.hash || '').trim();\r\n  if (h.startsWith('#post-')) {\r\n    const id = h.slice(6);\r\n    const node = document.getElementById('post-' + id);\r\n    if (node) {\r\n      node.classList.add('highlight');\r\n      node.scrollIntoView({ block: 'start' });\r\n      setTimeout(() => node.classList.remove('highlight'), 1500);\r\n    }\r\n    history.replaceState(null, '', location.pathname);\r\n  }\r\n\r\n  // Always enable drag-to-scroll for each feed post's tag list\r\n  document.querySelectorAll('.tag-cloud.post-tags-twolines').forEach(tc => {\r\n    enableTagCloudDragScroll(tc);\r\n  });\r\n}\r\n\r\nexport function renderTags(el, DB, prefs) {\r\n  const db = DB.getAll();\r\n  const m = new Map();\r\n  db.posts.forEach(p => (p.tags || []).forEach(t => m.set(t, (m.get(t) || 0) + 1)));\r\n\r\n  // Sorting UI\r\n  let sortMode = window.localStorage.getItem('tagSortMode') || 'freq';\r\n  function setSortMode(mode) {\r\n    sortMode = mode;\r\n    window.localStorage.setItem('tagSortMode', mode);\r\n    renderTags(el, DB, prefs);\r\n  }\r\n  // Remove old sort UI if present\r\n  const oldSortUI = el.querySelector('.tag-sort-ui');\r\n  if (oldSortUI) oldSortUI.remove();\r\n  // Remove old tag cloud if present\r\n  const oldCloud = el.querySelector('.tag-cloud');\r\n  if (oldCloud) oldCloud.remove();\r\n  // Tag cloud\r\n  let top = Array.from(m.entries());\r\n  if (sortMode === 'freq') {\r\n    top = top.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));\r\n  } else {\r\n    top = top.sort((a, b) => a[0].localeCompare(b[0]) || b[1] - a[1]);\r\n  }\r\n  top = top.slice(0, 80);\r\n  if (top.length === 0) { el.innerHTML = '<span class=\"muted small\">no tags yet</span>'; return; }\r\n  // Render all tags with the same class, no frequency-based sizing\r\n  const tagCloudDiv = document.createElement('div');\r\n  tagCloudDiv.className = 'tag-cloud';\r\n  // Highlight the selected tag in the tag cloud\r\n  const selectedTag = prefs && prefs.filterTag;\r\n  tagCloudDiv.innerHTML = top.map(([t, c]) =>\r\n    `<span class=\"tag${selectedTag === t ? ' tag-selected' : ''}\" data-action=\"filter-tag\" data-tag=\"${esc(t)}\"${selectedTag === t ? ' style=\"background:var(--acc,#8ab4ff);color:#111;font-weight:600;border-radius:6px;outline:2px solid var(--acc,#8ab4ff);outline-offset:0;z-index:2;\"' : ''}><span class=\"tag-label\">#${esc(t)}</span></span>`\r\n  ).join(' ');\r\n  el.appendChild(tagCloudDiv);\r\n  // Restore scrollLeft if present, else center selected tag only if user is at start, using rAF for timing\r\n  if (typeof window !== 'undefined' && typeof window._tagCloudScrollLeft === 'number') {\r\n    let tries = 0;\r\n    const maxTries = 8;\r\n    function rafScrollRestore() {\r\n      tagCloudDiv.scrollLeft = window._tagCloudScrollLeft;\r\n      tries++;\r\n      if (tries < maxTries) {\r\n        requestAnimationFrame(rafScrollRestore);\r\n      } else {\r\n        delete window._tagCloudScrollLeft;\r\n      }\r\n    }\r\n    requestAnimationFrame(rafScrollRestore);\r\n  } else if (selectedTag) {\r\n    // Center the selected tag after render if user is at start and no previous scroll position, only once\r\n    requestAnimationFrame(() => {\r\n      const tagEl = tagCloudDiv.querySelector('.tag-selected');\r\n      if (tagEl && tagCloudDiv.scrollLeft < 5) {\r\n        const tagRect = tagEl.getBoundingClientRect();\r\n        const cloudRect = tagCloudDiv.getBoundingClientRect();\r\n        // Only center if tag is not fully visible\r\n        if (tagRect.left < cloudRect.left || tagRect.right > cloudRect.right) {\r\n          const offset = tagEl.offsetLeft + tagRect.width / 2 - cloudRect.width / 2;\r\n          tagCloudDiv.scrollLeft = offset;\r\n        }\r\n      }\r\n    });\r\n  }\r\n  // Enable drag-to-scroll for the main tag cloud (desktop)\r\n  if (typeof enableTagCloudDragScroll === 'function') {\r\n    enableTagCloudDragScroll(tagCloudDiv);\r\n  }\r\n  // On mobile, add touchend handler directly to each tag to ensure tap works\r\n  if ('ontouchstart' in window) {\r\n  // No-op: all tap/drag/click logic is handled in tagcloud_scroll.js\r\n  }\r\n  // Minimal sort UI below\r\n    const sortUI = document.createElement('div');\r\n    sortUI.className = 'tag-sort-ui';\r\n    sortUI.style.display = 'inline-flex';\r\n    sortUI.style.gap = '10px';\r\n    sortUI.style.marginTop = '6px';\r\n    sortUI.style.fontSize = '0.93em';\r\n    sortUI.innerHTML = `\r\n      <a href=\"#\" data-sort=\"freq\" class=\"tag-sort-link${sortMode==='freq'?' active':''}\">freq</a>\r\n      <span style=\"color:#444;opacity:0.5;\">|</span>\r\n      <a href=\"#\" data-sort=\"az\" class=\"tag-sort-link${sortMode==='az'?' active':''}\" tabindex=\"0\">A-Z</a>\r\n      <style>\r\n        .tag-sort-link {\r\n          color: #aaa;\r\n          text-decoration: none;\r\n          border: none;\r\n          background: none;\r\n          padding: 0 2px;\r\n          cursor: pointer;\r\n          position: relative;\r\n          transition: color 0.18s;\r\n          font-weight: 500;\r\n          appearance: none;\r\n          -webkit-appearance: none;\r\n          -moz-appearance: none;\r\n          outline: none;\r\n          box-shadow: none;\r\n          overflow: visible;\r\n        }\r\n        .tag-sort-link.active {\r\n          color: var(--acc, #8ab4ff);\r\n        }\r\n        .tag-sort-link::after {\r\n          content: '';\r\n          display: block;\r\n          position: absolute;\r\n          left: 0; right: 0; bottom: -2px;\r\n          height: 2px;\r\n          background: var(--acc, #8ab4ff);\r\n          opacity: 0;\r\n          transform: scaleX(0.5);\r\n          transition: opacity 0.18s, transform 0.18s;\r\n        }\r\n        .tag-sort-link:hover::after, .tag-sort-link:focus::after, .tag-sort-link.active::after {\r\n          opacity: 1;\r\n          transform: scaleX(1);\r\n        }\r\n        .tag-sort-link:hover, .tag-sort-link:focus {\r\n          color: var(--acc, #8ab4ff);\r\n        }\r\n      </style>\r\n    `;\r\n  sortUI.addEventListener('click', e => {\r\n    const link = e.target.closest('a[data-sort]');\r\n    if (link) {\r\n      e.preventDefault();\r\n      setSortMode(link.getAttribute('data-sort'));\r\n    }\r\n  });\r\n  el.appendChild(sortUI);\r\n}", "// Core notification logic for in-app notifications\r\n// Usage: notifications.add('Message', 'success'|'error'|'info');\r\n\r\n\r\nconst NOTIF_KEY = 'tunedin.notifications';\r\nfunction loadPersisted() {\r\n  try {\r\n    const raw = localStorage.getItem(NOTIF_KEY);\r\n    if (!raw) return [];\r\n    const arr = JSON.parse(raw);\r\n    // Remove expired (timeout=0 means persistent)\r\n    const now = Date.now();\r\n    return arr.filter(n => !n.expires || n.expires > now);\r\n  } catch { return []; }\r\n}\r\n\r\nconst notifications = {\r\n  list: loadPersisted(),\r\n  add(message, type = 'info', timeout = 4000) {\r\n    const id = Date.now() + Math.random();\r\n    let expires = undefined;\r\n    if (timeout > 0) expires = Date.now() + timeout;\r\n    this.list.push({ id, message, type, expires });\r\n    this._persist();\r\n    this._notifyChange();\r\n    if (timeout > 0) {\r\n      setTimeout(() => this.remove(id), timeout);\r\n    }\r\n    return id;\r\n  },\r\n  remove(id) {\r\n    this.list = this.list.filter(n => n.id !== id);\r\n    this._persist();\r\n    this._notifyChange();\r\n  },\r\n  clear() {\r\n    this.list = [];\r\n    this._persist();\r\n    this._notifyChange();\r\n  },\r\n  _listeners: [],\r\n  subscribe(fn) {\r\n    this._listeners.push(fn);\r\n    return () => {\r\n      this._listeners = this._listeners.filter(l => l !== fn);\r\n    };\r\n  },\r\n  _notifyChange() {\r\n    this._listeners.forEach(fn => fn(this.list));\r\n  },\r\n  _persist() {\r\n    try {\r\n      localStorage.setItem(NOTIF_KEY, JSON.stringify(this.list));\r\n    } catch {}\r\n  }\r\n};\r\n\r\nexport default notifications;\r\n", "// js/core/changelog_modal.js\r\n// Provides a global showChangelogModal() for use anywhere\r\n\r\nexport function showChangelogModal() {\r\n  if (document.querySelector('.changelog-modal-bg')) return;\r\n  const modalBg = document.createElement('div');\r\n  modalBg.className = 'changelog-modal-bg';\r\n  modalBg.tabIndex = -1;\r\n  const modal = document.createElement('div');\r\n  modal.className = 'changelog-modal';\r\n  modal.innerHTML = `\r\n    <div class=\"changelog-modal-header\">\r\n      <span>Dev Changelog</span>\r\n      <button class=\"changelog-modal-close\" title=\"Close\">&times;</button>\r\n    </div>\r\n    <div class=\"changelog-modal-content\"><span class=\"muted\">Loading...</span></div>\r\n  `;\r\n  modalBg.appendChild(modal);\r\n  document.body.appendChild(modalBg);\r\n  document.body.style.overflow = 'hidden';\r\n  // Close logic\r\n  function closeModal() {\r\n    document.body.style.overflow = '';\r\n    modalBg.remove();\r\n  }\r\n  // Clicking or tapping anywhere in the modal background, modal, header, or content closes it\r\n  modalBg.addEventListener('click', () => closeModal());\r\n  document.addEventListener('keydown', function escHandler(e) {\r\n    if (e.key === 'Escape') { closeModal(); document.removeEventListener('keydown', escHandler); }\r\n  });\r\n  // Fetch and display changelog\r\n  fetch('CHANGELOG.md').then(r => r.text()).then(md => {\r\n    modal.querySelector('.changelog-modal-content').innerHTML = `<pre style=\"white-space:pre-wrap;\">${md.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`;\r\n  }).catch(() => {\r\n    modal.querySelector('.changelog-modal-content').innerHTML = '<span class=\"muted\">Could not load changelog.</span>';\r\n  });\r\n}\r\n\r\n// Always expose globally\r\nwindow.showChangelogModal = showChangelogModal;\r\n", "\r\nexport async function currentUser(DB) {\r\n  // Always use Supabase Auth for user identity\r\n  if (DB.isRemote && DB.supabase && DB.supabase.auth && DB.supabase.auth.getUser) {\r\n    try {\r\n      const authUser = await DB.supabase.auth.getUser();\r\n      const u = authUser?.data?.user;\r\n      if (u) {\r\n        const name = u.user_metadata?.name || u.email || 'user';\r\n        // Ensure user exists in DB\r\n        try { await DB.ensureUser(name); } catch {}\r\n        return { id: u.id, name, email: u.email };\r\n      }\r\n    } catch {}\r\n  }\r\n  // Not authenticated\r\n  return null;\r\n}", "// Help overlay module: injects the help overlay HTML into the page\r\nexport function renderHelpOverlay() {\r\n  const helpHTML = `\r\n  <div class=\"sheet\">\r\n      <div class=\"hstack\" style=\"justify-content:space-between; align-items:center\">\r\n        <div class=\"muted small\">> help</div>\r\n        <button class=\"btn btn-ghost small\" data-close-help>[ close ]</button>\r\n      </div>\r\n      <div class=\"sep\"></div>\r\n      <div class=\"small stack\" style=\"gap:1.5em\">\r\n        <div style=\"text-align:center;\">\r\n          <b>\uD83D\uDC4B Welcome to <span style=\"color:var(--accent,#6cf)\">TunedIn.space</span></b><br>\r\n          <span class=\"muted\">Post less. Feel more.</span><br>\r\n          <span class=\"muted\" style=\"display:block; margin-top:0.5em;\">\r\n          </span>\r\n        </div>\r\n        <div class=\"hstack\" style=\"justify-content:center; gap:12px; margin: 1em 0 0.5em 0;\">\r\n          <button class=\"btn btn-ghost\" data-action=\"show-changelog\">[ dev changelog ]</button>\r\n        </div>\r\n        <div>\r\n          <b>Getting Started</b><br>\r\n          <ul style=\"margin:0 0 0 1.2em; padding:0;\">\r\n            <li>Scroll the feed and eavesdrop on what everyone else is jamming to.</li>\r\n            <li>Smash <b>[ login / register ]</b> to join the party and drop your own bangers.</li>\r\n            <li>Share links from YouTube, Spotify, Bandcamp, SoundCloud, or even that obscure .mp3 you found at 3am.</li>\r\n            <li>Tag your posts (#vibes, #throwback, #2020) so fellow music nerds can find them.</li>\r\n            <li>Hit <b>[ play all ]</b> to turn the feed into your personal radio station.</li>\r\n          </ul>\r\n        </div>\r\n        <div>\r\n          <b>How to Post</b><br>\r\n          <ul style=\"margin:0 0 0 1.2em; padding:0;\">\r\n            <li>Give us a title, an artist, and a legit music link. (No Rickrolls. Or... maybe just one.)</li>\r\n            <li>Tags = discoverability. Don\u2019t be shy.</li>\r\n            <li>Optional: Tell us why this track slaps. Or just type \"banger.\" We get it.</li>\r\n            <li><b>Note:</b> You can post once every 24 hours. Plan your pick and come back tomorrow for more!</li>\r\n          </ul>\r\n        </div>\r\n        <div>\r\n          <b>Listening & Queue</b><br>\r\n          <ul style=\"margin:0 0 0 1.2em; padding:0;\">\r\n            <li>Player controls up top: play, skip, shuffle, clear. DJ skills not required.</li>\r\n            <li>The queue is just the current feed, so filter and sort to your heart\u2019s content.</li>\r\n          </ul>\r\n        </div>\r\n        <div>\r\n          <b>Personalize</b><br>\r\n          <button class=\"btn icon\" title=\"accent color\" data-action=\"accent-pick\">\uD83C\uDFA8</button>\r\n          <span class=\"muted small\">Pick an accent color. Express yourself. (Sorry, no glitter... yet.)</span>\r\n        </div>\r\n        <div>\r\n          <b>Tips & Tricks</b><br>\r\n          <ul style=\"margin:0 0 0 1.2em; padding:0;\">\r\n            <li>Click tags to filter the feed. Use [ clear tag ] to see everything again.</li>\r\n            <li>Everything is keyboard accessible, so you can flex your shortcut skills.</li>\r\n            <li>Be kind, have fun, and remember: one person\u2019s guilty pleasure is another\u2019s anthem.</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n      <div class=\"sep\"></div>\r\n      <div style=\"text-align:center; margin-top:2em;\">\r\n        <button class=\"btn btn-danger\" data-action=\"delete-account\">Delete My Account</button>\r\n        <div class=\"muted small\" style=\"margin-top:0.5em;\">This will permanently remove your account and posts.</div>\r\n      </div>\r\n    </div>\r\n  `;\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'overlay';\r\n  overlay.id = 'help';\r\n  overlay.innerHTML = helpHTML;\r\n  document.body.appendChild(overlay);\r\n  // (Leaderboard button removed)\r\n  // Changelog button handler\r\n  overlay.querySelector('[data-action=\"show-changelog\"]').onclick = () => {\r\n    import('./changelog_modal.js').then(mod => {\r\n      mod.showChangelogModal();\r\n      // Inject changelog modal CSS if not present\r\n      if (!document.getElementById('changelog-modal-css')) {\r\n        const link = document.createElement('link');\r\n        link.rel = 'stylesheet';\r\n        link.href = 'css/changelog_modal.css';\r\n        link.id = 'changelog-modal-css';\r\n        document.head.appendChild(link);\r\n      }\r\n      // Close help overlay so changelog is not hidden\r\n      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);\r\n    });\r\n  };\r\n  // Attach delete account handler\r\n  overlay.querySelector('[data-action=\"delete-account\"]').onclick = async () => {\r\n    // Create a modal overlay for confirmation\r\n    const modal = document.createElement('div');\r\n    modal.style.position = 'fixed';\r\n    modal.style.inset = '0';\r\n    modal.style.background = 'rgba(0,0,0,0.6)';\r\n    modal.style.zIndex = '10001';\r\n    modal.style.display = 'flex';\r\n    modal.style.alignItems = 'center';\r\n    modal.style.justifyContent = 'center';\r\n    modal.innerHTML = `\r\n      <div class=\"box stack\" style=\"max-width:340px; background:var(--bg,#111); padding:2em 1.5em; border-radius:10px; box-shadow:0 4px 32px #000a; align-items:center;\">\r\n        <div class=\"muted\" style=\"font-size:1.1em; margin-bottom:0.5em;\">Type <b>delete</b> to confirm account deletion.</div>\r\n        <input id=\"deleteConfirmInput\" class=\"field\" style=\"width:100%; margin-bottom:1em;\" placeholder=\"Type 'delete' to confirm\" autocomplete=\"off\" />\r\n        <div class=\"hstack\" style=\"gap:1em; justify-content:center;\">\r\n          <button class=\"btn btn-danger\" id=\"confirmDeleteBtn\">Delete</button>\r\n          <button class=\"btn btn-ghost\" id=\"cancelDeleteBtn\">Cancel</button>\r\n        </div>\r\n        <div class=\"muted small\" id=\"deleteErrorMsg\" style=\"color:#e66; margin-top:0.5em; display:none;\"></div>\r\n      </div>\r\n    `;\r\n    document.body.appendChild(modal);\r\n    const input = modal.querySelector('#deleteConfirmInput');\r\n    const confirmBtn = modal.querySelector('#confirmDeleteBtn');\r\n    const cancelBtn = modal.querySelector('#cancelDeleteBtn');\r\n    const errorMsg = modal.querySelector('#deleteErrorMsg');\r\n    input.focus();\r\n    cancelBtn.onclick = () => { modal.remove(); };\r\n    confirmBtn.onclick = async () => {\r\n      if (input.value.trim().toLowerCase() !== 'delete') {\r\n        errorMsg.textContent = \"You must type 'delete' to confirm.\";\r\n        errorMsg.style.display = '';\r\n        input.focus();\r\n        return;\r\n      }\r\n      confirmBtn.disabled = true;\r\n      errorMsg.style.display = 'none';\r\n      const DB = (await import('./db.js')).default;\r\n      const { currentUser } = await import('../auth/auth.js');\r\n      const { clearSession } = await import('../auth/session.js');\r\n      let user = await currentUser(DB);\r\n      if (!user) { alert('No user logged in.'); modal.remove(); return; }\r\n      const ok = await DB.deleteUser(user.id);\r\n      if (ok) {\r\n        // If using Supabase, also sign out\r\n        if (DB.isRemote && DB.supabase && DB.supabase.auth && DB.supabase.auth.signOut) {\r\n          try { await DB.supabase.auth.signOut(); } catch (e) { /* ignore */ }\r\n        }\r\n        clearSession();\r\n        alert('Your account and posts have been deleted.');\r\n        location.reload();\r\n      } else {\r\n        errorMsg.textContent = 'Failed to delete account.';\r\n        errorMsg.style.display = '';\r\n        confirmBtn.disabled = false;\r\n      }\r\n    };\r\n    input.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') confirmBtn.click();\r\n    });\r\n  };\r\n}\r\n", "// Export the main app state for use in notification helpers\r\nimport DB from './db.js';\r\nimport { currentUser } from '../auth/auth.js';\r\n\r\nexport const state = {\r\n  user: null,\r\n  queue: [],\r\n  qIndex: 0,\r\n  pageSize: 30,\r\n  page: 1,\r\n  forceLogin: false\r\n};\r\n\r\n// Always refresh user from Supabase (or local DB for local mode)\r\n// Supabase manages its own session persistence, so sessionStorage is not needed for remote users\r\nexport async function refreshUser() {\r\n  state.user = await currentUser(DB);\r\n}", "// Fetch oEmbed metadata for supported providers\r\n// Returns { title, author, thumbnail, ... } or null\r\nexport async function fetchOEmbed(url) {\r\n  // YouTube\r\n  if (/youtube\\.com|youtu\\.be/.test(url)) {\r\n    try {\r\n      // Always use canonical video URL for oEmbed (strip playlist param)\r\n      let canonical = url;\r\n      try {\r\n        const u = new URL(url);\r\n        // If v param exists, build canonical video URL\r\n        const v = u.searchParams.get('v');\r\n        if (v) {\r\n          canonical = `https://www.youtube.com/watch?v=${v}`;\r\n        } else if (/youtu\\.be$/.test(u.hostname)) {\r\n          // youtu.be short link\r\n          const id = u.pathname.split('/').filter(Boolean)[0];\r\n          if (id) canonical = `https://www.youtube.com/watch?v=${id}`;\r\n        }\r\n      } catch {}\r\n      const res = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(canonical)}&format=json`);\r\n      if (!res.ok) return null;\r\n      return await res.json();\r\n    } catch {}\r\n  }\r\n  // SoundCloud\r\n  if (/soundcloud\\.com/.test(url)) {\r\n    try {\r\n      // Use Vercel proxy endpoint to avoid CORS issues\r\n      const res = await fetch(`/api/soundcloud-oembed?url=${encodeURIComponent(url)}`);\r\n      if (!res.ok) return null;\r\n      return await res.json();\r\n    } catch {}\r\n  }\r\n  // Bandcamp (no official oEmbed, try OpenGraph)\r\n  if (/bandcamp\\.com/.test(url)) {\r\n    // Bandcamp does not support oEmbed, fallback to OpenGraph scraping (not possible client-side due to CORS)\r\n    return null;\r\n  }\r\n  // Spotify (no oEmbed, fallback to OpenGraph)\r\n  if (/spotify\\.com/.test(url)) {\r\n    return null;\r\n  }\r\n  // Fallback: try generic oEmbed providers if needed\r\n  return null;\r\n}\r\n", "// YouTube oEmbed returns title (usually \"Artist - Song\" or video title) and author_name (uploader)\r\n// Try to split title into artist/title if possible\r\nexport function parseYouTubeTitle(oembed) {\r\n  if (!oembed || !oembed.title) return { artist: '', title: '' };\r\n  // Try to split on ' - ' (common for music videos)\r\n  const dashIdx = oembed.title.indexOf(' - ');\r\n  if (dashIdx > 0 && dashIdx < oembed.title.length - 3) {\r\n    return {\r\n      artist: oembed.title.slice(0, dashIdx).trim(),\r\n      title: oembed.title.slice(dashIdx + 3).trim(),\r\n    };\r\n  }\r\n  // Fallback: treat uploader as artist, oembed.title as title\r\n  return {\r\n    artist: oembed.author_name || '',\r\n    title: oembed.title,\r\n  };\r\n}\r\n", "// Header module: injects the header HTML into the page\r\nexport function renderHeader() {\r\n  // Use Unicode box-drawing for perfect frame, and wrap with invisible comment markers\r\n  // Frame width: 36 chars (between | and |)\r\n  const frameWidth = 41;\r\n  function padLine(str) {\r\n    // Remove any HTML tags for length calculation\r\n    const plain = str.replace(/<[^>]*>/g, '');\r\n    const len = plain.length;\r\n    if (len < frameWidth) {\r\n      const pad = frameWidth - len;\r\n      const left = Math.floor(pad / 2);\r\n      const right = pad - left;\r\n      return '&nbsp;'.repeat(left) + str + '&nbsp;'.repeat(right);\r\n    }\r\n    return str;\r\n  }\r\n  const initialMsg = 'You can post once per day! Make it count!';\r\n  const headerHTML = `\r\n    <img src=\"/assets/logo.png\" alt=\"Logo\" class=\"login-logo-anim header-logo-anim\" style=\"width:44px; height:44px; object-fit:contain; display:block; margin:0 auto 8px auto;\" />\r\n    <pre id=\"ascii-banner\" class=\"head ascii-banner\" aria-hidden=\"false\" style=\"font-family:'Fira Mono','Consolas','Menlo','Monaco','Liberation Mono',monospace !important;font-size:1em;line-height:1.1;letter-spacing:0;white-space:pre;overflow-x:auto;margin:0 auto 8px auto;max-width:100vw;\">\r\n<!--ascii-start-->\r\n\u25CF--------------------------- TunedIn.space --\u25CF\r\n| <span id=\"ascii-post-limit\">${padLine(initialMsg)}</span> |\r\n\u25CF--------------------------------------------\u25CF\r\n<!--ascii-end-->\r\n    </pre>\r\n  `;\r\n  // Animate and update the ascii-post-limit line\r\n  setTimeout(() => {\r\n    const info = document.getElementById('ascii-post-limit');\r\n    if (!info) return;\r\n  let hover = false;\r\n  let lastType = '';\r\n  const readyMessages = [\r\n      \"Time\u2019s up! Drop your freshest tune.\",\r\n      \"The stage is yours\u2014share your music!\",\r\n      \"Ready to post? Let\u2019s hear what you\u2019ve got!\",\r\n      \"Mic\u2019s on. What are you listening to today?\",\r\n      \"It\u2019s posting time - bring the vibes!\",\r\n      \"Your post window is open. Make it count!\",\r\n      \"Go on, share your soundtrack for today.\",\r\n      \"Let\u2019s see what\u2019s spinning in your world!\",\r\n      \"You\u2019re up! What\u2019s your tune of the day?\",\r\n      \"Spotlight\u2019s on you\u2014post your music pick!\"\r\n    ];\r\n  let readyMsgIndex = 0;\r\n  let readyMsgAnimTimer = null;\r\n  let readyMsgFading = false;\r\n    // Add fade animation style if not present\r\n    if (!document.getElementById('ascii-post-limit-fade-style')) {\r\n      const style = document.createElement('style');\r\n      style.id = 'ascii-post-limit-fade-style';\r\n      style.textContent = `\r\n        #ascii-post-limit.fade { transition: opacity 0.35s cubic-bezier(.4,0,.2,1); opacity: 0.25; }\r\n        #ascii-post-limit { font-family: inherit; }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n    function getCountdown() {\r\n      if (!window.DB || !window.state || !window.state.user) return '';\r\n      const db = window.DB.getAll ? window.DB.getAll() : { posts: [] };\r\n      const me = window.state.user;\r\n      const now = Date.now();\r\n      const lastPost = (db.posts || []).filter(p => p.userId === me.id).sort((a, b) => b.createdAt - a.createdAt)[0];\r\n      if (lastPost && now - lastPost.createdAt < 24 * 60 * 60 * 1000) {\r\n        const timeLeft = 24 * 60 * 60 * 1000 - (now - lastPost.createdAt);\r\n        const hours = Math.floor(timeLeft / (60 * 60 * 1000));\r\n        const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));\r\n        const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);\r\n        return `${hours}h ${minutes}m ${seconds}s`;\r\n      }\r\n      return '';\r\n    }\r\n    function padLine(str) {\r\n      // Remove any HTML tags for length calculation\r\n      const plain = str.replace(/<[^>]*>/g, '');\r\n      const len = plain.length;\r\n      if (len < frameWidth) {\r\n        const pad = frameWidth - len;\r\n        const left = Math.floor(pad / 2);\r\n        const right = pad - left;\r\n        return '\\u00A0'.repeat(left) + str + '\\u00A0'.repeat(right);\r\n      }\r\n      return str;\r\n    }\r\n    function setTextWithFade(newText, typeChanged) {\r\n      // Only update if changed\r\n      if (info.innerHTML === newText) return;\r\n      // Only fade for ready messages, not for countdown/info\r\n      if (typeChanged && (lastType === 'ready' || typeChanged === 'ready')) {\r\n        readyMsgFading = true;\r\n        info.classList.add('fade');\r\n        setTimeout(() => {\r\n          info.innerHTML = newText;\r\n          info.classList.remove('fade');\r\n          setTimeout(() => { readyMsgFading = false; }, 350); // allow fade in to finish\r\n        }, 350); // fade out duration\r\n      } else {\r\n        info.innerHTML = newText;\r\n      }\r\n    }\r\n    function updatePostLimitInfo() {\r\n      let newText, type;\r\n      // If guest (no user), animate ready messages as if post window is open\r\n      if (!window.DB || !window.state || !window.state.user) {\r\n        // Animate ready messages for guests\r\n        if (!readyMsgAnimTimer && lastType !== 'ready') {\r\n          newText = padLine('You can post once per day! Make it count!');\r\n          type = 'ready';\r\n          readyMsgAnimTimer = setTimeout(() => {\r\n            let nextIndex;\r\n            do {\r\n              nextIndex = Math.floor(Math.random() * readyMessages.length);\r\n            } while (readyMessages.length > 1 && nextIndex === readyMsgIndex);\r\n            readyMsgIndex = nextIndex;\r\n            updatePostLimitInfo();\r\n            // Start the normal animation loop\r\n            const scheduleNext = () => {\r\n              const nextDelay = 4500 + Math.random() * 3500;\r\n              readyMsgAnimTimer = setTimeout(() => {\r\n                if (!readyMsgFading) {\r\n                  let nextIndex;\r\n                  do {\r\n                    nextIndex = Math.floor(Math.random() * readyMessages.length);\r\n                  } while (readyMessages.length > 1 && nextIndex === readyMsgIndex);\r\n                  readyMsgIndex = nextIndex;\r\n                  updatePostLimitInfo();\r\n                  scheduleNext();\r\n                } else {\r\n                  readyMsgAnimTimer = setTimeout(scheduleNext, 500);\r\n                }\r\n              }, nextDelay);\r\n            };\r\n            scheduleNext();\r\n          }, 4500 + Math.random() * 3500);\r\n        } else if (readyMsgAnimTimer) {\r\n          newText = padLine(readyMessages[readyMsgIndex]);\r\n          type = 'ready';\r\n        }\r\n      } else {\r\n        const countdown = getCountdown();\r\n        if (countdown) {\r\n          if (readyMsgAnimTimer) {\r\n            clearTimeout(readyMsgAnimTimer);\r\n            readyMsgAnimTimer = null;\r\n          }\r\n          if (hover) {\r\n            newText = padLine(`Time left: ${countdown}`);\r\n            type = 'countdown';\r\n          } else {\r\n            newText = padLine('You can post once per day! Make it count!');\r\n            type = 'info';\r\n          }\r\n        } else {\r\n          // Show the initial message for a full interval, then start animating ready messages\r\n          if (!readyMsgAnimTimer && lastType !== 'ready') {\r\n            newText = padLine('You can post once per day! Make it count!');\r\n            type = 'ready';\r\n            // After a full interval, start the animation\r\n            readyMsgAnimTimer = setTimeout(() => {\r\n              let nextIndex;\r\n              do {\r\n                nextIndex = Math.floor(Math.random() * readyMessages.length);\r\n              } while (readyMessages.length > 1 && nextIndex === readyMsgIndex);\r\n              readyMsgIndex = nextIndex;\r\n              updatePostLimitInfo();\r\n              // Now start the normal animation loop\r\n              const scheduleNext = () => {\r\n                const nextDelay = 4500 + Math.random() * 3500;\r\n                readyMsgAnimTimer = setTimeout(() => {\r\n                  if (!readyMsgFading) {\r\n                    let nextIndex;\r\n                    do {\r\n                      nextIndex = Math.floor(Math.random() * readyMessages.length);\r\n                    } while (readyMessages.length > 1 && nextIndex === readyMsgIndex);\r\n                    readyMsgIndex = nextIndex;\r\n                    updatePostLimitInfo();\r\n                    scheduleNext();\r\n                  } else {\r\n                    readyMsgAnimTimer = setTimeout(scheduleNext, 500);\r\n                  }\r\n                }, nextDelay);\r\n              };\r\n              scheduleNext();\r\n            }, 4500 + Math.random() * 3500);\r\n          } else if (readyMsgAnimTimer) {\r\n            newText = padLine(readyMessages[readyMsgIndex]);\r\n            type = 'ready';\r\n          }\r\n        }\r\n      }\r\n      const typeChanged = type !== lastType;\r\n      lastType = type;\r\n      setTextWithFade(newText, typeChanged);\r\n    }\r\n  info.addEventListener('mouseenter', () => { hover = true; updatePostLimitInfo(); });\r\n  info.addEventListener('mouseleave', () => { hover = false; updatePostLimitInfo(); });\r\n  updatePostLimitInfo();\r\n  setInterval(updatePostLimitInfo, 1000);\r\n  }, 0);\r\n  const header = document.createElement('header');\r\n  header.setAttribute('role', 'banner');\r\n  header.innerHTML = headerHTML;\r\n  document.querySelector('.wrap').prepend(header);\r\n}\r\n\r\n// Main app container module: ensures #app and #live exist\r\nexport function renderMainContainers() {\r\n  const wrap = document.querySelector('.wrap');\r\n  if (!document.getElementById('app')) {\r\n    const main = document.createElement('main');\r\n    main.id = 'app';\r\n    main.setAttribute('role', 'main');\r\n    wrap.appendChild(main);\r\n  }\r\n  if (!document.getElementById('live')) {\r\n    const live = document.createElement('div');\r\n    live.id = 'live';\r\n    live.className = 'sr-only';\r\n    live.setAttribute('aria-live', 'polite');\r\n    wrap.appendChild(live);\r\n  }\r\n}\r\n", "\r\nimport DB from './db.js';\r\nimport { $ } from './utils.js';\r\nimport { loadPrefs, PREF_KEY } from '../auth/prefs.js';\r\nimport { SESSION_KEY, GUEST_KEY, isGuestMode } from '../auth/session.js';\r\nimport { bindHelpOverlay } from '../views/overlays.js';\r\nimport { renderMain } from '../views/main_view.js';\r\nimport { renderLogin } from '../views/login_view.js';\r\nimport { onActionClick, onDelegatedSubmit } from '../features/actions.js';\r\nimport { onKey } from '../auth/keyboard.js';\r\nimport { seedDemo } from '../features/seed.js';\r\nimport { state } from './app_state.js';\r\n\r\nasync function renderApp() {\r\n  if (DB.refresh) await DB.refresh();\r\n  // Keep state.user in sync\r\n  const { refreshUser } = await import('./app_state.js');\r\n  await refreshUser();\r\n  const prefs = loadPrefs();\r\n\r\n  const root = $('#app');\r\n  const banner = document.getElementById('ascii-banner');\r\n  const body = document.body;\r\n\r\n\r\n  root.innerHTML = '';\r\n  if (state.forceLogin) {\r\n    state.forceLogin = false;\r\n    if (banner) banner.style.display = 'none';\r\n    body.classList.remove('show-header');\r\n    renderLogin(root, DB, renderApp);\r\n    return;\r\n  }\r\n  if (!state.user && !isGuestMode()) {\r\n    if (banner) banner.style.display = 'none';\r\n    body.classList.remove('show-header');\r\n    renderLogin(root, DB, renderApp);\r\n  } else {\r\n    if (!document.querySelector('header[role=\"banner\"]')) {\r\n      const { renderHeader } = await import('./header.js');\r\n      renderHeader();\r\n    }\r\n    if (banner) banner.style.display = '';\r\n    body.classList.add('show-header');\r\n    renderMain(root, state, DB, renderApp);\r\n  }\r\n\r\n  bindHelpOverlay();\r\n}\r\n\r\n// Global delegated events (bind once)\r\nfunction bindGlobalHandlers() {\r\n  const root = $('#app');\r\n  root.addEventListener('click', (e) => onActionClick(e, state, DB, renderApp));\r\n  root.addEventListener('submit', (e) => onDelegatedSubmit(e, state, DB, renderApp));\r\n  // Also bind action clicks in help overlay\r\n  const help = document.getElementById('help');\r\n  if (help) {\r\n    help.addEventListener('click', (e) => onActionClick(e, state, DB, renderApp));\r\n  }\r\n  document.addEventListener('keydown', (e) => onKey(e, state));\r\n\r\n  // Double click to like, prevent text selection\r\n  document.addEventListener('dblclick', (e) => {\r\n    const card = e.target.closest('.post');\r\n    if (!card) return;\r\n    // Prevent text selection on double click\r\n    if (window.getSelection) {\r\n      const sel = window.getSelection();\r\n      if (sel && sel.type === 'Range') sel.removeAllRanges();\r\n    }\r\n    const likeBtn = card.querySelector('[data-action=\"like\"]');\r\n    likeBtn?.click();\r\n  });\r\n\r\n  // Cross-tab sync\r\n  window.addEventListener('storage', async (ev) => {\r\n    if (ev.key === PREF_KEY || ev.key === SESSION_KEY || ev.key === GUEST_KEY) {\r\n      await DB.refresh();\r\n      renderApp();\r\n    }\r\n  });\r\n}\r\n\r\nasync function boot() {\r\n  await DB.init();\r\n  bindGlobalHandlers();\r\n  await renderApp();\r\n  // expose seed helper\r\n  window.seedDemo = () => seedDemo(DB, state, renderApp);\r\n}\r\n\r\nboot();\r\n\r\n// Add header, main containers, and help overlay on DOMContentLoaded\r\nimport { renderHeader, renderMainContainers } from './header.js';\r\nimport { renderHelpOverlay } from './help.js';\r\n\r\n// Ensure posts always fit the screen\r\n\r\nwindow.addEventListener('DOMContentLoaded', function() {\r\n  // Only render header if not about to show login/register in mobile tabbed mode\r\n  renderMainContainers();\r\n  renderHelpOverlay();\r\n  document.body.classList.add('header-logo-ready');\r\n\r\n  // Add post limit info below ASCII header after header is rendered\r\n  setTimeout(() => {\r\n    const banner = document.getElementById('ascii-banner');\r\n    if (!banner) return;\r\n    let info = document.getElementById('post-limit-info');\r\n    if (!info) {\r\n      info = document.createElement('div');\r\n      info.id = 'post-limit-info';\r\n      info.style.textAlign = 'center';\r\n      info.style.fontSize = '0.98em';\r\n      info.style.margin = '-8px 0 8px 0';\r\n      info.style.color = '#888';\r\n      info.style.display = 'none'; // Hide by default\r\n      banner.parentNode.insertBefore(info, banner.nextSibling);\r\n    } else {\r\n      info.style.display = 'none'; // Hide if already exists\r\n    }\r\n    let hover = false;\r\n    let lastType = '';\r\n    let lastCountdown = '';\r\n    // Add fade animation style\r\n    if (!document.getElementById('post-limit-fade-style')) {\r\n      const style = document.createElement('style');\r\n      style.id = 'post-limit-fade-style';\r\n      style.textContent = `\r\n        #post-limit-info.fade {\r\n          transition: opacity 0.35s cubic-bezier(.4,0,.2,1);\r\n          opacity: 0.25;\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n    function getCountdown() {\r\n      if (!window.DB || !window.state || !window.state.user) return '';\r\n      const db = window.DB.getAll ? window.DB.getAll() : { posts: [] };\r\n      const me = window.state.user;\r\n      const now = Date.now();\r\n      const lastPost = (db.posts || []).filter(p => p.userId === me.id).sort((a, b) => b.createdAt - a.createdAt)[0];\r\n      if (lastPost && now - lastPost.createdAt < 24 * 60 * 60 * 1000) {\r\n        const timeLeft = 24 * 60 * 60 * 1000 - (now - lastPost.createdAt);\r\n        const hours = Math.floor(timeLeft / (60 * 60 * 1000));\r\n        const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));\r\n        const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);\r\n        return `${hours}h ${minutes}m ${seconds}s`;\r\n      }\r\n      return '';\r\n    }\r\n    function setTextWithFade(newText, typeChanged) {\r\n      if (info.textContent === newText) return;\r\n      if (typeChanged) {\r\n        info.classList.add('fade');\r\n        setTimeout(() => {\r\n          info.textContent = newText;\r\n          info.classList.remove('fade');\r\n        }, 180);\r\n      } else {\r\n        info.textContent = newText;\r\n      }\r\n    }\r\n    function updatePostLimitInfo() {\r\n      let newText, type;\r\n      if (!window.DB || !window.state || !window.state.user) {\r\n        newText = 'You can post once per day! Make it count!';\r\n        type = 'info';\r\n      } else {\r\n        const countdown = getCountdown();\r\n        if (hover && countdown) {\r\n          newText = `Time left: ${countdown}`;\r\n          type = 'countdown';\r\n        } else {\r\n          newText = 'You can post once per day! Make it count!';\r\n          type = 'info';\r\n        }\r\n      }\r\n      const typeChanged = type !== lastType;\r\n      lastType = type;\r\n      setTextWithFade(newText, typeChanged);\r\n    }\r\n    info.addEventListener('mouseenter', () => { hover = true; updatePostLimitInfo(); });\r\n    info.addEventListener('mouseleave', () => { hover = false; updatePostLimitInfo(); });\r\n    // Expose state and DB for this logic if not already\r\n    if (!window.state) window.state = state;\r\n    if (!window.DB) window.DB = DB;\r\n    updatePostLimitInfo();\r\n    setInterval(updatePostLimitInfo, 1000);\r\n  }, 0);\r\n});", "import { applyAccent, applyDensity } from '../core/utils.js';\r\n\r\nexport const PREF_KEY = 'TunedIn.space/prefs@v2';\r\n\r\nexport const defaultPrefs = {\r\n  autoScroll: true,\r\n  sort: 'new', // new | likes | comments\r\n  search: '',\r\n  filterTag: null,\r\n  accent: '#ff6b6b',\r\n  density: 'cozy',\r\n  shuffle: false,\r\n  repeat: 'off' // off | all | one\r\n};\r\n\r\nlet PREFS = null;\r\n\r\nexport function loadPrefs() {\r\n  if (PREFS) return PREFS;\r\n  const raw = localStorage.getItem(PREF_KEY);\r\n  if (!raw) {\r\n    PREFS = { ...defaultPrefs };\r\n    applyAccent(PREFS.accent);\r\n    applyDensity(PREFS.density);\r\n    return PREFS;\r\n  }\r\n  try {\r\n    PREFS = { ...defaultPrefs, ...JSON.parse(raw) };\r\n  } catch {\r\n    PREFS = { ...defaultPrefs };\r\n  }\r\n  applyAccent(PREFS.accent);\r\n  applyDensity(PREFS.density);\r\n  return PREFS;\r\n}\r\n\r\nexport function savePrefs(p) {\r\n  PREFS = { ...loadPrefs(), ...p };\r\n  try { localStorage.setItem(PREF_KEY, JSON.stringify(PREFS)); } catch {}\r\n  if (p && ('accent' in p)) applyAccent(PREFS.accent);\r\n  if (p && ('density' in p)) applyDensity(PREFS.density);\r\n  return PREFS;\r\n}\r\n\r\nexport function resetPrefsCache() {\r\n  PREFS = null;\r\n}", "// Leaderboard overlay logic\r\nexport function openLeaderboardOverlay() {\r\n  const overlay = document.getElementById('leaderboard-overlay');\r\n  if (overlay) overlay.classList.add('active');\r\n}\r\n\r\nexport function closeLeaderboardOverlay() {\r\n  const overlay = document.getElementById('leaderboard-overlay');\r\n  if (overlay) overlay.classList.remove('active');\r\n  document.dispatchEvent(new CustomEvent('leaderboardOverlayClosed'));\r\n}\r\n\r\nexport function bindLeaderboardOverlay() {\r\n  const overlay = document.getElementById('leaderboard-overlay');\r\n  if (overlay) {\r\n    overlay.onclick = function (e) {\r\n      if (e.target === overlay) closeLeaderboardOverlay();\r\n    };\r\n  }\r\n  document.addEventListener('click', (e) => {\r\n    if (e.target.matches('[data-close-leaderboard]')) closeLeaderboardOverlay();\r\n  });\r\n}\r\nlet helpClickBound = false;\r\n\r\nexport function openHelpOverlay() {\r\n  const help = document.getElementById('help');\r\n  if (help) help.classList.add('active');\r\n}\r\n\r\nexport function closeHelpOverlay() {\r\n  const help = document.getElementById('help');\r\n  if (help) help.classList.remove('active');\r\n}\r\n\r\nexport function bindHelpOverlay() {\r\n  const helpOverlay = document.getElementById('help');\r\n  if (helpOverlay) {\r\n    helpOverlay.onclick = function (e) {\r\n      if (e.target === helpOverlay) closeHelpOverlay();\r\n    };\r\n  }\r\n  if (!helpClickBound) {\r\n    document.addEventListener('click', (e) => {\r\n      if (e.target.matches('[data-close-help]')) closeHelpOverlay();\r\n    });\r\n    helpClickBound = true;\r\n  }\r\n}", "// js/views/main_view.js\r\nimport { $ } from '../core/utils.js';\r\nimport { loadPrefs, savePrefs } from '../auth/prefs.js';\r\nimport { updateDock } from '../features/queue.js';\r\nimport { onImport } from '../features/import_export.js';\r\n\r\nimport { setupFeedPane } from './main_view_feed.js';\r\nimport { renderProfileBox } from './main_view_profile.js';\r\nimport { renderComposeBox } from './main_view_compose.js';\r\nimport { setupAutoRefresh, setupVisibilityRefresh } from './main_view_refresh.js';\r\n\r\nexport async function renderMain(root, state, DB, render) {\r\n  const prefs = loadPrefs();\r\n\r\n  // Restore scrollbars and show header/banner\r\n  document.body.style.overflow = '';\r\n  document.documentElement.style.overflow = '';\r\n  const banner = document.getElementById('ascii-banner');\r\n  if (banner) banner.style.display = '';\r\n  document.body.classList.add('show-header');\r\n\r\n  // Layout containers\r\n  const grid = document.createElement('div');\r\n  grid.className = 'grid';\r\n  const left = document.createElement('div');\r\n  const right = document.createElement('div');\r\n  grid.appendChild(left);\r\n  grid.appendChild(right);\r\n  root.appendChild(grid);\r\n\r\n  // Mobile tab bar logic\r\n  let isMobile = window.matchMedia('(max-width: 600px)').matches;\r\n  // Responsive: re-render on device width change\r\n  if (!window._tunedinMobileResizeHandler) {\r\n    window._tunedinMobileResizeHandler = true;\r\n    let lastIsMobile = isMobile;\r\n    window.addEventListener('resize', () => {\r\n      const nowMobile = window.matchMedia('(max-width: 600px)').matches;\r\n      if (nowMobile !== lastIsMobile) {\r\n        lastIsMobile = nowMobile;\r\n        // Remove tab bar if present\r\n        const oldTabBar = document.querySelector('.mobile-tab-bar');\r\n        if (oldTabBar) oldTabBar.remove();\r\n        // Re-render main view\r\n        render();\r\n      }\r\n    });\r\n  }\r\n  let currentTab = 'feed';\r\n  // Helper to show/hide views\r\n  function showTab(tab) {\r\n    currentTab = tab;\r\n    // Hide all\r\n    left.style.display = 'none';\r\n    right.style.display = 'none';\r\n    // Show selected\r\n    if (tab === 'feed') left.style.display = '';\r\n    if (tab === 'compose' || tab === 'profile') right.style.display = '';\r\n    // If profile, only show profile box, else show compose\r\n    if (tab === 'profile') {\r\n      right.innerHTML = '';\r\n      renderProfileBox(right, state, DB, render);\r\n    } else if (tab === 'compose') {\r\n      right.innerHTML = '';\r\n      renderComposeBox(right, state, DB, render);\r\n    }\r\n    // Update tab bar active state\r\n    const tabBtns = document.querySelectorAll('.mobile-tab-bar button');\r\n    tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));\r\n  }\r\n\r\n  // Left side: topbar + dock + tags + feed\r\n  setupFeedPane({ root, left, state, DB, prefs, render });\r\n\r\n  // Right side: profile + compose (or guest prompt)\r\n  if (!isMobile) {\r\n    if (state.user) {\r\n      renderProfileBox(right, state, DB, render);\r\n    }\r\n    renderComposeBox(right, state, DB, render);\r\n  } else {\r\n    // On mobile, default to feed tab, right is hidden until tab is switched\r\n    right.style.display = 'none';\r\n  }\r\n\r\n  // Mobile tab bar injection with accessibility and keyboard navigation\r\n  if (isMobile) {\r\n    // Remove any existing tab bar\r\n    const oldTabBar = document.querySelector('.mobile-tab-bar');\r\n    if (oldTabBar) oldTabBar.remove();\r\n    const tabBar = document.createElement('nav');\r\n    tabBar.className = 'mobile-tab-bar';\r\n    tabBar.setAttribute('role', 'tablist');\r\n    tabBar.innerHTML = `\r\n      <div class=\"tab-indicator\"></div>\r\n      <button data-tab=\"feed\" class=\"active\" aria-label=\"Feed\" role=\"tab\" aria-selected=\"true\" tabindex=\"0\">\r\n        <span>\uD83C\uDFE0</span>\r\n        <span class=\"tab-label\">Feed</span>\r\n      </button>\r\n      <button data-tab=\"compose\" aria-label=\"Compose\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">\r\n        <span>\u270D\uFE0F</span>\r\n        <span class=\"tab-label\">Compose</span>\r\n      </button>\r\n      <button data-tab=\"profile\" aria-label=\"Profile\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">\r\n        <span>\uD83D\uDC64</span>\r\n        <span class=\"tab-label\">Profile</span>\r\n      </button>\r\n    `;\r\n    document.body.appendChild(tabBar);\r\n\r\n    const tabBtns = Array.from(tabBar.querySelectorAll('button[data-tab]'));\r\n    const indicator = tabBar.querySelector('.tab-indicator');\r\n    function moveIndicator(tab) {\r\n      const idx = tabBtns.findIndex(b => b.dataset.tab === tab);\r\n      if (idx !== -1 && indicator) {\r\n        indicator.style.left = `calc(${idx} * 100% / 3)`;\r\n      }\r\n    }\r\n\r\n    tabBar.addEventListener('keydown', (e) => {\r\n      const idx = tabBtns.findIndex(btn => btn === document.activeElement);\r\n      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {\r\n        e.preventDefault();\r\n        let nextIdx = idx;\r\n        if (e.key === 'ArrowRight') nextIdx = (idx + 1) % tabBtns.length;\r\n        if (e.key === 'ArrowLeft') nextIdx = (idx - 1 + tabBtns.length) % tabBtns.length;\r\n        tabBtns[nextIdx].focus();\r\n      } else if (e.key === 'Home') {\r\n        e.preventDefault();\r\n        tabBtns[0].focus();\r\n      } else if (e.key === 'End') {\r\n        e.preventDefault();\r\n        tabBtns[tabBtns.length - 1].focus();\r\n      } else if (e.key === 'Enter' || e.key === ' ') {\r\n        e.preventDefault();\r\n        if (idx !== -1) tabBtns[idx].click();\r\n      }\r\n    });\r\n\r\n    tabBar.addEventListener('click', (e) => {\r\n      const btn = e.target.closest('button[data-tab]');\r\n      if (btn) {\r\n        showTab(btn.dataset.tab);\r\n        // Update ARIA attributes and tabindex\r\n        tabBtns.forEach(b => {\r\n          b.setAttribute('aria-selected', b === btn ? 'true' : 'false');\r\n          b.tabIndex = b === btn ? 0 : -1;\r\n        });\r\n        btn.focus();\r\n        moveIndicator(btn.dataset.tab);\r\n      }\r\n    });\r\n\r\n    // Initial state\r\n    showTab('feed');\r\n    moveIndicator('feed');\r\n    // Ensure first tab is focusable\r\n    tabBtns[0].tabIndex = 0;\r\n  }\r\n\r\n  // Initialize dock UI\r\n  updateDock(false, state, DB);\r\n\r\n  // Auto-refresh and instant refresh (idempotent via window flags)\r\n  setupAutoRefresh(state, DB);\r\n  setupVisibilityRefresh(state, DB);\r\n\r\n  // Delegated login button handler (top bar and right box)\r\n  root.addEventListener('click', (e) => {\r\n    const btn = e.target.closest('#goLoginBtn, [data-action=\"go-login\"]');\r\n    if (btn) {\r\n      e.preventDefault();\r\n      state.forceLogin = true;\r\n      render();\r\n    }\r\n  });\r\n\r\n  // Optional external controls elsewhere in the page\r\n  const importFile = $('#importFile');\r\n  if (importFile) importFile.addEventListener('change', (e) => onImport(e, DB, state, render));\r\n\r\n  const chk = $('#autoScroll');\r\n  if (chk) chk.onchange = () => savePrefs({ autoScroll: chk.checked });\r\n}", "import { loadPrefs } from '../auth/prefs.js';\r\nimport { $ } from '../core/utils.js';\r\n\r\nexport function getActiveQueueId(state) {\r\n  return state.queue[state.qIndex] || null;\r\n}\r\n\r\nexport function updateDock(showIfHidden, state, DB) {\r\n  const dock = $('#dock');\r\n  if (!dock) return;\r\n  const len = state.queue.length;\r\n  const qLen = document.getElementById('qLen');\r\n  const qPos = document.getElementById('qPos');\r\n  if (qLen) qLen.textContent = String(len);\r\n  if (qPos) qPos.textContent = String(len ? (state.qIndex + 1) : 0);\r\n  const prefs = loadPrefs();\r\n  const shuffleBtn = document.querySelector('[data-action=\"q-shuffle\"]');\r\n  if (shuffleBtn) shuffleBtn.setAttribute('aria-pressed', String(!!prefs.shuffle));\r\n  const repeatBtn = document.querySelector('[data-action=\"q-repeat\"]');\r\n  if (repeatBtn) repeatBtn.textContent = `[ repeat: ${prefs.repeat} ]`;\r\n\r\n  if (len > 0 || showIfHidden) {\r\n    dock.style.display = 'block';\r\n    const id = getActiveQueueId(state);\r\n    if (id) {\r\n      const db = DB.getAll();\r\n      const p = db.posts.find(x => x.id === id);\r\n      const now = document.getElementById('nowPlaying');\r\n      if (now) now.textContent = p ? `now: ${p.title}${p.artist ? ' \u2014 ' + p.artist : ''}` : '';\r\n    } else {\r\n      const now = document.getElementById('nowPlaying');\r\n      if (now) now.textContent = '';\r\n    }\r\n  } else {\r\n    dock.style.display = 'none';\r\n  }\r\n  const chk = document.getElementById('autoScroll');\r\n  if (chk) { chk.onchange = e => { const c = e.target; if (c) localStorage.setItem('autoScroll', c.checked ? '1' : '0'); }; }\r\n}\r\n\r\nexport function queuePrev(state, DB) {\r\n  if (state.queue.length === 0) return;\r\n  const prefs = loadPrefs();\r\n  if (prefs.repeat === 'one') {\r\n    // stay\r\n  } else if (state.qIndex === 0) {\r\n    if (prefs.repeat === 'all') state.qIndex = state.queue.length - 1;\r\n    else state.qIndex = 0;\r\n  } else {\r\n    state.qIndex = Math.max(0, state.qIndex - 1);\r\n  }\r\n  updateDock(false, state, DB);\r\n  jumpToQueueItem(state.qIndex, state);\r\n}\r\n\r\nexport function queueNext(auto, state, DB) {\r\n  if (state.queue.length === 0) return;\r\n  const prefs = loadPrefs();\r\n  if (prefs.repeat === 'one') {\r\n    // stay\r\n  } else if (prefs.shuffle && state.queue.length > 1) {\r\n    let n;\r\n    do { n = Math.floor(Math.random() * state.queue.length); } while (n === state.qIndex);\r\n    state.qIndex = n;\r\n  } else if (state.qIndex >= state.queue.length - 1) {\r\n    if (prefs.repeat === 'all') state.qIndex = 0;\r\n    else if (auto) return;\r\n    else state.qIndex = state.queue.length - 1;\r\n  } else {\r\n    state.qIndex++;\r\n  }\r\n  updateDock(false, state, DB);\r\n  jumpToQueueItem(state.qIndex, state);\r\n}\r\n\r\nexport function jumpToQueueItem(idx, state) {\r\n  const id = state.queue[idx];\r\n  if (!id) return;\r\n  const card = document.getElementById('post-' + id);\r\n  if (!card) return;\r\n  // Save scroll position\r\n  const scrollY = window.scrollY;\r\n  const pl = document.getElementById('player-' + id);\r\n  if (pl && !pl.classList.contains('active')) {\r\n    const btn = card.querySelector('[data-action=\"toggle-player\"]');\r\n    if (btn) btn.click();\r\n  }\r\n  document.querySelectorAll('.post').forEach(p => p.classList.remove('is-playing'));\r\n  card.classList.add('is-playing');\r\n  // Restore scroll position\r\n  window.scrollTo({ top: scrollY });\r\n}\r\n\r\nexport function markNowPlaying(postId, state, DB) {\r\n  document.querySelectorAll('.post').forEach(p => p.classList.remove('is-playing'));\r\n  const card = document.getElementById('post-' + postId);\r\n  if (card) card.classList.add('is-playing');\r\n  updateDock(false, state, DB);\r\n}", "import { approxSize, fmtBytes, toast } from '../core/utils.js';\r\n\r\nexport async function onImport(e, DB, state, render) {\r\n  const file = e.target.files && e.target.files[0];\r\n  if (!file) return;\r\n  try {\r\n    const text = await file.text();\r\n    const data = JSON.parse(text);\r\n    if (!data || !Array.isArray(data.posts) || !Array.isArray(data.users)) {\r\n      alert('Invalid export file.'); return;\r\n    }\r\n    await DB.replaceAll({ ...data, version: 2 });\r\n    toast(document.getElementById('app'), DB.isRemote ? 'imported to Supabase' : 'imported');\r\n    state.queue = [];\r\n    state.qIndex = 0;\r\n    await DB.refresh();\r\n    render();\r\n  } catch (err) {\r\n    console.error(err);\r\n    alert('Import failed.');\r\n  } finally {\r\n    e.target.value = '';\r\n  }\r\n}\r\n\r\nexport async function storageInfo(DB) {\r\n  if (DB.isRemote) {\r\n    return { text: 'Data synced with Supabase. Preferences and session are saved locally.', percent: null };\r\n  }\r\n  try {\r\n    if (navigator.storage && navigator.storage.estimate) {\r\n      const est = await navigator.storage.estimate();\r\n      const used = est.usage || 0;\r\n      const quota = est.quota || 0;\r\n      const pct = quota ? Math.min(100, Math.round((used / quota) * 100)) : null;\r\n      return {\r\n        text: `Storage approx: ${fmtBytes(used)}${quota ? ' of ' + fmtBytes(quota) : ''} used \u00B7 Local-only.`,\r\n        percent: pct\r\n      };\r\n    }\r\n  } catch {}\r\n  const raw = (localStorage.getItem('TunedIn.space/db@v2') || '') + (localStorage.getItem('TunedIn.space/prefs@v2') || '');\r\n  return { text: 'Storage approx: ' + approxSize(raw) + ' \u00B7 Local-only.', percent: null };\r\n}", "// js/views/main_view_feed.js\r\nimport { $, debounce, esc } from '../core/utils.js';\r\nimport { loadPrefs, savePrefs } from '../auth/prefs.js';\r\nimport { renderFeed, renderTags, getFilteredPosts } from '../features/feed.js';\r\nimport { enableTagCloudDragScroll } from '../features/tagcloud_scroll.js';\r\nimport notifications from '../core/notifications.js';\r\n\r\nexport function setupFeedPane({ root, left, state, DB, prefs, render }) {\r\n  // Show welcome/info popup for new users (like notifications)\r\n  const BANNER_KEY = 'tunedin.hideWelcomeBanner';\r\n  if (!localStorage.getItem(BANNER_KEY)) {\r\n    const popup = document.createElement('div');\r\n    popup.className = 'info-popup-banner popup-onboarding';\r\n    popup.innerHTML = `\r\n      <div style=\"display:flex;align-items:center;justify-content:space-between;width:100%;gap:18px;\">\r\n        <div style=\"display:flex;align-items:center;gap:10px;text-align:center;\">\r\n          <span style=\"font-size:1.5em;line-height:1.1;\">\uD83C\uDF89</span>\r\n          <span style=\"font-size:1.08em;line-height:1.5;text-align:center;display:block;\">\r\n            <b>Welcome!</b> Check \r\n            <a href=\"#\" class=\"popup-link popup-nowrap\" data-popup-action=\"help\" style=\"color:#6cf;text-decoration:underline;cursor:pointer;white-space:nowrap;\"><b>[ help ]</b></a>\r\n            for tips & \r\n            <a href=\"#\" class=\"popup-link popup-changelog-link popup-nowrap\" data-popup-action=\"changelog\" style=\"color:#6cf;text-decoration:underline;cursor:pointer;white-space:nowrap;\"><b>[ dev changelog ]</b></a>\r\n            for project updates.\r\n          </span>\r\n        </div>\r\n        <button class=\"btn btn-ghost small\" style=\"font-size:1.25em;opacity:0.7;padding:2px 10px 0 10px;line-height:1;\" title=\"Dismiss\" aria-label=\"Dismiss\">\u2715</button>\r\n      </div>\r\n    `;\r\n    // Dismiss logic (only one declaration)\r\n    const close = () => {\r\n      popup.style.animation = 'fadeout-popup-banner-bottom 0.4s';\r\n      setTimeout(() => {\r\n        popup.remove();\r\n        localStorage.setItem(BANNER_KEY, '1');\r\n      }, 350);\r\n    };\r\n    // Make [ help ] and [ dev changelog ] clickable\r\n    popup.querySelector('[data-popup-action=\"help\"]').onclick = (e) => {\r\n      e.preventDefault();\r\n      // Simulate a click on the user menu help button for identical behavior\r\n      const userMenuHelpBtn = document.querySelector('[data-action=\"show-help\"]');\r\n      if (userMenuHelpBtn) userMenuHelpBtn.click();\r\n      close();\r\n    };\r\n    popup.querySelector('[data-popup-action=\"changelog\"]').onclick = (e) => {\r\n      e.preventDefault();\r\n      import('../core/changelog_modal.js').then(mod => {\r\n        // Show the modal\r\n        if (mod && typeof mod.showChangelogModal === 'function') {\r\n          mod.showChangelogModal();\r\n        } else if (window.showChangelogModal) {\r\n          window.showChangelogModal();\r\n        }\r\n        // Inject changelog modal CSS if not present\r\n        if (!document.getElementById('changelog-modal-css')) {\r\n          const link = document.createElement('link');\r\n          link.rel = 'stylesheet';\r\n          link.href = 'css/changelog_modal.css';\r\n          link.id = 'changelog-modal-css';\r\n          document.head.appendChild(link);\r\n        }\r\n        // Close any open overlays (help, etc.)\r\n        document.querySelectorAll('.overlay').forEach(el => el.remove());\r\n      }).catch(err => {\r\n        if (window.showChangelogModal) window.showChangelogModal();\r\n        else console.error('Failed to load changelog modal:', err);\r\n        if (!document.getElementById('changelog-modal-css')) {\r\n          const link = document.createElement('link');\r\n          link.rel = 'stylesheet';\r\n          link.href = 'css/changelog_modal.css';\r\n          link.id = 'changelog-modal-css';\r\n          document.head.appendChild(link);\r\n        }\r\n        document.querySelectorAll('.overlay').forEach(el => el.remove());\r\n      });\r\n      close();\r\n    };\r\n    popup.style.textAlign = 'left';\r\n    Object.assign(popup.style, {\r\n      position: 'fixed',\r\n      bottom: '32px',\r\n      left: '0',\r\n      right: '0',\r\n      margin: '0 auto',\r\n      background: 'linear-gradient(90deg, #23272a 80%, #2d3136 100%)',\r\n      color: '#f3f3f3',\r\n      padding: '14px 28px 14px 22px',\r\n      borderRadius: '13px',\r\n      fontSize: '1em',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      boxShadow: '0 8px 32px #0005',\r\n      maxWidth: '480px',\r\n      minWidth: '220px',\r\n      zIndex: 20000,\r\n      animation: 'fadein-popup-banner-bottom 0.7s',\r\n      cursor: 'default',\r\n    });\r\n  // (removed duplicate close function)\r\n    popup.querySelector('button').onclick = close;\r\n    // Auto-dismiss after 8 seconds if not closed\r\n    setTimeout(() => { if (document.body.contains(popup)) close(); }, 8000);\r\n    document.body.appendChild(popup);\r\n    // Add fadein/fadeout keyframes if not present\r\n    if (!document.getElementById('info-popup-banner-anim-bottom')) {\r\n      const style = document.createElement('style');\r\n      style.id = 'info-popup-banner-anim-bottom';\r\n      style.textContent = `\r\n        @keyframes fadein-popup-banner-bottom { from { opacity:0; transform:translateY(48px);} to { opacity:1; transform:none; } }\r\n        @keyframes fadeout-popup-banner-bottom { from { opacity:1; } to { opacity:0; transform:translateY(48px);} }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n  }\r\n  // Ensure help overlay can always be opened\r\n  document.body.addEventListener('click', (e) => {\r\n    const btn = e.target.closest('[data-action=\"show-help\"]');\r\n    if (btn) {\r\n      import('../core/help.js').then(mod => mod.renderHelpOverlay());\r\n    }\r\n  });\r\n  const db = DB.getAll();\r\n  const me = state.user;\r\n\r\n  // Topbar\r\n  let userFilterId = window.filterPostsByUserId || null;\r\n  let filteredPosts = getFilteredPosts(DB, prefs);\r\n  if (userFilterId) filteredPosts = filteredPosts.filter(p => p.userId === userFilterId);\r\n  const postCount = (prefs.filterTag || prefs.search || userFilterId)\r\n    ? filteredPosts.length\r\n    : db.posts.length;\r\n\r\n  const top = document.createElement('div');\r\n  top.className = 'topbar';\r\n  top.innerHTML = `\r\n    <div class=\"toolbar topbar-toolbar\">\r\n      <div class=\"user-actions-container\">\r\n        ${me ? '<span class=\"notification-dot\" id=\"mobile-notification-dot\" style=\"position: static; cursor: pointer; display: inline-block; margin-left: 0px; margin-right: 0px; opacity: 0.35;\" title=\"No notifications\"></span>' : ''}\r\n        <div class=\"user-pill\" tabindex=\"0\" role=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\">\r\n          <span class=\"pill\" title=\"current user\">> user: ${me ? esc(me.name) : 'guest'}</span>\r\n        </div>\r\n        <div class=\"user-action-buttons\">\r\n          ${\r\n            me\r\n              ? `<button class=\"btn btn-ghost\" data-action=\"view-user\" data-uid=\"${esc(me.id)}\" style=\"position:relative;\">\r\n                  [ profile ]\r\n                </button><button class=\"btn btn-ghost\" data-action=\"logout\" title=\"logout\">[ logout ]</button>`\r\n              : `<button class=\"btn btn-ghost\" id=\"goLoginBtn\" title=\"login / register\" style=\"position:relative;\">\r\n                  [ login / register ]\r\n                </button>`\r\n          }\r\n          <button class=\"btn btn-ghost\" data-action=\"show-help\" title=\"keyboard shortcuts\">[ help ]</button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n  // Notification dot logic\r\n  // Notification dot logic (dynamically insert dot as child of user button)\r\n  const userBtn = top.querySelector('[data-action=\"view-user\"], #goLoginBtn');\r\n  // Notification dot removed from user button (already present in profile section)\r\n\r\n  // Slide-out user action buttons logic\r\n  const userActionsContainer = top.querySelector('.user-actions-container');\r\n  const userPill = top.querySelector('.user-pill');\r\n  const userActionButtons = top.querySelector('.user-action-buttons');\r\n  if (userPill && userActionButtons) {\r\n  // (Leaderboard and changelog buttons moved to help menu)\r\n    // On touch devices, open on first tap (touchstart)\r\n    if ('ontouchstart' in window) {\r\n      userPill.addEventListener('touchstart', (e) => {\r\n        if (!userActionsContainer.classList.contains('open')) {\r\n          userActionsContainer.classList.add('open');\r\n          userPill.setAttribute('aria-expanded', 'true');\r\n          e.preventDefault();\r\n        }\r\n      });\r\n      // Also allow closing on tap if already open\r\n      userPill.addEventListener('click', () => {\r\n        if (userActionsContainer.classList.contains('open')) {\r\n          userActionsContainer.classList.remove('open');\r\n          userPill.setAttribute('aria-expanded', 'false');\r\n        }\r\n      });\r\n    } else {\r\n      userPill.addEventListener('click', () => {\r\n        userActionsContainer.classList.toggle('open');\r\n        userPill.setAttribute('aria-expanded', userActionsContainer.classList.contains('open'));\r\n      });\r\n    }\r\n    userPill.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter' || e.key === ' ') {\r\n        e.preventDefault();\r\n        userActionsContainer.classList.toggle('open');\r\n        userPill.setAttribute('aria-expanded', userActionsContainer.classList.contains('open'));\r\n      }\r\n    });\r\n    // Enable hover open/close for desktop (non-touch) only\r\n    if (!('ontouchstart' in window)) {\r\n      userActionsContainer.addEventListener('mouseenter', () => {\r\n        userActionsContainer.classList.add('open');\r\n        userPill.setAttribute('aria-expanded', 'true');\r\n      });\r\n      userActionsContainer.addEventListener('mouseleave', () => {\r\n        userActionsContainer.classList.remove('open');\r\n        userPill.setAttribute('aria-expanded', 'false');\r\n      });\r\n    }\r\n    // Optional: close on outside click\r\n    document.addEventListener('click', (e) => {\r\n      if (!userActionsContainer.contains(e.target)) {\r\n        userActionsContainer.classList.remove('open');\r\n        userPill.setAttribute('aria-expanded', 'false');\r\n      }\r\n    });\r\n  }\r\n\r\n  // Dock\r\n  const prefsNow = loadPrefs();\r\n  const dock = document.createElement('div');\r\n  dock.className = 'dock';\r\n  dock.id = 'dock';\r\n  dock.style.display = 'none';\r\n  dock.style.borderBottom = 'none';\r\n  dock.innerHTML = `\r\n    <div class=\"hstack\" style=\"justify-content:center; align-items:center; flex-wrap:wrap; gap:18px;\">\r\n      <div class=\"hstack\" style=\"gap:18px;\">\r\n        <button class=\"btn\" data-action=\"q-prev\" title=\"previous in queue (k)\">[ prev ]</button>\r\n        <button class=\"btn\" data-action=\"q-stop\" title=\"stop\">[ stop ]</button>\r\n        <button class=\"btn\" data-action=\"q-next\" title=\"next in queue (j)\">[ next ]</button>\r\n        <button class=\"btn\" data-action=\"q-shuffle\" aria-pressed=\"${prefsNow.shuffle}\" title=\"shuffle\">[ shuffle ]</button>\r\n        <button class=\"btn btn-ghost\" data-action=\"q-clear\" title=\"clear queue\">[ clear ]</button>\r\n      </div>\r\n    </div>\r\n    <div class=\"small\" style=\"text-align:center; margin-top:6px;\">\r\n      <span id=\"nowPlaying\" class=\"muted\"></span> \u00B7 queue <span id=\"qPos\">0</span>/<span id=\"qLen\">0</span>\r\n    </div>\r\n  `;\r\n  dock.addEventListener('click', (e) => {\r\n    const stopBtn = e.target.closest('[data-action=\"q-stop\"]');\r\n    if (stopBtn) {\r\n      const activePlayer = document.querySelector('.player.active');\r\n      if (activePlayer) {\r\n        activePlayer.querySelectorAll('audio,video').forEach(el => {\r\n          el.pause && el.pause();\r\n          el.currentTime = 0;\r\n        });\r\n        activePlayer.querySelectorAll('iframe').forEach(ifr => (ifr.src = ''));\r\n        activePlayer.classList.remove('active');\r\n        const playingPost = document.querySelector('.post.is-playing');\r\n        if (playingPost) playingPost.classList.remove('is-playing');\r\n      }\r\n    }\r\n  });\r\n\r\n  // Left column: tags and feed\r\n  const playAllLabel = prefs.filterTag ? `play #${esc(prefs.filterTag)}` : 'play all';\r\n\r\n  const tagsBox = document.createElement('div');\r\n  tagsBox.className = 'box';\r\n  tagsBox.id = 'tagsBoxMain';\r\n  tagsBox.style.marginBottom = '16px';\r\n  tagsBox.innerHTML = `\r\n    <div class=\"hstack\" style=\"justify-content:space-between; align-items:center\">\r\n      <div class=\"muted small\">> tags</div>\r\n      ${prefs.filterTag ? `<button class=\"btn btn-ghost small\" data-action=\"clear-tag\">[ clear tag ]</button>` : ''}\r\n    </div>\r\n    <div id=\"tags\"></div>\r\n  `;\r\n\r\n  const feedBox = document.createElement('div');\r\n  feedBox.className = 'box';\r\n  feedBox.innerHTML = `\r\n    <div class=\"feed-search-bar\" style=\"margin-bottom:12px;\">\r\n      <input class=\"field\" id=\"search\" type=\"search\" placeholder=\"search title/artist/tags...\" value=\"${esc(prefs.search)}\" aria-label=\"search\"/>\r\n    </div>\r\n    <div class=\"hstack feed-header-bar\" style=\"justify-content:space-between; flex-wrap:wrap; align-items:center; margin-bottom:8px;\">\r\n      <div class=\"hstack\" style=\"gap:10px; align-items:center;\">\r\n        <span class=\"muted\">&gt; feed</span>\r\n        ${\r\n          userFilterId\r\n            ? `<span class=\"pill\">user filter: <a href=\"#\" data-action=\"clear-user-filter\">${esc(\r\n                db.users.find(u => u.id === userFilterId)?.name || 'user'\r\n              )}</a> <a href=\"#\" data-action=\"clear-user-filter\" title=\"clear user filter\">\u2715</a></span>`\r\n            : ''\r\n        }\r\n        ${prefs.filterTag ? `<span class=\"pill\">tag: #${esc(prefs.filterTag)} <a href=\"#\" data-action=\"clear-tag\" title=\"clear tag\">\u2715</a></span>` : ''}\r\n  <span title=\"total posts\">posts: ${postCount}</span>\r\n      </div>\r\n      <div class=\"hstack\" style=\"gap:12px; align-items:center;\">\r\n        <button class=\"btn btn-ghost\" data-action=\"play-all\">[ ${playAllLabel} ]</button>\r\n        <div class=\"sort-icons\" id=\"sort-icons\" aria-label=\"sort order\">\r\n          <button class=\"sort-btn${prefs.sort === 'new' ? ' active' : ''}\" data-sort=\"new\" title=\"Sort by newest\"><span class=\"icon-sort-newest\"></span></button>\r\n          <button class=\"sort-btn${prefs.sort === 'likes' ? ' active' : ''}\" data-sort=\"likes\" title=\"Sort by most liked\"><span class=\"icon-sort-likes\"></span></button>\r\n          <button class=\"sort-btn${prefs.sort === 'comments' ? ' active' : ''}\" data-sort=\"comments\" title=\"Sort by most commented\"><span class=\"icon-sort-comments\"></span></button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div id=\"feed\"></div>\r\n    <div id=\"pager\" class=\"hstack\" style=\"justify-content:center; margin-top:8px\"></div>\r\n  `;\r\n\r\n  left.appendChild(top);\r\n  left.appendChild(tagsBox);\r\n  left.appendChild(dock);\r\n  left.appendChild(feedBox);\r\n\r\n  // Always reload prefs and re-render feed/tags for correct tag highlight (mobile/desktop)\r\n  function doRender() {\r\n    // Save tag cloud scroll position before rerender\r\n    const tagCloud = document.querySelector('.tag-cloud');\r\n    if (tagCloud) {\r\n      window._tagCloudScrollLeft = tagCloud.scrollLeft;\r\n    }\r\n    const latestPrefs = loadPrefs();\r\n    state.page = 1;\r\n    renderFeed($('#feed'), $('#pager'), state, DB, latestPrefs);\r\n    renderTags($('#tags'), DB, latestPrefs);\r\n    enableTagCloudDragScroll();\r\n  }\r\n  // Global user filter event (once)\r\n  if (!window._userFilterHandlerAttached) {\r\n    window.addEventListener('filter-user-posts', (e) => {\r\n      window.filterPostsByUserId = e.detail.userId;\r\n      doRender();\r\n    });\r\n    window._userFilterHandlerAttached = true;\r\n  }\r\n\r\n  // Clear user filter (now in feed header bar)\r\n  feedBox.addEventListener('click', (e) => {\r\n    if (e.target && e.target.dataset && e.target.dataset.action === 'clear-user-filter') {\r\n      window.filterPostsByUserId = null;\r\n      doRender();\r\n      e.preventDefault();\r\n    }\r\n  });\r\n\r\n  // Initial feed + tags render\r\n  doRender();\r\n\r\n  // Search (now in feedBox)\r\n  const searchInput = feedBox.querySelector('#search');\r\n  if (searchInput) {\r\n    searchInput.addEventListener('input', debounce((e) => {\r\n      savePrefs({ search: e.target.value });\r\n      state.page = 1;\r\n      renderFeed($('#feed'), $('#pager'), state, DB, loadPrefs());\r\n    }, 120));\r\n  }\r\n\r\n  // Sort icons\r\n  const sortIcons = feedBox.querySelector('#sort-icons');\r\n  if (sortIcons) {\r\n    sortIcons.addEventListener('click', (e) => {\r\n      const btn = e.target.closest('.sort-btn');\r\n      if (btn) {\r\n        const sortType = btn.getAttribute('data-sort');\r\n        savePrefs({ sort: sortType });\r\n        state.page = 1;\r\n        renderFeed($('#feed'), $('#pager'), state, DB, loadPrefs());\r\n      }\r\n    });\r\n  }\r\n\r\n  return { top, dock, tagsBox, feedBox };\r\n}\r\n", "// --- MOBILE NOTIFICATION DOT (just below header, above user menu) ---\r\n  if (/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {\r\n    // Remove the dot for guests immediately to prevent any rendering\r\n    try {\r\n      let isGuest = true;\r\n      if (window.state && window.state.user) isGuest = false;\r\n      if (isGuest) {\r\n        const dot = document.getElementById('mobile-notification-dot');\r\n        if (dot && dot.parentNode) dot.parentNode.removeChild(dot);\r\n      }\r\n    } catch(e) {}\r\n    // Only add logic if dot exists in DOM\r\n    function setupMobileDotLogic() {\r\n      const mobileDot = document.getElementById('mobile-notification-dot');\r\n      if (!mobileDot) {\r\n        setTimeout(setupMobileDotLogic, 100); // Wait for dot to exist\r\n        return;\r\n      }\r\n      // Import state to check user\r\n      import('../core/app_state.js').then(({ state }) => {\r\n        if (!state.user) {\r\n          // Hide the dot for guests\r\n          mobileDot.style.display = 'none';\r\n          return;\r\n        }\r\n        // Make dot accessible and focusable\r\n        mobileDot.setAttribute('tabindex', '0');\r\n        mobileDot.setAttribute('role', 'button');\r\n        mobileDot.setAttribute('aria-label', 'Show notifications');\r\n        // Notification logic (subscribe, update, popup)\r\n        let allNotifications = [];\r\n        import('../core/notifications.js').then(({ default: notifications }) => {\r\n          function updateDot(list) {\r\n            mobileDot.style.display = 'inline-block';\r\n            if (list.length) {\r\n              mobileDot.style.opacity = '1';\r\n              mobileDot.title = 'Show notifications';\r\n            } else {\r\n              mobileDot.style.opacity = '0.35';\r\n              mobileDot.title = 'No notifications';\r\n            }\r\n            for (const n of list) {\r\n              if (!allNotifications.some(x => x.id === n.id)) allNotifications.push(n);\r\n            }\r\n          }\r\n          notifications.subscribe(updateDot);\r\n          updateDot(notifications.list);\r\n\r\n          // Notification popup panel (copied from profile dot logic)\r\n          let popup = null;\r\n          function closePopup() {\r\n            if (popup) {\r\n              popup.remove();\r\n              popup = null;\r\n            }\r\n          }\r\n          function handleDotActivate(e) {\r\n            if (e) {\r\n              if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== ' ') return;\r\n              e.stopPropagation();\r\n              e.preventDefault();\r\n            }\r\n            console.log('[notif-dot] handleDotActivate', e ? e.type : 'no event');\r\n            if (popup) {\r\n              closePopup();\r\n              return;\r\n            }\r\n            // Always show the popup, even if no notifications\r\n            popup = document.createElement('div');\r\n            popup.className = 'notification-popup-panel';\r\n            // Copy styles from profile dot popup\r\n            popup.style.position = 'fixed';\r\n            const rect = mobileDot.getBoundingClientRect();\r\n            popup.style.top = (rect.bottom + 6) + 'px';\r\n            popup.style.left = (rect.left - 12) + 'px';\r\n            popup.style.zIndex = '10000';\r\n            popup.style.background = '#232b36';\r\n            popup.style.color = '#fff';\r\n            popup.style.border = '1.5px solid #333a';\r\n            popup.style.borderRadius = '10px';\r\n            popup.style.boxShadow = '0 8px 32px #0008, 0 1.5px 0 #fff1 inset';\r\n            popup.style.padding = '14px 18px 10px 18px';\r\n            popup.style.minWidth = '220px';\r\n            popup.style.maxWidth = '320px';\r\n            popup.style.fontSize = '1em';\r\n            popup.style.display = 'flex';\r\n            popup.style.flexDirection = 'column';\r\n            popup.style.gap = '10px';\r\n            // ...existing code...\r\n            // Render notifications list\r\n            popup.innerHTML = `\r\n              <div style=\"font-weight:600;font-size:1.08em;margin-bottom:2px;letter-spacing:0.01em;\">Notifications</div>\r\n              <div class=\"notification-list\" style=\"max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;\">\r\n                ${allNotifications.length ? allNotifications.map(n => {\r\n                  let time = typeof n.id === 'number' ? (typeof fmtTime === 'function' ? fmtTime(n.id) : '') : '';\r\n                  if (time === 'just') time = 'just now';\r\n                  return `<div style=\\\"background:${n.type==='error'?'#f44336':'#263245'};padding:8px 12px;border-radius:6px;box-shadow:0 1px 4px #0002;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;gap:12px;\\\">\r\n                    <span>${n.message}</span>\r\n                    <span style=\\\"font-size:0.92em;opacity:0.7;white-space:nowrap;\\\">${time}</span>\r\n                  </div>`;\r\n                }).join('') : '<span class=\\\"muted small\\\">No notifications yet.</span>'}\r\n              </div>\r\n              <button class=\"btn btn-ghost small\" style=\"align-self:flex-end;margin-top:4px;\" id=\"closeNotifPopupBtn\">close</button>\r\n            `;\r\n            document.body.appendChild(popup);\r\n            // Close on button\r\n            popup.querySelector('#closeNotifPopupBtn').onclick = closePopup;\r\n            // Close on outside click (delay to avoid immediate close on touch)\r\n            setTimeout(() => {\r\n              document.addEventListener('mousedown', outsideClick, { once: true });\r\n              document.addEventListener('touchstart', outsideClick, { once: true });\r\n            }, 200);\r\n            function outsideClick(ev) {\r\n              if (popup && !popup.contains(ev.target) && ev.target !== mobileDot) closePopup();\r\n            }\r\n          }\r\n          mobileDot.addEventListener('click', handleDotActivate);\r\n          mobileDot.addEventListener('touchstart', handleDotActivate);\r\n          mobileDot.addEventListener('keydown', handleDotActivate);\r\n        });\r\n      });\r\n    }\r\n    setupMobileDotLogic();\r\n  }\r\n// js/views/main_view_profile.js\r\nimport { esc, fmtTime } from '../core/utils.js';\r\n\r\nexport function renderProfileBox(right, state, DB, render) {\r\n  // Show login/register message for guests\r\n  if (!state.user) {\r\n    right.innerHTML = `<div class=\"box\" style=\"text-align:center;padding:2.5em 1em;font-size:1.1em;line-height:1.6;\">\r\n      <div class=\"muted small\">&gt; profile</div>\r\n      <div style=\"margin:1.5em 0 0.5em 0;\">You need to <b>log in</b> or <b>register</b> to view your profile.</div>\r\n    <button class=\"btn\" data-action=\"go-login\" style=\"margin-top:1.2em;\">[ login / register ]</button>\r\n    </div>`;\r\n    return;\r\n  }\r\n  // Extract username from URL or return as-is if already a username\r\n  function getSocialUsername(val, type) {\r\n    if (!val) return '';\r\n    let v = val.trim();\r\n    if (!v) return '';\r\n    if (type === 'youtube') {\r\n      // If it's a full YouTube video or shorts URL, return as-is\r\n      if (/^https?:\\/\\/(www\\.)?youtube\\.com\\/(watch\\?v=|shorts\\/)[^\\s]+/i.test(v)) {\r\n        return v;\r\n      }\r\n      // Remove protocol and www for username/handle extraction\r\n      v = v.replace(/^https?:\\/\\//i, '').replace(/^www\\./i, '');\r\n      v = v.replace(/^youtube\\.com\\//i, '');\r\n      v = v.replace(/^@/, '').replace(/\\/$/, '');\r\n      return v ? '@' + v : '';\r\n    }\r\n    // Remove protocol\r\n    v = v.replace(/^https?:\\/\\//i, '');\r\n    switch (type) {\r\n      case 'facebook':\r\n        v = v.replace(/^(www\\.)?facebook\\.com\\//i, '');\r\n        break;\r\n      case 'instagram':\r\n        v = v.replace(/^(www\\.)?instagram\\.com\\//i, '');\r\n        break;\r\n      case 'twitter':\r\n        v = v.replace(/^(www\\.)?twitter\\.com\\//i, '');\r\n        break;\r\n      case 'bandcamp':\r\n        v = v.replace(/^(www\\.)?([^\\.]+)\\.bandcamp\\.com.*/i, '$2');\r\n        break;\r\n      case 'soundcloud':\r\n        v = v.replace(/^(www\\.)?soundcloud\\.com\\//i, '');\r\n        break;\r\n      case 'lastfm':\r\n        // Extract username from last.fm/user/ or just use as-is\r\n        let match = v.match(/last\\.fm\\/user\\/([^\\/]+)/i);\r\n        if (match) {\r\n          v = match[1];\r\n        } else {\r\n          // Remove www. and leading @ if present\r\n          v = v.replace(/^www\\./, '').replace(/^@/, '');\r\n        }\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n    // Remove trailing slashes and @, then add @ for display\r\n    v = v.replace(/^@/, '').replace(/\\/$/, '');\r\n    return v ? '@' + v : '';\r\n  }\r\n  const db = DB.getAll();\r\n  const me = state.user;\r\n  if (!me) return;\r\n\r\n  const meUser = db.users.find(u => u.id === me.id) || null;\r\n  const myAbout = meUser?.about || '';\r\n  const myAvatar = meUser?.avatarUrl || '/assets/android-chrome-512x512.png';\r\n  const socials = {\r\n    facebook: meUser?.facebook || '',\r\n    instagram: meUser?.instagram || '',\r\n    twitter: meUser?.twitter || '',\r\n    bandcamp: meUser?.bandcamp || '',\r\n    soundcloud: meUser?.soundcloud || '',\r\n    youtube: meUser?.youtube || '',\r\n    lastfm: meUser?.lastfm || ''\r\n  };\r\n\r\n  function renderSocialLinks(s) {\r\n    const icons = { facebook: '\uD83C\uDF10', instagram: '\uD83D\uDCF8', twitter: '\uD83D\uDC26', bandcamp: '\uD83C\uDFB5', soundcloud: '\u2601\uFE0F', youtube: '\u25B6\uFE0F', lastfm: '\uD83C\uDFB6' };\r\n    // Use formatSocial for all links to ensure proper URLs\r\n    function formatSocial(val, type) {\r\n      const input = (val || '').trim();\r\n      if (!input) return '';\r\n      if (/^https?:\\/\\//i.test(input)) return input;\r\n      switch (type) {\r\n        case 'facebook':\r\n          return 'https://facebook.com/' + input.replace(/^@/, '');\r\n        case 'instagram':\r\n          return 'https://instagram.com/' + input.replace(/^@/, '');\r\n        case 'twitter':\r\n          return 'https://twitter.com/' + input.replace(/^@/, '');\r\n        case 'bandcamp':\r\n          return 'https://' + input.replace(/^https?:\\/\\//, '').replace(/\\/$/, '') + '.bandcamp.com/';\r\n        case 'soundcloud':\r\n          return 'https://soundcloud.com/' + input.replace(/^@/, '');\r\n        case 'youtube':\r\n          if (/^[\\w-]{11}$/.test(input)) {\r\n            return 'https://www.youtube.com/watch?v=' + input;\r\n          }\r\n          if (/^@/.test(input)) {\r\n            return 'https://www.youtube.com/' + input;\r\n          }\r\n          return 'https://www.youtube.com/c/' + input.replace(/^@/, '');\r\n        case 'lastfm':\r\n          let cleaned = input.replace(/^@/, '');\r\n          const lastfmMatch = cleaned.match(/last\\.fm\\/user\\/([^\\/]+)/i);\r\n          if (lastfmMatch) {\r\n            return 'https://www.last.fm/user/' + lastfmMatch[1];\r\n          }\r\n          cleaned = cleaned.replace(/^www\\./, '');\r\n          return 'https://www.last.fm/user/' + cleaned;\r\n        default:\r\n          return input;\r\n      }\r\n    }\r\n    return Object.entries(s)\r\n      .filter(([_, v]) => v)\r\n      .map(([k, v]) => {\r\n        const url = formatSocial(v, k);\r\n        return `<a href=\"${esc(url)}\" target=\"_blank\" rel=\"noopener\" class=\"social-link\" title=\"${k}\">${icons[k]}</a>`;\r\n      })\r\n      .join(' ');\r\n  }\r\n\r\n  const box = document.createElement('div');\r\n  box.className = 'box';\r\n  box.id = 'aboutBox';\r\n  box.innerHTML = `\r\n    <div class=\"muted small\">&gt; my profile</div>\r\n    <div style=\"display:flex; flex-direction:column; align-items:center; margin-bottom:8px;\">\r\n      <img class=\"profile-avatar-small\" src=\"${esc(myAvatar)}\" alt=\"avatar\" />\r\n    </div>\r\n    <div id=\"aboutCollapsed\" style=\"display:flex; flex-direction:column; gap:8px; min-height:38px;\">\r\n      <div id=\"aboutText\" class=\"about-preview\">${\r\n        myAbout ? esc(myAbout).replace(/\\n/g, '<br>') : '<span class=\"muted small\">no about yet.</span>'\r\n      }</div>\r\n      <div id=\"aboutSocials\">${renderSocialLinks(socials) || '<span class=\"muted small\">no social links</span>'}</div>\r\n      <button class=\"btn btn-ghost small\" id=\"editAboutBtn\" type=\"button\">[ edit ]</button>\r\n    </div>\r\n    <form class=\"stack\" id=\"aboutEditForm\" data-action=\"profile-form\" autocomplete=\"off\" style=\"display:none; margin-top:8px;\" enctype=\"multipart/form-data\">\r\n  <label class=\"muted small\" style=\"margin-bottom:4px;\" for=\"avatarFile\">Change avatar:</label>\r\n      <div class=\"custom-file-input-wrapper\" style=\"margin-bottom:8px;\">\r\n        <input class=\"custom-file-input\" type=\"file\" id=\"avatarFile\" name=\"avatar\" accept=\"image/*\" />\r\n        <label for=\"avatarFile\" class=\"btn btn-ghost small\" id=\"avatarFileLabel\">[ upload new avatar ]</label>\r\n        <span class=\"muted small\" id=\"avatarFileName\" style=\"margin-left:8px;\"></span>\r\n      </div>\r\n      <textarea class=\"field\" id=\"aboutMe\" name=\"about\" rows=\"3\" maxlength=\"500\" placeholder=\"Write a short bio...\">${esc(myAbout)}</textarea>\r\n      <fieldset class=\"social-links-group\" style=\"border:1px dashed var(--line); border-radius:8px; padding:12px; margin:12px 0;\">\r\n        <legend class=\"muted small\" style=\"padding:0 8px;\">Social Links</legend>\r\n        <div class=\"social-fields\" style=\"display:grid; grid-template-columns:1fr; gap:8px;\">\r\n          <label for=\"socialFb\"><span class=\"sr-only\">Facebook</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialFb\" name=\"fb_user\" placeholder=\"Facebook username or URL\" value=\"${esc(getSocialUsername(socials.facebook, 'facebook'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialInsta\"><span class=\"sr-only\">Instagram</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialInsta\" name=\"insta_user\" placeholder=\"Instagram username or URL\" value=\"${esc(getSocialUsername(socials.instagram, 'instagram'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialTwtr\"><span class=\"sr-only\">Twitter</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialTwtr\" name=\"twtr_user\" placeholder=\"Twitter username or URL\" value=\"${esc(getSocialUsername(socials.twitter, 'twitter'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialBandcamp\"><span class=\"sr-only\">Bandcamp</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialBandcamp\" name=\"bc_user\" placeholder=\"Bandcamp username or URL\" value=\"${esc(getSocialUsername(socials.bandcamp, 'bandcamp'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialSoundcloud\"><span class=\"sr-only\">SoundCloud</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialSoundcloud\" name=\"sc_user\" placeholder=\"SoundCloud username or URL\" value=\"${esc(getSocialUsername(socials.soundcloud, 'soundcloud'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialYoutube\"><span class=\"sr-only\">YouTube</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialYoutube\" name=\"yt_user\" placeholder=\"YouTube username or URL\" value=\"${esc(getSocialUsername(socials.youtube, 'youtube'))}\" autocomplete=\"username\" />\r\n          <label for=\"socialLastfm\"><span class=\"sr-only\">Last.fm</span></label>\r\n          <input class=\"field\" type=\"text\" id=\"socialLastfm\" name=\"lastfm_user\" placeholder=\"Last.fm username or URL\" value=\"${esc(getSocialUsername(socials.lastfm, 'lastfm'))}\" autocomplete=\"username\" />\r\n        </div>\r\n        <div class=\"muted small\" style=\"margin-top:8px;\">You can enter just your username or a full URL for each social field.</div>\r\n      </fieldset>\r\n      <div class=\"hstack\">\r\n        <button class=\"btn\" type=\"submit\">[ save about ]</button>\r\n        <button class=\"btn btn-ghost small\" id=\"cancelAboutBtn\" type=\"button\">[ cancel ]</button>\r\n        <span class=\"muted small\" id=\"profileMsg\"></span>\r\n      </div>\r\n    </form>\r\n  `;\r\n\r\n  // Custom file input JS: show file name, hide default text\r\n  const avatarFileInput = box.querySelector('#avatarFile');\r\n  const avatarFileName = box.querySelector('#avatarFileName');\r\n  if (avatarFileInput && avatarFileName) {\r\n    avatarFileInput.addEventListener('change', function() {\r\n      avatarFileName.textContent = this.files && this.files.length > 0 ? this.files[0].name : '';\r\n    });\r\n  }\r\n  // Insert notification dot into profile panel\r\n  const profileTitle = box.querySelector('.muted.small');\r\n  if (profileTitle) {\r\n    const dot = document.createElement('span');\r\n    dot.className = 'notification-dot';\r\n    dot.style.display = 'none';\r\n    dot.style.position = 'static';\r\n    dot.style.marginLeft = '8px';\r\n    dot.style.verticalAlign = 'middle';\r\n    dot.style.background = '#f44336';\r\n    dot.style.border = '2px solid #222e3a';\r\n    dot.style.boxShadow = '0 0 2px #0008';\r\n    profileTitle.appendChild(dot);\r\n    // Subscribe to notifications\r\n    // Store all notifications ever received\r\n    let allNotifications = [];\r\n    import('../core/notifications.js').then(({ default: notifications }) => {\r\n      function updateDot(list) {\r\n        dot.style.display = 'inline-block';\r\n        if (list.length) {\r\n          dot.style.opacity = '1';\r\n          dot.title = 'Show notifications';\r\n        } else {\r\n          dot.style.opacity = '0.35';\r\n          dot.title = 'No notifications';\r\n        }\r\n        // Add new notifications to allNotifications\r\n        for (const n of list) {\r\n          if (!allNotifications.some(x => x.id === n.id)) allNotifications.push(n);\r\n        }\r\n      }\r\n      notifications.subscribe(updateDot);\r\n      updateDot(notifications.list);\r\n      dot.style.cursor = 'pointer';\r\n\r\n      // Notification popup panel\r\n      let popup = null;\r\n      function closePopup() {\r\n        if (popup) {\r\n          popup.remove();\r\n          popup = null;\r\n        }\r\n      }\r\n      dot.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        if (popup) {\r\n          closePopup();\r\n          return;\r\n        }\r\n        // Always show the popup, even if no notifications\r\n        popup = document.createElement('div');\r\n        popup.className = 'notification-popup-panel';\r\n        popup.style.position = 'absolute';\r\n        popup.style.top = '28px';\r\n        popup.style.left = '0';\r\n        popup.style.zIndex = '10000';\r\n        popup.style.background = '#232b36';\r\n        popup.style.color = '#fff';\r\n        popup.style.border = '1.5px solid #333a';\r\n        popup.style.borderRadius = '10px';\r\n        popup.style.boxShadow = '0 8px 32px #0008, 0 1.5px 0 #fff1 inset';\r\n        popup.style.padding = '14px 18px 10px 18px';\r\n        popup.style.minWidth = '220px';\r\n        popup.style.maxWidth = '320px';\r\n        popup.style.fontSize = '1em';\r\n        popup.style.display = 'flex';\r\n        popup.style.flexDirection = 'column';\r\n        popup.style.gap = '10px';\r\n        popup.innerHTML = `\r\n          <div style=\\\"font-weight:600;font-size:1.08em;margin-bottom:2px;letter-spacing:0.01em;\\\">Notifications</div>\r\n          <div class=\\\"notification-list\\\" style=\\\"max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;\\\">\r\n            ${allNotifications.length ? allNotifications.map(n => {\r\n              let time = typeof n.id === 'number' ? fmtTime(n.id) : '';\r\n              if (time === 'just') time = 'just now';\r\n              return `<div style=\\\"background:${n.type==='error'?'#f44336':'#263245'};padding:8px 12px;border-radius:6px;box-shadow:0 1px 4px #0002;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;gap:12px;\\\">\r\n                <span>${n.message}</span>\r\n                <span style=\\\"font-size:0.92em;opacity:0.7;white-space:nowrap;\\\">${time}</span>\r\n              </div>`;\r\n            }).join('') : '<span class=\\\"muted small\\\">No notifications yet.</span>'}\r\n          </div>\r\n          <button class=\\\"btn btn-ghost small\\\" style=\\\"align-self:flex-end;margin-top:4px;\\\" id=\\\"closeNotifPopupBtn\\\">close</button>\r\n        `;\r\n        // Position popup relative to dot\r\n        const rect = dot.getBoundingClientRect();\r\n        popup.style.position = 'fixed';\r\n        popup.style.top = (rect.bottom + 6) + 'px';\r\n        popup.style.left = (rect.left - 12) + 'px';\r\n        document.body.appendChild(popup);\r\n        // Close on button\r\n        popup.querySelector('#closeNotifPopupBtn').onclick = closePopup;\r\n        // Close on outside click\r\n        setTimeout(() => {\r\n          document.addEventListener('mousedown', outsideClick, { once: true });\r\n        }, 0);\r\n        function outsideClick(ev) {\r\n          if (popup && !popup.contains(ev.target) && ev.target !== dot) closePopup();\r\n        }\r\n      });\r\n    });\r\n  }\r\n  right.appendChild(box);\r\n\r\n  const aboutCollapsed = box.querySelector('#aboutCollapsed');\r\n  const aboutEditForm = box.querySelector('#aboutEditForm');\r\n  const editBtn = box.querySelector('#editAboutBtn');\r\n  const cancelBtn = box.querySelector('#cancelAboutBtn');\r\n\r\n  // Animate out the collapsed section, then show the edit form\r\n  editBtn.addEventListener('click', () => {\r\n    aboutCollapsed.classList.add('fade-out');\r\n    aboutCollapsed.classList.remove('fade-in');\r\n    setTimeout(() => {\r\n      aboutCollapsed.style.display = 'none';\r\n      aboutEditForm.style.display = '';\r\n      // Prevent auto-focus on mobile devices (avoid keyboard pop-up)\r\n      if (!/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {\r\n        aboutEditForm.querySelector('#aboutMe').focus();\r\n      }\r\n    }, 180); // match CSS duration\r\n  });\r\n  // Animate in the collapsed section when canceling\r\n  cancelBtn.addEventListener('click', () => {\r\n    aboutEditForm.style.display = 'none';\r\n    aboutCollapsed.style.display = 'flex';\r\n    aboutCollapsed.classList.remove('fade-out');\r\n    aboutCollapsed.classList.add('fade-in');\r\n  });\r\n\r\n  function formatSocial(val, type) {\r\n    const input = (val || '').trim();\r\n    if (!input) return '';\r\n    // If input is a full URL, return as-is\r\n    if (/^https?:\\/\\//i.test(input)) return input;\r\n    switch (type) {\r\n      case 'facebook':\r\n        return 'https://facebook.com/' + input.replace(/^@/, '');\r\n      case 'instagram':\r\n        return 'https://instagram.com/' + input.replace(/^@/, '');\r\n      case 'twitter':\r\n        return 'https://twitter.com/' + input.replace(/^@/, '');\r\n      case 'bandcamp':\r\n        return 'https://' + input.replace(/^https?:\\/\\//, '').replace(/\\/$/, '') + '.bandcamp.com/';\r\n      case 'soundcloud':\r\n        return 'https://soundcloud.com/' + input.replace(/^@/, '');\r\n      case 'youtube':\r\n        // If input looks like a YouTube video ID, build a watch URL\r\n        if (/^[\\w-]{11}$/.test(input)) {\r\n          return 'https://www.youtube.com/watch?v=' + input;\r\n        }\r\n        // If input looks like a handle (starts with @), build a channel URL\r\n        if (/^@/.test(input)) {\r\n          return 'https://www.youtube.com/' + input;\r\n        }\r\n        // Otherwise, assume it's a username or channel name\r\n        return 'https://www.youtube.com/c/' + input.replace(/^@/, '');\r\n      case 'lastfm':\r\n        // Remove leading @ if present\r\n        let cleaned = input.replace(/^@/, '');\r\n        // If input contains last.fm/user/, extract the username\r\n        const lastfmMatch = cleaned.match(/last\\.fm\\/user\\/([^\\/]+)/i);\r\n        if (lastfmMatch) {\r\n          return 'https://www.last.fm/user/' + lastfmMatch[1];\r\n        }\r\n        // If input starts with www., remove it\r\n        cleaned = cleaned.replace(/^www\\./, '');\r\n        return 'https://www.last.fm/user/' + cleaned;\r\n      default:\r\n        return input;\r\n    }\r\n  }\r\n\r\n  aboutEditForm.addEventListener('submit', async (e) => {\r\n    e.preventDefault();\r\n    const form = aboutEditForm;\r\n\r\n  const about = form.querySelector('#aboutMe').value;\r\n  const facebook = formatSocial(form.querySelector('#socialFb').value, 'facebook');\r\n  const instagram = formatSocial(form.querySelector('#socialInsta').value, 'instagram');\r\n  const twitter = formatSocial(form.querySelector('#socialTwtr').value, 'twitter');\r\n  const bandcamp = formatSocial(form.querySelector('#socialBandcamp').value, 'bandcamp');\r\n  const soundcloud = formatSocial(form.querySelector('#socialSoundcloud').value, 'soundcloud');\r\n  const youtube = formatSocial(form.querySelector('#socialYoutube').value, 'youtube');\r\n  const lastfm = formatSocial(form.querySelector('#socialLastfm').value, 'lastfm');\r\n\r\n  await DB.updateUser(me.id, { about, facebook, instagram, twitter, bandcamp, soundcloud, youtube, lastfm });\r\n    setTimeout(() => {\r\n      aboutEditForm.style.display = 'none';\r\n      aboutCollapsed.style.display = 'flex';\r\n      aboutCollapsed.classList.remove('fade-out');\r\n      aboutCollapsed.classList.add('fade-in');\r\n      if (typeof render === 'function') render();\r\n    }, 100);\r\n  });\r\n}", "\r\n// Shared string constants\r\nexport const PROMPT_STUCK = '> so what song has been stuck in your head lately?';\r\nexport const PROMPT_SHARE = '> share a track that made your day better!';\r\nexport const PROMPT_LOOPING = '> what have you been looping non-stop?';\r\nexport const PROMPT_HIDDEN_GEM = '> found a hidden gem? drop it here!';\r\nexport const PROMPT_TUNE = '> what tune do you want everyone to hear right now?';\r\nexport const PROMPT_MOOD = '> got a song that matches your mood? share it!';\r\nexport const PROMPT_MEMORY = '> post a track that brings back memories.';\r\nexport const PROMPT_DISCOVER = '> help us discover something new today!';\r\nexport const PROMPT_VIBE = '> what track sets the vibe for you right now?';\r\nexport const PROMPT_REPEAT = '> which song do you keep coming back to?';\r\nexport const PROMPT_SOUNDTRACK = '> what would be the soundtrack to your day?';\r\nexport const PROMPT_FIRST = '> what was the first song you loved?';\r\nexport const PROMPT_LAST = '> what was the last song you added to your playlist?';\r\nexport const PROMPT_MORNING = '> what song gets you going in the morning?';\r\nexport const PROMPT_NIGHT = '> what do you listen to late at night?';\r\nexport const PROMPT_FAVORITE_LYRICS = '> share a song with your favorite lyrics!';\r\nexport const PROMPT_UNDERRATED = '> what\u2019s the most underrated track you know?';\r\nexport const PROMPT_DANCE = '> which song makes you want to dance?';\r\nexport const PROMPT_CHILL = '> what\u2019s your go-to chillout song?';\r\nexport const PROMPT_INSPIRE = '> which song inspires you the most?';\r\nexport const PROMPT_TRAVEL = '> what\u2019s your favorite song for traveling?';\r\nexport const PROMPT_FRIEND = '> what song would you recommend to a friend?';\r\nexport const PROMPTS = [\r\n\tPROMPT_STUCK,\r\n\tPROMPT_SHARE,\r\n\tPROMPT_LOOPING,\r\n\tPROMPT_HIDDEN_GEM,\r\n\tPROMPT_TUNE,\r\n\tPROMPT_MOOD,\r\n\tPROMPT_MEMORY,\r\n\tPROMPT_DISCOVER,\r\n\tPROMPT_VIBE,\r\n\tPROMPT_REPEAT,\r\n\tPROMPT_SOUNDTRACK,\r\n\tPROMPT_FIRST,\r\n\tPROMPT_LAST,\r\n\tPROMPT_MORNING,\r\n\tPROMPT_NIGHT\r\n\t,PROMPT_FAVORITE_LYRICS\r\n\t,PROMPT_UNDERRATED\r\n\t,PROMPT_DANCE\r\n\t,PROMPT_CHILL\r\n\t,PROMPT_INSPIRE\r\n\t,PROMPT_TRAVEL\r\n\t,PROMPT_FRIEND\r\n];\r\n", "// js/views/main_view_compose.js\r\nimport { PROMPTS } from '../core/constants.js';\r\nimport { $, esc } from '../core/utils.js';\r\nimport { onCreatePost } from '../features/posts.js';\r\nimport { parseProvider } from '../features/providers.js';\r\n\r\nfunction getComposePrompt() {\r\n  return PROMPTS[Math.floor(Math.random() * PROMPTS.length)];\r\n}\r\n\r\nexport function renderComposeBox(right, state, DB, render) {\r\n  const me = state.user;\r\n\r\n  if (!me) {\r\n    const guest = document.createElement('div');\r\n    guest.className = 'box';\r\n    guest.innerHTML = `\r\n      <div class=\"muted small\" id=\"composePromptGuest\"></div>\r\n      <div class=\"notice small\">You are in guest read-only mode. Login to post, like, or comment.</div>\r\n      <button class=\"btn btn-ghost\" data-action=\"go-login\">[ login / register ]</button>\r\n    `;\r\n    right.appendChild(guest);\r\n    // Looping prompt for guest\r\n    const promptDiv = guest.querySelector('#composePromptGuest');\r\n    let lastPrompt = '';\r\n    function setPrompt() {\r\n      let prompt;\r\n      do { prompt = getComposePrompt(); } while (prompt === lastPrompt && PROMPTS.length > 1);\r\n      lastPrompt = prompt;\r\n      // Typewriter effect\r\n      let i = 0;\r\n      promptDiv.textContent = '';\r\n      promptDiv.classList.remove('fadein', 'fadeout');\r\n      function typeWriter() {\r\n        if (i < prompt.length) {\r\n          promptDiv.textContent += prompt.charAt(i);\r\n          i++;\r\n          // Simulate human typing: random delay, longer on spaces/punctuation\r\n          let delay = 28 + Math.random() * 40;\r\n          if (/[.,!?]/.test(prompt.charAt(i-1))) delay += 80 + Math.random() * 60;\r\n          if (prompt.charAt(i-1) === ' ') delay += 30;\r\n          setTimeout(typeWriter, delay);\r\n        }\r\n      }\r\n      typeWriter();\r\n    }\r\n    setPrompt();\r\n    setInterval(setPrompt, 10000);\r\n    return;\r\n  }\r\n\r\n  const box = document.createElement('div');\r\n  box.className = 'box';\r\n  box.innerHTML = `\r\n    <div class=\"muted small typewriter\" id=\"composePrompt\" style=\"margin-bottom:18px;\"></div>\r\n    <form id=\"postForm\" class=\"stack\" autocomplete=\"off\">\r\n      <input class=\"field\" id=\"f_url\" placeholder=\"Link (YouTube / Spotify / Bandcamp, etc)\" required/>\r\n  <div class=\"muted small\" id=\"autofillMsg\" style=\"margin-bottom:2px; display:none;\">&#8593; Should autofill artist information if we're lucky.</div>\r\n      <input class=\"field\" id=\"f_artist\" placeholder=\"Artist\" maxlength=\"120\" style=\"margin-top:8px;\" />\r\n      <input class=\"field\" id=\"f_title\" placeholder=\"Title (song or album)\" required maxlength=\"120\" />\r\n      <input class=\"field\" id=\"f_tags\" placeholder=\"#Tags go here\"/>\r\n      <div id=\"tagSuggestions\" class=\"hstack\" style=\"flex-wrap:wrap; gap:4px; margin:4px 0 0 0;\"></div>\r\n      <div style=\"position:relative;\">\r\n        <textarea class=\"field\" id=\"f_body\" rows=\"4\" placeholder=\"Share something about this track, a memory, or the vibe it gives you.\" maxlength=\"200\" oninput=\"document.getElementById('bodyCounter').textContent = this.value.length + '/200';\"></textarea>\r\n        <span class=\"muted small\" id=\"bodyCounter\" style=\"position:absolute; bottom:6px; right:10px; pointer-events:none;\">0/200</span>\r\n      </div>\r\n      <div class=\"hstack\" style=\"justify-content:space-between; align-items:center; margin-bottom:4px;\">\r\n        <div class=\"muted small\" id=\"captchaBox\" style=\"margin:0;\"></div>\r\n      </div>\r\n      <input class=\"field\" id=\"f_captcha\" placeholder=\"Enter captcha answer\" autocomplete=\"off\" style=\"margin-bottom:2px;\" />\r\n      <div id=\"postFormError\" class=\"muted small\" style=\"color:#c00;min-height:18px;\"></div>\r\n      <div class=\"hstack\" style=\"justify-content:center; margin-top:1px; gap:10px;\">\r\n        <button class=\"btn\" type=\"submit\" id=\"postBtn\">[ post ]</button>\r\n        <button class=\"btn btn-ghost\" type=\"button\" id=\"previewBtn\">[ preview ]</button>\r\n      </div>\r\n      <div id=\"preview\" class=\"player\" aria-live=\"polite\"></div>\r\n      <div id=\"postCooldown\" class=\"muted small\" style=\"text-align:center;margin-top:8px;\"></div>\r\n    </form>\r\n  `;\r\n  // Cooldown logic: disable post button and show timer if user posted in last 24h\r\n  function updateCooldown() {\r\n    const db = DB.getAll();\r\n    const me = state.user;\r\n    const postBtn = box.querySelector('#postBtn');\r\n    const cooldownDiv = box.querySelector('#postCooldown');\r\n    if (!me) return;\r\n    const now = Date.now();\r\n    const lastPost = db.posts\r\n      .filter(p => p.userId === me.id)\r\n      .sort((a, b) => b.createdAt - a.createdAt)[0];\r\n    if (lastPost && now - lastPost.createdAt < 24 * 60 * 60 * 1000) {\r\n      const timeLeft = 24 * 60 * 60 * 1000 - (now - lastPost.createdAt);\r\n      const hours = Math.floor(timeLeft / (60 * 60 * 1000));\r\n      const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));\r\n      const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);\r\n      if (postBtn) postBtn.disabled = true;\r\n      if (cooldownDiv) cooldownDiv.textContent = `You can post again in ${hours}h ${minutes}m ${seconds}s.`;\r\n    } else {\r\n      if (postBtn) postBtn.disabled = false;\r\n      if (cooldownDiv) cooldownDiv.textContent = '';\r\n    }\r\n  }\r\n  setInterval(updateCooldown, 1000);\r\n  updateCooldown();\r\n  // Looping prompt for logged-in user, but only if not focused in any composer field\r\n  const promptDiv = box.querySelector('#composePrompt');\r\n  let lastPrompt = '';\r\n  const composerFields = [\r\n    box.querySelector('#f_url'),\r\n    box.querySelector('#f_title'),\r\n    box.querySelector('#f_artist'),\r\n    box.querySelector('#f_tags'),\r\n    box.querySelector('#f_body')\r\n  ];\r\n  let promptTimeouts = [];\r\n  function clearPromptTimeouts() {\r\n    promptTimeouts.forEach(t => clearTimeout(t));\r\n    promptTimeouts = [];\r\n  }\r\n  function setPrompt() {\r\n    clearPromptTimeouts();\r\n    let prompt;\r\n    do { prompt = getComposePrompt(); } while (prompt === lastPrompt && PROMPTS.length > 1);\r\n    lastPrompt = prompt;\r\n    // Typewriter + backspace effect\r\n    let i = 0;\r\n    promptDiv.textContent = '';\r\n    promptDiv.classList.remove('fadein', 'fadeout');\r\n    if (!promptDiv.classList.contains('typewriter')) promptDiv.classList.add('typewriter');\r\n    function typeWriter() {\r\n      if (i < prompt.length) {\r\n        promptDiv.textContent += prompt.charAt(i);\r\n        i++;\r\n        // More human-like: variable speed, longer pauses, random short pauses\r\n        let delay = 16 + Math.random() * 32;\r\n        if (/[.,!?]/.test(prompt.charAt(i-1))) delay += 90 + Math.random() * 60;\r\n        if (prompt.charAt(i-1) === ' ') delay += 18 + Math.random() * 10;\r\n        // Occasionally pause for a bit longer (simulate thinking)\r\n        if (Math.random() < 0.07) delay += 80 + Math.random() * 120;\r\n        promptTimeouts.push(setTimeout(typeWriter, delay));\r\n      } else {\r\n        // After finished, wait longer, then backspace\r\n        promptTimeouts.push(setTimeout(() => {\r\n          let del = prompt.length;\r\n          let stopAt = 0;\r\n          if (prompt.startsWith('> ')) stopAt = 2;\r\n          function backspace() {\r\n            if (del > stopAt) {\r\n              promptDiv.textContent = promptDiv.textContent.slice(0, -1);\r\n              del--;\r\n              let delay = 13 + Math.random() * 22;\r\n              if (promptDiv.textContent.endsWith(' ')) delay += 12;\r\n              // Occasionally pause while erasing\r\n              if (Math.random() < 0.05) delay += 60 + Math.random() * 80;\r\n              promptTimeouts.push(setTimeout(backspace, delay));\r\n            } else {\r\n              // Wait, then start new prompt\r\n              promptTimeouts.push(setTimeout(setPrompt, 900));\r\n            }\r\n          }\r\n          backspace();\r\n        }, 2600 + Math.random() * 700));\r\n      }\r\n    }\r\n    typeWriter();\r\n  }\r\n  setPrompt();\r\n  // Show autofill message only when user is interacting with the composer\r\n  const autofillMsg = box.querySelector('#autofillMsg');\r\n  composerFields.forEach(field => {\r\n    if (field) {\r\n      field.addEventListener('focus', () => {\r\n        const urlField = composerFields.find(f => f && f.id === 'f_url');\r\n        if (urlField && !urlField.value) {\r\n          autofillMsg.style.display = 'block';\r\n        } else {\r\n          autofillMsg.style.display = 'none';\r\n        }\r\n      });\r\n      if (field.id === 'f_url') {\r\n        field.addEventListener('input', () => {\r\n          if (field.value) {\r\n            autofillMsg.style.display = 'none';\r\n          } else {\r\n            autofillMsg.style.display = 'block';\r\n          }\r\n        });\r\n      }\r\n      field.addEventListener('blur', () => {\r\n        setTimeout(() => {\r\n          // Only hide if no composer field is focused\r\n          if (!composerFields.some(f => f && document.activeElement === f)) {\r\n            autofillMsg.style.display = 'none';\r\n          }\r\n        }, 50);\r\n        // Also, if user leaves all fields, allow prompt to update again\r\n        setTimeout(() => {\r\n          if (!composerFields.some(f => f && document.activeElement === f)) setPrompt();\r\n        }, 60);\r\n      });\r\n    }\r\n  });\r\n  right.appendChild(box);\r\n\r\n  // Full post preview\r\n  const previewBtn = box.querySelector('#previewBtn');\r\n  if (previewBtn) {\r\n    previewBtn.addEventListener('click', async () => {\r\n      const preview = $('#preview');\r\n      const title = $('#f_title').value.trim();\r\n      const artist = $('#f_artist').value.trim();\r\n      const url = $('#f_url').value.trim();\r\n      const tags = ($('#f_tags').value || '').split(/[#\\s,]+/g).map(t => t.trim().toLowerCase()).filter(Boolean);\r\n      const body = $('#f_body').value.trim();\r\n      const pv = parseProvider(url);\r\n      const fakePost = {\r\n        id: 'preview',\r\n        userId: (state.user && state.user.id) || 'preview',\r\n        title, artist, url, provider: pv, tags, body,\r\n        likes: [], comments: [], createdAt: Date.now(),\r\n      };\r\n\r\n      const mod = await import('../features/feed.js');\r\n      preview.classList.add('active');\r\n      let html = mod.renderPostHTML(fakePost, state, DB);\r\n      html = html.replace(/<div class=\"actions[\\s\\S]*?<\\/div>/, ''); // strip actions\r\n      html = `<div class=\"muted small\" style=\"margin-bottom:4px;\">Preview Post</div>` + html;\r\n      preview.innerHTML = html;\r\n    });\r\n  }\r\n\r\n  // oEmbed autofill for title/artist\r\n  const f_url = box.querySelector('#f_url');\r\n  if (f_url) {\r\n    let lastMetaUrl = '';\r\n    let lastAutofill = { title: '', artist: '' };\r\n    const f_title = box.querySelector('#f_title');\r\n    const f_artist = box.querySelector('#f_artist');\r\n    let userEdited = { title: false, artist: false };\r\n\r\n    // Helper: reset autofill state if all fields are empty\r\n    function maybeResetAutofill() {\r\n      if (!f_url.value.trim() && !f_title.value.trim() && !f_artist.value.trim()) {\r\n        lastMetaUrl = '';\r\n        lastAutofill = { title: '', artist: '' };\r\n        userEdited = { title: false, artist: false };\r\n      }\r\n    }\r\n\r\n    f_title.addEventListener('input', () => { userEdited.title = true; });\r\n    f_artist.addEventListener('input', () => { userEdited.artist = true; });\r\n\r\n    // Reset autofill state if any of the three fields are cleared\r\n    [f_url, f_title, f_artist].forEach(field => {\r\n      field.addEventListener('input', maybeResetAutofill);\r\n    });\r\n\r\n    f_url.addEventListener('input', async () => {\r\n      const url = f_url.value.trim();\r\n      if (!url) {\r\n        lastMetaUrl = '';\r\n        return;\r\n      }\r\n      if (url === lastMetaUrl) return;\r\n      lastMetaUrl = url;\r\n\r\n      const { fetchOEmbed } = await import('../features/oembed.js');\r\n      const meta = await fetchOEmbed(url);\r\n      if (meta) {\r\n        let ytArtist = '', ytTitle = '';\r\n        if (/youtube\\.com|youtu\\.be/.test(url)) {\r\n          const { parseYouTubeTitle } = await import('../features/yt_title_parse.js');\r\n          const parsed = parseYouTubeTitle(meta);\r\n          ytArtist = parsed.artist;\r\n          ytTitle = parsed.title;\r\n          // Clean up artist if it ends with ' - Topic'\r\n          if (ytArtist && ytArtist.endsWith(' - Topic')) {\r\n            ytArtist = ytArtist.replace(/ - Topic$/, '').trim();\r\n          }\r\n        }\r\n        // Prefer parsed title/artist, fallback to oEmbed\r\n        let autofillTitle = ytTitle || meta.title;\r\n        let autofillArtist = ytArtist || meta.author_name || '';\r\n        // Clean up oEmbed author_name if it ends with ' - Topic'\r\n        if (!ytArtist && autofillArtist.endsWith(' - Topic')) {\r\n          autofillArtist = autofillArtist.replace(/ - Topic$/, '').trim();\r\n        }\r\n        if ((autofillTitle) && (!userEdited.title || f_title.value === lastAutofill.title)) {\r\n          f_title.value = autofillTitle;\r\n          lastAutofill.title = f_title.value;\r\n          userEdited.title = false;\r\n        }\r\n        if ((autofillArtist) && (!userEdited.artist || f_artist.value === lastAutofill.artist)) {\r\n          f_artist.value = autofillArtist;\r\n          lastAutofill.artist = f_artist.value;\r\n          userEdited.artist = false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // Captcha\r\n  function setCaptcha() {\r\n    const a = Math.floor(Math.random() * 10) + 1;\r\n    const b = Math.floor(Math.random() * 10) + 1;\r\n    box.querySelector('#captchaBox').textContent = `Captcha: What is ${a} + ${b}?`;\r\n    box.querySelector('#captchaBox').dataset.answer = (a + b).toString();\r\n    box.querySelector('#f_captcha').value = '';\r\n  }\r\n  setCaptcha();\r\n\r\n  // Post submit + reset captcha\r\n  const postForm = box.querySelector('#postForm');\r\n  if (postForm) {\r\n    postForm.addEventListener('submit', (e) => onCreatePost(e, state, DB, render));\r\n    postForm.addEventListener('resetCaptcha', setCaptcha);\r\n  }\r\n\r\n  // Tag suggestions\r\n  const f_tags = box.querySelector('#f_tags');\r\n  const tagSuggestions = box.querySelector('#tagSuggestions');\r\n  if (f_tags && tagSuggestions) {\r\n    // Helper to deduplicate tags in the input (now only on blur)\r\n    function dedupeTagsInput() {\r\n      let val = f_tags.value;\r\n      // Split by space/comma, remove empty, lowercase, keep #\r\n      let tags = val.split(/[#\\s,]+/g).map(t => t.trim().toLowerCase()).filter(Boolean);\r\n      // Remove duplicates, preserve order\r\n      let seen = new Set();\r\n      let deduped = [];\r\n      for (let t of tags) {\r\n        if (!seen.has(t)) {\r\n          seen.add(t);\r\n          deduped.push('#' + t);\r\n        }\r\n      }\r\n      // Join with space, add trailing space if input had it\r\n      let trailing = /[\\s,]$/.test(val) ? ' ' : '';\r\n      f_tags.value = deduped.join(' ') + trailing;\r\n    }\r\n  function getPopularTags() {\r\n      const db = DB.getAll();\r\n      const m = new Map();\r\n      db.posts.forEach(p => (p.tags || []).forEach(t => m.set(t, (m.get(t) || 0) + 1)));\r\n      return Array.from(m.entries())\r\n        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))\r\n        .slice(0, 20)\r\n        .map(([t]) => t);\r\n    }\r\n    function renderTagSuggestions(filter = '') {\r\n      const tags = getPopularTags();\r\n      // Get tags already used in the input (ignore #, split by space/comma)\r\n      const usedTags = (f_tags.value || '').split(/[#\\s,]+/g).map(t => t.trim().toLowerCase()).filter(Boolean);\r\n      // Filter out used tags\r\n      let filtered = tags.filter(t => !usedTags.includes(t.toLowerCase()));\r\n      // Further filter by input if needed\r\n      if (filter) filtered = filtered.filter(t => t.toLowerCase().includes(filter.toLowerCase()));\r\n      if (filtered.length === 0) {\r\n        tagSuggestions.innerHTML = '';\r\n        tagSuggestions.style.display = 'none';\r\n        return;\r\n      }\r\n      tagSuggestions.innerHTML = filtered.map(t => `<span class=\"tag small tag-suggestion\" style=\"cursor:pointer;\">#${esc(t)}</span>`).join(' ');\r\n      tagSuggestions.style.display = 'flex';\r\n    }\r\n    function maybeShowSuggestions() {\r\n      const val = f_tags.value;\r\n      if (document.activeElement === f_tags || val.length > 0) {\r\n        const last = val.split(/[, ]/).pop().replace(/^#/, '');\r\n        renderTagSuggestions(last);\r\n      } else {\r\n        tagSuggestions.style.display = 'none';\r\n      }\r\n    }\r\n    f_tags.addEventListener('input', () => {\r\n  maybeShowSuggestions();\r\n    });\r\n    f_tags.addEventListener('focus', maybeShowSuggestions);\r\n    f_tags.addEventListener('blur', () => setTimeout(() => { tagSuggestions.style.display = 'none'; }, 100));\r\n    f_tags.addEventListener('blur', () => {\r\n      dedupeTagsInput();\r\n      setTimeout(() => { tagSuggestions.style.display = 'none'; }, 100);\r\n    });\r\n    tagSuggestions.addEventListener('mousedown', (e) => e.preventDefault());\r\n    tagSuggestions.addEventListener('click', (e) => {\r\n      if (e.target.classList.contains('tag-suggestion')) {\r\n        let current = f_tags.value;\r\n        let tag = e.target.textContent.replace(/^#/, '');\r\n        // Find the last partial tag (after last space/comma)\r\n        let before = current.slice(0, f_tags.selectionStart).replace(/[#]*([^#\\s,]*)$/, '');\r\n        let after = current.slice(f_tags.selectionStart);\r\n        // Remove any trailing spaces in before\r\n        before = before.replace(/[\\s,]*$/, '');\r\n        // Compose new value: before + space + #tag + (space if after is empty or whitespace)\r\n        let newVal = before;\r\n        if (newVal && !/\\s$/.test(newVal)) newVal += ' ';\r\n        newVal += '#' + tag;\r\n        // If after is not empty and not just whitespace, add a space\r\n        if (after && !/^\\s*$/.test(after)) newVal += ' ';\r\n        // Add the after part if it exists and is not just whitespace\r\n        if (after && !/^\\s*$/.test(after)) newVal += after;\r\n        f_tags.value = newVal.trim() + ' ';\r\n        f_tags.dispatchEvent(new Event('input'));\r\n        f_tags.focus();\r\n      }\r\n    });\r\n    tagSuggestions.style.display = 'none';\r\n  }\r\n}", "// js/views/main_view_refresh.js\r\nimport { $ } from '../core/utils.js';\r\nimport { loadPrefs } from '../auth/prefs.js';\r\nimport { renderFeed, renderTags, getFilteredPosts } from '../features/feed.js';\r\n\r\nasync function smartRefresh(state, DB) {\r\n  if (typeof DB.refresh !== 'function') return;\r\n\r\n  const activePlayer = document.querySelector('.player.active');\r\n  await DB.refresh();\r\n\r\n  const feedEl = $('#feed');\r\n  const pagerEl = $('#pager');\r\n  const tagsEl = $('#tags');\r\n  if (!feedEl || !pagerEl || !tagsEl) return; // Not on main view\r\n\r\n  if (!activePlayer) {\r\n    // Save tag cloud scroll position before rerender\r\n    const tagCloud = document.querySelector('.tag-cloud');\r\n    if (tagCloud) {\r\n      window._tagCloudScrollLeft = tagCloud.scrollLeft;\r\n    }\r\n    const prefs = loadPrefs();\r\n    renderFeed(feedEl, pagerEl, state, DB, prefs);\r\n    renderTags(tagsEl, DB, prefs);\r\n    return;\r\n  }\r\n\r\n  const prefs = loadPrefs();\r\n  const posts = getFilteredPosts(DB, prefs);\r\n\r\n  // Update like counts and comment counts for visible posts\r\n  posts.forEach(p => {\r\n    const postEl = document.getElementById('post-' + p.id);\r\n    if (postEl) {\r\n      const likeBtn = postEl.querySelector('[data-action=\"like\"]');\r\n      if (likeBtn) {\r\n        likeBtn.innerHTML = `[ \u2665 ${p.likes ? p.likes.length : 0} ]`;\r\n        const pressed = (p.likes || []).includes(state.user && state.user.id) ? 'true' : 'false';\r\n        likeBtn.setAttribute('aria-pressed', pressed);\r\n        if (pressed === 'true') likeBtn.classList.add('like-on');\r\n        else likeBtn.classList.remove('like-on');\r\n      }\r\n      const commentBtn = postEl.querySelector('[data-action=\"comment\"]');\r\n      if (commentBtn) commentBtn.innerHTML = `[ comments ${p.comments ? p.comments.length : 0} ]`;\r\n    }\r\n  });\r\n\r\n  // Append new posts if any\r\n  const existingIds = Array.from(feedEl.querySelectorAll('.post')).map(el => el.getAttribute('data-post'));\r\n  const newPosts = posts.filter(p => !existingIds.includes(String(p.id)));\r\n  if (newPosts.length > 0) {\r\n    const mod = await import('../features/feed.js'); // dynamic import from features\r\n    const html = newPosts.map(p => mod.renderPostHTML(p, state, DB)).join('');\r\n    feedEl.insertAdjacentHTML('beforeend', html);\r\n  }\r\n\r\n  // Update pager and tags\r\n  if (posts.length > existingIds.length) {\r\n    pagerEl.innerHTML = `<button class=\"btn btn-ghost\" data-action=\"load-more\">[ load more (${existingIds.length}/${posts.length}) ]</button>`;\r\n  } else {\r\n    pagerEl.innerHTML = `<div class=\"small muted\">${posts.length} loaded</div>`;\r\n  }\r\n  renderTags(tagsEl, DB, prefs);\r\n}\r\n\r\nexport function setupAutoRefresh(state, DB) {\r\n  if (!window._autoFeedRefresh) {\r\n    window._autoFeedRefresh = setInterval(() => {\r\n      smartRefresh(state, DB).catch(console.error);\r\n    }, 30000); // 30s\r\n  }\r\n}\r\n\r\nexport function setupVisibilityRefresh(state, DB) {\r\n  if (!window._feedVisibilityHandler) {\r\n    const instantRefresh = () => smartRefresh(state, DB).catch(console.error);\r\n    window.addEventListener('focus', instantRefresh);\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (document.visibilityState === 'visible') instantRefresh();\r\n    });\r\n    window._feedVisibilityHandler = true;\r\n  }\r\n}", "import { $ } from '../core/utils.js';\r\nimport { startPromptAnimation, startLoginPromptAnimation, stopLoginPromptAnimation } from './login_prompts.js';\r\nimport { setGuestMode, setSession, clearSession } from '../auth/session.js';\r\nimport { renderHeader } from '../core/header.js';\r\n\r\nexport function renderLogin(root, DB, render) {\r\n  const banner = document.getElementById('ascii-banner');\r\n  if (banner) banner.style.display = 'none';\r\n  document.body.classList.remove('show-header');\r\n  // Prevent vertical scrollbar on login view (html & body)\r\n  const prevBodyOverflow = document.body.style.overflow;\r\n  const prevHtmlOverflow = document.documentElement.style.overflow;\r\n  document.body.style.overflow = 'hidden';\r\n  document.documentElement.style.overflow = 'hidden';\r\n\r\n  const div = document.createElement('div');\r\n  div.className = 'login login-fadein';\r\n  div.innerHTML = `\r\n    <div class=\"auth-shell\">\r\n      <img src=\"/assets/logo.png\" alt=\"Logo\" class=\"login-logo-anim\" style=\"display:block; margin:0 auto; width:64px; height:64px; object-fit:contain; animation:none;\" />\r\n      <div class=\"small muted\">\u250C\u2500 login or register to</div>\r\n      <div class=\"logo\">TunedIn.space</div>\r\n      <div class=\"small muted\">\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500</div>\r\n\r\n      <div class=\"title\">\r\n        <span id=\"loginAnimatedPrompt\" aria-hidden=\"true\"></span>\r\n        <span id=\"registerAnimatedPrompt\" aria-hidden=\"true\" style=\"display:none;\"></span>\r\n      </div>\r\n\r\n      <form id=\"loginForm\" class=\"stack auth-form\" autocomplete=\"off\">\r\n        <input required type=\"email\" id=\"loginEmail\" class=\"field\" placeholder=\"Email\" />\r\n        <input required minlength=\"6\" maxlength=\"64\" id=\"loginPass\" class=\"field\" type=\"password\" placeholder=\"Password\" />\r\n        <button class=\"btn\" type=\"submit\">[ sign in ]</button>\r\n        <div class=\"auth-links\">\r\n          <a href=\"#\" id=\"showRegister\" class=\"muted small\" style=\"text-decoration:underline;\">Don't have an account? Create one</a>\r\n        </div>\r\n        <div class=\"muted small auth-msg\" id=\"loginMsg\">${DB.isRemote ? 'Sign in to be able to post content,<br>' : ''}or use guest mode below.</div>\r\n      </form>\r\n\r\n      <form id=\"registerForm\" class=\"stack auth-form\" autocomplete=\"off\" style=\"display:none;\">\r\n        <input required minlength=\"2\" maxlength=\"24\" id=\"regName\" class=\"field\" placeholder=\"Username\" />\r\n        <input required type=\"email\" id=\"regEmail\" class=\"field\" placeholder=\"Email\" />\r\n        <input required minlength=\"6\" maxlength=\"64\" id=\"regPass\" class=\"field\" type=\"password\" placeholder=\"Password\" />\r\n        <button class=\"btn\" type=\"submit\">[ create account ]</button>\r\n        <div class=\"auth-links\">\r\n          <a href=\"#\" id=\"showLogin\" class=\"muted small\" style=\"text-decoration:underline;\">Already have an account? Sign in</a>\r\n        </div>\r\n        <div class=\"muted small auth-msg\" id=\"regMsg\">${DB.isRemote ? 'Register to post.  ' : ''}Or view in guest mode.</div>\r\n      </form>\r\n\r\n      <div class=\"sep\"></div>\r\n      <div class=\"hstack\" style=\"justify-content:center;\">\r\n        <button class=\"btn btn-ghost\" id=\"guestBtn\" type=\"button\">[ continue as guest ]</button>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  root.appendChild(div);\r\n  // After parent fade-in, trigger logo animation\r\n  setTimeout(() => {\r\n    const logo = div.querySelector('.login-logo-anim');\r\n    if (logo) {\r\n      logo.style.animation = '';\r\n    }\r\n  }, 700); // match .login-fadein duration\r\n  // In mobile tabbed mode, remove header (and logo) from DOM if present\r\n  if (window.matchMedia('(max-width: 600px)').matches) {\r\n    const header = document.querySelector('header[role=\"banner\"]');\r\n    if (header && header.parentNode) {\r\n      header.parentNode.removeChild(header);\r\n    }\r\n  }\r\n  // Restore overflow when leaving login view\r\n  const restoreOverflow = () => {\r\n    document.body.style.overflow = prevBodyOverflow || '';\r\n    document.documentElement.style.overflow = prevHtmlOverflow || '';\r\n  };\r\n  // Patch render to restore overflow if main view is rendered\r\n  const wrappedRender = (...args) => {\r\n    restoreOverflow();\r\n    // If in mobile mode, ensure header is present before rendering main view\r\n    if (window.matchMedia('(max-width: 600px)').matches) {\r\n      // Only add header if not present\r\n      if (!document.querySelector('header[role=\"banner\"]')) {\r\n        renderHeader();\r\n      }\r\n    }\r\n    render(...args);\r\n  };\r\n\r\n  // Animations\r\n  let stopRegisterPrompt = null;\r\n\r\n  function showLoginForm() {\r\n    setGuestMode(false); // Always disable guest mode when showing login\r\n    $('#loginForm').style.display = '';\r\n    $('#registerForm').style.display = 'none';\r\n    $('#loginAnimatedPrompt').style.display = '';\r\n    $('#registerAnimatedPrompt').style.display = 'none';\r\n\r\n    // stop register animator if running\r\n    if (stopRegisterPrompt) {\r\n      stopRegisterPrompt();\r\n      stopRegisterPrompt = null;\r\n    }\r\n    // start login animator\r\n    $('#loginAnimatedPrompt').textContent = '';\r\n    startLoginPromptAnimation();\r\n\r\n    // Prevent auto-focus on mobile devices (avoid keyboard pop-up)\r\n    if (!/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {\r\n      $('#loginEmail').focus();\r\n    }\r\n  }\r\n\r\n  function showRegisterForm() {\r\n    $('#loginForm').style.display = 'none';\r\n    $('#registerForm').style.display = '';\r\n    $('#loginAnimatedPrompt').style.display = 'none';\r\n    $('#registerAnimatedPrompt').style.display = '';\r\n\r\n    // stop login animator\r\n    stopLoginPromptAnimation();\r\n\r\n    // start register animator\r\n    const regEl = document.getElementById('registerAnimatedPrompt');\r\n    regEl.textContent = '';\r\n    stopRegisterPrompt = startPromptAnimation(regEl);\r\n\r\n    // Prevent auto-focus on mobile devices (avoid keyboard pop-up)\r\n    if (!/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)) {\r\n      $('#regName').focus();\r\n    }\r\n  }\r\n\r\n  $('#showLogin').onclick = (e) => { e.preventDefault(); showLoginForm(); };\r\n  $('#showRegister').onclick = (e) => { e.preventDefault(); showRegisterForm(); };\r\n\r\n  $('#guestBtn').onclick = () => {\r\n    setGuestMode(true);\r\n    wrappedRender();\r\n  };\r\n\r\n  // Register\r\n  $('#registerForm').addEventListener('submit', async (e) => {\r\n    e.preventDefault();\r\n    const name = $('#regName').value.trim();\r\n    const email = $('#regEmail').value.trim();\r\n    const pass = $('#regPass').value;\r\n    if (!name || !email || !pass) return;\r\n    // Email format and disposable domain validation\r\n    import('../core/utils.js').then(utils => {\r\n      if (!utils.isValidEmailFormat(email)) {\r\n        $('#regMsg').textContent = 'Please enter a valid email address.';\r\n        return;\r\n      }\r\n      // isDisposableEmail is defined in db.js, so import it from there\r\n      import('../core/db.js').then(dbmod => {\r\n        if (dbmod.isDisposableEmail && dbmod.isDisposableEmail(email)) {\r\n          $('#regMsg').textContent = 'Disposable (temporary) email addresses are not allowed.';\r\n          return;\r\n        }\r\n        proceed();\r\n      });\r\n    });\r\n\r\n    function proceed() {\r\n      $('#regMsg').textContent = 'Registering...';\r\n      (async () => {\r\n        try {\r\n          let u;\r\n          if (DB.isRemote && DB.supabase) {\r\n            const { data, error } = await DB.supabase.auth.signUp({ email, password: pass, options: { data: { name } } });\r\n            if (error) throw error;\r\n            // Supabase: always require email confirmation before login\r\n            $('#regMsg').innerHTML = 'Registration successful!<br>Please check your email and confirm your account before logging in.';\r\n            $('#registerForm').reset();\r\n            // Optionally, hide the form or disable it\r\n            $('#registerForm').style.display = 'none';\r\n            // Show login form after a short delay\r\n            setTimeout(() => {\r\n              showLoginForm();\r\n              $('#loginMsg').innerHTML = 'A confirmation email has been sent to your address.<br><b>Please confirm your email before logging in.</b>';\r\n            }, 3500);\r\n            return;\r\n          } else {\r\n            u = await DB.ensureUser(name, email, pass);\r\n            setSession({ userId: u.id }); // Only for local users\r\n            setGuestMode(false);\r\n            await DB.refresh();\r\n            wrappedRender();\r\n          }\r\n        } catch (err) {\r\n          $('#regMsg').textContent = 'Registration failed: ' + (err.message || err);\r\n        }\r\n      })();\r\n    }\r\n  });\r\n\r\n  // Login\r\n  $('#loginForm').addEventListener('submit', async (e) => {\r\n    e.preventDefault();\r\n    const email = $('#loginEmail').value.trim();\r\n    const pass = $('#loginPass').value;\r\n    if (!email || !pass) return;\r\n    $('#loginMsg').textContent = 'Logging in...';\r\n    try {\r\n      // Always clear session and cache before login to prevent leaks\r\n      clearSession();\r\n      if (DB.isRemote && DB.supabase && DB.supabase.auth && DB.supabase.auth.signOut) {\r\n        try { await DB.supabase.auth.signOut(); } catch (e) { /* ignore */ }\r\n      }\r\n      let u;\r\n      if (DB.isRemote && DB.supabase) {\r\n        const { data, error } = await DB.supabase.auth.signInWithPassword({ email, password: pass });\r\n        if (error) throw error;\r\n        // Check if user is confirmed (Supabase v2: user.confirmed_at, v1: user.confirmed)\r\n        const userObj = data.session?.user || data.user;\r\n        const isConfirmed = userObj?.confirmed_at || userObj?.confirmed || userObj?.email_confirmed_at;\r\n        if (!isConfirmed) {\r\n          $('#loginMsg').innerHTML = 'You must confirm your email before logging in. Please check your inbox.';\r\n          return;\r\n        }\r\n        // Do not setSession for Supabase users; rely on Supabase session\r\n        setGuestMode(false);\r\n        await DB.refresh();\r\n        wrappedRender();\r\n      } else {\r\n        u = await DB.loginUser(email, pass);\r\n        if (!u) throw new Error('Invalid credentials');\r\n        setSession({ userId: u.id }); // Only for local users\r\n        setGuestMode(false);\r\n        await DB.refresh();\r\n        wrappedRender();\r\n      }\r\n    } catch (err) {\r\n      $('#loginMsg').textContent = 'Login failed: ' + (err.message || err);\r\n    }\r\n  });\r\n\r\n  // Start on login by default\r\n  showLoginForm();\r\n}", "// Animated rotating prompts for auth screens\r\nimport { PROMPTS } from '../core/constants.js';\r\nconst loginPrompts = PROMPTS;\r\n\r\nfunction rand(min, max) { return min + Math.random() * (max - min); }\r\n\r\nfunction measureTextWidth(text, el) {\r\n  const cs = getComputedStyle(el);\r\n  const probe = document.createElement('span');\r\n  probe.textContent = text;\r\n  probe.style.position = 'absolute';\r\n  probe.style.visibility = 'hidden';\r\n  probe.style.whiteSpace = 'nowrap';\r\n  probe.style.font = cs.font;             // font-style variant weight size/line-height family\r\n  probe.style.letterSpacing = cs.letterSpacing;\r\n  document.body.appendChild(probe);\r\n  const w = probe.offsetWidth;\r\n  document.body.removeChild(probe);\r\n  return w || 0;\r\n}\r\n\r\nfunction computeScaleToFit(text, el) {\r\n  // Use the prompt's parent width (the .title container) as the target width.\r\n  const parent = el.parentElement || el;\r\n  const containerWidth = parent.clientWidth || 0;\r\n  if (!containerWidth) return 1;\r\n\r\n  // Measure full text at the base (computed) font-size.\r\n  const basePx = parseFloat(getComputedStyle(el).fontSize) || 14;\r\n  // Temporarily ensure we measure at base size (clear any inline scaling)\r\n  const prevInline = el.style.fontSize;\r\n  el.style.fontSize = basePx + 'px';\r\n\r\n  const textWidth = measureTextWidth(text, el);\r\n  // Restore any previous inline font-size before we apply the final one below.\r\n  el.style.fontSize = prevInline || '';\r\n\r\n  if (!textWidth) return 1;\r\n\r\n  // Scale down as needed so the full text fits on one line. No min cap = always fits.\r\n  const scale = Math.min(1, containerWidth / textWidth);\r\n  return { scale, basePx };\r\n}\r\n\r\n// Generic prompt animator. Pass an element or element id.\r\n// Returns a stop() function.\r\nexport function startPromptAnimation(target, options = {}) {\r\n  const el = typeof target === 'string' ? document.getElementById(target) : target;\r\n  if (!el) return () => {};\r\n\r\n  const prompts = options.prompts || loginPrompts;\r\n\r\n  // Timing\r\n  const typeMin = options.typeMin ?? 28;\r\n  const typeMax = options.typeMax ?? 60;\r\n  const eraseMin = options.eraseMin ?? 16;\r\n  const eraseMax = options.eraseMax ?? 40;\r\n  const holdMs = options.holdMs ?? 1200;\r\n  const pauseBetween = options.pauseBetween ?? 300;\r\n\r\n  // State\r\n  let idx = Math.floor(Math.random() * prompts.length);\r\n  let char = 0;\r\n  let erase = false;\r\n  let timer = null;\r\n  let stopped = false;\r\n\r\n  // Single-line guarantees\r\n  el.style.whiteSpace = 'nowrap';\r\n  el.style.overflow = 'hidden';\r\n  el.style.textOverflow = 'clip';\r\n\r\n  // Precompute and apply scale for a given prompt (once per cycle)\r\n  let basePx = parseFloat(getComputedStyle(el).fontSize) || 14;\r\n  let currentPrompt = prompts[idx];\r\n  let currentScale = 1;\r\n\r\n  function applyScaleForCurrentPrompt() {\r\n    const res = computeScaleToFit(currentPrompt, el);\r\n    if (typeof res === 'object' && res !== null) {\r\n      currentScale = res.scale ?? 1;\r\n      basePx = res.basePx ?? basePx;\r\n    } else {\r\n      currentScale = res || 1;\r\n    }\r\n    el.style.fontSize = (basePx * currentScale).toFixed(2) + 'px';\r\n  }\r\n\r\n  function nextPrompt() {\r\n    idx = (idx + 1) % prompts.length;\r\n    currentPrompt = prompts[idx];\r\n    char = 0;\r\n    erase = false;\r\n    applyScaleForCurrentPrompt();\r\n  }\r\n\r\n  // Resize handler: keep it one-line if viewport changes\r\n  const onResize = () => applyScaleForCurrentPrompt();\r\n  window.addEventListener('resize', onResize);\r\n  window.addEventListener('orientationchange', onResize);\r\n\r\n  // Initial scale for first prompt\r\n  applyScaleForCurrentPrompt();\r\n\r\n  function tick() {\r\n    if (stopped) return;\r\n\r\n    const text = currentPrompt;\r\n\r\n    if (!erase) {\r\n      char++;\r\n      el.textContent = text.slice(0, char);\r\n      if (char < text.length) {\r\n        timer = setTimeout(tick, rand(typeMin, typeMax));\r\n      } else {\r\n        erase = true;\r\n        timer = setTimeout(tick, holdMs);\r\n      }\r\n    } else {\r\n      char--;\r\n      el.textContent = text.slice(0, char);\r\n      if (char > 0) {\r\n        timer = setTimeout(tick, rand(eraseMin, eraseMax));\r\n      } else {\r\n        nextPrompt();\r\n        timer = setTimeout(tick, pauseBetween);\r\n      }\r\n    }\r\n  }\r\n\r\n  tick();\r\n\r\n  return () => {\r\n    stopped = true;\r\n    clearTimeout(timer);\r\n    window.removeEventListener('resize', onResize);\r\n    window.removeEventListener('orientationchange', onResize);\r\n    el.style.fontSize = ''; // reset to stylesheet value for next time\r\n  };\r\n}\r\n\r\n/* Backward-compat shims for existing calls */\r\nlet currentStopper = null;\r\n\r\nexport function startLoginPromptAnimation() {\r\n  const el = document.getElementById('loginAnimatedPrompt');\r\n  if (!el) return;\r\n  stopLoginPromptAnimation();\r\n  currentStopper = startPromptAnimation(el);\r\n}\r\n\r\nexport function stopLoginPromptAnimation() {\r\n  if (currentStopper) {\r\n    currentStopper();\r\n    currentStopper = null;\r\n  }\r\n}", "import { $, esc, toast, liveSay, copyText, uid } from '../core/utils.js';\r\nimport { parseProvider, buildEmbed } from './providers.js';\r\nimport { loadPrefs, savePrefs, PREF_KEY, resetPrefsCache } from '../auth/prefs.js';\r\nimport { SESSION_KEY, GUEST_KEY, setGuestMode, clearSession } from '../auth/session.js';\r\nimport { renderFeed, renderPostHTML, renderCommentHTML } from './feed.js';\r\nimport { notifyPostLike, notifyPostComment } from '../core/notify_helpers.js';\r\nimport { containsBannedWords, looksLikeSpam } from './automod.js';\r\nimport { openEditInline } from './posts.js';\r\nimport { showUserProfile } from '../views/profile.js';\r\nimport { supabase } from '../core/supabase_client.js';\r\nimport { pickAccent } from '../auth/theme.js';\r\nimport { updateDock, queuePrev, queueNext, markNowPlaying, getActiveQueueId } from './queue.js';\r\nimport { openHelpOverlay } from '../views/overlays.js';\r\n\r\nexport async function onActionClick(e, state, DB, render) {\r\n  const btn = e.target.closest('[data-action]');\r\n  if (!btn) return;\r\n  const action = btn.dataset.action;\r\n  const root = $('#app');\r\n  const card = e.target.closest('.post');\r\n  const postId = card ? card.dataset.post : null;\r\n\r\n  if (action === 'toggle-player' && postId) {\r\n    const pl = document.getElementById('player-' + postId);\r\n    const active = pl.classList.contains('active');\r\n    if (active) {\r\n      pl.classList.remove('active');\r\n      try { pl._cleanup && pl._cleanup(); } catch {}\r\n      pl.innerHTML = '';\r\n      card.classList.remove('is-playing');\r\n    } else {\r\n      // Close any other active players\r\n      document.querySelectorAll('.player.active').forEach(otherPl => {\r\n        if (otherPl !== pl) {\r\n          otherPl.classList.remove('active');\r\n          try { otherPl._cleanup && otherPl._cleanup(); } catch {}\r\n          otherPl.innerHTML = '';\r\n          const otherCard = otherPl.closest('.post');\r\n          if (otherCard) otherCard.classList.remove('is-playing');\r\n        }\r\n      });\r\n      pl.classList.add('active');\r\n      const db = DB.getAll();\r\n      const p = db.posts.find(x => x.id === postId);\r\n      if (!p || (!p.url && !(p.provider && p.provider.id))) {\r\n        toast(card || root, 'Could not load post for playback', true);\r\n        return;\r\n      }\r\n      console.log('Attempting to build embed:', { post: p, playerDiv: pl });\r\n      buildEmbed(p, pl, { autoplay: true, onEnded: () => queueNext(true, state, DB) });\r\n      console.log('Embed built. Player div innerHTML:', pl.innerHTML);\r\n      markNowPlaying(postId, state, DB);\r\n      if (loadPrefs().autoScroll) card.scrollIntoView({ block: 'center' });\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (action === 'like' && postId) {\r\n    if (!state.user) { toast(card || root, 'login to like', true); return; }\r\n    const updated = await DB.toggleLike(postId, state.user.id);\r\n    if (updated && card) {\r\n      // Notify post author if not self\r\n      const db = DB.getAll();\r\n      const post = db.posts.find(x => x.id === postId);\r\n      notifyPostLike(post, state.user);\r\n      // Find the like button before updating\r\n      const likeBtn = card.querySelector('[data-action=\"like\"]');\r\n      if (likeBtn) {\r\n        likeBtn.classList.remove('like-animate');\r\n        // Force reflow to restart animation\r\n        void likeBtn.offsetWidth;\r\n        likeBtn.classList.add('like-animate');\r\n        if ((updated.likes || []).includes(state.user.id)) {\r\n          likeBtn.classList.add('like-on');\r\n          likeBtn.setAttribute('aria-pressed', 'true');\r\n        } else {\r\n          likeBtn.classList.remove('like-on');\r\n          likeBtn.setAttribute('aria-pressed', 'false');\r\n        }\r\n        likeBtn.innerHTML = `[ \u2665 ${(updated.likes ? updated.likes.length : 0)} ]`;\r\n      }\r\n    }\r\n    return;\r\n  }\r\n// ...existing code...\r\n\r\n  if (action === 'delete' && postId) {\r\n    const db = DB.getAll();\r\n    const p = db.posts.find(x => x.id === postId);\r\n    if (!p) return;\r\n    if (!state.user || p.userId !== state.user.id) { toast(card || root, 'you can only delete your posts', true); return; }\r\n\r\n    // Remove any existing confirm popup\r\n    document.querySelectorAll('.post-delete-confirm').forEach(el => el.remove());\r\n\r\n    // Create confirm popup (identical to comment delete)\r\n    const confirmDiv = document.createElement('div');\r\n    confirmDiv.className = 'comment-delete-confirm fadein';\r\n    confirmDiv.innerHTML = `\r\n      <div class=\"confirm-inner\">\r\n        <span><b>Delete this post?</b></span>\r\n        <button class=\"btn small btn-danger confirm-yes\" tabindex=\"0\">OK</button>\r\n        <button class=\"btn small confirm-no\" tabindex=\"0\">Cancel</button>\r\n      </div>\r\n    `;\r\n    // Position near the button\r\n    const rect = btn.getBoundingClientRect();\r\n    confirmDiv.style.position = 'absolute';\r\n    confirmDiv.style.zIndex = 10010;\r\n    let left = rect.left + window.scrollX;\r\n    const minWidth = 180;\r\n    // Prevent offscreen right\r\n    if (left + minWidth > window.innerWidth - 8) {\r\n      left = window.innerWidth - minWidth - 8;\r\n    }\r\n    confirmDiv.style.left = left + 'px';\r\n    confirmDiv.style.top = (rect.bottom + window.scrollY + 4) + 'px';\r\n\r\n    document.body.appendChild(confirmDiv);\r\n\r\n    // Remove popup helper (with fadeout)\r\n    function removeConfirm() {\r\n      confirmDiv.classList.remove('fadein');\r\n      confirmDiv.classList.add('fadeout');\r\n      setTimeout(() => confirmDiv.remove(), 180);\r\n    }\r\n\r\n    // Confirm\r\n    confirmDiv.querySelector('.confirm-yes').onclick = async () => {\r\n      removeConfirm();\r\n      await DB.deletePost(postId);\r\n      render();\r\n    };\r\n    // Cancel\r\n    confirmDiv.querySelector('.confirm-no').onclick = removeConfirm;\r\n    // Keyboard accessibility\r\n    confirmDiv.onkeydown = (ev) => {\r\n      if (ev.key === 'Enter') {\r\n        confirmDiv.querySelector('.confirm-yes').click();\r\n      } else if (ev.key === 'Escape') {\r\n        removeConfirm();\r\n      }\r\n    };\r\n    // Focus first button\r\n    setTimeout(() => {\r\n      confirmDiv.querySelector('.confirm-yes').focus();\r\n    }, 10);\r\n    // Dismiss on outside click\r\n    setTimeout(() => {\r\n      function outside(ev) {\r\n        if (!confirmDiv.contains(ev.target)) {\r\n          removeConfirm();\r\n          document.removeEventListener('mousedown', outside);\r\n        }\r\n      }\r\n      document.addEventListener('mousedown', outside);\r\n    }, 0);\r\n    return;\r\n  }\r\n\r\n\r\n  if (action === 'comment' && postId) {\r\n    // Close any open edit form first\r\n    if (window.editingPostId) {\r\n      const lastCard = document.getElementById('post-' + window.editingPostId);\r\n      const lastEditBoxId = 'editbox-' + window.editingPostId;\r\n      const lastOpened = lastCard ? lastCard.querySelector('#' + lastEditBoxId) : null;\r\n      if (lastOpened) {\r\n        lastOpened.classList.remove('fade-in');\r\n        lastOpened.classList.add('fade-out');\r\n        setTimeout(() => {\r\n          if (lastOpened.parentNode) lastOpened.parentNode.removeChild(lastOpened);\r\n          if (window.editingPostId == lastEditBoxId.replace('editbox-', '')) window.editingPostId = null;\r\n        }, 180);\r\n      } else {\r\n        window.editingPostId = null;\r\n      }\r\n    }\r\n    // Close any other open comment box first\r\n    if (window.openCommentId && window.openCommentId !== postId) {\r\n      const lastCbox = document.getElementById('cbox-' + window.openCommentId);\r\n      if (lastCbox && lastCbox.classList.contains('active')) {\r\n        lastCbox.classList.remove('fade-in');\r\n        lastCbox.classList.add('fade-out');\r\n        setTimeout(() => {\r\n          lastCbox.classList.remove('active');\r\n          lastCbox.classList.remove('fade-out');\r\n        }, 180);\r\n      }\r\n      window.openCommentId = null;\r\n    }\r\n    const cbox = document.getElementById('cbox-' + postId);\r\n    if (cbox.classList.contains('active')) {\r\n      // Animate out\r\n      cbox.classList.remove('fade-in');\r\n      cbox.classList.add('fade-out');\r\n      setTimeout(() => {\r\n        cbox.classList.remove('active');\r\n        cbox.classList.remove('fade-out');\r\n      }, 180);\r\n      window.openCommentId = null;\r\n    } else {\r\n      cbox.classList.add('active');\r\n      cbox.classList.remove('fade-out');\r\n      cbox.classList.add('fade-in');\r\n      window.openCommentId = postId;\r\n      if (state.user) {\r\n        // Focus input after animation, but prevent scroll jump\r\n        setTimeout(() => {\r\n          const inp = cbox.querySelector('input.field');\r\n          if (inp) {\r\n            const prevScroll = window.scrollY;\r\n            inp.focus({ preventScroll: true });\r\n            // If the cbox is not fully visible, restore scroll\r\n            const rect = cbox.getBoundingClientRect();\r\n            if (rect.bottom > window.innerHeight) {\r\n              window.scrollTo({ top: prevScroll });\r\n            }\r\n          }\r\n        }, 180);\r\n      }\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (action === 'delete-comment') {\r\n    const pid = btn.dataset.post || postId;\r\n    const cid = btn.dataset.comment;\r\n    if (!pid || !cid) return;\r\n    if (!state.user) { toast(card || root, 'login to delete comments', true); return; }\r\n    const db = DB.getAll();\r\n    const p = db.posts.find(x => x.id === pid);\r\n    if (!p) return;\r\n    const com = (p.comments || []).find(c => c.id === cid);\r\n    if (!com) return;\r\n    if (com.userId !== state.user.id) { toast(card || root, 'you can only delete your comments', true); return; }\r\n\r\n    // Remove any existing confirm popup\r\n    document.querySelectorAll('.comment-delete-confirm').forEach(el => el.remove());\r\n\r\n    // Create confirm popup\r\n    const confirmDiv = document.createElement('div');\r\n    confirmDiv.className = 'comment-delete-confirm fadein';\r\n    confirmDiv.innerHTML = `\r\n      <div class=\"confirm-inner\">\r\n        <span>Delete this comment?</span>\r\n        <button class=\"btn small btn-danger confirm-yes\" tabindex=\"0\">OK</button>\r\n        <button class=\"btn small confirm-no\" tabindex=\"0\">Cancel</button>\r\n      </div>\r\n    `;\r\n    // Position near the button\r\n    const rect = btn.getBoundingClientRect();\r\n    confirmDiv.style.position = 'absolute';\r\n    confirmDiv.style.zIndex = 10010;\r\n    let left = rect.left + window.scrollX;\r\n    const minWidth = 180;\r\n    // Prevent offscreen right\r\n    if (left + minWidth > window.innerWidth - 8) {\r\n      left = window.innerWidth - minWidth - 8;\r\n    }\r\n    confirmDiv.style.left = left + 'px';\r\n    confirmDiv.style.top = (rect.bottom + window.scrollY + 4) + 'px';\r\n\r\n    document.body.appendChild(confirmDiv);\r\n\r\n    // Remove popup helper (with fadeout)\r\n    function removeConfirm() {\r\n      confirmDiv.classList.remove('fadein');\r\n      confirmDiv.classList.add('fadeout');\r\n      setTimeout(() => confirmDiv.remove(), 180);\r\n    }\r\n\r\n    // Confirm\r\n    confirmDiv.querySelector('.confirm-yes').onclick = async () => {\r\n      removeConfirm();\r\n      await DB.deleteComment(pid, cid);\r\n      const updated = DB.getAll().posts.find(x => x.id === pid);\r\n      const cwrap = document.getElementById('comments-' + pid);\r\n      cwrap.innerHTML = (updated?.comments || []).map(x => renderCommentHTML(x, pid, state, DB)).join('');\r\n      liveSay('comment deleted');\r\n    };\r\n    // Cancel\r\n    confirmDiv.querySelector('.confirm-no').onclick = removeConfirm;\r\n    // Keyboard accessibility\r\n    confirmDiv.onkeydown = (ev) => {\r\n      if (ev.key === 'Enter') {\r\n        confirmDiv.querySelector('.confirm-yes').click();\r\n      } else if (ev.key === 'Escape') {\r\n        removeConfirm();\r\n      }\r\n    };\r\n    // Focus first button\r\n    setTimeout(() => {\r\n      confirmDiv.querySelector('.confirm-yes').focus();\r\n    }, 10);\r\n    // Dismiss on outside click\r\n    setTimeout(() => {\r\n      function outside(ev) {\r\n        if (!confirmDiv.contains(ev.target)) {\r\n          removeConfirm();\r\n          document.removeEventListener('mousedown', outside);\r\n        }\r\n      }\r\n      document.addEventListener('mousedown', outside);\r\n    }, 0);\r\n  }\r\n\r\n  if (action === 'go-login') {\r\n    setGuestMode(false);\r\n    state.forceLogin = true;\r\n    render();\r\n    return;\r\n  }\r\n\r\n  if (action === 'share') {\r\n    const perma = btn.dataset.perma || (location.pathname + '#post-' + postId);\r\n    const db = DB.getAll();\r\n    const p = postId ? db.posts.find(x => x.id === postId) : null;\r\n  const title = p ? `${p.title}${p.artist ? ' \u2014 ' + p.artist : ''}` : 'TunedIn.space';\r\n    if (navigator.share) {\r\n      navigator.share({ title, url: perma }).catch(() => copyText(perma));\r\n    } else {\r\n      copyText(perma)\r\n        .then(() => toast(card || root, 'permalink copied to clipboard'))\r\n        .catch(() => toast(card || root, 'copy failed', true));\r\n    }\r\n  }\r\n\r\n  if (action === 'queue' && postId) {\r\n    if (!state.queue.includes(postId)) state.queue.push(postId);\r\n    updateDock(true, state, DB);\r\n    toast(card, 'added to queue');\r\n  }\r\n\r\n  if (action === 'filter-tag') {\r\n    const t = btn.dataset.tag;\r\n    // Prevent default anchor or button scroll behavior\r\n    if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n    savePrefs({ filterTag: t, search: '' });\r\n    state.page = 1;\r\n    render();\r\n    // Do not scroll the page\r\n    return;\r\n  }\r\n  if (action === 'clear-tag') {\r\n    // Prevent default anchor or button scroll behavior\r\n    if (e && typeof e.preventDefault === 'function') e.preventDefault();\r\n    savePrefs({ filterTag: null });\r\n    state.page = 1;\r\n    render();\r\n    // Do not scroll the page\r\n    return;\r\n  }\r\n\r\n  if (action === 'q-prev') queuePrev(state, DB);\r\n  if (action === 'q-next') queueNext(false, state, DB);\r\n  if (action === 'q-clear') { state.queue = []; state.qIndex = 0; updateDock(false, state, DB); }\r\n  if (action === 'q-shuffle') { savePrefs({ shuffle: !loadPrefs().shuffle }); updateDock(false, state, DB); }\r\n  if (action === 'q-repeat') {\r\n    const order = ['off', 'all', 'one'];\r\n    const cur = loadPrefs().repeat || 'off';\r\n    const next = order[(order.indexOf(cur) + 1) % order.length];\r\n    savePrefs({ repeat: next });\r\n    updateDock(false, state, DB);\r\n  }\r\n\r\n  if (action === 'reset') {\r\n    if (DB.isRemote) {\r\n      alert('Reset all is only for local mode. For Supabase, use Import to replace remote data.');\r\n      return;\r\n    }\r\n  if (confirm('Reset all TunedIn.space data (posts, users, prefs)? This cannot be undone.')) {\r\n  localStorage.removeItem('TunedIn.space/db@v2');\r\n  localStorage.removeItem('TunedIn.space/v1');\r\n      localStorage.removeItem(PREF_KEY);\r\n      localStorage.removeItem(SESSION_KEY);\r\n      localStorage.removeItem(GUEST_KEY);\r\n      resetPrefsCache();\r\n      state.queue = [];\r\n      state.qIndex = 0;\r\n      await DB.init();\r\n      render();\r\n    }\r\n  }\r\n\r\n  if (action === 'accent-pick') pickAccent();\r\n  if (action === 'toggle-density') {\r\n    const cur = loadPrefs().density;\r\n    const next = cur === 'cozy' ? 'compact' : 'cozy';\r\n    savePrefs({ density: next });\r\n    render();\r\n  }\r\n  if (action === 'load-more') {\r\n    state.page++;\r\n    renderFeed($('#feed'), $('#pager'), state, DB, loadPrefs());\r\n  }\r\n\r\n  if (action === 'show-help') openHelpOverlay();\r\n\r\n  if (action === 'view-user') { e.preventDefault(); const uid = btn.dataset.uid; if (uid) showUserProfile(uid, DB); }\r\n\r\n  if (action === 'go-edit-profile') {\r\n    document.getElementById('profile')?.remove();\r\n    document.getElementById('aboutMe')?.focus();\r\n  }\r\n\r\n  if (action === 'play-all') {\r\n    // Build queue from current feed\r\n    const posts = document.querySelectorAll('#feed .post');\r\n    state.queue = Array.from(posts).map(n => n.dataset.post);\r\n    state.qIndex = 0;\r\n    updateDock(true, state, DB);\r\n    // start first\r\n    const first = state.queue[0];\r\n    if (first) {\r\n      const btn = document.querySelector(`#post-${first} [data-action=\"toggle-player\"]`);\r\n      btn?.click();\r\n    }\r\n  }\r\n\r\n  if (action === 'logout') {\r\n    // Clear all session and user data\r\n    clearSession();\r\n    setGuestMode(false);\r\n    // Supabase: sign out from all sessions on this device\r\n    if (DB.isRemote && DB.supabase && DB.supabase.auth && DB.supabase.auth.signOut) {\r\n      try { await DB.supabase.auth.signOut(); } catch (e) { /* ignore */ }\r\n    }\r\n    // Clear all localStorage and sessionStorage\r\n    try {\r\n      localStorage.clear();\r\n      sessionStorage.clear();\r\n    } catch {}\r\n    // Remove all cookies (best effort)\r\n    if (document.cookie && document.cookie.length > 0) {\r\n      document.cookie.split(';').forEach(function(c) {\r\n        const eqPos = c.indexOf('=');\r\n        const name = eqPos > -1 ? c.substr(0, eqPos) : c;\r\n        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';\r\n      });\r\n    }\r\n    // Reset prefs cache if available\r\n    if (typeof resetPrefsCache === 'function') resetPrefsCache();\r\n    // Force reload to ensure all in-memory state is reset\r\n    location.reload();\r\n  }\r\n}\r\n\r\nexport async function onDelegatedSubmit(e, state, DB, render) {\r\n  const form = e.target.closest('form[data-action=\"comment-form\"], form[data-action=\"edit-form\"], form[data-action=\"profile-form\"]');\r\n  if (!form) return;\r\n  e.preventDefault();\r\n  const pid = form.dataset.post;\r\n\r\n  if (form.dataset.action === 'comment-form') {\r\n    if (!state.user) { toast(document.getElementById('app'), 'login to comment', true); return; }\r\n    const input = form.querySelector('input');\r\n    const text = input.value.trim();\r\n    if (!text) return;\r\n    // Automoderation for comments\r\n    if (containsBannedWords(text) || looksLikeSpam(text)) {\r\n      // Remove any previous moderation message\r\n      let modMsg = form.querySelector('.mod-msg');\r\n      if (modMsg) modMsg.remove();\r\n      // Find the send button\r\n      const sendBtn = form.querySelector('button, input[type=submit], [data-action=\"send\"]');\r\n      // Create and insert the moderation message after the button\r\n      modMsg = document.createElement('div');\r\n      modMsg.className = 'mod-msg notice small warn';\r\n      modMsg.textContent = 'Comment blocked by moderation.';\r\n      if (sendBtn && sendBtn.parentNode) {\r\n        sendBtn.parentNode.insertBefore(modMsg, sendBtn.nextSibling);\r\n      } else {\r\n        form.appendChild(modMsg);\r\n      }\r\n      return;\r\n    }\r\n    const c = { id: uid('c'), userId: state.user.id, text, createdAt: Date.now() };\r\n    await DB.addComment(pid, c);\r\n    input.value = '';\r\n    const p = DB.getAll().posts.find(x => x.id === pid);\r\n    // Notify post author if not self\r\n    notifyPostComment(p, state.user);\r\n    const cwrap = document.getElementById('comments-' + pid);\r\n    cwrap.innerHTML = (p.comments || []).map(x => renderCommentHTML(x, pid, state, DB)).join('');\r\n    liveSay('comment added');\r\n    return;\r\n  }\r\n\r\n  if (form.dataset.action === 'edit-form') {\r\n    const title = form.querySelector('[name=title]').value.trim();\r\n    const artist = form.querySelector('[name=artist]').value.trim();\r\n    const url = form.querySelector('[name=url]').value.trim();\r\n    const body = form.querySelector('[name=body]').value.trim();\r\n    const tagsRaw = form.querySelector('[name=tags]').value.trim();\r\n    const tags = tagsRaw.split(/[#,\\s]+/g).map(t => t.trim().toLowerCase()).filter(Boolean).slice(0, 12);\r\n    const provider = parseProvider(url);\r\n    const updated = await DB.updatePost(pid, { title, artist, url, body, tags, provider });\r\n    const card = document.getElementById('post-' + pid);\r\n    if (card && updated) card.outerHTML = renderPostHTML(updated, state, DB);\r\n    liveSay('post updated');\r\n    return;\r\n  }\r\n\r\n  if (form.dataset.action === 'profile-form') {\r\n    if (!state.user) {\r\n      toast(document.getElementById('app'), 'login first', true);\r\n      return;\r\n    }\r\n    const about = form.querySelector('[name=about]').value.trim();\r\n    let avatarUrl = undefined;\r\n    const fileInput = form.querySelector('[name=avatar]');\r\n    const file = fileInput && fileInput.files && fileInput.files[0];\r\n    if (file) {\r\n      try {\r\n        // Check bucket existence and permissions in Supabase dashboard if this fails\r\n        const fileExt = file.name.split('.').pop();\r\n        const filePath = `avatars/${state.user.id}_${Date.now()}.${fileExt}`;\r\n        const uploadRes = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });\r\n        if (uploadRes.error) {\r\n          console.error('Avatar upload error:', uploadRes.error);\r\n          const msg = document.getElementById('profileMsg');\r\n          if (msg) msg.textContent = 'Avatar upload failed: ' + uploadRes.error.message;\r\n          return;\r\n        }\r\n        const publicUrlRes = supabase.storage.from('avatars').getPublicUrl(filePath);\r\n        if (publicUrlRes.error) {\r\n          console.error('Get public URL error:', publicUrlRes.error);\r\n          const msg = document.getElementById('profileMsg');\r\n          if (msg) msg.textContent = 'Avatar URL error: ' + publicUrlRes.error.message;\r\n          return;\r\n        }\r\n        avatarUrl = publicUrlRes.data?.publicUrl || '';\r\n      } catch (err) {\r\n        console.error('Unexpected avatar upload error:', err);\r\n        const msg = document.getElementById('profileMsg');\r\n        if (msg) msg.textContent = 'Avatar upload failed (unexpected error)';\r\n        return;\r\n      }\r\n    }\r\n    try {\r\n      const patch = avatarUrl ? { about, avatarUrl } : { about };\r\n      await DB.updateUser(state.user.id, patch);\r\n      await DB.refresh();\r\n      toast(document.getElementById('app'), 'profile updated');\r\n      render();\r\n    } catch (err) {\r\n      console.error('Profile update error:', err);\r\n      const msg = document.getElementById('profileMsg');\r\n      if (msg) msg.textContent = 'Save failed';\r\n    }\r\n    return;\r\n  }\r\n}", "// Notification integration for likes and comments\r\nimport notifications from '../core/notifications.js';\r\n\r\n// Only show notification if the current user is the post author\r\nimport { state } from './app_state.js'; // We'll create this to export the app state\r\n\r\nexport function notifyPostLike(post, liker) {\r\n  if (!post || !liker || !state.user) return;\r\n  if (post.userId !== state.user.id) return; // Only notify if current user is the author\r\n  if (post.userId === liker.id) return; // Don't notify self\r\n  notifications.add(`Your post \"${post.title}\" received a like!`, 'info');\r\n}\r\n\r\nexport function notifyPostComment(post, commenter) {\r\n  if (!post || !commenter || !state.user) return;\r\n  if (post.userId !== state.user.id) return; // Only notify if current user is the author\r\n  if (post.userId === commenter.id) return; // Don't notify self\r\n  notifications.add(`Your post \"${post.title}\" received a new comment!`, 'info');\r\n}\r\n", "import { esc } from '../core/utils.js';\r\n\r\nexport function showUserProfile(userId, DB) {\r\n  const db = DB.getAll();\r\n  const u = db.users.find(x => x.id === userId);\r\n  const userPosts = db.posts.filter(p => p.userId === userId);\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.id = 'profile';\r\n  overlay.style.position = 'fixed';\r\n  overlay.style.inset = '0';\r\n  overlay.style.background = 'rgba(0,0,0,0.4)';\r\n  overlay.style.zIndex = '10000';\r\n  overlay.innerHTML = `\r\n    <div class=\"box\" style=\"max-width:520px; margin:10vh auto; background:var(--bg,#111);\">\r\n      <div class=\"hstack\" style=\"justify-content:space-between; align-items:center\">\r\n        <div class=\"muted small\">> user profile</div>\r\n        <button class=\"btn btn-ghost\" data-close-profile=\"1\">[ close ]</button>\r\n      </div>\r\n      <div class=\"sep\"></div>\r\n      ${\r\n        u\r\n          ? `\r\n            <div style=\"display:flex; flex-direction:column; align-items:center; margin-bottom:12px;\">\r\n              <img class=\"profile-avatar\" src=\"${u.avatarUrl ? esc(u.avatarUrl) : '/assets/android-chrome-512x512.png'}\" alt=\"avatar\" />\r\n            </div>\r\n            <div class=\"title\">${esc(u.name)}</div>\r\n            <div class=\"small muted\" style=\"margin-bottom:8px\">\r\n              member since ${new Date(u.createdAt||Date.now()).toLocaleDateString()}<br>\r\n              posts: ${userPosts.length}\r\n            </div>\r\n            <div>${u.about ? esc(u.about).replace(/\\n/g,'<br>') : '<span class=\\\"muted small\\\">no about yet.</span>'}</div>\r\n            <div style=\"margin:8px 0;\">\r\n              ${(() => {\r\n                const socials = {\r\n                  facebook: u.facebook || '',\r\n                  instagram: u.instagram || '',\r\n                  twitter: u.twitter || '',\r\n                  bandcamp: u.bandcamp || '',\r\n                  soundcloud: u.soundcloud || '',\r\n                  youtube: u.youtube || '',\r\n                  lastfm: u.lastfm || ''\r\n                };\r\n                const icons = {\r\n                  facebook: '\uD83C\uDF10',\r\n                  instagram: '\uD83D\uDCF8',\r\n                  twitter: '\uD83D\uDC26',\r\n                  bandcamp: '\uD83C\uDFB5',\r\n                  soundcloud: '\u2601\uFE0F',\r\n                  youtube: '\u25B6\uFE0F',\r\n                  lastfm: '\uD83C\uDFB6'\r\n                };\r\n                function extractUser(url, type) {\r\n                  if (!url) return '';\r\n                  try {\r\n                    let u = url;\r\n                    if (type === 'bandcamp') {\r\n                      // https://username.bandcamp.com/\r\n                      const m = u.match(/https?:\\/\\/(.*?)\\.bandcamp\\.com/);\r\n                      return m ? m[1] : url;\r\n                    }\r\n                    if (type === 'youtube') {\r\n                      // If it's a video or shorts link, return a label\r\n                      if (/youtube\\.com\\/(watch\\?v=|shorts\\/)/i.test(u)) {\r\n                        return 'YouTube Video';\r\n                      }\r\n                      // Otherwise, try to extract handle/channel\r\n                      const m = u.match(/youtube\\.com\\/(?:@)?([^/?#]+)/i);\r\n                      return m ? m[1] : url;\r\n                    }\r\n                    const patterns = {\r\n                      facebook: /facebook\\.com\\/([^/?#]+)/i,\r\n                      instagram: /instagram\\.com\\/([^/?#]+)/i,\r\n                      twitter: /twitter\\.com\\/([^/?#]+)/i,\r\n                      soundcloud: /soundcloud\\.com\\/([^/?#]+)/i,\r\n                      lastfm: /last\\.fm\\/user\\/([^/?#]+)/i\r\n                    };\r\n                    if (patterns[type]) {\r\n                      const m = u.match(patterns[type]);\r\n                      return m ? m[1] : url;\r\n                    }\r\n                  } catch {}\r\n                  return url;\r\n                }\r\n                return Object.entries(socials).filter(([k,v])=>v).map(([k,v]) => {\r\n                  const user = extractUser(v, k);\r\n                  return `<a href=\\\"${esc(v)}\\\" target=\\\"_blank\\\" rel=\\\"noopener\\\" class=\\\"social-link\\\" title=\\\"${k}\\\"><span style='display:inline-flex;align-items:center;white-space:nowrap'>${icons[k]} <span class='muted small'>${esc(user)}</span></span></a>`;\r\n                }).join(' ') || '<span class=\\\"muted small\\\">no social links</span>';\r\n              })()}\r\n            </div>\r\n            <div style=\"margin:12px 0 0 0;\">\r\n              <button class=\"btn btn-ghost\" id=\"filter-user-posts-btn\" data-user-id=\"${esc(u.id)}\">[ show only this user's posts ]</button>\r\n            </div>\r\n          `\r\n          : `<div class=\"muted small\">user not found</div>`\r\n      }\r\n    </div>\r\n  `;\r\n  document.body.appendChild(overlay);\r\n  overlay.addEventListener('click', (e) => {\r\n    if (e.target.dataset.closeProfile || e.target.id === 'profile') overlay.remove();\r\n    // Filter posts by user button\r\n    if (e.target && e.target.id === 'filter-user-posts-btn') {\r\n      overlay.remove();\r\n      // Set a global filter and re-render feed\r\n      window.filterPostsByUserId = userId;\r\n      const event = new CustomEvent('filter-user-posts', { detail: { userId } });\r\n      window.dispatchEvent(event);\r\n    }\r\n  });\r\n}", "import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';\r\nimport { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';\r\n\r\nexport const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);\r\n", "import { savePrefs } from './prefs.js';\r\nimport { applyAccent } from '../core/utils.js';\r\n\r\nexport function pickAccent() {\r\n  const colors = ['#8ab4ff','#ff79c6','#7ab6ff','#7bd389','#ffd166','#ff6b6b','#c792ea','#64d2ff','#f4a261','#00e5ff'];\r\n  const palette = document.createElement('div');\r\n  palette.className = 'box';\r\n  palette.style.position='fixed';\r\n  palette.style.right='24px';\r\n  palette.style.top='24px';\r\n  palette.style.zIndex='20001'; // Ensure above overlays\r\n  palette.style.padding='10px 16px 10px 16px';\r\n  palette.style.minWidth='unset';\r\n  palette.style.maxWidth='fit-content';\r\n  palette.style.boxShadow='0 2px 12px #0008';\r\n  palette.innerHTML = `\r\n    <div class=\"small muted\" style=\"margin-bottom:4px;\">choose accent</div>\r\n    <div class=\"hstack\" style=\"margin-top:0; flex-wrap:wrap; gap:6px;\">\r\n      ${colors.map(c=>`<button class=\"btn\" data-color=\"${c}\" style=\"background:${c}20;border-color:${c}80;color:${c};width:28px;height:28px;min-width:28px;min-height:28px;font-size:18px;padding:0;line-height:1;\">\u25CF</button>`).join('')}\r\n      <button class=\"btn btn-ghost\" data-close=\"1\" style=\"margin-left:8px;\">[ close ]</button>\r\n    </div>\r\n  `;\r\n  document.body.appendChild(palette);\r\n  palette.addEventListener('click', (e) => {\r\n    const b = e.target.closest('button');\r\n    if (!b) return;\r\n    if (b.dataset.close) { palette.remove(); return; }\r\n    const c = b.dataset.color;\r\n    savePrefs({ accent: c });\r\n    applyAccent(c);\r\n  });\r\n}", "import { $, $$ } from '../core/utils.js';\r\nimport { queueNext, queuePrev, getActiveQueueId } from '../features/queue.js';\r\nimport { openHelpOverlay } from '../views/overlays.js';\r\n\r\nexport function onKey(e, state) {\r\n  const tag = e.target.tagName.toLowerCase();\r\n  if (tag === 'input' || tag === 'textarea') return;\r\n\r\n  const posts = $$('#app', '.post');\r\n  const currentId = getActiveQueueId(state);\r\n  const currentEl = currentId ? document.getElementById('post-' + currentId) : null;\r\n  let focusCard = currentEl || posts[0];\r\n\r\n  if (e.key === '/') { e.preventDefault(); $('#search')?.focus(); return; }\r\n  if (e.key.toLowerCase() === 'n') { $('#f_title')?.focus(); return; }\r\n  if (e.key.toLowerCase() === 'j') { e.preventDefault(); queueNext(false, state); return; }\r\n  if (e.key.toLowerCase() === 'k') { e.preventDefault(); queuePrev(state); return; }\r\n  if (e.key === '?') { openHelpOverlay(); return; }\r\n  if (e.key.toLowerCase() === 'l' && focusCard) {\r\n    const likeBtn = focusCard.querySelector('[data-action=\"like\"]');\r\n    likeBtn?.click(); return;\r\n  }\r\n  if (e.key.toLowerCase() === 'o' && focusCard) {\r\n    const playBtn = focusCard.querySelector('[data-action=\"toggle-player\"]');\r\n    playBtn?.click(); return;\r\n  }\r\n}", "import { parseProvider } from './providers.js';\r\nimport { uid } from '../core/utils.js';\r\n\r\nexport async function seedDemo(DB, state, render) {\r\n  // Always ensure demo user exists in DB (handles both local and remote)\r\n  let me = null;\r\n  try {\r\n    me = await DB.ensureUser('demo');\r\n  } catch (e) {\r\n    console.error('Failed to ensure demo user', e);\r\n    throw e;\r\n  }\r\n  if (!state.user) {\r\n  localStorage.setItem('TunedIn.space/session@v1', JSON.stringify({ userId: me.id }));\r\n    state.user = me;\r\n  }\r\n\r\n  const samples = [\r\n    {\r\n      title:'Selected Ambient Works 85 - 92', artist:'Aphex Twin',\r\n      url:'https://www.youtube.com/watch?v=Xw5AiRVqfqk',\r\n      tags:['idm','electronic','techno'], body:'Richard D James early work. A must hear.',\r\n    },\r\n    {\r\n      title:'\u0160lamantys', artist:'Mesijus',\r\n      url:'https://open.spotify.com/track/64rMCuIiJVT49SjLhmrHdW',\r\n      tags:['hiphop','rap','lithuanian'], body:'Lithuanian version of MF Doom.'\r\n    },\r\n    {\r\n      title:'Pints of Guiness Make You Strong', artist:'Against Me!',\r\n      url:'https://againstme.bandcamp.com/track/pints-of-guiness-make-you-strong',\r\n      tags:['punk','folk'], body:'The punk classic!'\r\n    },\r\n    {\r\n      title:'Giant Steps',\r\n      artist:'John Coltrane',\r\n      url:'https://www.youtube.com/watch?v=xy_fxxj1mMY',\r\n      tags:['jazz','bebop'],\r\n      body:'One of the greatest jazz albums of all time.'\r\n    },\r\n    {\r\n      title:'Mania',\r\n      artist:'ChildsMind',\r\n      url:'https://soundcloud.com/childsmindmusic/mania',\r\n      tags:['electronic','techno'], body:'Some fun techno from Soundcloud.'\r\n    }\r\n  ];\r\n\r\n  if (DB.isRemote && DB.replaceAll) {\r\n    // Keep only the demo user in remote DB before seeding posts\r\n    const users = [me];\r\n    await DB.replaceAll({ users, posts: [] });\r\n    await DB.refresh();\r\n  } else if (DB.getAll && DB.getAll().posts) {\r\n    DB.getAll().posts.length = 0;\r\n    await DB.refresh();\r\n  }\r\n\r\n  let firstId = null;\r\n  for (const [i, s] of samples.entries()) {\r\n    const provider = parseProvider(s.url);\r\n    const post = {\r\n      id: uid('p'),\r\n      userId: me.id,\r\n      title: s.title, artist: s.artist, url: s.url,\r\n      provider, tags: s.tags, body: s.body,\r\n      likes: [], comments: [], createdAt: Date.now()\r\n    };\r\n    if (i === 0) firstId = post.id;\r\n    await DB.createPost(post);\r\n  }\r\n  await DB.refresh();\r\n  render();\r\n\r\n  setTimeout(() => {\r\n    const btn = document.querySelector(`#post-${firstId} [data-action=\"toggle-player\"]`);\r\n    if (btn) btn.click();\r\n  }, 600);\r\n}"],
  "mappings": "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",
  "names": ["utils_exports", "__export", "$", "$$", "applyAccent", "applyDensity", "approxSize", "copyText", "debounce", "esc", "fmtBytes", "fmtTime", "isValidEmailFormat", "liveSay", "raf", "safeClone", "toast", "uid", "email", "a", "b", "root", "ta", "ok", "anchor", "msg", "warn", "note", "str", "bytes", "n", "color", "meta", "d", "init_utils", "__esmMin", "sel", "fn", "ms", "t", "args", "o", "p", "s", "m", "ts", "diff", "sec", "min", "hr", "day", "SUPABASE_URL", "SUPABASE_ANON_KEY", "init_config", "__esmMin", "db_exports", "__export", "db_default", "isDisposableEmail", "email", "domain", "parts", "i", "checkDomain", "DISPOSABLE_EMAIL_DOMAINS", "DB_KEY_V2", "DB_KEY_V1", "defaultDB", "LocalAdapter", "SupabaseAdapter", "DB", "init_db", "__esmMin", "init_utils", "init_config", "id", "u", "p", "v2", "safeClone", "v1", "old", "name", "password", "x", "salt", "hash", "user", "patch", "userId", "c", "postId", "commentId", "data", "postError", "userError", "url", "key", "createClient", "row", "uRes", "pRes", "users", "r", "posts", "authUser", "existing", "error", "post", "cur", "next", "likes", "comments", "update", "SUPABASE_URL", "SUPABASE_ANON_KEY", "session_exports", "__export", "GUEST_KEY", "SESSION_KEY", "clearSession", "getSession", "isGuestMode", "setGuestMode", "setSession", "s", "on", "init_session", "__esmMin", "safeURL", "u", "isHTTPOrigin", "origin", "parseProvider", "url", "l", "parsed", "sp", "list", "path", "id", "parts", "kind", "buildEmbed", "post", "container", "opts", "p", "wrap", "autoplay", "params", "src", "ifr", "onMessage", "ev", "data", "postListening", "embedUrl", "playerUrl", "audio", "fallbackLink", "href", "label", "a", "init_providers", "__esmMin", "normalize", "text", "containsBannedWords", "norm", "BANNED_PATTERNS", "pattern", "looksLikeSpam", "init_automod", "__esmMin", "onCreatePost", "e", "state", "DB", "render", "db", "me", "toast", "now", "lastPost", "p", "a", "b", "timeLeft", "hours", "minutes", "seconds", "errorDiv", "title", "artist", "url", "body", "tags", "captchaBox", "captchaInput", "answer", "evt", "tagsArr", "t", "seenTags", "containsBannedWords", "looksLikeSpam", "provider", "parseProvider", "dup", "removeConfirm", "confirmDiv", "actuallyCreatePost", "post", "uid", "el", "submitBtn", "rect", "left", "minWidth", "ev", "outside", "preview", "openEditInline", "postId", "opts", "cbox", "x", "card", "editBoxId", "edit", "esc", "form", "saveDraft", "draft", "init_posts", "__esmMin", "init_providers", "init_utils", "init_automod", "enableTagCloudDragScroll", "tagCloud", "isDown", "startX", "startY", "scrollLeft", "tagCloudRect", "downTag", "drag", "pointerId", "DRAG_THRESHOLD", "pointerDown", "e", "el", "pointerMove", "clientX", "clientY", "dx", "dy", "x", "pointerUp", "tagEl", "tag", "evt", "init_tagcloud_scroll", "__esmMin", "feed_exports", "__export", "getFilteredPosts", "renderCommentHTML", "renderFeed", "renderPostHTML", "renderTags", "userName", "id", "state", "DB", "u", "x", "prefs", "posts", "p", "q", "t", "a", "b", "c", "postId", "canDel", "uname", "avatarUrl", "esc", "fmtTime", "user", "me", "liked", "tgs", "perma", "canEdit", "likeCount", "commentsCount", "commentsHTML", "authorAvatar", "artistHTML", "userBy", "d", "m", "el", "pager", "openComments", "box", "commentInputs", "inp", "userId", "total", "start", "end", "chunk", "setFeedGlobals", "card", "editBoxId", "editPanel", "openEditInline", "e", "btn", "opened", "h", "node", "tc", "enableTagCloudDragScroll", "db", "sortMode", "setSortMode", "mode", "oldSortUI", "oldCloud", "top", "tagCloudDiv", "selectedTag", "rafScrollRestore", "tries", "maxTries", "tagEl", "tagRect", "cloudRect", "offset", "sortUI", "link", "init_feed", "__esmMin", "init_utils", "init_posts", "init_tagcloud_scroll", "notifications_exports", "__export", "notifications_default", "loadPersisted", "raw", "NOTIF_KEY", "arr", "now", "notifications", "init_notifications", "__esmMin", "message", "type", "timeout", "id", "expires", "n", "fn", "l", "changelog_modal_exports", "__export", "showChangelogModal", "modalBg", "modal", "closeModal", "escHandler", "e", "r", "md", "c", "init_changelog_modal", "__esmMin", "auth_exports", "__export", "currentUser", "DB", "u", "name", "init_auth", "__esmMin", "help_exports", "__export", "renderHelpOverlay", "helpHTML", "overlay", "mod", "link", "modal", "input", "confirmBtn", "cancelBtn", "errorMsg", "DB", "currentUser", "clearSession", "user", "e", "init_help", "__esmMin", "app_state_exports", "__export", "refreshUser", "state", "currentUser", "db_default", "init_app_state", "__esmMin", "init_db", "init_auth", "oembed_exports", "__export", "fetchOEmbed", "url", "canonical", "u", "v", "id", "res", "init_oembed", "__esmMin", "yt_title_parse_exports", "__export", "parseYouTubeTitle", "oembed", "dashIdx", "init_yt_title_parse", "__esmMin", "header_exports", "__export", "renderHeader", "renderMainContainers", "padLine", "str", "len", "pad", "left", "right", "headerHTML", "info", "hover", "lastType", "readyMessages", "readyMsgIndex", "readyMsgAnimTimer", "readyMsgFading", "style", "getCountdown", "db", "me", "now", "lastPost", "p", "a", "b", "timeLeft", "hours", "minutes", "seconds", "setTextWithFade", "newText", "typeChanged", "updatePostLimitInfo", "type", "nextIndex", "scheduleNext", "nextDelay", "countdown", "header", "wrap", "main", "live", "init_header", "__esmMin", "init_db", "init_utils", "init_utils", "PREF_KEY", "defaultPrefs", "PREFS", "loadPrefs", "raw", "applyAccent", "applyDensity", "savePrefs", "p", "resetPrefsCache", "init_session", "helpClickBound", "openHelpOverlay", "help", "closeHelpOverlay", "bindHelpOverlay", "helpOverlay", "init_utils", "init_utils", "getActiveQueueId", "state", "updateDock", "showIfHidden", "DB", "dock", "$", "len", "qLen", "qPos", "prefs", "loadPrefs", "shuffleBtn", "repeatBtn", "id", "p", "x", "now", "chk", "e", "c", "queuePrev", "jumpToQueueItem", "queueNext", "auto", "n", "idx", "card", "scrollY", "pl", "btn", "markNowPlaying", "postId", "init_utils", "onImport", "e", "DB", "state", "render", "file", "text", "data", "toast", "err", "init_utils", "init_feed", "init_tagcloud_scroll", "init_notifications", "setupFeedPane", "root", "left", "state", "DB", "prefs", "render", "BANNER_KEY", "popup", "close", "e", "userMenuHelpBtn", "mod", "link", "el", "err", "style", "db", "me", "userFilterId", "filteredPosts", "getFilteredPosts", "p", "postCount", "top", "esc", "userBtn", "userActionsContainer", "userPill", "userActionButtons", "prefsNow", "loadPrefs", "dock", "activePlayer", "ifr", "playingPost", "playAllLabel", "tagsBox", "feedBox", "u", "doRender", "tagCloud", "latestPrefs", "renderFeed", "$", "renderTags", "enableTagCloudDragScroll", "searchInput", "debounce", "savePrefs", "sortIcons", "btn", "sortType", "init_utils", "setupMobileDotLogic", "mobileDot", "state", "allNotifications", "notifications", "updateDot", "list", "n", "x", "popup", "closePopup", "handleDotActivate", "e", "rect", "time", "fmtTime", "outsideClick", "ev", "isGuest", "dot", "renderProfileBox", "right", "DB", "render", "getSocialUsername", "val", "type", "v", "match", "db", "me", "meUser", "u", "myAbout", "myAvatar", "socials", "renderSocialLinks", "s", "icons", "formatSocial", "input", "cleaned", "lastfmMatch", "_", "k", "url", "esc", "box", "avatarFileInput", "avatarFileName", "profileTitle", "aboutCollapsed", "aboutEditForm", "editBtn", "cancelBtn", "form", "about", "facebook", "instagram", "twitter", "bandcamp", "soundcloud", "youtube", "lastfm", "PROMPT_STUCK", "PROMPT_SHARE", "PROMPT_LOOPING", "PROMPT_HIDDEN_GEM", "PROMPT_TUNE", "PROMPT_MOOD", "PROMPT_MEMORY", "PROMPT_DISCOVER", "PROMPT_VIBE", "PROMPT_REPEAT", "PROMPT_SOUNDTRACK", "PROMPT_FIRST", "PROMPT_LAST", "PROMPT_MORNING", "PROMPT_NIGHT", "PROMPT_FAVORITE_LYRICS", "PROMPT_UNDERRATED", "PROMPT_DANCE", "PROMPT_CHILL", "PROMPT_INSPIRE", "PROMPT_TRAVEL", "PROMPT_FRIEND", "PROMPTS", "init_utils", "init_posts", "init_providers", "getComposePrompt", "PROMPTS", "renderComposeBox", "right", "state", "DB", "render", "setPrompt", "prompt", "lastPrompt", "i", "promptDiv", "typeWriter", "delay", "guest", "box", "updateCooldown", "db", "me", "postBtn", "cooldownDiv", "now", "lastPost", "p", "a", "b", "timeLeft", "hours", "minutes", "seconds", "composerFields", "promptTimeouts", "clearPromptTimeouts", "t", "del", "stopAt", "backspace", "autofillMsg", "field", "urlField", "f", "previewBtn", "preview", "$", "title", "artist", "url", "tags", "body", "pv", "parseProvider", "fakePost", "mod", "html", "f_url", "maybeResetAutofill", "f_title", "f_artist", "lastMetaUrl", "lastAutofill", "userEdited", "fetchOEmbed", "meta", "ytArtist", "ytTitle", "parseYouTubeTitle", "parsed", "autofillTitle", "autofillArtist", "setCaptcha", "postForm", "e", "onCreatePost", "f_tags", "tagSuggestions", "dedupeTagsInput", "val", "seen", "deduped", "trailing", "getPopularTags", "m", "renderTagSuggestions", "filter", "usedTags", "filtered", "esc", "maybeShowSuggestions", "last", "current", "tag", "before", "after", "newVal", "init_utils", "init_feed", "smartRefresh", "state", "DB", "activePlayer", "feedEl", "$", "pagerEl", "tagsEl", "tagCloud", "prefs", "loadPrefs", "renderFeed", "renderTags", "posts", "getFilteredPosts", "p", "postEl", "likeBtn", "pressed", "commentBtn", "existingIds", "el", "newPosts", "mod", "html", "setupAutoRefresh", "setupVisibilityRefresh", "instantRefresh", "renderMain", "root", "state", "DB", "render", "prefs", "loadPrefs", "banner", "grid", "left", "right", "isMobile", "lastIsMobile", "nowMobile", "oldTabBar", "currentTab", "showTab", "tab", "renderProfileBox", "renderComposeBox", "btn", "setupFeedPane", "moveIndicator", "idx", "tabBtns", "b", "indicator", "tabBar", "e", "nextIdx", "updateDock", "setupAutoRefresh", "setupVisibilityRefresh", "importFile", "$", "onImport", "chk", "savePrefs", "init_utils", "loginPrompts", "PROMPTS", "rand", "min", "max", "measureTextWidth", "text", "el", "cs", "probe", "w", "computeScaleToFit", "containerWidth", "basePx", "prevInline", "textWidth", "startPromptAnimation", "target", "options", "prompts", "typeMin", "typeMax", "eraseMin", "eraseMax", "holdMs", "pauseBetween", "idx", "char", "erase", "timer", "stopped", "currentPrompt", "currentScale", "applyScaleForCurrentPrompt", "res", "nextPrompt", "onResize", "tick", "currentStopper", "startLoginPromptAnimation", "stopLoginPromptAnimation", "init_session", "init_header", "renderLogin", "root", "DB", "render", "banner", "prevBodyOverflow", "prevHtmlOverflow", "div", "logo", "header", "restoreOverflow", "wrappedRender", "args", "renderHeader", "stopRegisterPrompt", "showLoginForm", "setGuestMode", "$", "startLoginPromptAnimation", "showRegisterForm", "stopLoginPromptAnimation", "regEl", "startPromptAnimation", "e", "name", "email", "pass", "utils", "dbmod", "proceed", "u", "data", "error", "setSession", "err", "clearSession", "userObj", "init_utils", "init_providers", "init_session", "init_feed", "init_notifications", "init_app_state", "notifyPostLike", "post", "liker", "state", "notifications_default", "notifyPostComment", "commenter", "init_automod", "init_posts", "init_utils", "showUserProfile", "userId", "DB", "db", "u", "x", "userPosts", "p", "overlay", "esc", "socials", "icons", "extractUser", "url", "type", "m", "patterns", "k", "v", "user", "e", "event", "import_esm", "init_config", "supabase", "SUPABASE_URL", "SUPABASE_ANON_KEY", "init_utils", "pickAccent", "colors", "palette", "c", "e", "b", "savePrefs", "applyAccent", "onActionClick", "e", "state", "DB", "render", "btn", "action", "root", "$", "card", "postId", "pl", "otherPl", "otherCard", "p", "x", "toast", "buildEmbed", "queueNext", "markNowPlaying", "loadPrefs", "updated", "post", "notifyPostLike", "likeBtn", "removeConfirm", "confirmDiv", "el", "rect", "left", "minWidth", "ev", "outside", "lastCard", "lastEditBoxId", "lastOpened", "lastCbox", "cbox", "inp", "prevScroll", "pid", "cid", "com", "c", "cwrap", "renderCommentHTML", "liveSay", "setGuestMode", "perma", "db", "title", "copyText", "updateDock", "t", "savePrefs", "queuePrev", "order", "cur", "next", "PREF_KEY", "SESSION_KEY", "GUEST_KEY", "resetPrefsCache", "pickAccent", "renderFeed", "openHelpOverlay", "uid", "showUserProfile", "posts", "n", "first", "clearSession", "eqPos", "name", "onDelegatedSubmit", "form", "input", "text", "containsBannedWords", "looksLikeSpam", "modMsg", "sendBtn", "notifyPostComment", "artist", "url", "body", "tags", "provider", "parseProvider", "renderPostHTML", "about", "avatarUrl", "fileInput", "file", "fileExt", "filePath", "uploadRes", "supabase", "msg", "publicUrlRes", "err", "patch", "init_utils", "onKey", "e", "state", "tag", "posts", "$$", "currentId", "getActiveQueueId", "focusCard", "$", "queueNext", "queuePrev", "openHelpOverlay", "init_providers", "init_utils", "seedDemo", "DB", "state", "render", "me", "e", "samples", "users", "firstId", "i", "s", "provider", "parseProvider", "post", "uid", "btn", "init_app_state", "init_header", "init_help", "renderApp", "db_default", "refreshUser", "prefs", "loadPrefs", "root", "$", "banner", "body", "state", "renderLogin", "isGuestMode", "renderHeader", "renderMain", "bindHelpOverlay", "bindGlobalHandlers", "e", "onActionClick", "onDelegatedSubmit", "help", "onKey", "card", "sel", "ev", "PREF_KEY", "SESSION_KEY", "GUEST_KEY", "boot", "seedDemo", "renderMainContainers", "renderHelpOverlay", "info", "hover", "lastType", "lastCountdown", "style", "getCountdown", "db", "me", "now", "lastPost", "p", "a", "b", "timeLeft", "hours", "minutes", "seconds", "setTextWithFade", "newText", "typeChanged", "updatePostLimitInfo", "type", "countdown"]
}
