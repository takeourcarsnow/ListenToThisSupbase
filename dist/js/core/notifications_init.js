(()=>{var I=Object.create;var g=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var C=(a=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(a,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):a)(function(a){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+a+'" is not supported')});var D=(a,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of A(t))!E.call(a,r)&&r!==e&&g(a,r,{get:()=>t[r],enumerable:!(s=U(t,r))||s.enumerable});return a};var T=(a,t,e)=>(e=a!=null?I(k(a)):{},D(t||!a||!a.__esModule?g(e,"default",{value:a,enumerable:!0}):e,a));var b="tunedin.notifications";function N(){try{let a=localStorage.getItem(b);if(!a)return[];let t=JSON.parse(a),e=Date.now();return t.filter(s=>!s.expires||s.expires>e)}catch{return[]}}var P={list:N(),add(a,t="info",e=4e3){let s=Date.now()+Math.random(),r;return e>0&&(r=Date.now()+e),this.list.push({id:s,message:a,type:t,expires:r}),this._persist(),this._notifyChange(),e>0&&setTimeout(()=>this.remove(s),e),s},remove(a){this.list=this.list.filter(t=>t.id!==a),this._persist(),this._notifyChange()},clear(){this.list=[],this._persist(),this._notifyChange()},_listeners:[],subscribe(a){return this._listeners.push(a),()=>{this._listeners=this._listeners.filter(t=>t!==a)}},_notifyChange(){this._listeners.forEach(a=>a(this.list))},_persist(){try{localStorage.setItem(b,JSON.stringify(this.list))}catch{}}},c=P;var w="notifications-popup-container",O={container:null,currentTimeout:null,init(){document.getElementById(w)||(this.container=document.createElement("div"),this.container.id=w,this.container.style.position="fixed",this.container.style.top="0",this.container.style.left="50%",this.container.style.transform="translateX(-50%)",this.container.style.zIndex="9999",this.container.style.width="100%",this.container.style.maxWidth="400px",this.container.style.pointerEvents="none",this.container.style.display="flex",this.container.style.justifyContent="center",this.container.style.alignItems="flex-start",this.container.style.background="none",this.container.style.border="none",this.container.style.boxShadow="none",this.container.style.transition="none",document.body.appendChild(this.container),c.subscribe(this.render.bind(this)),this.render(c.list))},render(a){if(!this.container||(this.container.innerHTML="",!a.length))return;let t="tunedin.notifications.lastSeen",e=+(localStorage.getItem(t)||0),s=a.filter(i=>i.id>e);if(!s.length)return;let r=Math.max(...s.map(i=>i.id));r>e&&(localStorage.setItem(t,String(r)),e=r),s.forEach(i=>{let n=document.createElement("div");n.textContent=i.message,n.className=`notification-popup ${i.type}`,n.style.pointerEvents="auto",n.style.minWidth="180px",n.style.maxWidth="360px",n.style.margin="0 auto",n.style.marginTop="16px",n.style.padding="12px 24px",n.style.borderRadius="8px",n.style.background=i.type==="success"?"#4caf50":i.type==="error"?"#f44336":"#222e3a",n.style.color="#fff",n.style.fontWeight="500",n.style.fontSize="1.08em",n.style.boxShadow="0 4px 24px rgba(0,0,0,0.18)",n.style.opacity="0",n.style.transform="translateY(-32px)",n.style.transition="opacity 0.3s cubic-bezier(.4,0,.2,1), transform 0.3s cubic-bezier(.4,0,.2,1)",n.style.textAlign="center",setTimeout(()=>{n.style.opacity="1",n.style.transform="translateY(0)"},10),n.onclick=()=>c.remove(i.id),this.container.appendChild(n)}),this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=null}},x=O;var m=a=>typeof structuredClone=="function"?structuredClone(a):JSON.parse(JSON.stringify(a));var h="https://ykwbnqaobcirrpunnkkn.supabase.co",f="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrd2JucWFvYmNpcnJwdW5ua2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDcwMjcsImV4cCI6MjA3MTE4MzAyN30.qoZg10-v6rmqW6RZDj9SGYio_DblzSfP3RTPBMoJBuM";var M=["mailinator.com","10minutemail.com","guerrillamail.com","tempmail.com","yopmail.com","trashmail.com","getnada.com","dispostable.com","maildrop.cc","fakeinbox.com","mintemail.com","mytemp.email","throwawaymail.com","sharklasers.com","spamgourmet.com","mailnesia.com","temp-mail.org","emailondeck.com","moakt.com","mailcatch.com","mailnull.com","33mail.com","mailtemp.net","tempail.com","tempmail.net","tempmailaddress.com","tempmailbox.com","tempmails.net","trashmail.de","maildrop.cc","disposablemail.com","spambog.com","spambog.de","spambog.ru","spambog.xyz","spambog.pl","spambog.com","spambog.de","spambog.ru","spambog.xyz","spambog.pl","spam4.me","spamex.com","spaml.com","spammail.de","spammail.net","spammail.org","spamobox.com","spamspot.com","spamwc.com"];function q(a){if(!a||typeof a!="string")return!1;let t=a.split("@")[1]?.toLowerCase();if(!t)return!1;let e=t.split(".");for(let s=0;s<e.length-1;s++){let r=e.slice(s).join(".");if(M.includes(r))return!0}return!1}var S="TunedIn.space/db@v2",J="TunedIn.space/v1",u={users:[],posts:[],createdAt:Date.now(),version:2},p=class{async deleteUser(t){await this.init();let e=(this.cache.users||[]).findIndex(s=>s.id===t);return e<0?!1:(this.cache.users.splice(e,1),this.cache.posts=(this.cache.posts||[]).filter(s=>s.userId!==t),await this._save(),!0)}constructor(){this.cache=null,this.isRemote=!1}async init(){if(this.cache)return this.cache;let t=localStorage.getItem(S);if(t){try{this.cache=JSON.parse(t)}catch{this.cache=m(u)}return this.cache}let e=localStorage.getItem(J);if(e){try{let s=JSON.parse(e);this.cache={...u,...s,version:2},await this._save()}catch{this.cache=m(u)}return this.cache}return this.cache=m(u),this.cache}getAll(){return this.cache||u}async refresh(){return this.cache}async _save(){try{localStorage.setItem(S,JSON.stringify(this.cache))}catch{}}async ensureUser(t,e,s){if(await this.init(),!e||!s||s.length<6)throw new Error("Email and password (min 6 chars) are required.");if(q(e))throw new Error("Disposable (temporary) email addresses are not allowed.");let r=this.cache.users.find(i=>i.name.toLowerCase()===t.toLowerCase()||e&&i.email===e);if(!r){let i=window.bcrypt.genSaltSync(10),n=window.bcrypt.hashSync(s,i);r={id:crypto.randomUUID?crypto.randomUUID():"u_"+Math.random().toString(36).slice(2),name:t.trim(),email:e,password:n,about:"",facebook:"",instagram:"",twitter:"",bandcamp:"",soundcloud:"",youtube:"",lastfm:"",createdAt:Date.now()},this.cache.users.push(r),await this._save()}return r}async loginUser(t,e){if(await this.init(),!t||!e||e.length<6)return null;let s=this.cache.users.find(i=>i.email===t);return!s||!s.password||s.password.length<6?null:window.bcrypt.compareSync(e,s.password)?s:null}getUserById(t){return(this.cache?.users||[]).find(e=>e.id===t)||null}async createPost(t){return await this.init(),this.cache.posts.push(t),await this._save(),t}async updatePost(t,e){await this.init();let s=this.cache.posts.findIndex(r=>r.id===t);return s<0?null:(this.cache.posts[s]={...this.cache.posts[s],...e},await this._save(),this.cache.posts[s])}async deletePost(t){await this.init();let e=this.cache.posts.findIndex(s=>s.id===t);e<0||(this.cache.posts.splice(e,1),await this._save())}async toggleLike(t,e){await this.init();let s=this.cache.posts.find(i=>i.id===t);if(!s)return null;s.likes=s.likes||[];let r=s.likes.indexOf(e);return r>=0?s.likes.splice(r,1):s.likes.push(e),await this._save(),s}async addComment(t,e){await this.init();let s=this.cache.posts.find(r=>r.id===t);return s?(s.comments=s.comments||[],s.comments.push(e),await this._save(),s.comments):null}async deleteComment(t,e){await this.init();let s=this.cache.posts.find(r=>r.id===t);return s?(s.comments=(s.comments||[]).filter(r=>r.id!==e),await this._save(),s.comments):null}async updateUser(t,e){await this.init();let s=(this.cache.users||[]).findIndex(r=>r.id===t);return s<0?null:(this.cache.users[s]={...this.cache.users[s],...e},await this._save(),this.cache.users[s])}async replaceAll(t){this.cache={version:2,createdAt:Date.now(),users:t.users||[],posts:t.posts||[]},await this._save()}exportJSON(){return JSON.stringify(this.cache||u,null,2)}},y=class{async deleteUser(t){let{error:e}=await this.supabase.from("posts").delete().eq("user_id",t);e&&console.error("deleteUser posts error",e);let{error:s}=await this.supabase.from("users").delete().eq("id",t);return s&&console.error("deleteUser user error",s),await this.refresh(),!s}constructor(t,e){this.isRemote=!0,this.supabase=null,this.cache={...u},this.url=t,this.key=e}async init(){if(!this.supabase){let{createClient:t}=await import("https://esm.sh/@supabase/supabase-js@2");this.supabase=t(this.url,this.key)}return await this.refresh(),this.cache}mapRowToPost(t){return{id:t.id,userId:t.user_id,title:t.title,artist:t.artist,url:t.url,provider:t.provider||null,tags:t.tags||[],body:t.body||"",likes:t.likes||[],comments:t.comments||[],createdAt:t.created_at?new Date(t.created_at).getTime():Date.now()}}mapPostToRow(t){return{id:t.id,user_id:t.userId,title:t.title,artist:t.artist||null,url:t.url,provider:t.provider||null,tags:t.tags||[],body:t.body||null,likes:t.likes||[],comments:t.comments||[],created_at:new Date(t.createdAt||Date.now()).toISOString()}}mapRowToUser(t){return{id:t.id,name:t.name,about:t.about||"",facebook:t.facebook||"",instagram:t.instagram||"",twitter:t.twitter||"",bandcamp:t.bandcamp||"",soundcloud:t.soundcloud||"",youtube:t.youtube||"",lastfm:t.lastfm||"",avatarUrl:t.avatarurl||"",createdAt:t.created_at?new Date(t.created_at).getTime():Date.now()}}async refresh(){let[t,e]=await Promise.all([this.supabase.from("users").select("*").order("created_at",{ascending:!0}),this.supabase.from("posts").select("*").order("created_at",{ascending:!1})]);t.error&&console.warn("Supabase users error",t.error),e.error&&console.warn("Supabase posts error",e.error);let s=(t.data||[]).map(i=>this.mapRowToUser(i)),r=(e.data||[]).map(i=>this.mapRowToPost(i));return this.cache={version:2,createdAt:this.cache.createdAt||Date.now(),users:s,posts:r},this.cache}getAll(){return this.cache}async ensureUser(t){let e=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let n=await this.supabase.auth.getUser();e=n?.data?.user?.id||n?.user?.id}if(!e)throw new Error("No authenticated user");let s=this.cache.users.find(n=>n.id===e||n.name.toLowerCase()===t.toLowerCase());if(s)return s;let r={id:e,name:t.trim(),about:"",createdAt:Date.now()},{error:i}=await this.supabase.from("users").insert({id:r.id,name:r.name,about:r.about,created_at:new Date(r.createdAt).toISOString()});return i&&console.warn("ensureUser insert failed",i),this.cache.users.push(r),r}getUserById(t){return this.cache.users.find(e=>e.id===t)||null}async createPost(t){let e=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let i=await this.supabase.auth.getUser();e=i?.data?.user?.id||i?.user?.id}if(!e)throw new Error("No authenticated user");let s={...this.mapPostToRow(t),user_id:e},{error:r}=await this.supabase.from("posts").insert(s);return r&&console.error("createPost error",r),await this.refresh(),this.cache.posts.find(i=>i.id===t.id)}async updatePost(t,e){let s=this.cache.posts.find(o=>o.id===t);if(!s)return null;let r={...s,...e},i=this.mapPostToRow(r),{error:n}=await this.supabase.from("posts").update(i).eq("id",t);return n&&console.error("updatePost error",n),await this.refresh(),this.cache.posts.find(o=>o.id===t)}async deletePost(t){let{error:e}=await this.supabase.from("posts").delete().eq("id",t);e&&console.error("deletePost error",e),await this.refresh()}async toggleLike(t,e){let s=this.cache.posts.find(o=>o.id===t);if(!s)return null;let r=Array.isArray(s.likes)?[...s.likes]:[],i=r.indexOf(e);i>=0?r.splice(i,1):r.push(e);let{error:n}=await this.supabase.from("posts").update({likes:r}).eq("id",t);return n&&console.error("toggleLike error",n),await this.refresh(),this.cache.posts.find(o=>o.id===t)}async addComment(t,e){let s=this.cache.posts.find(o=>o.id===t);if(!s)return null;let r=Array.isArray(s.comments)?[...s.comments]:[];r.push(e);let{error:i}=await this.supabase.from("posts").update({comments:r}).eq("id",t);i&&console.error("addComment error",i),await this.refresh();let n=this.cache.posts.find(o=>o.id===t);return n?n.comments:r}async deleteComment(t,e){let s=this.cache.posts.find(o=>o.id===t);if(!s)return null;let r=(s.comments||[]).filter(o=>o.id!==e),{error:i}=await this.supabase.from("posts").update({comments:r}).eq("id",t);i&&console.error("deleteComment error",i),await this.refresh();let n=this.cache.posts.find(o=>o.id===t);return n?n.comments:r}async updateUser(t,e){let s=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let n=await this.supabase.auth.getUser();s=n?.data?.user?.id||n?.user?.id}if(!s)throw new Error("No authenticated user");let r={};if(e.name!==void 0&&(r.name=e.name),e.about!==void 0&&(r.about=e.about),e.avatarUrl!==void 0&&(r.avatarurl=e.avatarUrl),e.facebook!==void 0&&(r.facebook=e.facebook),e.instagram!==void 0&&(r.instagram=e.instagram),e.twitter!==void 0&&(r.twitter=e.twitter),e.bandcamp!==void 0&&(r.bandcamp=e.bandcamp),e.soundcloud!==void 0&&(r.soundcloud=e.soundcloud),e.youtube!==void 0&&(r.youtube=e.youtube),e.lastfm!==void 0&&(r.lastfm=e.lastfm),Object.keys(r).length===0)return this.getUserById(s);let{error:i}=await this.supabase.from("users").update(r).eq("id",s);return i&&console.error("updateUser error",i),await this.refresh(),this.getUserById(s)}async replaceAll(t){await this.supabase.from("posts").delete().neq("id",""),await this.supabase.from("users").delete().neq("id","");let e=(t.users||[]).map(r=>({id:r.id,name:r.name,about:r.about||null,created_at:new Date(r.createdAt||Date.now()).toISOString()}));if(e.length){let{error:r}=await this.supabase.from("users").upsert(e);r&&console.error("replaceAll users error",r)}let s=(t.posts||[]).map(r=>({...this.mapPostToRow(r)}));if(s.length){let{error:r}=await this.supabase.from("posts").upsert(s);r&&console.error("replaceAll posts error",r)}await this.refresh()}exportJSON(){return JSON.stringify(this.cache,null,2)}},R=h&&f?new y(h,f):new p,l=R;var d={user:null,queue:[],qIndex:0,pageSize:30,page:1,forceLogin:!1};function v(a){return`tunedin_post_activity_${a}`}function L(a){try{return JSON.parse(localStorage.getItem(v(a))||"{}")}catch{return{}}}function z(a,t){localStorage.setItem(v(a),JSON.stringify(t))}async function _(){if(!d.user)return;l.refresh&&await l.refresh();let t=l.getAll().posts.filter(r=>r.userId===d.user.id),e=L(d.user.id),s=!1;t.forEach(r=>{let i=e[r.id]||{likes:0,comments:0};(r.likes?.length||0)>i.likes&&(c.add(`Your post "${r.title}" received a new like!`,"info"),s=!0),(r.comments?.length||0)>i.comments&&(c.add(`Your post "${r.title}" received a new comment!`,"info"),s=!0),e[r.id]={likes:r.likes?.length||0,comments:r.comments?.length||0}}),s&&z(d.user.id,e)}window.addEventListener("DOMContentLoaded",function(){x.init(),setTimeout(()=>{_(),setInterval(_,1e4)},1e3)});})();
//# sourceMappingURL=notifications_init.js.map
