(()=>{var Vt=Object.create;var $e=Object.defineProperty;var Xt=Object.getOwnPropertyDescriptor;var Zt=Object.getOwnPropertyNames;var Qt=Object.getPrototypeOf,eo=Object.prototype.hasOwnProperty;var dt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,o)=>(typeof require<"u"?require:e)[o]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var N=(t,e)=>()=>(t&&(e=t(t=0)),e);var F=(t,e)=>{for(var o in e)$e(t,o,{get:e[o],enumerable:!0})},to=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Zt(e))!eo.call(t,s)&&s!==o&&$e(t,s,{get:()=>e[s],enumerable:!(n=Xt(e,s))||n.enumerable});return t};var oo=(t,e,o)=>(o=t!=null?Vt(Qt(t)):{},to(e||!t||!t.__esModule?$e(o,"default",{value:t,enumerable:!0}):o,t));var pt={};F(pt,{$:()=>T,$$:()=>_e,applyAccent:()=>Z,applyDensity:()=>ue,approxSize:()=>ut,copyText:()=>ke,debounce:()=>Be,esc:()=>A,fmtBytes:()=>mt,fmtTime:()=>K,isValidEmailFormat:()=>no,liveSay:()=>de,raf:()=>so,safeClone:()=>ce,toast:()=>B,uid:()=>G});function no(t){return/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t)}function _e(t,e){if(!e)return Array.from(document.querySelectorAll(t));let o=typeof t=="string"?document.querySelector(t):t;return Array.from(o?o.querySelectorAll(e):[])}function ke(t){if(navigator.clipboard&&location.protocol!=="file:")return navigator.clipboard.writeText(t);{let e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),e.setSelectionRange(0,99999);let o=document.execCommand&&document.execCommand("copy");return e.remove(),o?Promise.resolve():Promise.reject()}}function B(t,e,o){let n=document.createElement("div");n.className="notice small",n.textContent=e,o&&n.classList.add("warn"),(t?.parentNode||document.body).insertBefore(n,t?.nextSibling||null),setTimeout(()=>n.remove(),1500)}function ut(t){let e=new Blob([t]).size;return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/1024/1024).toFixed(2)+" MB"}function mt(t){return t<1024?t+" B":t<1024*1024?(t/1024).toFixed(1)+" KB":t<1024*1024*1024?(t/1024/1024).toFixed(2)+" MB":(t/1024/1024/1024).toFixed(2)+" GB"}function Z(t){try{document.documentElement.style.setProperty("--acc",t||"#8ab4ff");let e=document.querySelector('meta[name="theme-color"]');e&&e.setAttribute("content","#0b0d10")}catch{}}function ue(t){document.documentElement.setAttribute("data-density",t||"cozy")}var T,so,Be,ce,G,A,K,de,_=N(()=>{T=(t,e=document)=>e.querySelector(t);so=t=>requestAnimationFrame(t),Be=(t,e=200)=>{let o;return(...n)=>{clearTimeout(o),o=setTimeout(()=>t(...n),e)}},ce=t=>typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t)),G=(t="id")=>t+"_"+Math.random().toString(36).slice(2,8)+Date.now().toString(36),A=t=>String(t).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[e]),K=t=>{let e=new Date(t),o=Date.now()-t,n=Math.round(o/1e3),s=Math.round(n/60),i=Math.round(s/60),a=Math.round(i/24);return n<45?"just now":s<60?`${s}m ago`:i<24?`${i}h ago`:a<7?`${a}d ago`:e.toLocaleString()},de=t=>{let e=T("#live");e&&(e.textContent=t)}});var me,pe,Re=N(()=>{me="https://ykwbnqaobcirrpunnkkn.supabase.co",pe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrd2JucWFvYmNpcnJwdW5ua2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDcwMjcsImV4cCI6MjA3MTE4MzAyN30.qoZg10-v6rmqW6RZDj9SGYio_DblzSfP3RTPBMoJBuM"});var Oe={};F(Oe,{default:()=>O});function ro(t){if(!t||typeof t!="string")return!1;let e=t.split("@")[1]?.toLowerCase();if(!e)return!1;let o=e.split(".");for(let n=0;n<o.length-1;n++){let s=o.slice(n).join(".");if(ao.includes(s))return!0}return!1}var ao,ft,lo,Q,Ne,Ue,co,O,fe=N(()=>{_();Re();ao=["mailinator.com","10minutemail.com","guerrillamail.com","tempmail.com","yopmail.com","trashmail.com","getnada.com","dispostable.com","maildrop.cc","fakeinbox.com","mintemail.com","mytemp.email","throwawaymail.com","sharklasers.com","spamgourmet.com","mailnesia.com","temp-mail.org","emailondeck.com","moakt.com","mailcatch.com","mailnull.com","33mail.com","mailtemp.net","tempail.com","tempmail.net","tempmailaddress.com","tempmailbox.com","tempmails.net","trashmail.de","maildrop.cc","disposablemail.com","spambog.com","spambog.de","spambog.ru","spambog.xyz","spambog.pl","spambog.com","spambog.de","spambog.ru","spambog.xyz","spambog.pl","spam4.me","spamex.com","spaml.com","spammail.de","spammail.net","spammail.org","spamobox.com","spamspot.com","spamwc.com"];ft="TunedIn.space/db@v2",lo="TunedIn.space/v1",Q={users:[],posts:[],createdAt:Date.now(),version:2},Ne=class{async deleteUser(e){await this.init();let o=(this.cache.users||[]).findIndex(n=>n.id===e);return o<0?!1:(this.cache.users.splice(o,1),this.cache.posts=(this.cache.posts||[]).filter(n=>n.userId!==e),await this._save(),!0)}constructor(){this.cache=null,this.isRemote=!1}async init(){if(this.cache)return this.cache;let e=localStorage.getItem(ft);if(e){try{this.cache=JSON.parse(e)}catch{this.cache=ce(Q)}return this.cache}let o=localStorage.getItem(lo);if(o){try{let n=JSON.parse(o);this.cache={...Q,...n,version:2},await this._save()}catch{this.cache=ce(Q)}return this.cache}return this.cache=ce(Q),this.cache}getAll(){return this.cache||Q}async refresh(){return this.cache}async _save(){try{localStorage.setItem(ft,JSON.stringify(this.cache))}catch{}}async ensureUser(e,o,n){if(await this.init(),!o||!n||n.length<6)throw new Error("Email and password (min 6 chars) are required.");if(ro(o))throw new Error("Disposable (temporary) email addresses are not allowed.");let s=this.cache.users.find(i=>i.name.toLowerCase()===e.toLowerCase()||o&&i.email===o);if(!s){let i=window.bcrypt.genSaltSync(10),a=window.bcrypt.hashSync(n,i);s={id:crypto.randomUUID?crypto.randomUUID():"u_"+Math.random().toString(36).slice(2),name:e.trim(),email:o,password:a,about:"",facebook:"",instagram:"",twitter:"",bandcamp:"",soundcloud:"",youtube:"",lastfm:"",createdAt:Date.now()},this.cache.users.push(s),await this._save()}return s}async loginUser(e,o){if(await this.init(),!e||!o||o.length<6)return null;let n=this.cache.users.find(i=>i.email===e);return!n||!n.password||n.password.length<6?null:window.bcrypt.compareSync(o,n.password)?n:null}getUserById(e){return(this.cache?.users||[]).find(o=>o.id===e)||null}async createPost(e){return await this.init(),this.cache.posts.push(e),await this._save(),e}async updatePost(e,o){await this.init();let n=this.cache.posts.findIndex(s=>s.id===e);return n<0?null:(this.cache.posts[n]={...this.cache.posts[n],...o},await this._save(),this.cache.posts[n])}async deletePost(e){await this.init();let o=this.cache.posts.findIndex(n=>n.id===e);o<0||(this.cache.posts.splice(o,1),await this._save())}async toggleLike(e,o){await this.init();let n=this.cache.posts.find(i=>i.id===e);if(!n)return null;n.likes=n.likes||[];let s=n.likes.indexOf(o);return s>=0?n.likes.splice(s,1):n.likes.push(o),await this._save(),n}async addComment(e,o){await this.init();let n=this.cache.posts.find(s=>s.id===e);return n?(n.comments=n.comments||[],n.comments.push(o),await this._save(),n.comments):null}async deleteComment(e,o){await this.init();let n=this.cache.posts.find(s=>s.id===e);return n?(n.comments=(n.comments||[]).filter(s=>s.id!==o),await this._save(),n.comments):null}async updateUser(e,o){await this.init();let n=(this.cache.users||[]).findIndex(s=>s.id===e);return n<0?null:(this.cache.users[n]={...this.cache.users[n],...o},await this._save(),this.cache.users[n])}async replaceAll(e){this.cache={version:2,createdAt:Date.now(),users:e.users||[],posts:e.posts||[]},await this._save()}exportJSON(){return JSON.stringify(this.cache||Q,null,2)}},Ue=class{async deleteUser(e){let{error:o}=await this.supabase.from("posts").delete().eq("user_id",e);o&&console.error("deleteUser posts error",o);let{error:n}=await this.supabase.from("users").delete().eq("id",e);return n&&console.error("deleteUser user error",n),await this.refresh(),!n}constructor(e,o){this.isRemote=!0,this.supabase=null,this.cache={...Q},this.url=e,this.key=o}async init(){if(!this.supabase){let{createClient:e}=await import("https://esm.sh/@supabase/supabase-js@2");this.supabase=e(this.url,this.key)}return await this.refresh(),this.cache}mapRowToPost(e){return{id:e.id,userId:e.user_id,title:e.title,artist:e.artist,url:e.url,provider:e.provider||null,tags:e.tags||[],body:e.body||"",likes:e.likes||[],comments:e.comments||[],createdAt:e.created_at?new Date(e.created_at).getTime():Date.now()}}mapPostToRow(e){return{id:e.id,user_id:e.userId,title:e.title,artist:e.artist||null,url:e.url,provider:e.provider||null,tags:e.tags||[],body:e.body||null,likes:e.likes||[],comments:e.comments||[],created_at:new Date(e.createdAt||Date.now()).toISOString()}}mapRowToUser(e){return{id:e.id,name:e.name,about:e.about||"",facebook:e.facebook||"",instagram:e.instagram||"",twitter:e.twitter||"",bandcamp:e.bandcamp||"",soundcloud:e.soundcloud||"",youtube:e.youtube||"",lastfm:e.lastfm||"",avatarUrl:e.avatarurl||"",createdAt:e.created_at?new Date(e.created_at).getTime():Date.now()}}async refresh(){let[e,o]=await Promise.all([this.supabase.from("users").select("*").order("created_at",{ascending:!0}),this.supabase.from("posts").select("*").order("created_at",{ascending:!1})]);e.error&&console.warn("Supabase users error",e.error),o.error&&console.warn("Supabase posts error",o.error);let n=(e.data||[]).map(i=>this.mapRowToUser(i)),s=(o.data||[]).map(i=>this.mapRowToPost(i));return this.cache={version:2,createdAt:this.cache.createdAt||Date.now(),users:n,posts:s},this.cache}getAll(){return this.cache}async ensureUser(e){let o=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let a=await this.supabase.auth.getUser();o=a?.data?.user?.id||a?.user?.id}if(!o)throw new Error("No authenticated user");let n=this.cache.users.find(a=>a.id===o||a.name.toLowerCase()===e.toLowerCase());if(n)return n;let s={id:o,name:e.trim(),about:"",createdAt:Date.now()},{error:i}=await this.supabase.from("users").insert({id:s.id,name:s.name,about:s.about,created_at:new Date(s.createdAt).toISOString()});return i&&console.warn("ensureUser insert failed",i),this.cache.users.push(s),s}getUserById(e){return this.cache.users.find(o=>o.id===e)||null}async createPost(e){let o=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let i=await this.supabase.auth.getUser();o=i?.data?.user?.id||i?.user?.id}if(!o)throw new Error("No authenticated user");let n={...this.mapPostToRow(e),user_id:o},{error:s}=await this.supabase.from("posts").insert(n);return s&&console.error("createPost error",s),await this.refresh(),this.cache.posts.find(i=>i.id===e.id)}async updatePost(e,o){let n=this.cache.posts.find(c=>c.id===e);if(!n)return null;let s={...n,...o},i=this.mapPostToRow(s),{error:a}=await this.supabase.from("posts").update(i).eq("id",e);return a&&console.error("updatePost error",a),await this.refresh(),this.cache.posts.find(c=>c.id===e)}async deletePost(e){let{error:o}=await this.supabase.from("posts").delete().eq("id",e);o&&console.error("deletePost error",o),await this.refresh()}async toggleLike(e,o){let n=this.cache.posts.find(c=>c.id===e);if(!n)return null;let s=Array.isArray(n.likes)?[...n.likes]:[],i=s.indexOf(o);i>=0?s.splice(i,1):s.push(o);let{error:a}=await this.supabase.from("posts").update({likes:s}).eq("id",e);return a&&console.error("toggleLike error",a),await this.refresh(),this.cache.posts.find(c=>c.id===e)}async addComment(e,o){let n=this.cache.posts.find(c=>c.id===e);if(!n)return null;let s=Array.isArray(n.comments)?[...n.comments]:[];s.push(o);let{error:i}=await this.supabase.from("posts").update({comments:s}).eq("id",e);i&&console.error("addComment error",i),await this.refresh();let a=this.cache.posts.find(c=>c.id===e);return a?a.comments:s}async deleteComment(e,o){let n=this.cache.posts.find(c=>c.id===e);if(!n)return null;let s=(n.comments||[]).filter(c=>c.id!==o),{error:i}=await this.supabase.from("posts").update({comments:s}).eq("id",e);i&&console.error("deleteComment error",i),await this.refresh();let a=this.cache.posts.find(c=>c.id===e);return a?a.comments:s}async updateUser(e,o){let n=null;if(this.supabase&&this.supabase.auth&&this.supabase.auth.getUser){let a=await this.supabase.auth.getUser();n=a?.data?.user?.id||a?.user?.id}if(!n)throw new Error("No authenticated user");let s={};if(o.name!==void 0&&(s.name=o.name),o.about!==void 0&&(s.about=o.about),o.avatarUrl!==void 0&&(s.avatarurl=o.avatarUrl),o.facebook!==void 0&&(s.facebook=o.facebook),o.instagram!==void 0&&(s.instagram=o.instagram),o.twitter!==void 0&&(s.twitter=o.twitter),o.bandcamp!==void 0&&(s.bandcamp=o.bandcamp),o.soundcloud!==void 0&&(s.soundcloud=o.soundcloud),o.youtube!==void 0&&(s.youtube=o.youtube),o.lastfm!==void 0&&(s.lastfm=o.lastfm),Object.keys(s).length===0)return this.getUserById(n);let{error:i}=await this.supabase.from("users").update(s).eq("id",n);return i&&console.error("updateUser error",i),await this.refresh(),this.getUserById(n)}async replaceAll(e){await this.supabase.from("posts").delete().neq("id",""),await this.supabase.from("users").delete().neq("id","");let o=(e.users||[]).map(s=>({id:s.id,name:s.name,about:s.about||null,created_at:new Date(s.createdAt||Date.now()).toISOString()}));if(o.length){let{error:s}=await this.supabase.from("users").upsert(o);s&&console.error("replaceAll users error",s)}let n=(e.posts||[]).map(s=>({...this.mapPostToRow(s)}));if(n.length){let{error:s}=await this.supabase.from("posts").upsert(n);s&&console.error("replaceAll posts error",s)}await this.refresh()}exportJSON(){return JSON.stringify(this.cache,null,2)}},co=me&&pe?new Ue(me,pe):new Ne,O=co});var gt={};F(gt,{GUEST_KEY:()=>V,SESSION_KEY:()=>X,clearSession:()=>ge,getSession:()=>uo,isGuestMode:()=>Fe,setGuestMode:()=>z,setSession:()=>Ee});function uo(){try{return JSON.parse(sessionStorage.getItem(X)||"null")}catch{return null}}function Ee(t){sessionStorage.setItem(X,JSON.stringify(t))}function ge(){sessionStorage.removeItem(X)}function Fe(){return localStorage.getItem(V)==="1"}function z(t){t?localStorage.setItem(V,"1"):localStorage.removeItem(V)}var X,V,he=N(()=>{X="TunedIn.space/session@v1",V="TunedIn.space/guest@v1"});function mo(t){try{return new URL(t)}catch{return null}}function po(t){return typeof t=="string"&&/^https?:\/\//i.test(t)}function Y(t){let e=(t||"").trim(),o=e.toLowerCase(),n=mo(e);if(/\.(mp3|ogg|wav|m4a)(?:$|\?)/i.test(o))return{provider:"audio",id:e};if(n&&/(^|\.)youtube\.com$|(^|\.)m\.youtube\.com$|(^|\.)music\.youtube\.com$|(^|\.)youtu\.be$/.test(n.hostname)){let s=n.searchParams,i=s.get("list"),a=n.pathname.replace(/\/+$/,""),c=s.get("v");if(!c&&/\/shorts\//i.test(a)&&(c=a.split("/").filter(Boolean).pop()),!c&&/\/embed\//i.test(a)&&(c=a.split("/").filter(Boolean).pop()),!c&&/youtu\.be$/i.test(n.hostname)&&(c=a.split("/").filter(Boolean).shift()),c&&/^[a-zA-Z0-9_-]{11}$/.test(c))return{provider:"youtube",id:c};if(i)return{provider:"youtube_playlist",id:i}}if(n&&/(^|\.)open\.spotify\.com$/.test(n.hostname)){let s=n.pathname.split("/").filter(Boolean);if(s.length>=2){let i=s[0].toLowerCase(),a=s[1];if(/^(track|album|playlist|episode|show)$/i.test(i)&&a)return{provider:"spotify",kind:i,id:a}}}return n&&/bandcamp\.com$/i.test(n.hostname)||/bandcamp\.com$/i.test(o)?{provider:"bandcamp",id:e}:n&&/(^|\.)soundcloud\.com$/.test(n.hostname)||/soundcloud\.com/i.test(o)?{provider:"soundcloud",id:e}:{provider:"link",id:e}}function kt(t,e,o={}){let n=t.provider||Y(t.url||t.id||""),s=e;try{s._cleanup&&s._cleanup()}catch{}s._cleanup=null,s.innerHTML="";let i=!!o.autoplay;if(n.provider==="youtube"){let a=po(location.origin)?location.origin:"https://localhost",c=new URLSearchParams({rel:"0",modestbranding:"1",playsinline:"1",enablejsapi:"1",origin:a});i&&c.set("autoplay","1");let g=`https://www.youtube-nocookie.com/embed/${encodeURIComponent(n.id)}?${c.toString()}`,r=document.createElement("iframe");if(r.className="yt",r.src=g,r.frameBorder="0",r.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",r.allowFullscreen=!0,r.loading="lazy",r.referrerPolicy="strict-origin-when-cross-origin",r.style.width="100%",r.style.aspectRatio="16/9",s.appendChild(r),typeof o.onEnded=="function"){let d=u=>{if(u.source!==r.contentWindow)return;let l=u.data;if(typeof l=="string")try{l=JSON.parse(l)}catch{}!l||typeof l!="object"||l.event==="onStateChange"&&l.info===0&&o.onEnded()},m=()=>{try{r.contentWindow&&r.contentWindow.postMessage(JSON.stringify({event:"listening",id:1,channel:"widget"}),"*")}catch{}};window.addEventListener("message",d),r.addEventListener("load",m),setTimeout(m,500),s._cleanup=()=>{window.removeEventListener("message",d)}}return}if(n.provider==="youtube_playlist"){let a=new URLSearchParams({list:n.id,rel:"0",modestbranding:"1",playsinline:"1"});i&&a.set("autoplay","1");let c=`https://www.youtube-nocookie.com/embed/videoseries?${a.toString()}`;s.innerHTML=`
      <iframe class="yt" src="${c}" frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"
        style="width:100%;aspect-ratio:16/9;"></iframe>
    `;return}if(n.provider==="spotify"){let a=`https://open.spotify.com/embed/${n.kind}/${n.id}`;s.innerHTML=`
      <iframe class="sp" src="${a}" frameborder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy" referrerpolicy="strict-origin-when-cross-origin"
        style="width:100%;min-height:80px;"></iframe>
    `;return}if(n.provider==="bandcamp"){let a=t.url||n.id,c=`https://bandcamp.com/EmbeddedPlayer/?url=${encodeURIComponent(a)}&size=large&bgcol=ffffff&linkcol=0687f5&transparent=true`;s.innerHTML=`
      <iframe class="bc" style="width:100%; min-height:120px; max-height:450px;" frameborder="0" allowtransparency="true" allow="autoplay; encrypted-media"
        src="${c}" loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
    `;return}if(n.provider==="soundcloud"){let a=t.url||n.id,c=`https://w.soundcloud.com/player/?url=${encodeURIComponent(a)}&color=%230066cc&auto_play=${o.autoplay?"true":"false"}&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`;s.innerHTML=`
      <iframe class="sc" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay"
        src="${c}"
        style="width:100%; min-height:166px; max-height:450px;"
        loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
    `;return}if(n.provider==="audio"){let a=document.createElement("audio");a.controls=!0,a.className="audio",a.src=n.id,a.preload="metadata",a.playsInline=!0,i&&setTimeout(()=>{a.play().catch(()=>{})},0),a.addEventListener("ended",()=>{typeof o.onEnded=="function"&&o.onEnded()}),s.appendChild(a);return}fo(t.url||n.id,s,"Open link")}function fo(t,e,o){e.innerHTML="";let n=document.createElement("a");n.href=t,n.textContent=o,n.target="_blank",n.rel="noopener noreferrer",e.appendChild(n)}var be=N(()=>{});function ho(t){return t.toLowerCase().replace(/[0@]/g,"o").replace(/[1!|]/g,"i").replace(/[3]/g,"e").replace(/[4]/g,"a").replace(/[5]/g,"s").replace(/[7]/g,"t")}function ee(t){if(!t)return!1;let e=ho(t);return go.some(o=>o.test(t)||o.test(e))}function ie(t){return t?(t.match(/https?:\/\//g)||[]).length>4||(t.match(/[^\x00-\x7F]/g)||[]).length>20||t.length>1200:!1}var go,ze=N(()=>{go=[/\bf+u+c+k+\b/i,/\bs+h+i+t+\b/i,/\bb+i+t+c+h+\b/i,/\ba+s+s+h*o*l*e*\b/i,/\bb+a+s+t+a*r*d+\b/i,/\bd+i+c+k+\b/i,/\bc+u+n+t+\b/i,/\bp+i+s+s+\b/i,/\bc+o+c+k+\b/i,/\bp+u+s+s+y+\b/i,/\bf+a+g+\b/i,/\bs+l+u+t+\b/i,/\bw+h*o+r*e*\b/i,/\bn+i+g+g*(a|e*r*)\b/i,/\bk+i+k+e+\b/i,/\bc+h+i+n+k+\b/i,/\bg+o+o+k+\b/i,/\bs+p+i+c+\b/i,/\bw+e+t+b+a+c+k+\b/i,/\bf+a+g+g*o*t*\b/i,/\bt+r+a+n+n*y*\b/i,/\br+e+t+a+r+d+\b/i,/\bd+y+k+e+\b/i,/\bc+o+o+n+\b/i,/free\s*money/i,/work\s*from\s*home/i,/viagra/i,/cialis/i,/loan/i,/credit\s*score/i,/casino/i,/betting/i,/http:\/\/(bit\.ly|tinyurl)/i,/buy\s*now/i,/click\s*here/i,/subscribe/i,/earn\s*\$/i]});async function Lt(t,e,o,n){t.preventDefault();let s=o.getAll(),i=e.user;if(!i){B(document.getElementById("app"),"login to post",!0);return}let a=Date.now(),c=s.posts.filter(f=>f.userId===i.id).sort((f,S)=>S.createdAt-f.createdAt)[0];if(c&&a-c.createdAt<1440*60*1e3){let f=864e5-(a-c.createdAt),S=Math.floor(f/(3600*1e3)),b=Math.floor(f%(3600*1e3)/(60*1e3)),x=Math.floor(f%(60*1e3)/1e3),M=document.getElementById("postFormError");M&&(M.textContent=`You can post again in ${S}h ${b}m ${x}s.`);return}let g=document.getElementById("f_title").value.trim(),r=document.getElementById("f_artist").value.trim(),d=document.getElementById("f_url").value.trim(),m=document.getElementById("f_body").value.trim();m.length>200&&(m=m.slice(0,200));let u=(document.getElementById("f_tags").value||"").trim(),l=document.getElementById("postFormError");l&&(l.textContent="");let p=document.getElementById("captchaBox"),y=document.getElementById("f_captcha");if(p&&y){let f=p.dataset.answer;if(y.value.trim()!==f){l&&(l.textContent="Captcha incorrect. Please try again."),y.value="";let S=new Event("resetCaptcha");document.getElementById("postForm").dispatchEvent(S);return}}if(!g||!d)return;if(!u){l&&(l.textContent="Please enter at least one tag.");return}if(!m){l&&(l.textContent="Don't be shy! Tell us what makes this track stand out.");return}let h=u.split(/[#,\s]+/g).map(f=>f.trim().toLowerCase()).filter(Boolean).slice(0,12),k=new Set;if(h=h.filter(f=>k.has(f)?!1:(k.add(f),!0)),ee(g)||ee(r)||ee(m)||h.some(ee)){l&&(l.textContent="Your post contains banned words.");return}if(ie(g)||ie(r)||ie(m)){l&&(l.textContent="Your post looks like spam.");return}let E=Y(d);u=h;let L=s.posts.find(f=>f.url.trim()===d||f.provider&&E&&f.provider.provider===E.provider&&f.provider.id===E.id&&f.provider.kind===E.kind);if(L){let P=function(){f.classList.remove("fadein"),f.classList.add("fadeout"),setTimeout(()=>f.remove(),180)},C=function(){let q={id:G("p"),userId:i.id,title:g,artist:r,url:d,provider:E,tags:u,body:m,likes:[],comments:[],createdAt:Date.now()};o.createPost(q).then(()=>n())};document.querySelectorAll(".comment-delete-confirm").forEach(q=>q.remove());let f=document.createElement("div");f.className="comment-delete-confirm fadein",f.innerHTML=`
      <div class="confirm-inner">
        <span><b>This link looks like a duplicate. Add anyway?</b></span>
        <button class="btn small btn-danger confirm-yes" tabindex="0">OK</button>
        <button class="btn small confirm-no" tabindex="0">Cancel</button>
      </div>
    `;let S=document.querySelector('#postForm button[type="submit"]'),b=S?S.getBoundingClientRect():{left:window.innerWidth/2,bottom:window.innerHeight/2};f.style.position="absolute",f.style.zIndex=10010;let x=b.left+window.scrollX,M=260;x+M>window.innerWidth-8&&(x=window.innerWidth-M-8),f.style.left=x+"px",f.style.top=b.bottom+window.scrollY+4+"px",document.body.appendChild(f),f.querySelector(".confirm-yes").onclick=()=>{P(),C()},f.querySelector(".confirm-no").onclick=()=>{P(),setTimeout(()=>{let q=document.getElementById("post-"+L.id);q&&(q.classList.add("highlight"),q.scrollIntoView({block:"start"}),setTimeout(()=>q.classList.remove("highlight"),1500))},10)},f.onkeydown=q=>{q.key==="Enter"?f.querySelector(".confirm-yes").click():q.key==="Escape"&&P()},setTimeout(()=>{f.querySelector(".confirm-yes").focus()},10),setTimeout(()=>{function q(J){f.contains(J.target)||(P(),document.removeEventListener("mousedown",q))}document.addEventListener("mousedown",q)},0);return}let v={id:G("p"),userId:i.id,title:g,artist:r,url:d,provider:E,tags:u,body:m,likes:[],comments:[],createdAt:Date.now()};await o.createPost(v),document.getElementById("f_title").value="",document.getElementById("f_artist").value="",document.getElementById("f_url").value="",document.getElementById("f_tags").value="",document.getElementById("f_body").value="",l&&(l.textContent="");let w=document.getElementById("preview");w.classList.remove("active"),w.innerHTML="";let I=new Event("resetCaptcha");document.getElementById("postForm").dispatchEvent(I),n(),setTimeout(()=>{let f=document.getElementById("post-"+v.id);f&&(f.classList.add("highlight"),f.scrollIntoView({block:"start"}),setTimeout(()=>f.classList.remove("highlight"),1500))},10)}function Te(t,e,o,n={}){window.editingPostId=t;let s=document.getElementById("cbox-"+t);s&&s.classList.contains("active")&&(s.classList.remove("fade-in"),s.classList.add("fade-out"),setTimeout(()=>{s.classList.remove("active"),s.classList.remove("fade-out"),window.openCommentId==t&&(window.openCommentId=null)},180));let a=o.getAll().posts.find(u=>u.id===t);if(!a)return;if(!e.user||a.userId!==e.user.id){B(document.getElementById("app"),"you can only edit your posts",!0);return}let c=document.getElementById("post-"+t);if(!c)return;let g="editbox-"+t;if(c.querySelector("#"+g))return;let d=document.createElement("div");d.className="box"+(n.noAnimation?"":" fade-in"),d.id=g,d.style.marginTop="8px",d.innerHTML=`
    <div class="muted small">edit post</div>
    <form class="stack" data-action="edit-form" data-post="${a.id}">
    <input class="field" name="title" value="${A(a.title)}" required maxlength="120" placeholder="Title (song or album)"/>
    <input class="field" name="artist" value="${A(a.artist||"")}" placeholder="Artist"/>
    <input class="field" name="url" value="${A(a.url)}" required readonly placeholder="Link (YouTube / Spotify / Bandcamp, etc)"/>
    <input class="field" name="tags" value="${A((a.tags||[]).join(" "))}" placeholder="#Tags go here"/>
  <textarea class="field" name="body" rows="4" maxlength="200" oninput="this.nextElementSibling.textContent = this.value.length + '/200';" placeholder="Share something about this track, a memory, or the vibe it gives you.">${A(a.body||"")}</textarea>
  <div class="muted small" style="text-align:right">${(a.body||"").length}/200</div>
      <div class="hstack">
        <button class="btn" type="submit">[ save ]</button>
        <button class="btn btn-ghost" type="button" data-action="toggle-player">[ preview ]</button>
      </div>
    </form>
  `,c.appendChild(d),window.editingPostDrafts||(window.editingPostDrafts={});let m=d.querySelector('form[data-action="edit-form"]');if(m){let u=()=>{window.editingPostDrafts[t]={title:m.title?.value,artist:m.artist?.value,url:m.url?.value,tags:m.tags?.value,body:m.body?.value}};m.addEventListener("input",u);let l=window.editingPostDrafts[t];l&&(l.title!==void 0&&(m.title.value=l.title),l.artist!==void 0&&(m.artist.value=l.artist),l.url!==void 0&&(m.url.value=l.url),l.tags!==void 0&&(m.tags.value=l.tags),l.body!==void 0&&(m.body.value=l.body))}window.openEditInline||(window.openEditInline=Te),document.addEventListener("submit",function(u){let l=u.target;if(l&&l.matches('form[data-action="edit-form"]')){let p=l.getAttribute("data-post");window.editingPostId==p&&(window.editingPostId=null)}})}var Me=N(()=>{be();_();ze()});function te(t){if(t||(t=document.querySelector(".tag-cloud")),!t)return;typeof window<"u"&&typeof window._tagCloudScrollLeft=="number"&&(t.scrollLeft=window._tagCloudScrollLeft,delete window._tagCloudScrollLeft),typeof window<"u"&&(window.enableTagCloudDragScroll=te);let e=!1,o,n,s,i,a=null,c=!1,g=null,r=5;function d(l){if(l.type==="mousedown"&&l.button!==0||l.type==="pointerdown"&&l.pointerType==="mouse"&&l.button!==0)return;e=!0,c=!1,g=l.pointerId||null,t.classList.add("dragging"),i=t.getBoundingClientRect(),l.type.startsWith("touch")?(o=l.touches[0].clientX,n=l.touches[0].clientY):(o=l.clientX,n=l.clientY),s=t.scrollLeft;let p=l.target;p&&p.classList&&p.classList.contains("tag")?a=p:p&&p.closest&&p.closest(".tag")?a=p.closest(".tag"):a=null,l.preventDefault&&l.preventDefault()}function m(l){if(!e)return;let p,y;l.type.startsWith("touch")?(p=l.touches[0].clientX,y=l.touches[0].clientY):(p=l.clientX,y=l.clientY);let h=p-o,k=y-n;!c&&Math.sqrt(h*h+k*k)>r&&(c=!0),i||(i=t.getBoundingClientRect());let E=p-i.left;t.scrollLeft=s-(E-(o-i.left)),l.preventDefault&&l.preventDefault()}function u(l){if(!e)return;let p,y;l.type.startsWith("touch")?(p=l.changedTouches&&l.changedTouches[0].clientX||o,y=l.changedTouches&&l.changedTouches[0].clientY||n):(p=l.clientX,y=l.clientY);let h=p-o,k=y-n;if(!c&&a){let E=document.elementFromPoint(p,y),L=null;if(E&&E.classList&&E.classList.contains("tag")?L=E:E&&E.closest&&E.closest(".tag")&&(L=E.closest(".tag")),L===a){if(window&&window.prefs&&typeof window.prefs.filterTag<"u"){let v=L.getAttribute("data-tag");if(window.prefs.filterTag===v){window.prefs.filterTag="",typeof window.renderApp=="function"&&window.renderApp();return}else window.prefs.filterTag=v}if(typeof window.onActionClick=="function"){let v=new Event("click",{bubbles:!0,cancelable:!0});Object.defineProperty(v,"target",{value:L,enumerable:!0}),window.onActionClick(v,window.state,window.DB,window.renderApp)}else L.click();typeof window.renderApp=="function"&&window.renderApp()}}e=!1,a=null,c=!1,g=null,t.classList.remove("dragging"),i=null,l.preventDefault&&l.preventDefault()}window.PointerEvent?(t.addEventListener("pointerdown",d,{passive:!1}),t.addEventListener("pointermove",m,{passive:!1}),t.addEventListener("pointerup",u,{passive:!1}),t.addEventListener("pointercancel",u,{passive:!1})):(t.addEventListener("mousedown",d,{passive:!1}),document.addEventListener("mousemove",m,{passive:!1}),document.addEventListener("mouseup",u,{passive:!1}),t.addEventListener("touchstart",d,{passive:!1}),t.addEventListener("touchmove",m,{passive:!1}),t.addEventListener("touchend",u,{passive:!1}),t.addEventListener("touchcancel",u,{passive:!1}))}var Ye=N(()=>{});var je={};F(je,{getFilteredPosts:()=>ae,renderCommentHTML:()=>ve,renderFeed:()=>j,renderPostHTML:()=>Ce,renderTags:()=>oe});function yo(t,e,o){let s=o.getAll().users.find(i=>i.id===t);return s?s.name:e.user&&e.user.id===t?e.user.name||"user":"anon"}function ae(t,e){let n=t.getAll().posts.slice();if(e.filterTag&&(n=n.filter(s=>(s.tags||[]).includes(e.filterTag))),e.search){let s=e.search.toLowerCase();n=n.filter(i=>(i.title||"").toLowerCase().includes(s)||(i.artist||"").toLowerCase().includes(s)||(i.tags||[]).some(a=>a.includes(s))||(i.body||"").toLowerCase().includes(s))}return e.sort==="likes"?n.sort((s,i)=>(i.likes?.length||0)-(s.likes?.length||0)||i.createdAt-s.createdAt):e.sort==="comments"?n.sort((s,i)=>(i.comments?.length||0)-(s.comments?.length||0)||i.createdAt-s.createdAt):n.sort((s,i)=>i.createdAt-s.createdAt),n}function ve(t,e,o,n){let s=o.user&&t.userId===o.user.id,a=n.getAll().users.find(r=>r.id===t.userId)||null,c=yo(t.userId,o,n),g=a&&a.avatarUrl?A(a.avatarUrl):"/assets/android-chrome-512x512.png";return`<div class="comment small" data-comment="${t.id}" data-post="${e}">
      <img class="avatar avatar-sm" src="${g}" alt="avatar" />
      <span class="muted">${K(t.createdAt)}</span> <b>${a?`<a href="#" data-action="view-user" data-uid="${A(a.id)}">${A(c)}</a>`:A(c)}</b>: ${A(t.text)}
      ${s?` <button class="btn btn-ghost small" data-action="delete-comment" data-post="${e}" data-comment="${t.id}">[ delete ]</button>`:""}
    </div>`}function Ce(t,e,o){let s=o.getAll().users.find(h=>h.id===t.userId),i=e.user,a=i?(t.likes||[]).includes(i.id):!1,c=(t.tags||[]).map(h=>`<a href="#" class="tag small" data-action="filter-tag" data-tag="${A(h)}">#${A(h)}</a>`).join(" "),g=`${location.origin?location.origin+location.pathname:location.pathname}#post-${t.id}`,r=!!(i&&t.userId===i.id),d=t.likes?t.likes.length:0,m=t.comments?t.comments.length:0,u=(t.comments||[]).map(h=>ve(h,t.id,e,o)).join(""),l=s&&s.avatarUrl?A(s.avatarUrl):"/assets/android-chrome-512x512.png",p=t.artist?`<span class="post-artist-twolines muted thin">by ${A(t.artist)}</span>`:"",y=t.artist?"":"by ";return`
  <article class="post" id="post-${t.id}" data-post="${t.id}" aria-label="${A(t.title)}">
    <div class="post-header-twolines">
      <div class="post-title-twolines">${A(t.title)}${p}</div>
      <div class="small meta-twolines">
        <a href="#" data-action="view-user" data-uid="${s?A(s.id):""}">
          <img class="avatar avatar-sm" src="${l}" alt="avatar" />
        </a>
        <span class="muted">${y}${s?`<a href="#" data-action="view-user" data-uid="${A(s.id)}">${A(s.name)}</a>`:"anon"}</span>
    <span class="muted sep-slash">/</span>
  <span class="muted" title="${(()=>{let h=new Date(t.createdAt),k=h.getMinutes();return k=k<15?0:k<45?30:0,k===0&&h.getMinutes()>=45&&h.setHours(h.getHours()+1),h.setMinutes(k,0,0),h.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})()}">${K(t.createdAt)}</span>
  ${c?`<span class="muted sep-slash">/</span> <div class="tag-cloud post-tags-twolines">${c}</div>`:""}
      </div>
    </div>
    ${t.body?`<div class="sep"></div><div>${A(t.body)}</div>`:""}
    <div class="actions hstack" style="margin-top:8px">
      <button class="btn" data-action="toggle-player">[ play ]</button>
      <button class="btn ${a?"like-on":""}" data-action="like" aria-pressed="${a}" title="like">[ \u2665 ${d} ]</button>
      <button class="btn" data-action="comment" title="comments">[ comments ${m} ]</button>
      <button class="btn btn-ghost" data-action="queue" title="add to queue">[ add to queue ]</button>
      <button class="btn btn-ghost" data-action="share" data-perma="${A(g)}" title="share/copy link">[ share ]</button>
      ${r?`
        <button class="btn btn-ghost" data-action="edit" data-post="${t.id}">[ edit ]</button>
        <button class="btn btn-ghost" data-action="delete">[ delete ]</button>
      `:""}
    </div>
    <div class="player" id="player-${t.id}" aria-label="player"></div>
    <div class="comment-box" id="cbox-${t.id}">
      <div class="sep"></div>
      <div id="comments-${t.id}">
        ${u}
      </div>
      ${e.user?`
        <form class="hstack" data-action="comment-form" data-post="${t.id}">
          <label class="sr-only" for="c-${t.id}">Write a comment</label>
          <input class="field" id="c-${t.id}" placeholder="write a comment\u2026" maxlength="500" aria-label="Write a comment" />
          <button class="btn">[ send ]</button>
        </form>
      `:'<div class="muted small">login to comment</div>'}
    </div>
  </article>
  `}function j(t,e,o,n,s){let i=Array.from(document.querySelectorAll(".comment-box.active")).map(y=>y.id),a={};i.forEach(y=>{let h=document.getElementById(y);if(h){let k=h.querySelector("input.field");k&&(a[y]=k.value)}});let c=ae(n,s),g=s._userFilterId||window.filterPostsByUserId;g&&(c=c.filter(y=>y.userId===g));let r=c.length,d=0,m=Math.min(o.page*o.pageSize,r),u=c.slice(d,m);if(r===0){t.innerHTML='<div class="notice small">No posts yet. Add one on the right.</div>',e.innerHTML="";return}if(t.innerHTML=u.map(y=>Ce(y,o,n)).join(""),i.forEach(y=>{let h=document.getElementById(y);if(h){h.classList.add("active");let k=h.querySelector("input.field");k&&a[y]!==void 0&&(k.value=a[y])}}),l(o,n),window.editingPostId){let y=document.getElementById("post-"+window.editingPostId),h="editbox-"+window.editingPostId,k=document.getElementById(h);y&&k&&k.parentNode!==y?y.appendChild(k):y&&!k&&Te(window.editingPostId,o,n,{noAnimation:!0})}window._editBtnHandlerAttached||(document.addEventListener("click",function(y){let h=y.target.closest('button[data-action="edit"][data-post]');if(h){let k=h.getAttribute("data-post"),E=document.getElementById("post-"+k),L="editbox-"+k,v=E?E.querySelector("#"+L):null;v?(v.classList.remove("fade-in"),v.classList.add("fade-out"),setTimeout(()=>{v.parentNode&&v.parentNode.removeChild(v),window.editingPostId==k&&(window.editingPostId=null)},180)):Te(k,window._lastFeedState,window._lastFeedDB),y.preventDefault()}}),window._editBtnHandlerAttached=!0);function l(y,h){window._lastFeedState=y,window._lastFeedDB=h}m<r?e.innerHTML=`<button class="btn btn-ghost" data-action="load-more">[ load more (${m}/${r}) ]</button>`:e.innerHTML=`<div class="small muted">${r} loaded</div>`;let p=(location.hash||"").trim();if(p.startsWith("#post-")){let y=p.slice(6),h=document.getElementById("post-"+y);h&&(h.classList.add("highlight"),h.scrollIntoView({block:"start"}),setTimeout(()=>h.classList.remove("highlight"),1500)),history.replaceState(null,"",location.pathname)}document.querySelectorAll(".tag-cloud.post-tags-twolines").forEach(y=>{te(y)})}function oe(t,e,o){let n=e.getAll(),s=new Map;n.posts.forEach(l=>(l.tags||[]).forEach(p=>s.set(p,(s.get(p)||0)+1)));let i=window.localStorage.getItem("tagSortMode")||"freq";function a(l){i=l,window.localStorage.setItem("tagSortMode",l),oe(t,e,o)}let c=t.querySelector(".tag-sort-ui");c&&c.remove();let g=t.querySelector(".tag-cloud");g&&g.remove();let r=Array.from(s.entries());if(i==="freq"?r=r.sort((l,p)=>p[1]-l[1]||l[0].localeCompare(p[0])):r=r.sort((l,p)=>l[0].localeCompare(p[0])||p[1]-l[1]),r=r.slice(0,80),r.length===0){t.innerHTML='<span class="muted small">no tags yet</span>';return}let d=document.createElement("div");d.className="tag-cloud";let m=o&&o.filterTag;if(d.innerHTML=r.map(([l,p])=>`<span class="tag${m===l?" tag-selected":""}" data-action="filter-tag" data-tag="${A(l)}"${m===l?' style="background:var(--acc,#8ab4ff);color:#111;font-weight:600;border-radius:6px;outline:2px solid var(--acc,#8ab4ff);outline-offset:0;z-index:2;"':""}><span class="tag-label">#${A(l)}</span></span>`).join(" "),t.appendChild(d),typeof window<"u"&&typeof window._tagCloudScrollLeft=="number"){let y=function(){d.scrollLeft=window._tagCloudScrollLeft,l++,l<p?requestAnimationFrame(y):delete window._tagCloudScrollLeft},l=0,p=8;requestAnimationFrame(y)}else m&&requestAnimationFrame(()=>{let l=d.querySelector(".tag-selected");if(l&&d.scrollLeft<5){let p=l.getBoundingClientRect(),y=d.getBoundingClientRect();if(p.left<y.left||p.right>y.right){let h=l.offsetLeft+p.width/2-y.width/2;d.scrollLeft=h}}});typeof te=="function"&&te(d),"ontouchstart"in window;let u=document.createElement("div");u.className="tag-sort-ui",u.style.display="inline-flex",u.style.gap="10px",u.style.marginTop="6px",u.style.fontSize="0.93em",u.innerHTML=`
      <a href="#" data-sort="freq" class="tag-sort-link${i==="freq"?" active":""}">freq</a>
      <span style="color:#444;opacity:0.5;">|</span>
      <a href="#" data-sort="az" class="tag-sort-link${i==="az"?" active":""}" tabindex="0">A-Z</a>
      <style>
        .tag-sort-link {
          color: #aaa;
          text-decoration: none;
          border: none;
          background: none;
          padding: 0 2px;
          cursor: pointer;
          position: relative;
          transition: color 0.18s;
          font-weight: 500;
          appearance: none;
          -webkit-appearance: none;
          -moz-appearance: none;
          outline: none;
          box-shadow: none;
          overflow: visible;
        }
        .tag-sort-link.active {
          color: var(--acc, #8ab4ff);
        }
        .tag-sort-link::after {
          content: '';
          display: block;
          position: absolute;
          left: 0; right: 0; bottom: -2px;
          height: 2px;
          background: var(--acc, #8ab4ff);
          opacity: 0;
          transform: scaleX(0.5);
          transition: opacity 0.18s, transform 0.18s;
        }
        .tag-sort-link:hover::after, .tag-sort-link:focus::after, .tag-sort-link.active::after {
          opacity: 1;
          transform: scaleX(1);
        }
        .tag-sort-link:hover, .tag-sort-link:focus {
          color: var(--acc, #8ab4ff);
        }
      </style>
    `,u.addEventListener("click",l=>{let p=l.target.closest("a[data-sort]");p&&(l.preventDefault(),a(p.getAttribute("data-sort")))}),t.appendChild(u)}var re=N(()=>{_();Me();Ye()});var We={};F(We,{default:()=>Ae});function bo(){try{let t=localStorage.getItem(Et);if(!t)return[];let e=JSON.parse(t),o=Date.now();return e.filter(n=>!n.expires||n.expires>o)}catch{return[]}}var Et,vo,Ae,we=N(()=>{Et="tunedin.notifications";vo={list:bo(),add(t,e="info",o=4e3){let n=Date.now()+Math.random(),s;return o>0&&(s=Date.now()+o),this.list.push({id:n,message:t,type:e,expires:s}),this._persist(),this._notifyChange(),o>0&&setTimeout(()=>this.remove(n),o),n},remove(t){this.list=this.list.filter(e=>e.id!==t),this._persist(),this._notifyChange()},clear(){this.list=[],this._persist(),this._notifyChange()},_listeners:[],subscribe(t){return this._listeners.push(t),()=>{this._listeners=this._listeners.filter(e=>e!==t)}},_notifyChange(){this._listeners.forEach(t=>t(this.list))},_persist(){try{localStorage.setItem(Et,JSON.stringify(this.list))}catch{}}},Ae=vo});var Je={};F(Je,{showChangelogModal:()=>St});function St(){if(document.querySelector(".changelog-modal-bg"))return;let t=document.createElement("div");t.className="changelog-modal-bg",t.tabIndex=-1;let e=document.createElement("div");e.className="changelog-modal",e.innerHTML=`
    <div class="changelog-modal-header">
      <span>Dev Changelog</span>
      <button class="changelog-modal-close" title="Close">&times;</button>
    </div>
    <div class="changelog-modal-content"><span class="muted">Loading...</span></div>
  `,t.appendChild(e),document.body.appendChild(t),document.body.style.overflow="hidden";function o(){document.body.style.overflow="",t.remove()}t.addEventListener("click",()=>o()),document.addEventListener("keydown",function n(s){s.key==="Escape"&&(o(),document.removeEventListener("keydown",n))}),fetch("CHANGELOG.md").then(n=>n.text()).then(n=>{e.querySelector(".changelog-modal-content").innerHTML=`<pre style="white-space:pre-wrap;">${n.replace(/[<>&]/g,s=>({"<":"&lt;",">":"&gt;","&":"&amp;"})[s])}</pre>`}).catch(()=>{e.querySelector(".changelog-modal-content").innerHTML='<span class="muted">Could not load changelog.</span>'})}var Ge=N(()=>{window.showChangelogModal=St});var It={};F(It,{currentUser:()=>Ke});async function Ke(t){if(t.isRemote&&t.supabase&&t.supabase.auth&&t.supabase.auth.getUser)try{let o=(await t.supabase.auth.getUser())?.data?.user;if(o){let n=o.user_metadata?.name||o.email||"user";try{await t.ensureUser(n)}catch{}return{id:o.id,name:n,email:o.email}}}catch{}return null}var Ve=N(()=>{});var Tt={};F(Tt,{renderHelpOverlay:()=>Xe});function Xe(){let t=`
  <div class="sheet">
      <div class="hstack" style="justify-content:space-between; align-items:center">
        <div class="muted small">> help</div>
        <button class="btn btn-ghost small" data-close-help>[ close ]</button>
      </div>
      <div class="sep"></div>
      <div class="small stack" style="gap:1.5em">
        <div style="text-align:center;">
          <b>\u{1F44B} Welcome to <span style="color:var(--accent,#6cf)">TunedIn.space</span></b><br>
          <span class="muted">Post less. Feel more.</span><br>
          <span class="muted" style="display:block; margin-top:0.5em;">
          </span>
        </div>
        <div class="hstack" style="justify-content:center; gap:12px; margin: 1em 0 0.5em 0;">
          <button class="btn btn-ghost" data-action="show-changelog">[ dev changelog ]</button>
        </div>
        <div>
          <b>Getting Started</b><br>
          <ul style="margin:0 0 0 1.2em; padding:0;">
            <li>Scroll the feed and eavesdrop on what everyone else is jamming to.</li>
            <li>Smash <b>[ login / register ]</b> to join the party and drop your own bangers.</li>
            <li>Share links from YouTube, Spotify, Bandcamp, SoundCloud, or even that obscure .mp3 you found at 3am.</li>
            <li>Tag your posts (#vibes, #throwback, #2020) so fellow music nerds can find them.</li>
            <li>Hit <b>[ play all ]</b> to turn the feed into your personal radio station.</li>
          </ul>
        </div>
        <div>
          <b>How to Post</b><br>
          <ul style="margin:0 0 0 1.2em; padding:0;">
            <li>Give us a title, an artist, and a legit music link. (No Rickrolls. Or... maybe just one.)</li>
            <li>Tags = discoverability. Don\u2019t be shy.</li>
            <li>Optional: Tell us why this track slaps. Or just type "banger." We get it.</li>
            <li><b>Note:</b> You can post once every 24 hours. Plan your pick and come back tomorrow for more!</li>
          </ul>
        </div>
        <div>
          <b>Listening & Queue</b><br>
          <ul style="margin:0 0 0 1.2em; padding:0;">
            <li>Player controls up top: play, skip, shuffle, clear. DJ skills not required.</li>
            <li>The queue is just the current feed, so filter and sort to your heart\u2019s content.</li>
          </ul>
        </div>
        <div>
          <b>Personalize</b><br>
          <button class="btn icon" title="accent color" data-action="accent-pick">\u{1F3A8}</button>
          <span class="muted small">Pick an accent color. Express yourself. (Sorry, no glitter... yet.)</span>
        </div>
        <div>
          <b>Tips & Tricks</b><br>
          <ul style="margin:0 0 0 1.2em; padding:0;">
            <li>Click tags to filter the feed. Use [ clear tag ] to see everything again.</li>
            <li>Everything is keyboard accessible, so you can flex your shortcut skills.</li>
            <li>Be kind, have fun, and remember: one person\u2019s guilty pleasure is another\u2019s anthem.</li>
          </ul>
        </div>
      </div>
      <div class="sep"></div>
      <div style="text-align:center; margin-top:2em;">
        <button class="btn btn-danger" data-action="delete-account">Delete My Account</button>
        <div class="muted small" style="margin-top:0.5em;">This will permanently remove your account and posts.</div>
      </div>
    </div>
  `,e=document.createElement("div");e.className="overlay",e.id="help",e.innerHTML=t,document.body.appendChild(e),e.querySelector('[data-action="show-changelog"]').onclick=()=>{Promise.resolve().then(()=>(Ge(),Je)).then(o=>{if(o.showChangelogModal(),!document.getElementById("changelog-modal-css")){let n=document.createElement("link");n.rel="stylesheet",n.href="css/changelog_modal.css",n.id="changelog-modal-css",document.head.appendChild(n)}e&&e.parentNode&&e.parentNode.removeChild(e)})},e.querySelector('[data-action="delete-account"]').onclick=async()=>{let o=document.createElement("div");o.style.position="fixed",o.style.inset="0",o.style.background="rgba(0,0,0,0.6)",o.style.zIndex="10001",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.innerHTML=`
      <div class="box stack" style="max-width:340px; background:var(--bg,#111); padding:2em 1.5em; border-radius:10px; box-shadow:0 4px 32px #000a; align-items:center;">
        <div class="muted" style="font-size:1.1em; margin-bottom:0.5em;">Type <b>delete</b> to confirm account deletion.</div>
        <input id="deleteConfirmInput" class="field" style="width:100%; margin-bottom:1em;" placeholder="Type 'delete' to confirm" autocomplete="off" />
        <div class="hstack" style="gap:1em; justify-content:center;">
          <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          <button class="btn btn-ghost" id="cancelDeleteBtn">Cancel</button>
        </div>
        <div class="muted small" id="deleteErrorMsg" style="color:#e66; margin-top:0.5em; display:none;"></div>
      </div>
    `,document.body.appendChild(o);let n=o.querySelector("#deleteConfirmInput"),s=o.querySelector("#confirmDeleteBtn"),i=o.querySelector("#cancelDeleteBtn"),a=o.querySelector("#deleteErrorMsg");n.focus(),i.onclick=()=>{o.remove()},s.onclick=async()=>{if(n.value.trim().toLowerCase()!=="delete"){a.textContent="You must type 'delete' to confirm.",a.style.display="",n.focus();return}s.disabled=!0,a.style.display="none";let c=(await Promise.resolve().then(()=>(fe(),Oe))).default,{currentUser:g}=await Promise.resolve().then(()=>(Ve(),It)),{clearSession:r}=await Promise.resolve().then(()=>(he(),gt)),d=await g(c);if(!d){alert("No user logged in."),o.remove();return}if(await c.deleteUser(d.id)){if(c.isRemote&&c.supabase&&c.supabase.auth&&c.supabase.auth.signOut)try{await c.supabase.auth.signOut()}catch{}r(),alert("Your account and posts have been deleted."),location.reload()}else a.textContent="Failed to delete account.",a.style.display="",s.disabled=!1},n.addEventListener("keydown",c=>{c.key==="Enter"&&s.click()})}}var Ze=N(()=>{});var Qe={};F(Qe,{refreshUser:()=>wo,state:()=>R});async function wo(){R.user=await Ke(O)}var R,xe=N(()=>{fe();Ve();R={user:null,queue:[],qIndex:0,pageSize:30,page:1,forceLogin:!1}});var Ct={};F(Ct,{fetchOEmbed:()=>zo});async function zo(t){if(/youtube\.com|youtu\.be/.test(t))try{let e=t;try{let n=new URL(t),s=n.searchParams.get("v");if(s)e=`https://www.youtube.com/watch?v=${s}`;else if(/youtu\.be$/.test(n.hostname)){let i=n.pathname.split("/").filter(Boolean)[0];i&&(e=`https://www.youtube.com/watch?v=${i}`)}}catch{}let o=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(e)}&format=json`);return o.ok?await o.json():null}catch{}if(/soundcloud\.com/.test(t))try{let e=await fetch(`/api/soundcloud-oembed?url=${encodeURIComponent(t)}`);return e.ok?await e.json():null}catch{}return/bandcamp\.com/.test(t)||/spotify\.com/.test(t),null}var At=N(()=>{});var Pt={};F(Pt,{parseYouTubeTitle:()=>Yo});function Yo(t){if(!t||!t.title)return{artist:"",title:""};let e=t.title.indexOf(" - ");return e>0&&e<t.title.length-3?{artist:t.title.slice(0,e).trim(),title:t.title.slice(e+3).trim()}:{artist:t.author_name||"",title:t.title}}var qt=N(()=>{});var Ht={};F(Ht,{renderHeader:()=>st,renderMainContainers:()=>it});function st(){function e(i){let c=i.replace(/<[^>]*>/g,"").length;if(c<41){let g=41-c,r=Math.floor(g/2),d=g-r;return"&nbsp;".repeat(r)+i+"&nbsp;".repeat(d)}return i}let n=`
    <img src="/assets/logo.png" alt="Logo" class="login-logo-anim header-logo-anim" style="width:44px; height:44px; object-fit:contain; display:block; margin:0 auto 8px auto;" />
    <pre id="ascii-banner" class="head ascii-banner" aria-hidden="false" style="font-family:'Fira Mono','Consolas','Menlo','Monaco','Liberation Mono',monospace !important;font-size:1em;line-height:1.1;letter-spacing:0;white-space:pre;overflow-x:auto;margin:0 auto 8px auto;max-width:100vw;">
<!--ascii-start-->
\u25CF--------------------------- TunedIn.space --\u25CF
| <span id="ascii-post-limit">${e("You can post once per day! Make it count!")}</span> |
\u25CF--------------------------------------------\u25CF
<!--ascii-end-->
    </pre>
  `;setTimeout(()=>{let i=document.getElementById("ascii-post-limit");if(!i)return;let a=!1,c="",g=["Time\u2019s up! Drop your freshest tune.","The stage is yours\u2014share your music!","Ready to post? Let\u2019s hear what you\u2019ve got!","Mic\u2019s on. What are you listening to today?","It\u2019s posting time - bring the vibes!","Your post window is open. Make it count!","Go on, share your soundtrack for today.","Let\u2019s see what\u2019s spinning in your world!","You\u2019re up! What\u2019s your tune of the day?","Spotlight\u2019s on you\u2014post your music pick!"],r=0,d=null,m=!1;if(!document.getElementById("ascii-post-limit-fade-style")){let h=document.createElement("style");h.id="ascii-post-limit-fade-style",h.textContent=`
        #ascii-post-limit.fade { transition: opacity 0.35s cubic-bezier(.4,0,.2,1); opacity: 0.25; }
        #ascii-post-limit { font-family: inherit; }
      `,document.head.appendChild(h)}function u(){if(!window.DB||!window.state||!window.state.user)return"";let h=window.DB.getAll?window.DB.getAll():{posts:[]},k=window.state.user,E=Date.now(),L=(h.posts||[]).filter(v=>v.userId===k.id).sort((v,w)=>w.createdAt-v.createdAt)[0];if(L&&E-L.createdAt<1440*60*1e3){let v=864e5-(E-L.createdAt),w=Math.floor(v/(3600*1e3)),I=Math.floor(v%(3600*1e3)/(60*1e3)),f=Math.floor(v%(60*1e3)/1e3);return`${w}h ${I}m ${f}s`}return""}function l(h){let E=h.replace(/<[^>]*>/g,"").length;if(E<41){let L=41-E,v=Math.floor(L/2),w=L-v;return"\xA0".repeat(v)+h+"\xA0".repeat(w)}return h}function p(h,k){i.innerHTML!==h&&(k&&(c==="ready"||k==="ready")?(m=!0,i.classList.add("fade"),setTimeout(()=>{i.innerHTML=h,i.classList.remove("fade"),setTimeout(()=>{m=!1},350)},350)):i.innerHTML=h)}function y(){let h,k;if(!window.DB||!window.state||!window.state.user)!d&&c!=="ready"?(h=l("You can post once per day! Make it count!"),k="ready",d=setTimeout(()=>{let L;do L=Math.floor(Math.random()*g.length);while(g.length>1&&L===r);r=L,y();let v=()=>{let w=4500+Math.random()*3500;d=setTimeout(()=>{if(m)d=setTimeout(v,500);else{let I;do I=Math.floor(Math.random()*g.length);while(g.length>1&&I===r);r=I,y(),v()}},w)};v()},4500+Math.random()*3500)):d&&(h=l(g[r]),k="ready");else{let L=u();L?(d&&(clearTimeout(d),d=null),a?(h=l(`Time left: ${L}`),k="countdown"):(h=l("You can post once per day! Make it count!"),k="info")):!d&&c!=="ready"?(h=l("You can post once per day! Make it count!"),k="ready",d=setTimeout(()=>{let v;do v=Math.floor(Math.random()*g.length);while(g.length>1&&v===r);r=v,y();let w=()=>{let I=4500+Math.random()*3500;d=setTimeout(()=>{if(m)d=setTimeout(w,500);else{let f;do f=Math.floor(Math.random()*g.length);while(g.length>1&&f===r);r=f,y(),w()}},I)};w()},4500+Math.random()*3500)):d&&(h=l(g[r]),k="ready")}let E=k!==c;c=k,p(h,E)}i.addEventListener("mouseenter",()=>{a=!0,y()}),i.addEventListener("mouseleave",()=>{a=!1,y()}),y(),setInterval(y,1e3)},0);let s=document.createElement("header");s.setAttribute("role","banner"),s.innerHTML=n,document.querySelector(".wrap").prepend(s)}function it(){let t=document.querySelector(".wrap");if(!document.getElementById("app")){let e=document.createElement("main");e.id="app",e.setAttribute("role","main"),t.appendChild(e)}if(!document.getElementById("live")){let e=document.createElement("div");e.id="live",e.className="sr-only",e.setAttribute("aria-live","polite"),t.appendChild(e)}}var qe=N(()=>{});fe();_();_();var se="TunedIn.space/prefs@v2",He={autoScroll:!0,sort:"new",search:"",filterTag:null,accent:"#ff6b6b",density:"cozy",shuffle:!1,repeat:"off"},U=null;function $(){if(U)return U;let t=localStorage.getItem(se);if(!t)return U={...He},Z(U.accent),ue(U.density),U;try{U={...He,...JSON.parse(t)}}catch{U={...He}}return Z(U.accent),ue(U.density),U}function H(t){U={...$(),...t};try{localStorage.setItem(se,JSON.stringify(U))}catch{}return t&&"accent"in t&&Z(U.accent),t&&"density"in t&&ue(U.density),U}function Le(){U=null}he();var ht=!1;function Se(){let t=document.getElementById("help");t&&t.classList.add("active")}function yt(){let t=document.getElementById("help");t&&t.classList.remove("active")}function bt(){let t=document.getElementById("help");t&&(t.onclick=function(e){e.target===t&&yt()}),ht||(document.addEventListener("click",e=>{e.target.matches("[data-close-help]")&&yt()}),ht=!0)}_();_();function De(t){return t.queue[t.qIndex]||null}function D(t,e,o){let n=T("#dock");if(!n)return;let s=e.queue.length,i=document.getElementById("qLen"),a=document.getElementById("qPos");i&&(i.textContent=String(s)),a&&(a.textContent=String(s?e.qIndex+1:0));let c=$(),g=document.querySelector('[data-action="q-shuffle"]');g&&g.setAttribute("aria-pressed",String(!!c.shuffle));let r=document.querySelector('[data-action="q-repeat"]');if(r&&(r.textContent=`[ repeat: ${c.repeat} ]`),s>0||t){n.style.display="block";let m=De(e);if(m){let l=o.getAll().posts.find(y=>y.id===m),p=document.getElementById("nowPlaying");p&&(p.textContent=l?`now: ${l.title}${l.artist?" \u2014 "+l.artist:""}`:"")}else{let u=document.getElementById("nowPlaying");u&&(u.textContent="")}}else n.style.display="none";let d=document.getElementById("autoScroll");d&&(d.onchange=m=>{let u=m.target;u&&localStorage.setItem("autoScroll",u.checked?"1":"0")})}function Ie(t,e){if(t.queue.length===0)return;let o=$();o.repeat==="one"||(t.qIndex===0?o.repeat==="all"?t.qIndex=t.queue.length-1:t.qIndex=0:t.qIndex=Math.max(0,t.qIndex-1)),D(!1,t,e),vt(t.qIndex,t)}function ye(t,e,o){if(e.queue.length===0)return;let n=$();if(n.repeat!=="one")if(n.shuffle&&e.queue.length>1){let s;do s=Math.floor(Math.random()*e.queue.length);while(s===e.qIndex);e.qIndex=s}else if(e.qIndex>=e.queue.length-1)if(n.repeat==="all")e.qIndex=0;else{if(t)return;e.qIndex=e.queue.length-1}else e.qIndex++;D(!1,e,o),vt(e.qIndex,e)}function vt(t,e){let o=e.queue[t];if(!o)return;let n=document.getElementById("post-"+o);if(!n)return;let s=window.scrollY,i=document.getElementById("player-"+o);if(i&&!i.classList.contains("active")){let a=n.querySelector('[data-action="toggle-player"]');a&&a.click()}document.querySelectorAll(".post").forEach(a=>a.classList.remove("is-playing")),n.classList.add("is-playing"),window.scrollTo({top:s})}function wt(t,e,o){document.querySelectorAll(".post").forEach(s=>s.classList.remove("is-playing"));let n=document.getElementById("post-"+t);n&&n.classList.add("is-playing"),D(!1,e,o)}_();async function xt(t,e,o,n){let s=t.target.files&&t.target.files[0];if(s)try{let i=await s.text(),a=JSON.parse(i);if(!a||!Array.isArray(a.posts)||!Array.isArray(a.users)){alert("Invalid export file.");return}await e.replaceAll({...a,version:2}),B(document.getElementById("app"),e.isRemote?"imported to Supabase":"imported"),o.queue=[],o.qIndex=0,await e.refresh(),n()}catch(i){console.error(i),alert("Import failed.")}finally{t.target.value=""}}_();re();Ye();we();function Mt({root:t,left:e,state:o,DB:n,prefs:s,render:i}){let a="tunedin.hideWelcomeBanner";if(!localStorage.getItem(a)){let b=document.createElement("div");b.className="info-popup-banner popup-onboarding",b.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between;width:100%;gap:18px;">
        <div style="display:flex;align-items:center;gap:10px;text-align:center;">
          <span style="font-size:1.5em;line-height:1.1;">\u{1F389}</span>
          <span style="font-size:1.08em;line-height:1.5;text-align:center;display:block;">
            <b>Welcome!</b> Check 
            <a href="#" class="popup-link popup-nowrap" data-popup-action="help" style="color:#6cf;text-decoration:underline;cursor:pointer;white-space:nowrap;"><b>[ help ]</b></a>
            for tips & 
            <a href="#" class="popup-link popup-changelog-link popup-nowrap" data-popup-action="changelog" style="color:#6cf;text-decoration:underline;cursor:pointer;white-space:nowrap;"><b>[ dev changelog ]</b></a>
            for project updates.
          </span>
        </div>
        <button class="btn btn-ghost small" style="font-size:1.25em;opacity:0.7;padding:2px 10px 0 10px;line-height:1;" title="Dismiss" aria-label="Dismiss">\u2715</button>
      </div>
    `;let x=()=>{b.style.animation="fadeout-popup-banner-bottom 0.4s",setTimeout(()=>{b.remove(),localStorage.setItem(a,"1")},350)};if(b.querySelector('[data-popup-action="help"]').onclick=M=>{M.preventDefault();let P=document.querySelector('[data-action="show-help"]');P&&P.click(),x()},b.querySelector('[data-popup-action="changelog"]').onclick=M=>{M.preventDefault(),Promise.resolve().then(()=>(Ge(),Je)).then(P=>{if(P&&typeof P.showChangelogModal=="function"?P.showChangelogModal():window.showChangelogModal&&window.showChangelogModal(),!document.getElementById("changelog-modal-css")){let C=document.createElement("link");C.rel="stylesheet",C.href="css/changelog_modal.css",C.id="changelog-modal-css",document.head.appendChild(C)}document.querySelectorAll(".overlay").forEach(C=>C.remove())}).catch(P=>{if(window.showChangelogModal?window.showChangelogModal():console.error("Failed to load changelog modal:",P),!document.getElementById("changelog-modal-css")){let C=document.createElement("link");C.rel="stylesheet",C.href="css/changelog_modal.css",C.id="changelog-modal-css",document.head.appendChild(C)}document.querySelectorAll(".overlay").forEach(C=>C.remove())}),x()},b.style.textAlign="left",Object.assign(b.style,{position:"fixed",bottom:"32px",left:"0",right:"0",margin:"0 auto",background:"linear-gradient(90deg, #23272a 80%, #2d3136 100%)",color:"#f3f3f3",padding:"14px 28px 14px 22px",borderRadius:"13px",fontSize:"1em",display:"flex",alignItems:"center",boxShadow:"0 8px 32px #0005",maxWidth:"480px",minWidth:"220px",zIndex:2e4,animation:"fadein-popup-banner-bottom 0.7s",cursor:"default"}),b.querySelector("button").onclick=x,setTimeout(()=>{document.body.contains(b)&&x()},8e3),document.body.appendChild(b),!document.getElementById("info-popup-banner-anim-bottom")){let M=document.createElement("style");M.id="info-popup-banner-anim-bottom",M.textContent=`
        @keyframes fadein-popup-banner-bottom { from { opacity:0; transform:translateY(48px);} to { opacity:1; transform:none; } }
        @keyframes fadeout-popup-banner-bottom { from { opacity:1; } to { opacity:0; transform:translateY(48px);} }
      `,document.head.appendChild(M)}}document.body.addEventListener("click",b=>{b.target.closest('[data-action="show-help"]')&&Promise.resolve().then(()=>(Ze(),Tt)).then(M=>M.renderHelpOverlay())});let c=n.getAll(),g=o.user,r=window.filterPostsByUserId||null,d=ae(n,s);r&&(d=d.filter(b=>b.userId===r));let m=s.filterTag||s.search||r?d.length:c.posts.length,u=document.createElement("div");u.className="topbar",u.innerHTML=`
    <div class="toolbar topbar-toolbar">
      <div class="user-actions-container">
        ${g?'<span class="notification-dot" id="mobile-notification-dot" style="position: static; cursor: pointer; display: inline-block; margin-left: 0px; margin-right: 0px; opacity: 0.35;" title="No notifications"></span>':""}
        <div class="user-pill" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false">
          <span class="pill" title="current user">> user: ${g?A(g.name):"guest"}</span>
        </div>
        <div class="user-action-buttons">
          ${g?`<button class="btn btn-ghost" data-action="view-user" data-uid="${A(g.id)}" style="position:relative;">
                  [ profile ]
                </button><button class="btn btn-ghost" data-action="logout" title="logout">[ logout ]</button>`:`<button class="btn btn-ghost" id="goLoginBtn" title="login / register" style="position:relative;">
                  [ login / register ]
                </button>`}
          <button class="btn btn-ghost" data-action="show-help" title="keyboard shortcuts">[ help ]</button>
        </div>
      </div>
    </div>
  `;let l=u.querySelector('[data-action="view-user"], #goLoginBtn'),p=u.querySelector(".user-actions-container"),y=u.querySelector(".user-pill"),h=u.querySelector(".user-action-buttons");y&&h&&("ontouchstart"in window?(y.addEventListener("touchstart",b=>{p.classList.contains("open")||(p.classList.add("open"),y.setAttribute("aria-expanded","true"),b.preventDefault())}),y.addEventListener("click",()=>{p.classList.contains("open")&&(p.classList.remove("open"),y.setAttribute("aria-expanded","false"))})):y.addEventListener("click",()=>{p.classList.toggle("open"),y.setAttribute("aria-expanded",p.classList.contains("open"))}),y.addEventListener("keydown",b=>{(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),p.classList.toggle("open"),y.setAttribute("aria-expanded",p.classList.contains("open")))}),"ontouchstart"in window||(p.addEventListener("mouseenter",()=>{p.classList.add("open"),y.setAttribute("aria-expanded","true")}),p.addEventListener("mouseleave",()=>{p.classList.remove("open"),y.setAttribute("aria-expanded","false")})),document.addEventListener("click",b=>{p.contains(b.target)||(p.classList.remove("open"),y.setAttribute("aria-expanded","false"))}));let k=$(),E=document.createElement("div");E.className="dock",E.id="dock",E.style.display="none",E.style.borderBottom="none",E.innerHTML=`
    <div class="hstack" style="justify-content:center; align-items:center; flex-wrap:wrap; gap:18px;">
      <div class="hstack" style="gap:18px;">
        <button class="btn" data-action="q-prev" title="previous in queue (k)">[ prev ]</button>
        <button class="btn" data-action="q-stop" title="stop">[ stop ]</button>
        <button class="btn" data-action="q-next" title="next in queue (j)">[ next ]</button>
        <button class="btn" data-action="q-shuffle" aria-pressed="${k.shuffle}" title="shuffle">[ shuffle ]</button>
        <button class="btn btn-ghost" data-action="q-clear" title="clear queue">[ clear ]</button>
      </div>
    </div>
    <div class="small" style="text-align:center; margin-top:6px;">
      <span id="nowPlaying" class="muted"></span> \xB7 queue <span id="qPos">0</span>/<span id="qLen">0</span>
    </div>
  `,E.addEventListener("click",b=>{if(b.target.closest('[data-action="q-stop"]')){let M=document.querySelector(".player.active");if(M){M.querySelectorAll("audio,video").forEach(C=>{C.pause&&C.pause(),C.currentTime=0}),M.querySelectorAll("iframe").forEach(C=>C.src=""),M.classList.remove("active");let P=document.querySelector(".post.is-playing");P&&P.classList.remove("is-playing")}}});let L=s.filterTag?`play #${A(s.filterTag)}`:"play all",v=document.createElement("div");v.className="box",v.id="tagsBoxMain",v.style.marginBottom="16px",v.innerHTML=`
    <div class="hstack" style="justify-content:space-between; align-items:center">
      <div class="muted small">> tags</div>
      ${s.filterTag?'<button class="btn btn-ghost small" data-action="clear-tag">[ clear tag ]</button>':""}
    </div>
    <div id="tags"></div>
  `;let w=document.createElement("div");w.className="box",w.innerHTML=`
    <div class="feed-search-bar" style="margin-bottom:12px;">
      <input class="field" id="search" type="search" placeholder="search title/artist/tags..." value="${A(s.search)}" aria-label="search"/>
    </div>
    <div class="hstack feed-header-bar" style="justify-content:space-between; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <div class="hstack" style="gap:10px; align-items:center;">
        <span class="muted">&gt; feed</span>
        ${r?`<span class="pill">user filter: <a href="#" data-action="clear-user-filter">${A(c.users.find(b=>b.id===r)?.name||"user")}</a> <a href="#" data-action="clear-user-filter" title="clear user filter">\u2715</a></span>`:""}
        ${s.filterTag?`<span class="pill">tag: #${A(s.filterTag)} <a href="#" data-action="clear-tag" title="clear tag">\u2715</a></span>`:""}
  <span title="total posts">posts: ${m}</span>
      </div>
      <div class="hstack" style="gap:12px; align-items:center;">
        <button class="btn btn-ghost" data-action="play-all">[ ${L} ]</button>
        <div class="sort-icons" id="sort-icons" aria-label="sort order">
          <button class="sort-btn${s.sort==="new"?" active":""}" data-sort="new" title="Sort by newest"><span class="icon-sort-newest"></span></button>
          <button class="sort-btn${s.sort==="likes"?" active":""}" data-sort="likes" title="Sort by most liked"><span class="icon-sort-likes"></span></button>
          <button class="sort-btn${s.sort==="comments"?" active":""}" data-sort="comments" title="Sort by most commented"><span class="icon-sort-comments"></span></button>
        </div>
      </div>
    </div>
    <div id="feed"></div>
    <div id="pager" class="hstack" style="justify-content:center; margin-top:8px"></div>
  `,e.appendChild(u),e.appendChild(v),e.appendChild(E),e.appendChild(w);function I(){let b=document.querySelector(".tag-cloud");b&&(window._tagCloudScrollLeft=b.scrollLeft);let x=$();o.page=1,j(T("#feed"),T("#pager"),o,n,x),oe(T("#tags"),n,x),te()}window._userFilterHandlerAttached||(window.addEventListener("filter-user-posts",b=>{window.filterPostsByUserId=b.detail.userId,I()}),window._userFilterHandlerAttached=!0),w.addEventListener("click",b=>{b.target&&b.target.dataset&&b.target.dataset.action==="clear-user-filter"&&(window.filterPostsByUserId=null,I(),b.preventDefault())}),I();let f=w.querySelector("#search");f&&f.addEventListener("input",Be(b=>{H({search:b.target.value}),o.page=1,j(T("#feed"),T("#pager"),o,n,$())},120));let S=w.querySelector("#sort-icons");return S&&S.addEventListener("click",b=>{let x=b.target.closest(".sort-btn");if(x){let M=x.getAttribute("data-sort");H({sort:M}),o.page=1,j(T("#feed"),T("#pager"),o,n,$())}}),{top:u,dock:E,tagsBox:v,feedBox:w}}_();if(/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)){let t=function(){let e=document.getElementById("mobile-notification-dot");if(!e){setTimeout(t,100);return}Promise.resolve().then(()=>(xe(),Qe)).then(({state:o})=>{if(!o.user){e.style.display="none";return}e.setAttribute("tabindex","0"),e.setAttribute("role","button"),e.setAttribute("aria-label","Show notifications");let n=[];Promise.resolve().then(()=>(we(),We)).then(({default:s})=>{function i(r){e.style.display="inline-block",r.length?(e.style.opacity="1",e.title="Show notifications"):(e.style.opacity="0.35",e.title="No notifications");for(let d of r)n.some(m=>m.id===d.id)||n.push(d)}s.subscribe(i),i(s.list);let a=null;function c(){a&&(a.remove(),a=null)}function g(r){if(r){if(r.type==="keydown"&&r.key!=="Enter"&&r.key!==" ")return;r.stopPropagation(),r.preventDefault()}if(console.log("[notif-dot] handleDotActivate",r?r.type:"no event"),a){c();return}a=document.createElement("div"),a.className="notification-popup-panel",a.style.position="fixed";let d=e.getBoundingClientRect();a.style.top=d.bottom+6+"px",a.style.left=d.left-12+"px",a.style.zIndex="10000",a.style.background="#232b36",a.style.color="#fff",a.style.border="1.5px solid #333a",a.style.borderRadius="10px",a.style.boxShadow="0 8px 32px #0008, 0 1.5px 0 #fff1 inset",a.style.padding="14px 18px 10px 18px",a.style.minWidth="220px",a.style.maxWidth="320px",a.style.fontSize="1em",a.style.display="flex",a.style.flexDirection="column",a.style.gap="10px",a.innerHTML=`
              <div style="font-weight:600;font-size:1.08em;margin-bottom:2px;letter-spacing:0.01em;">Notifications</div>
              <div class="notification-list" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;">
                ${n.length?n.map(u=>{let l=typeof u.id=="number"&&typeof K=="function"?K(u.id):"";return l==="just"&&(l="just now"),`<div style="background:${u.type==="error"?"#f44336":"#263245"};padding:8px 12px;border-radius:6px;box-shadow:0 1px 4px #0002;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;gap:12px;">
                    <span>${u.message}</span>
                    <span style="font-size:0.92em;opacity:0.7;white-space:nowrap;">${l}</span>
                  </div>`}).join(""):'<span class="muted small">No notifications yet.</span>'}
              </div>
              <button class="btn btn-ghost small" style="align-self:flex-end;margin-top:4px;" id="closeNotifPopupBtn">close</button>
            `,document.body.appendChild(a),a.querySelector("#closeNotifPopupBtn").onclick=c,setTimeout(()=>{document.addEventListener("mousedown",m,{once:!0}),document.addEventListener("touchstart",m,{once:!0})},200);function m(u){a&&!a.contains(u.target)&&u.target!==e&&c()}}e.addEventListener("click",g),e.addEventListener("touchstart",g),e.addEventListener("keydown",g)})})};try{let e=!0;if(window.state&&window.state.user&&(e=!1),e){let o=document.getElementById("mobile-notification-dot");o&&o.parentNode&&o.parentNode.removeChild(o)}}catch{}t()}function et(t,e,o,n){if(!e.user){t.innerHTML=`<div class="box" style="text-align:center;padding:2.5em 1em;font-size:1.1em;line-height:1.6;">
      <div class="muted small">&gt; profile</div>
      <div style="margin:1.5em 0 0.5em 0;">You need to <b>log in</b> or <b>register</b> to view your profile.</div>
    <button class="btn" data-action="go-login" style="margin-top:1.2em;">[ login / register ]</button>
    </div>`;return}function s(w,I){if(!w)return"";let f=w.trim();if(!f)return"";if(I==="youtube")return/^https?:\/\/(www\.)?youtube\.com\/(watch\?v=|shorts\/)[^\s]+/i.test(f)?f:(f=f.replace(/^https?:\/\//i,"").replace(/^www\./i,""),f=f.replace(/^youtube\.com\//i,""),f=f.replace(/^@/,"").replace(/\/$/,""),f?"@"+f:"");switch(f=f.replace(/^https?:\/\//i,""),I){case"facebook":f=f.replace(/^(www\.)?facebook\.com\//i,"");break;case"instagram":f=f.replace(/^(www\.)?instagram\.com\//i,"");break;case"twitter":f=f.replace(/^(www\.)?twitter\.com\//i,"");break;case"bandcamp":f=f.replace(/^(www\.)?([^\.]+)\.bandcamp\.com.*/i,"$2");break;case"soundcloud":f=f.replace(/^(www\.)?soundcloud\.com\//i,"");break;case"lastfm":let S=f.match(/last\.fm\/user\/([^\/]+)/i);S?f=S[1]:f=f.replace(/^www\./,"").replace(/^@/,"");break;default:break}return f=f.replace(/^@/,"").replace(/\/$/,""),f?"@"+f:""}let i=o.getAll(),a=e.user;if(!a)return;let c=i.users.find(w=>w.id===a.id)||null,g=c?.about||"",r=c?.avatarUrl||"/assets/android-chrome-512x512.png",d={facebook:c?.facebook||"",instagram:c?.instagram||"",twitter:c?.twitter||"",bandcamp:c?.bandcamp||"",soundcloud:c?.soundcloud||"",youtube:c?.youtube||"",lastfm:c?.lastfm||""};function m(w){let I={facebook:"\u{1F310}",instagram:"\u{1F4F8}",twitter:"\u{1F426}",bandcamp:"\u{1F3B5}",soundcloud:"\u2601\uFE0F",youtube:"\u25B6\uFE0F",lastfm:"\u{1F3B6}"};function f(S,b){let x=(S||"").trim();if(!x)return"";if(/^https?:\/\//i.test(x))return x;switch(b){case"facebook":return"https://facebook.com/"+x.replace(/^@/,"");case"instagram":return"https://instagram.com/"+x.replace(/^@/,"");case"twitter":return"https://twitter.com/"+x.replace(/^@/,"");case"bandcamp":return"https://"+x.replace(/^https?:\/\//,"").replace(/\/$/,"")+".bandcamp.com/";case"soundcloud":return"https://soundcloud.com/"+x.replace(/^@/,"");case"youtube":return/^[\w-]{11}$/.test(x)?"https://www.youtube.com/watch?v="+x:/^@/.test(x)?"https://www.youtube.com/"+x:"https://www.youtube.com/c/"+x.replace(/^@/,"");case"lastfm":let M=x.replace(/^@/,""),P=M.match(/last\.fm\/user\/([^\/]+)/i);return P?"https://www.last.fm/user/"+P[1]:(M=M.replace(/^www\./,""),"https://www.last.fm/user/"+M);default:return x}}return Object.entries(w).filter(([S,b])=>b).map(([S,b])=>{let x=f(b,S);return`<a href="${A(x)}" target="_blank" rel="noopener" class="social-link" title="${S}">${I[S]}</a>`}).join(" ")}let u=document.createElement("div");u.className="box",u.id="aboutBox",u.innerHTML=`
    <div class="muted small">&gt; my profile</div>
    <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:8px;">
      <img class="profile-avatar-small" src="${A(r)}" alt="avatar" />
    </div>
    <div id="aboutCollapsed" style="display:flex; flex-direction:column; gap:8px; min-height:38px;">
      <div id="aboutText" class="about-preview">${g?A(g).replace(/\n/g,"<br>"):'<span class="muted small">no about yet.</span>'}</div>
      <div id="aboutSocials">${m(d)||'<span class="muted small">no social links</span>'}</div>
      <button class="btn btn-ghost small" id="editAboutBtn" type="button">[ edit ]</button>
    </div>
    <form class="stack" id="aboutEditForm" data-action="profile-form" autocomplete="off" style="display:none; margin-top:8px;" enctype="multipart/form-data">
  <label class="muted small" style="margin-bottom:4px;" for="avatarFile">Change avatar:</label>
      <div class="custom-file-input-wrapper" style="margin-bottom:8px;">
        <input class="custom-file-input" type="file" id="avatarFile" name="avatar" accept="image/*" />
        <label for="avatarFile" class="btn btn-ghost small" id="avatarFileLabel">[ upload new avatar ]</label>
        <span class="muted small" id="avatarFileName" style="margin-left:8px;"></span>
      </div>
      <textarea class="field" id="aboutMe" name="about" rows="3" maxlength="500" placeholder="Write a short bio...">${A(g)}</textarea>
      <fieldset class="social-links-group" style="border:1px dashed var(--line); border-radius:8px; padding:12px; margin:12px 0;">
        <legend class="muted small" style="padding:0 8px;">Social Links</legend>
        <div class="social-fields" style="display:grid; grid-template-columns:1fr; gap:8px;">
          <label for="socialFb"><span class="sr-only">Facebook</span></label>
          <input class="field" type="text" id="socialFb" name="fb_user" placeholder="Facebook username or URL" value="${A(s(d.facebook,"facebook"))}" autocomplete="username" />
          <label for="socialInsta"><span class="sr-only">Instagram</span></label>
          <input class="field" type="text" id="socialInsta" name="insta_user" placeholder="Instagram username or URL" value="${A(s(d.instagram,"instagram"))}" autocomplete="username" />
          <label for="socialTwtr"><span class="sr-only">Twitter</span></label>
          <input class="field" type="text" id="socialTwtr" name="twtr_user" placeholder="Twitter username or URL" value="${A(s(d.twitter,"twitter"))}" autocomplete="username" />
          <label for="socialBandcamp"><span class="sr-only">Bandcamp</span></label>
          <input class="field" type="text" id="socialBandcamp" name="bc_user" placeholder="Bandcamp username or URL" value="${A(s(d.bandcamp,"bandcamp"))}" autocomplete="username" />
          <label for="socialSoundcloud"><span class="sr-only">SoundCloud</span></label>
          <input class="field" type="text" id="socialSoundcloud" name="sc_user" placeholder="SoundCloud username or URL" value="${A(s(d.soundcloud,"soundcloud"))}" autocomplete="username" />
          <label for="socialYoutube"><span class="sr-only">YouTube</span></label>
          <input class="field" type="text" id="socialYoutube" name="yt_user" placeholder="YouTube username or URL" value="${A(s(d.youtube,"youtube"))}" autocomplete="username" />
          <label for="socialLastfm"><span class="sr-only">Last.fm</span></label>
          <input class="field" type="text" id="socialLastfm" name="lastfm_user" placeholder="Last.fm username or URL" value="${A(s(d.lastfm,"lastfm"))}" autocomplete="username" />
        </div>
        <div class="muted small" style="margin-top:8px;">You can enter just your username or a full URL for each social field.</div>
      </fieldset>
      <div class="hstack">
        <button class="btn" type="submit">[ save about ]</button>
        <button class="btn btn-ghost small" id="cancelAboutBtn" type="button">[ cancel ]</button>
        <span class="muted small" id="profileMsg"></span>
      </div>
    </form>
  `;let l=u.querySelector("#avatarFile"),p=u.querySelector("#avatarFileName");l&&p&&l.addEventListener("change",function(){p.textContent=this.files&&this.files.length>0?this.files[0].name:""});let y=u.querySelector(".muted.small");if(y){let w=document.createElement("span");w.className="notification-dot",w.style.display="none",w.style.position="static",w.style.marginLeft="8px",w.style.verticalAlign="middle",w.style.background="#f44336",w.style.border="2px solid #222e3a",w.style.boxShadow="0 0 2px #0008",y.appendChild(w);let I=[];Promise.resolve().then(()=>(we(),We)).then(({default:f})=>{function S(M){w.style.display="inline-block",M.length?(w.style.opacity="1",w.title="Show notifications"):(w.style.opacity="0.35",w.title="No notifications");for(let P of M)I.some(C=>C.id===P.id)||I.push(P)}f.subscribe(S),S(f.list),w.style.cursor="pointer";let b=null;function x(){b&&(b.remove(),b=null)}w.addEventListener("click",M=>{if(M.stopPropagation(),b){x();return}b=document.createElement("div"),b.className="notification-popup-panel",b.style.position="absolute",b.style.top="28px",b.style.left="0",b.style.zIndex="10000",b.style.background="#232b36",b.style.color="#fff",b.style.border="1.5px solid #333a",b.style.borderRadius="10px",b.style.boxShadow="0 8px 32px #0008, 0 1.5px 0 #fff1 inset",b.style.padding="14px 18px 10px 18px",b.style.minWidth="220px",b.style.maxWidth="320px",b.style.fontSize="1em",b.style.display="flex",b.style.flexDirection="column",b.style.gap="10px",b.innerHTML=`
          <div style="font-weight:600;font-size:1.08em;margin-bottom:2px;letter-spacing:0.01em;">Notifications</div>
          <div class="notification-list" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;">
            ${I.length?I.map(q=>{let J=typeof q.id=="number"?K(q.id):"";return J==="just"&&(J="just now"),`<div style="background:${q.type==="error"?"#f44336":"#263245"};padding:8px 12px;border-radius:6px;box-shadow:0 1px 4px #0002;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;gap:12px;">
                <span>${q.message}</span>
                <span style="font-size:0.92em;opacity:0.7;white-space:nowrap;">${J}</span>
              </div>`}).join(""):'<span class="muted small">No notifications yet.</span>'}
          </div>
          <button class="btn btn-ghost small" style="align-self:flex-end;margin-top:4px;" id="closeNotifPopupBtn">close</button>
        `;let P=w.getBoundingClientRect();b.style.position="fixed",b.style.top=P.bottom+6+"px",b.style.left=P.left-12+"px",document.body.appendChild(b),b.querySelector("#closeNotifPopupBtn").onclick=x,setTimeout(()=>{document.addEventListener("mousedown",C,{once:!0})},0);function C(q){b&&!b.contains(q.target)&&q.target!==w&&x()}})})}t.appendChild(u);let h=u.querySelector("#aboutCollapsed"),k=u.querySelector("#aboutEditForm"),E=u.querySelector("#editAboutBtn"),L=u.querySelector("#cancelAboutBtn");E.addEventListener("click",()=>{h.classList.add("fade-out"),h.classList.remove("fade-in"),setTimeout(()=>{h.style.display="none",k.style.display="",/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)||k.querySelector("#aboutMe").focus()},180)}),L.addEventListener("click",()=>{k.style.display="none",h.style.display="flex",h.classList.remove("fade-out"),h.classList.add("fade-in")});function v(w,I){let f=(w||"").trim();if(!f)return"";if(/^https?:\/\//i.test(f))return f;switch(I){case"facebook":return"https://facebook.com/"+f.replace(/^@/,"");case"instagram":return"https://instagram.com/"+f.replace(/^@/,"");case"twitter":return"https://twitter.com/"+f.replace(/^@/,"");case"bandcamp":return"https://"+f.replace(/^https?:\/\//,"").replace(/\/$/,"")+".bandcamp.com/";case"soundcloud":return"https://soundcloud.com/"+f.replace(/^@/,"");case"youtube":return/^[\w-]{11}$/.test(f)?"https://www.youtube.com/watch?v="+f:/^@/.test(f)?"https://www.youtube.com/"+f:"https://www.youtube.com/c/"+f.replace(/^@/,"");case"lastfm":let S=f.replace(/^@/,""),b=S.match(/last\.fm\/user\/([^\/]+)/i);return b?"https://www.last.fm/user/"+b[1]:(S=S.replace(/^www\./,""),"https://www.last.fm/user/"+S);default:return f}}k.addEventListener("submit",async w=>{w.preventDefault();let I=k,f=I.querySelector("#aboutMe").value,S=v(I.querySelector("#socialFb").value,"facebook"),b=v(I.querySelector("#socialInsta").value,"instagram"),x=v(I.querySelector("#socialTwtr").value,"twitter"),M=v(I.querySelector("#socialBandcamp").value,"bandcamp"),P=v(I.querySelector("#socialSoundcloud").value,"soundcloud"),C=v(I.querySelector("#socialYoutube").value,"youtube"),q=v(I.querySelector("#socialLastfm").value,"lastfm");await o.updateUser(a.id,{about:f,facebook:S,instagram:b,twitter:x,bandcamp:M,soundcloud:P,youtube:C,lastfm:q}),setTimeout(()=>{k.style.display="none",h.style.display="flex",h.classList.remove("fade-out"),h.classList.add("fade-in"),typeof n=="function"&&n()},100)})}var xo="> so what song has been stuck in your head lately?",ko="> share a track that made your day better!",Lo="> what have you been looping non-stop?",Eo="> found a hidden gem? drop it here!",So="> what tune do you want everyone to hear right now?",Io="> got a song that matches your mood? share it!",To="> post a track that brings back memories.",Mo="> help us discover something new today!",Co="> what track sets the vibe for you right now?",Ao="> which song do you keep coming back to?",Po="> what would be the soundtrack to your day?",qo="> what was the first song you loved?",$o="> what was the last song you added to your playlist?",_o="> what song gets you going in the morning?",Bo="> what do you listen to late at night?",Ro="> share a song with your favorite lyrics!",No="> what\u2019s the most underrated track you know?",Uo="> which song makes you want to dance?",Oo="> what\u2019s your go-to chillout song?",Ho="> which song inspires you the most?",Fo="> what\u2019s your favorite song for traveling?",Do="> what song would you recommend to a friend?",ne=[xo,ko,Lo,Eo,So,Io,To,Mo,Co,Ao,Po,qo,$o,_o,Bo,Ro,No,Uo,Oo,Ho,Fo,Do];_();Me();be();function $t(){return ne[Math.floor(Math.random()*ne.length)]}function tt(t,e,o,n){if(!e.user){let f=function(){let S;do S=$t();while(S===I&&ne.length>1);I=S;let b=0;w.textContent="",w.classList.remove("fadein","fadeout");function x(){if(b<S.length){w.textContent+=S.charAt(b),b++;let M=28+Math.random()*40;/[.,!?]/.test(S.charAt(b-1))&&(M+=80+Math.random()*60),S.charAt(b-1)===" "&&(M+=30),setTimeout(x,M)}}x()},v=document.createElement("div");v.className="box",v.innerHTML=`
      <div class="muted small" id="composePromptGuest"></div>
      <div class="notice small">You are in guest read-only mode. Login to post, like, or comment.</div>
      <button class="btn btn-ghost" data-action="go-login">[ login / register ]</button>
    `,t.appendChild(v);let w=v.querySelector("#composePromptGuest"),I="";f(),setInterval(f,1e4);return}let i=document.createElement("div");i.className="box",i.innerHTML=`
    <div class="muted small typewriter" id="composePrompt" style="margin-bottom:18px;"></div>
    <form id="postForm" class="stack" autocomplete="off">
      <input class="field" id="f_url" placeholder="Link (YouTube / Spotify / Bandcamp, etc)" required/>
  <div class="muted small" id="autofillMsg" style="margin-bottom:2px; display:none;">&#8593; Should autofill artist information if we're lucky.</div>
      <input class="field" id="f_artist" placeholder="Artist" maxlength="120" style="margin-top:8px;" />
      <input class="field" id="f_title" placeholder="Title (song or album)" required maxlength="120" />
      <input class="field" id="f_tags" placeholder="#Tags go here"/>
      <div id="tagSuggestions" class="hstack" style="flex-wrap:wrap; gap:4px; margin:4px 0 0 0;"></div>
      <div style="position:relative;">
        <textarea class="field" id="f_body" rows="4" placeholder="Share something about this track, a memory, or the vibe it gives you." maxlength="200" oninput="document.getElementById('bodyCounter').textContent = this.value.length + '/200';"></textarea>
        <span class="muted small" id="bodyCounter" style="position:absolute; bottom:6px; right:10px; pointer-events:none;">0/200</span>
      </div>
      <div class="hstack" style="justify-content:space-between; align-items:center; margin-bottom:4px;">
        <div class="muted small" id="captchaBox" style="margin:0;"></div>
      </div>
      <input class="field" id="f_captcha" placeholder="Enter captcha answer" autocomplete="off" style="margin-bottom:2px;" />
      <div id="postFormError" class="muted small" style="color:#c00;min-height:18px;"></div>
      <div class="hstack" style="justify-content:center; margin-top:1px; gap:10px;">
        <button class="btn" type="submit" id="postBtn">[ post ]</button>
        <button class="btn btn-ghost" type="button" id="previewBtn">[ preview ]</button>
      </div>
      <div id="preview" class="player" aria-live="polite"></div>
      <div id="postCooldown" class="muted small" style="text-align:center;margin-top:8px;"></div>
    </form>
  `;function a(){let v=o.getAll(),w=e.user,I=i.querySelector("#postBtn"),f=i.querySelector("#postCooldown");if(!w)return;let S=Date.now(),b=v.posts.filter(x=>x.userId===w.id).sort((x,M)=>M.createdAt-x.createdAt)[0];if(b&&S-b.createdAt<1440*60*1e3){let x=864e5-(S-b.createdAt),M=Math.floor(x/(3600*1e3)),P=Math.floor(x%(3600*1e3)/(60*1e3)),C=Math.floor(x%(60*1e3)/1e3);I&&(I.disabled=!0),f&&(f.textContent=`You can post again in ${M}h ${P}m ${C}s.`)}else I&&(I.disabled=!1),f&&(f.textContent="")}setInterval(a,1e3),a();let c=i.querySelector("#composePrompt"),g="",r=[i.querySelector("#f_url"),i.querySelector("#f_title"),i.querySelector("#f_artist"),i.querySelector("#f_tags"),i.querySelector("#f_body")],d=[];function m(){d.forEach(v=>clearTimeout(v)),d=[]}function u(){m();let v;do v=$t();while(v===g&&ne.length>1);g=v;let w=0;c.textContent="",c.classList.remove("fadein","fadeout"),c.classList.contains("typewriter")||c.classList.add("typewriter");function I(){if(w<v.length){c.textContent+=v.charAt(w),w++;let f=16+Math.random()*32;/[.,!?]/.test(v.charAt(w-1))&&(f+=90+Math.random()*60),v.charAt(w-1)===" "&&(f+=18+Math.random()*10),Math.random()<.07&&(f+=80+Math.random()*120),d.push(setTimeout(I,f))}else d.push(setTimeout(()=>{let f=v.length,S=0;v.startsWith("> ")&&(S=2);function b(){if(f>S){c.textContent=c.textContent.slice(0,-1),f--;let x=13+Math.random()*22;c.textContent.endsWith(" ")&&(x+=12),Math.random()<.05&&(x+=60+Math.random()*80),d.push(setTimeout(b,x))}else d.push(setTimeout(u,900))}b()},2600+Math.random()*700))}I()}u();let l=i.querySelector("#autofillMsg");r.forEach(v=>{v&&(v.addEventListener("focus",()=>{let w=r.find(I=>I&&I.id==="f_url");w&&!w.value?l.style.display="block":l.style.display="none"}),v.id==="f_url"&&v.addEventListener("input",()=>{v.value?l.style.display="none":l.style.display="block"}),v.addEventListener("blur",()=>{setTimeout(()=>{r.some(w=>w&&document.activeElement===w)||(l.style.display="none")},50),setTimeout(()=>{r.some(w=>w&&document.activeElement===w)||u()},60)}))}),t.appendChild(i);let p=i.querySelector("#previewBtn");p&&p.addEventListener("click",async()=>{let v=T("#preview"),w=T("#f_title").value.trim(),I=T("#f_artist").value.trim(),f=T("#f_url").value.trim(),S=(T("#f_tags").value||"").split(/[#\s,]+/g).map(q=>q.trim().toLowerCase()).filter(Boolean),b=T("#f_body").value.trim(),x=Y(f),M={id:"preview",userId:e.user&&e.user.id||"preview",title:w,artist:I,url:f,provider:x,tags:S,body:b,likes:[],comments:[],createdAt:Date.now()},P=await Promise.resolve().then(()=>(re(),je));v.classList.add("active");let C=P.renderPostHTML(M,e,o);C=C.replace(/<div class="actions[\s\S]*?<\/div>/,""),C='<div class="muted small" style="margin-bottom:4px;">Preview Post</div>'+C,v.innerHTML=C});let y=i.querySelector("#f_url");if(y){let b=function(){!y.value.trim()&&!I.value.trim()&&!f.value.trim()&&(v="",w={title:"",artist:""},S={title:!1,artist:!1})},v="",w={title:"",artist:""},I=i.querySelector("#f_title"),f=i.querySelector("#f_artist"),S={title:!1,artist:!1};I.addEventListener("input",()=>{S.title=!0}),f.addEventListener("input",()=>{S.artist=!0}),[y,I,f].forEach(x=>{x.addEventListener("input",b)}),y.addEventListener("input",async()=>{let x=y.value.trim();if(!x){v="";return}if(x===v)return;v=x;let{fetchOEmbed:M}=await Promise.resolve().then(()=>(At(),Ct)),P=await M(x);if(P){let C="",q="";if(/youtube\.com|youtu\.be/.test(x)){let{parseYouTubeTitle:Kt}=await Promise.resolve().then(()=>(qt(),Pt)),ct=Kt(P);C=ct.artist,q=ct.title,C&&C.endsWith(" - Topic")&&(C=C.replace(/ - Topic$/,"").trim())}let J=q||P.title,le=C||P.author_name||"";!C&&le.endsWith(" - Topic")&&(le=le.replace(/ - Topic$/,"").trim()),J&&(!S.title||I.value===w.title)&&(I.value=J,w.title=I.value,S.title=!1),le&&(!S.artist||f.value===w.artist)&&(f.value=le,w.artist=f.value,S.artist=!1)}})}function h(){let v=Math.floor(Math.random()*10)+1,w=Math.floor(Math.random()*10)+1;i.querySelector("#captchaBox").textContent=`Captcha: What is ${v} + ${w}?`,i.querySelector("#captchaBox").dataset.answer=(v+w).toString(),i.querySelector("#f_captcha").value=""}h();let k=i.querySelector("#postForm");k&&(k.addEventListener("submit",v=>Lt(v,e,o,n)),k.addEventListener("resetCaptcha",h));let E=i.querySelector("#f_tags"),L=i.querySelector("#tagSuggestions");if(E&&L){let v=function(){let S=E.value,b=S.split(/[#\s,]+/g).map(C=>C.trim().toLowerCase()).filter(Boolean),x=new Set,M=[];for(let C of b)x.has(C)||(x.add(C),M.push("#"+C));let P=/[\s,]$/.test(S)?" ":"";E.value=M.join(" ")+P},w=function(){let S=o.getAll(),b=new Map;return S.posts.forEach(x=>(x.tags||[]).forEach(M=>b.set(M,(b.get(M)||0)+1))),Array.from(b.entries()).sort((x,M)=>M[1]-x[1]||x[0].localeCompare(M[0])).slice(0,20).map(([x])=>x)},I=function(S=""){let b=w(),x=(E.value||"").split(/[#\s,]+/g).map(P=>P.trim().toLowerCase()).filter(Boolean),M=b.filter(P=>!x.includes(P.toLowerCase()));if(S&&(M=M.filter(P=>P.toLowerCase().includes(S.toLowerCase()))),M.length===0){L.innerHTML="",L.style.display="none";return}L.innerHTML=M.map(P=>`<span class="tag small tag-suggestion" style="cursor:pointer;">#${A(P)}</span>`).join(" "),L.style.display="flex"},f=function(){let S=E.value;if(document.activeElement===E||S.length>0){let b=S.split(/[, ]/).pop().replace(/^#/,"");I(b)}else L.style.display="none"};E.addEventListener("input",()=>{f()}),E.addEventListener("focus",f),E.addEventListener("blur",()=>setTimeout(()=>{L.style.display="none"},100)),E.addEventListener("blur",()=>{v(),setTimeout(()=>{L.style.display="none"},100)}),L.addEventListener("mousedown",S=>S.preventDefault()),L.addEventListener("click",S=>{if(S.target.classList.contains("tag-suggestion")){let b=E.value,x=S.target.textContent.replace(/^#/,""),M=b.slice(0,E.selectionStart).replace(/[#]*([^#\s,]*)$/,""),P=b.slice(E.selectionStart);M=M.replace(/[\s,]*$/,"");let C=M;C&&!/\s$/.test(C)&&(C+=" "),C+="#"+x,P&&!/^\s*$/.test(P)&&(C+=" "),P&&!/^\s*$/.test(P)&&(C+=P),E.value=C.trim()+" ",E.dispatchEvent(new Event("input")),E.focus()}}),L.style.display="none"}}_();re();async function _t(t,e){if(typeof e.refresh!="function")return;let o=document.querySelector(".player.active");await e.refresh();let n=T("#feed"),s=T("#pager"),i=T("#tags");if(!n||!s||!i)return;if(!o){let d=document.querySelector(".tag-cloud");d&&(window._tagCloudScrollLeft=d.scrollLeft);let m=$();j(n,s,t,e,m),oe(i,e,m);return}let a=$(),c=ae(e,a);c.forEach(d=>{let m=document.getElementById("post-"+d.id);if(m){let u=m.querySelector('[data-action="like"]');if(u){u.innerHTML=`[ \u2665 ${d.likes?d.likes.length:0} ]`;let p=(d.likes||[]).includes(t.user&&t.user.id)?"true":"false";u.setAttribute("aria-pressed",p),p==="true"?u.classList.add("like-on"):u.classList.remove("like-on")}let l=m.querySelector('[data-action="comment"]');l&&(l.innerHTML=`[ comments ${d.comments?d.comments.length:0} ]`)}});let g=Array.from(n.querySelectorAll(".post")).map(d=>d.getAttribute("data-post")),r=c.filter(d=>!g.includes(String(d.id)));if(r.length>0){let d=await Promise.resolve().then(()=>(re(),je)),m=r.map(u=>d.renderPostHTML(u,t,e)).join("");n.insertAdjacentHTML("beforeend",m)}c.length>g.length?s.innerHTML=`<button class="btn btn-ghost" data-action="load-more">[ load more (${g.length}/${c.length}) ]</button>`:s.innerHTML=`<div class="small muted">${c.length} loaded</div>`,oe(i,e,a)}function Bt(t,e){window._autoFeedRefresh||(window._autoFeedRefresh=setInterval(()=>{_t(t,e).catch(console.error)},3e4))}function Rt(t,e){if(!window._feedVisibilityHandler){let o=()=>_t(t,e).catch(console.error);window.addEventListener("focus",o),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&o()}),window._feedVisibilityHandler=!0}}async function Nt(t,e,o,n){let s=$();document.body.style.overflow="",document.documentElement.style.overflow="";let i=document.getElementById("ascii-banner");i&&(i.style.display=""),document.body.classList.add("show-header");let a=document.createElement("div");a.className="grid";let c=document.createElement("div"),g=document.createElement("div");a.appendChild(c),a.appendChild(g),t.appendChild(a);let r=window.matchMedia("(max-width: 600px)").matches;if(!window._tunedinMobileResizeHandler){window._tunedinMobileResizeHandler=!0;let p=r;window.addEventListener("resize",()=>{let y=window.matchMedia("(max-width: 600px)").matches;if(y!==p){p=y;let h=document.querySelector(".mobile-tab-bar");h&&h.remove(),n()}})}let d="feed";function m(p){d=p,c.style.display="none",g.style.display="none",p==="feed"&&(c.style.display=""),(p==="compose"||p==="profile")&&(g.style.display=""),p==="profile"?(g.innerHTML="",et(g,e,o,n)):p==="compose"&&(g.innerHTML="",tt(g,e,o,n)),document.querySelectorAll(".mobile-tab-bar button").forEach(h=>h.classList.toggle("active",h.dataset.tab===p))}if(Mt({root:t,left:c,state:e,DB:o,prefs:s,render:n}),r?g.style.display="none":(e.user&&et(g,e,o,n),tt(g,e,o,n)),r){let E=function(L){let v=h.findIndex(w=>w.dataset.tab===L);v!==-1&&k&&(k.style.left=`calc(${v} * 100% / 3)`)},p=document.querySelector(".mobile-tab-bar");p&&p.remove();let y=document.createElement("nav");y.className="mobile-tab-bar",y.setAttribute("role","tablist"),y.innerHTML=`
      <div class="tab-indicator"></div>
      <button data-tab="feed" class="active" aria-label="Feed" role="tab" aria-selected="true" tabindex="0">
        <span>\u{1F3E0}</span>
        <span class="tab-label">Feed</span>
      </button>
      <button data-tab="compose" aria-label="Compose" role="tab" aria-selected="false" tabindex="-1">
        <span>\u270D\uFE0F</span>
        <span class="tab-label">Compose</span>
      </button>
      <button data-tab="profile" aria-label="Profile" role="tab" aria-selected="false" tabindex="-1">
        <span>\u{1F464}</span>
        <span class="tab-label">Profile</span>
      </button>
    `,document.body.appendChild(y);let h=Array.from(y.querySelectorAll("button[data-tab]")),k=y.querySelector(".tab-indicator");y.addEventListener("keydown",L=>{let v=h.findIndex(w=>w===document.activeElement);if(L.key==="ArrowRight"||L.key==="ArrowLeft"){L.preventDefault();let w=v;L.key==="ArrowRight"&&(w=(v+1)%h.length),L.key==="ArrowLeft"&&(w=(v-1+h.length)%h.length),h[w].focus()}else L.key==="Home"?(L.preventDefault(),h[0].focus()):L.key==="End"?(L.preventDefault(),h[h.length-1].focus()):(L.key==="Enter"||L.key===" ")&&(L.preventDefault(),v!==-1&&h[v].click())}),y.addEventListener("click",L=>{let v=L.target.closest("button[data-tab]");v&&(m(v.dataset.tab),h.forEach(w=>{w.setAttribute("aria-selected",w===v?"true":"false"),w.tabIndex=w===v?0:-1}),v.focus(),E(v.dataset.tab))}),m("feed"),E("feed"),h[0].tabIndex=0}D(!1,e,o),Bt(e,o),Rt(e,o),t.addEventListener("click",p=>{p.target.closest('#goLoginBtn, [data-action="go-login"]')&&(p.preventDefault(),e.forceLogin=!0,n())});let u=T("#importFile");u&&u.addEventListener("change",p=>xt(p,o,e,n));let l=T("#autoScroll");l&&(l.onchange=()=>H({autoScroll:l.checked}))}_();var jo=ne;function Ut(t,e){return t+Math.random()*(e-t)}function Wo(t,e){let o=getComputedStyle(e),n=document.createElement("span");n.textContent=t,n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.style.font=o.font,n.style.letterSpacing=o.letterSpacing,document.body.appendChild(n);let s=n.offsetWidth;return document.body.removeChild(n),s||0}function Jo(t,e){let n=(e.parentElement||e).clientWidth||0;if(!n)return 1;let s=parseFloat(getComputedStyle(e).fontSize)||14,i=e.style.fontSize;e.style.fontSize=s+"px";let a=Wo(t,e);return e.style.fontSize=i||"",a?{scale:Math.min(1,n/a),basePx:s}:1}function ot(t,e={}){let o=typeof t=="string"?document.getElementById(t):t;if(!o)return()=>{};let n=e.prompts||jo,s=e.typeMin??28,i=e.typeMax??60,a=e.eraseMin??16,c=e.eraseMax??40,g=e.holdMs??1200,r=e.pauseBetween??300,d=Math.floor(Math.random()*n.length),m=0,u=!1,l=null,p=!1;o.style.whiteSpace="nowrap",o.style.overflow="hidden",o.style.textOverflow="clip";let y=parseFloat(getComputedStyle(o).fontSize)||14,h=n[d],k=1;function E(){let I=Jo(h,o);typeof I=="object"&&I!==null?(k=I.scale??1,y=I.basePx??y):k=I||1,o.style.fontSize=(y*k).toFixed(2)+"px"}function L(){d=(d+1)%n.length,h=n[d],m=0,u=!1,E()}let v=()=>E();window.addEventListener("resize",v),window.addEventListener("orientationchange",v),E();function w(){if(p)return;let I=h;u?(m--,o.textContent=I.slice(0,m),m>0?l=setTimeout(w,Ut(a,c)):(L(),l=setTimeout(w,r))):(m++,o.textContent=I.slice(0,m),m<I.length?l=setTimeout(w,Ut(s,i)):(u=!0,l=setTimeout(w,g)))}return w(),()=>{p=!0,clearTimeout(l),window.removeEventListener("resize",v),window.removeEventListener("orientationchange",v),o.style.fontSize=""}}var Pe=null;function Ot(){let t=document.getElementById("loginAnimatedPrompt");t&&(nt(),Pe=ot(t))}function nt(){Pe&&(Pe(),Pe=null)}he();qe();function at(t,e,o){let n=document.getElementById("ascii-banner");n&&(n.style.display="none"),document.body.classList.remove("show-header");let s=document.body.style.overflow,i=document.documentElement.style.overflow;document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden";let a=document.createElement("div");if(a.className="login login-fadein",a.innerHTML=`
    <div class="auth-shell">
      <img src="/assets/logo.png" alt="Logo" class="login-logo-anim" style="display:block; margin:0 auto; width:64px; height:64px; object-fit:contain; animation:none;" />
      <div class="small muted">\u250C\u2500 login or register to</div>
      <div class="logo">TunedIn.space</div>
      <div class="small muted">\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500</div>

      <div class="title">
        <span id="loginAnimatedPrompt" aria-hidden="true"></span>
        <span id="registerAnimatedPrompt" aria-hidden="true" style="display:none;"></span>
      </div>

      <form id="loginForm" class="stack auth-form" autocomplete="off">
        <input required type="email" id="loginEmail" class="field" placeholder="Email" />
        <input required minlength="6" maxlength="64" id="loginPass" class="field" type="password" placeholder="Password" />
        <button class="btn" type="submit">[ sign in ]</button>
        <div class="auth-links">
          <a href="#" id="showRegister" class="muted small" style="text-decoration:underline;">Don't have an account? Create one</a>
        </div>
        <div class="muted small auth-msg" id="loginMsg">${e.isRemote?"Sign in to be able to post content,<br>":""}or use guest mode below.</div>
      </form>

      <form id="registerForm" class="stack auth-form" autocomplete="off" style="display:none;">
        <input required minlength="2" maxlength="24" id="regName" class="field" placeholder="Username" />
        <input required type="email" id="regEmail" class="field" placeholder="Email" />
        <input required minlength="6" maxlength="64" id="regPass" class="field" type="password" placeholder="Password" />
        <button class="btn" type="submit">[ create account ]</button>
        <div class="auth-links">
          <a href="#" id="showLogin" class="muted small" style="text-decoration:underline;">Already have an account? Sign in</a>
        </div>
        <div class="muted small auth-msg" id="regMsg">${e.isRemote?"Register to post.  ":""}Or view in guest mode.</div>
      </form>

      <div class="sep"></div>
      <div class="hstack" style="justify-content:center;">
        <button class="btn btn-ghost" id="guestBtn" type="button">[ continue as guest ]</button>
      </div>
    </div>
  `,t.appendChild(a),setTimeout(()=>{let u=a.querySelector(".login-logo-anim");u&&(u.style.animation="")},700),window.matchMedia("(max-width: 600px)").matches){let u=document.querySelector('header[role="banner"]');u&&u.parentNode&&u.parentNode.removeChild(u)}let c=()=>{document.body.style.overflow=s||"",document.documentElement.style.overflow=i||""},g=(...u)=>{c(),window.matchMedia("(max-width: 600px)").matches&&(document.querySelector('header[role="banner"]')||st()),o(...u)},r=null;function d(){z(!1),T("#loginForm").style.display="",T("#registerForm").style.display="none",T("#loginAnimatedPrompt").style.display="",T("#registerAnimatedPrompt").style.display="none",r&&(r(),r=null),T("#loginAnimatedPrompt").textContent="",Ot(),/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)||T("#loginEmail").focus()}function m(){T("#loginForm").style.display="none",T("#registerForm").style.display="",T("#loginAnimatedPrompt").style.display="none",T("#registerAnimatedPrompt").style.display="",nt();let u=document.getElementById("registerAnimatedPrompt");u.textContent="",r=ot(u),/Mobi|Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)||T("#regName").focus()}T("#showLogin").onclick=u=>{u.preventDefault(),d()},T("#showRegister").onclick=u=>{u.preventDefault(),m()},T("#guestBtn").onclick=()=>{z(!0),g()},T("#registerForm").addEventListener("submit",async u=>{u.preventDefault();let l=T("#regName").value.trim(),p=T("#regEmail").value.trim(),y=T("#regPass").value;if(!l||!p||!y)return;Promise.resolve().then(()=>(_(),pt)).then(k=>{if(!k.isValidEmailFormat(p)){T("#regMsg").textContent="Please enter a valid email address.";return}Promise.resolve().then(()=>(fe(),Oe)).then(E=>{if(E.isDisposableEmail&&E.isDisposableEmail(p)){T("#regMsg").textContent="Disposable (temporary) email addresses are not allowed.";return}h()})});function h(){T("#regMsg").textContent="Registering...",(async()=>{try{let k;if(e.isRemote&&e.supabase){let{data:E,error:L}=await e.supabase.auth.signUp({email:p,password:y,options:{data:{name:l}}});if(L)throw L;T("#regMsg").innerHTML="Registration successful!<br>Please check your email and confirm your account before logging in.",T("#registerForm").reset(),T("#registerForm").style.display="none",setTimeout(()=>{d(),T("#loginMsg").innerHTML="A confirmation email has been sent to your address.<br><b>Please confirm your email before logging in.</b>"},3500);return}else k=await e.ensureUser(l,p,y),Ee({userId:k.id}),z(!1),await e.refresh(),g()}catch(k){T("#regMsg").textContent="Registration failed: "+(k.message||k)}})()}}),T("#loginForm").addEventListener("submit",async u=>{u.preventDefault();let l=T("#loginEmail").value.trim(),p=T("#loginPass").value;if(!(!l||!p)){T("#loginMsg").textContent="Logging in...";try{if(ge(),e.isRemote&&e.supabase&&e.supabase.auth&&e.supabase.auth.signOut)try{await e.supabase.auth.signOut()}catch{}let y;if(e.isRemote&&e.supabase){let{data:h,error:k}=await e.supabase.auth.signInWithPassword({email:l,password:p});if(k)throw k;let E=h.session?.user||h.user;if(!(E?.confirmed_at||E?.confirmed||E?.email_confirmed_at)){T("#loginMsg").innerHTML="You must confirm your email before logging in. Please check your inbox.";return}z(!1),await e.refresh(),g()}else{if(y=await e.loginUser(l,p),!y)throw new Error("Invalid credentials");Ee({userId:y.id}),z(!1),await e.refresh(),g()}}catch(y){T("#loginMsg").textContent="Login failed: "+(y.message||y)}}}),d()}_();be();he();re();we();xe();function Ft(t,e){!t||!e||!R.user||t.userId===R.user.id&&t.userId!==e.id&&Ae.add(`Your post "${t.title}" received a like!`,"info")}function Dt(t,e){!t||!e||!R.user||t.userId===R.user.id&&t.userId!==e.id&&Ae.add(`Your post "${t.title}" received a new comment!`,"info")}ze();Me();_();function zt(t,e){let o=e.getAll(),n=o.users.find(a=>a.id===t),s=o.posts.filter(a=>a.userId===t),i=document.createElement("div");i.id="profile",i.style.position="fixed",i.style.inset="0",i.style.background="rgba(0,0,0,0.4)",i.style.zIndex="10000",i.innerHTML=`
    <div class="box" style="max-width:520px; margin:10vh auto; background:var(--bg,#111);">
      <div class="hstack" style="justify-content:space-between; align-items:center">
        <div class="muted small">> user profile</div>
        <button class="btn btn-ghost" data-close-profile="1">[ close ]</button>
      </div>
      <div class="sep"></div>
      ${n?`
            <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:12px;">
              <img class="profile-avatar" src="${n.avatarUrl?A(n.avatarUrl):"/assets/android-chrome-512x512.png"}" alt="avatar" />
            </div>
            <div class="title">${A(n.name)}</div>
            <div class="small muted" style="margin-bottom:8px">
              member since ${new Date(n.createdAt||Date.now()).toLocaleDateString()}<br>
              posts: ${s.length}
            </div>
            <div>${n.about?A(n.about).replace(/\n/g,"<br>"):'<span class="muted small">no about yet.</span>'}</div>
            <div style="margin:8px 0;">
              ${(()=>{let a={facebook:n.facebook||"",instagram:n.instagram||"",twitter:n.twitter||"",bandcamp:n.bandcamp||"",soundcloud:n.soundcloud||"",youtube:n.youtube||"",lastfm:n.lastfm||""},c={facebook:"\u{1F310}",instagram:"\u{1F4F8}",twitter:"\u{1F426}",bandcamp:"\u{1F3B5}",soundcloud:"\u2601\uFE0F",youtube:"\u25B6\uFE0F",lastfm:"\u{1F3B6}"};function g(r,d){if(!r)return"";try{let m=r;if(d==="bandcamp"){let l=m.match(/https?:\/\/(.*?)\.bandcamp\.com/);return l?l[1]:r}if(d==="youtube"){if(/youtube\.com\/(watch\?v=|shorts\/)/i.test(m))return"YouTube Video";let l=m.match(/youtube\.com\/(?:@)?([^/?#]+)/i);return l?l[1]:r}let u={facebook:/facebook\.com\/([^/?#]+)/i,instagram:/instagram\.com\/([^/?#]+)/i,twitter:/twitter\.com\/([^/?#]+)/i,soundcloud:/soundcloud\.com\/([^/?#]+)/i,lastfm:/last\.fm\/user\/([^/?#]+)/i};if(u[d]){let l=m.match(u[d]);return l?l[1]:r}}catch{}return r}return Object.entries(a).filter(([r,d])=>d).map(([r,d])=>{let m=g(d,r);return`<a href="${A(d)}" target="_blank" rel="noopener" class="social-link" title="${r}"><span style='display:inline-flex;align-items:center;white-space:nowrap'>${c[r]} <span class='muted small'>${A(m)}</span></span></a>`}).join(" ")||'<span class="muted small">no social links</span>'})()}
            </div>
            <div style="margin:12px 0 0 0;">
              <button class="btn btn-ghost" id="filter-user-posts-btn" data-user-id="${A(n.id)}">[ show only this user's posts ]</button>
            </div>
          `:'<div class="muted small">user not found</div>'}
    </div>
  `,document.body.appendChild(i),i.addEventListener("click",a=>{if((a.target.dataset.closeProfile||a.target.id==="profile")&&i.remove(),a.target&&a.target.id==="filter-user-posts-btn"){i.remove(),window.filterPostsByUserId=t;let c=new CustomEvent("filter-user-posts",{detail:{userId:t}});window.dispatchEvent(c)}})}var Yt=dt("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");Re();var rt=(0,Yt.createClient)(me,pe);_();function jt(){let t=["#8ab4ff","#ff79c6","#7ab6ff","#7bd389","#ffd166","#ff6b6b","#c792ea","#64d2ff","#f4a261","#00e5ff"],e=document.createElement("div");e.className="box",e.style.position="fixed",e.style.right="24px",e.style.top="24px",e.style.zIndex="20001",e.style.padding="10px 16px 10px 16px",e.style.minWidth="unset",e.style.maxWidth="fit-content",e.style.boxShadow="0 2px 12px #0008",e.innerHTML=`
    <div class="small muted" style="margin-bottom:4px;">choose accent</div>
    <div class="hstack" style="margin-top:0; flex-wrap:wrap; gap:6px;">
      ${t.map(o=>`<button class="btn" data-color="${o}" style="background:${o}20;border-color:${o}80;color:${o};width:28px;height:28px;min-width:28px;min-height:28px;font-size:18px;padding:0;line-height:1;">\u25CF</button>`).join("")}
      <button class="btn btn-ghost" data-close="1" style="margin-left:8px;">[ close ]</button>
    </div>
  `,document.body.appendChild(e),e.addEventListener("click",o=>{let n=o.target.closest("button");if(!n)return;if(n.dataset.close){e.remove();return}let s=n.dataset.color;H({accent:s}),Z(s)})}async function lt(t,e,o,n){let s=t.target.closest("[data-action]");if(!s)return;let i=s.dataset.action,a=T("#app"),c=t.target.closest(".post"),g=c?c.dataset.post:null;if(i==="toggle-player"&&g){let r=document.getElementById("player-"+g);if(r.classList.contains("active")){r.classList.remove("active");try{r._cleanup&&r._cleanup()}catch{}r.innerHTML="",c.classList.remove("is-playing")}else{document.querySelectorAll(".player.active").forEach(l=>{if(l!==r){l.classList.remove("active");try{l._cleanup&&l._cleanup()}catch{}l.innerHTML="";let p=l.closest(".post");p&&p.classList.remove("is-playing")}}),r.classList.add("active");let u=o.getAll().posts.find(l=>l.id===g);if(!u||!u.url&&!(u.provider&&u.provider.id)){B(c||a,"Could not load post for playback",!0);return}console.log("Attempting to build embed:",{post:u,playerDiv:r}),kt(u,r,{autoplay:!0,onEnded:()=>ye(!0,e,o)}),console.log("Embed built. Player div innerHTML:",r.innerHTML),wt(g,e,o),$().autoScroll&&c.scrollIntoView({block:"center"})}return}if(i==="like"&&g){if(!e.user){B(c||a,"login to like",!0);return}let r=await o.toggleLike(g,e.user.id);if(r&&c){let m=o.getAll().posts.find(l=>l.id===g);Ft(m,e.user);let u=c.querySelector('[data-action="like"]');u&&(u.classList.remove("like-animate"),u.offsetWidth,u.classList.add("like-animate"),(r.likes||[]).includes(e.user.id)?(u.classList.add("like-on"),u.setAttribute("aria-pressed","true")):(u.classList.remove("like-on"),u.setAttribute("aria-pressed","false")),u.innerHTML=`[ \u2665 ${r.likes?r.likes.length:0} ]`)}return}if(i==="delete"&&g){let y=function(){m.classList.remove("fadein"),m.classList.add("fadeout"),setTimeout(()=>m.remove(),180)},d=o.getAll().posts.find(h=>h.id===g);if(!d)return;if(!e.user||d.userId!==e.user.id){B(c||a,"you can only delete your posts",!0);return}document.querySelectorAll(".post-delete-confirm").forEach(h=>h.remove());let m=document.createElement("div");m.className="comment-delete-confirm fadein",m.innerHTML=`
      <div class="confirm-inner">
        <span><b>Delete this post?</b></span>
        <button class="btn small btn-danger confirm-yes" tabindex="0">OK</button>
        <button class="btn small confirm-no" tabindex="0">Cancel</button>
      </div>
    `;let u=s.getBoundingClientRect();m.style.position="absolute",m.style.zIndex=10010;let l=u.left+window.scrollX,p=180;l+p>window.innerWidth-8&&(l=window.innerWidth-p-8),m.style.left=l+"px",m.style.top=u.bottom+window.scrollY+4+"px",document.body.appendChild(m),m.querySelector(".confirm-yes").onclick=async()=>{y(),await o.deletePost(g),n()},m.querySelector(".confirm-no").onclick=y,m.onkeydown=h=>{h.key==="Enter"?m.querySelector(".confirm-yes").click():h.key==="Escape"&&y()},setTimeout(()=>{m.querySelector(".confirm-yes").focus()},10),setTimeout(()=>{function h(k){m.contains(k.target)||(y(),document.removeEventListener("mousedown",h))}document.addEventListener("mousedown",h)},0);return}if(i==="comment"&&g){if(window.editingPostId){let d=document.getElementById("post-"+window.editingPostId),m="editbox-"+window.editingPostId,u=d?d.querySelector("#"+m):null;u?(u.classList.remove("fade-in"),u.classList.add("fade-out"),setTimeout(()=>{u.parentNode&&u.parentNode.removeChild(u),window.editingPostId==m.replace("editbox-","")&&(window.editingPostId=null)},180)):window.editingPostId=null}if(window.openCommentId&&window.openCommentId!==g){let d=document.getElementById("cbox-"+window.openCommentId);d&&d.classList.contains("active")&&(d.classList.remove("fade-in"),d.classList.add("fade-out"),setTimeout(()=>{d.classList.remove("active"),d.classList.remove("fade-out")},180)),window.openCommentId=null}let r=document.getElementById("cbox-"+g);r.classList.contains("active")?(r.classList.remove("fade-in"),r.classList.add("fade-out"),setTimeout(()=>{r.classList.remove("active"),r.classList.remove("fade-out")},180),window.openCommentId=null):(r.classList.add("active"),r.classList.remove("fade-out"),r.classList.add("fade-in"),window.openCommentId=g,e.user&&setTimeout(()=>{let d=r.querySelector("input.field");if(d){let m=window.scrollY;d.focus({preventScroll:!0}),r.getBoundingClientRect().bottom>window.innerHeight&&window.scrollTo({top:m})}},180));return}if(i==="delete-comment"){let E=function(){p.classList.remove("fadein"),p.classList.add("fadeout"),setTimeout(()=>p.remove(),180)},r=s.dataset.post||g,d=s.dataset.comment;if(!r||!d)return;if(!e.user){B(c||a,"login to delete comments",!0);return}let u=o.getAll().posts.find(L=>L.id===r);if(!u)return;let l=(u.comments||[]).find(L=>L.id===d);if(!l)return;if(l.userId!==e.user.id){B(c||a,"you can only delete your comments",!0);return}document.querySelectorAll(".comment-delete-confirm").forEach(L=>L.remove());let p=document.createElement("div");p.className="comment-delete-confirm fadein",p.innerHTML=`
      <div class="confirm-inner">
        <span>Delete this comment?</span>
        <button class="btn small btn-danger confirm-yes" tabindex="0">OK</button>
        <button class="btn small confirm-no" tabindex="0">Cancel</button>
      </div>
    `;let y=s.getBoundingClientRect();p.style.position="absolute",p.style.zIndex=10010;let h=y.left+window.scrollX,k=180;h+k>window.innerWidth-8&&(h=window.innerWidth-k-8),p.style.left=h+"px",p.style.top=y.bottom+window.scrollY+4+"px",document.body.appendChild(p),p.querySelector(".confirm-yes").onclick=async()=>{E(),await o.deleteComment(r,d);let L=o.getAll().posts.find(w=>w.id===r),v=document.getElementById("comments-"+r);v.innerHTML=(L?.comments||[]).map(w=>ve(w,r,e,o)).join(""),de("comment deleted")},p.querySelector(".confirm-no").onclick=E,p.onkeydown=L=>{L.key==="Enter"?p.querySelector(".confirm-yes").click():L.key==="Escape"&&E()},setTimeout(()=>{p.querySelector(".confirm-yes").focus()},10),setTimeout(()=>{function L(v){p.contains(v.target)||(E(),document.removeEventListener("mousedown",L))}document.addEventListener("mousedown",L)},0)}if(i==="go-login"){z(!1),e.forceLogin=!0,n();return}if(i==="share"){let r=s.dataset.perma||location.pathname+"#post-"+g,d=o.getAll(),m=g?d.posts.find(l=>l.id===g):null,u=m?`${m.title}${m.artist?" \u2014 "+m.artist:""}`:"TunedIn.space";navigator.share?navigator.share({title:u,url:r}).catch(()=>ke(r)):ke(r).then(()=>B(c||a,"permalink copied to clipboard")).catch(()=>B(c||a,"copy failed",!0))}if(i==="queue"&&g&&(e.queue.includes(g)||e.queue.push(g),D(!0,e,o),B(c,"added to queue")),i==="filter-tag"){let r=s.dataset.tag;t&&typeof t.preventDefault=="function"&&t.preventDefault(),H({filterTag:r,search:""}),e.page=1,n();return}if(i==="clear-tag"){t&&typeof t.preventDefault=="function"&&t.preventDefault(),H({filterTag:null}),e.page=1,n();return}if(i==="q-prev"&&Ie(e,o),i==="q-next"&&ye(!1,e,o),i==="q-clear"&&(e.queue=[],e.qIndex=0,D(!1,e,o)),i==="q-shuffle"&&(H({shuffle:!$().shuffle}),D(!1,e,o)),i==="q-repeat"){let r=["off","all","one"],d=$().repeat||"off",m=r[(r.indexOf(d)+1)%r.length];H({repeat:m}),D(!1,e,o)}if(i==="reset"){if(o.isRemote){alert("Reset all is only for local mode. For Supabase, use Import to replace remote data.");return}confirm("Reset all TunedIn.space data (posts, users, prefs)? This cannot be undone.")&&(localStorage.removeItem("TunedIn.space/db@v2"),localStorage.removeItem("TunedIn.space/v1"),localStorage.removeItem(se),localStorage.removeItem(X),localStorage.removeItem(V),Le(),e.queue=[],e.qIndex=0,await o.init(),n())}if(i==="accent-pick"&&jt(),i==="toggle-density"){let d=$().density==="cozy"?"compact":"cozy";H({density:d}),n()}if(i==="load-more"&&(e.page++,j(T("#feed"),T("#pager"),e,o,$())),i==="show-help"&&Se(),i==="view-user"){t.preventDefault();let r=s.dataset.uid;r&&zt(r,o)}if(i==="go-edit-profile"&&(document.getElementById("profile")?.remove(),document.getElementById("aboutMe")?.focus()),i==="play-all"){let r=document.querySelectorAll("#feed .post");e.queue=Array.from(r).map(m=>m.dataset.post),e.qIndex=0,D(!0,e,o);let d=e.queue[0];d&&document.querySelector(`#post-${d} [data-action="toggle-player"]`)?.click()}if(i==="logout"){if(ge(),z(!1),o.isRemote&&o.supabase&&o.supabase.auth&&o.supabase.auth.signOut)try{await o.supabase.auth.signOut()}catch{}try{localStorage.clear(),sessionStorage.clear()}catch{}document.cookie&&document.cookie.length>0&&document.cookie.split(";").forEach(function(r){let d=r.indexOf("="),m=d>-1?r.substr(0,d):r;document.cookie=m+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"}),typeof Le=="function"&&Le(),location.reload()}}async function Wt(t,e,o,n){let s=t.target.closest('form[data-action="comment-form"], form[data-action="edit-form"], form[data-action="profile-form"]');if(!s)return;t.preventDefault();let i=s.dataset.post;if(s.dataset.action==="comment-form"){if(!e.user){B(document.getElementById("app"),"login to comment",!0);return}let a=s.querySelector("input"),c=a.value.trim();if(!c)return;if(ee(c)||ie(c)){let m=s.querySelector(".mod-msg");m&&m.remove();let u=s.querySelector('button, input[type=submit], [data-action="send"]');m=document.createElement("div"),m.className="mod-msg notice small warn",m.textContent="Comment blocked by moderation.",u&&u.parentNode?u.parentNode.insertBefore(m,u.nextSibling):s.appendChild(m);return}let g={id:G("c"),userId:e.user.id,text:c,createdAt:Date.now()};await o.addComment(i,g),a.value="";let r=o.getAll().posts.find(m=>m.id===i);Dt(r,e.user);let d=document.getElementById("comments-"+i);d.innerHTML=(r.comments||[]).map(m=>ve(m,i,e,o)).join(""),de("comment added");return}if(s.dataset.action==="edit-form"){let a=s.querySelector("[name=title]").value.trim(),c=s.querySelector("[name=artist]").value.trim(),g=s.querySelector("[name=url]").value.trim(),r=s.querySelector("[name=body]").value.trim(),m=s.querySelector("[name=tags]").value.trim().split(/[#,\s]+/g).map(y=>y.trim().toLowerCase()).filter(Boolean).slice(0,12),u=Y(g),l=await o.updatePost(i,{title:a,artist:c,url:g,body:r,tags:m,provider:u}),p=document.getElementById("post-"+i);p&&l&&(p.outerHTML=Ce(l,e,o)),de("post updated");return}if(s.dataset.action==="profile-form"){if(!e.user){B(document.getElementById("app"),"login first",!0);return}let a=s.querySelector("[name=about]").value.trim(),c,g=s.querySelector("[name=avatar]"),r=g&&g.files&&g.files[0];if(r)try{let d=r.name.split(".").pop(),m=`avatars/${e.user.id}_${Date.now()}.${d}`,u=await rt.storage.from("avatars").upload(m,r,{upsert:!0});if(u.error){console.error("Avatar upload error:",u.error);let p=document.getElementById("profileMsg");p&&(p.textContent="Avatar upload failed: "+u.error.message);return}let l=rt.storage.from("avatars").getPublicUrl(m);if(l.error){console.error("Get public URL error:",l.error);let p=document.getElementById("profileMsg");p&&(p.textContent="Avatar URL error: "+l.error.message);return}c=l.data?.publicUrl||""}catch(d){console.error("Unexpected avatar upload error:",d);let m=document.getElementById("profileMsg");m&&(m.textContent="Avatar upload failed (unexpected error)");return}try{let d=c?{about:a,avatarUrl:c}:{about:a};await o.updateUser(e.user.id,d),await o.refresh(),B(document.getElementById("app"),"profile updated"),n()}catch(d){console.error("Profile update error:",d);let m=document.getElementById("profileMsg");m&&(m.textContent="Save failed")}return}}_();function Jt(t,e){let o=t.target.tagName.toLowerCase();if(o==="input"||o==="textarea")return;let n=_e("#app",".post"),s=De(e),a=(s?document.getElementById("post-"+s):null)||n[0];if(t.key==="/"){t.preventDefault(),T("#search")?.focus();return}if(t.key.toLowerCase()==="n"){T("#f_title")?.focus();return}if(t.key.toLowerCase()==="j"){t.preventDefault(),ye(!1,e);return}if(t.key.toLowerCase()==="k"){t.preventDefault(),Ie(e);return}if(t.key==="?"){Se();return}if(t.key.toLowerCase()==="l"&&a){a.querySelector('[data-action="like"]')?.click();return}if(t.key.toLowerCase()==="o"&&a){a.querySelector('[data-action="toggle-player"]')?.click();return}}be();_();async function Gt(t,e,o){let n=null;try{n=await t.ensureUser("demo")}catch(a){throw console.error("Failed to ensure demo user",a),a}e.user||(localStorage.setItem("TunedIn.space/session@v1",JSON.stringify({userId:n.id})),e.user=n);let s=[{title:"Selected Ambient Works 85 - 92",artist:"Aphex Twin",url:"https://www.youtube.com/watch?v=Xw5AiRVqfqk",tags:["idm","electronic","techno"],body:"Richard D James early work. A must hear."},{title:"\u0160lamantys",artist:"Mesijus",url:"https://open.spotify.com/track/64rMCuIiJVT49SjLhmrHdW",tags:["hiphop","rap","lithuanian"],body:"Lithuanian version of MF Doom."},{title:"Pints of Guiness Make You Strong",artist:"Against Me!",url:"https://againstme.bandcamp.com/track/pints-of-guiness-make-you-strong",tags:["punk","folk"],body:"The punk classic!"},{title:"Giant Steps",artist:"John Coltrane",url:"https://www.youtube.com/watch?v=xy_fxxj1mMY",tags:["jazz","bebop"],body:"One of the greatest jazz albums of all time."},{title:"Mania",artist:"ChildsMind",url:"https://soundcloud.com/childsmindmusic/mania",tags:["electronic","techno"],body:"Some fun techno from Soundcloud."}];if(t.isRemote&&t.replaceAll){let a=[n];await t.replaceAll({users:a,posts:[]}),await t.refresh()}else t.getAll&&t.getAll().posts&&(t.getAll().posts.length=0,await t.refresh());let i=null;for(let[a,c]of s.entries()){let g=Y(c.url),r={id:G("p"),userId:n.id,title:c.title,artist:c.artist,url:c.url,provider:g,tags:c.tags,body:c.body,likes:[],comments:[],createdAt:Date.now()};a===0&&(i=r.id),await t.createPost(r)}await t.refresh(),o(),setTimeout(()=>{let a=document.querySelector(`#post-${i} [data-action="toggle-player"]`);a&&a.click()},600)}xe();qe();Ze();async function W(){O.refresh&&await O.refresh();let{refreshUser:t}=await Promise.resolve().then(()=>(xe(),Qe));await t();let e=$(),o=T("#app"),n=document.getElementById("ascii-banner"),s=document.body;if(o.innerHTML="",R.forceLogin){R.forceLogin=!1,n&&(n.style.display="none"),s.classList.remove("show-header"),at(o,O,W);return}if(!R.user&&!Fe())n&&(n.style.display="none"),s.classList.remove("show-header"),at(o,O,W);else{if(!document.querySelector('header[role="banner"]')){let{renderHeader:i}=await Promise.resolve().then(()=>(qe(),Ht));i()}n&&(n.style.display=""),s.classList.add("show-header"),Nt(o,R,O,W)}bt()}function Go(){let t=T("#app");t.addEventListener("click",o=>lt(o,R,O,W)),t.addEventListener("submit",o=>Wt(o,R,O,W));let e=document.getElementById("help");e&&e.addEventListener("click",o=>lt(o,R,O,W)),document.addEventListener("keydown",o=>Jt(o,R)),document.addEventListener("dblclick",o=>{let n=o.target.closest(".post");if(!n)return;if(window.getSelection){let i=window.getSelection();i&&i.type==="Range"&&i.removeAllRanges()}n.querySelector('[data-action="like"]')?.click()}),window.addEventListener("storage",async o=>{(o.key===se||o.key===X||o.key===V)&&(await O.refresh(),W())})}async function Ko(){await O.init(),Go(),await W(),window.seedDemo=()=>Gt(O,R,W)}Ko();window.addEventListener("DOMContentLoaded",function(){it(),Xe(),document.body.classList.add("header-logo-ready"),setTimeout(()=>{let t=document.getElementById("ascii-banner");if(!t)return;let e=document.getElementById("post-limit-info");e?e.style.display="none":(e=document.createElement("div"),e.id="post-limit-info",e.style.textAlign="center",e.style.fontSize="0.98em",e.style.margin="-8px 0 8px 0",e.style.color="#888",e.style.display="none",t.parentNode.insertBefore(e,t.nextSibling));let o=!1,n="",s="";if(!document.getElementById("post-limit-fade-style")){let g=document.createElement("style");g.id="post-limit-fade-style",g.textContent=`
        #post-limit-info.fade {
          transition: opacity 0.35s cubic-bezier(.4,0,.2,1);
          opacity: 0.25;
        }
      `,document.head.appendChild(g)}function i(){if(!window.DB||!window.state||!window.state.user)return"";let g=window.DB.getAll?window.DB.getAll():{posts:[]},r=window.state.user,d=Date.now(),m=(g.posts||[]).filter(u=>u.userId===r.id).sort((u,l)=>l.createdAt-u.createdAt)[0];if(m&&d-m.createdAt<1440*60*1e3){let u=864e5-(d-m.createdAt),l=Math.floor(u/(3600*1e3)),p=Math.floor(u%(3600*1e3)/(60*1e3)),y=Math.floor(u%(60*1e3)/1e3);return`${l}h ${p}m ${y}s`}return""}function a(g,r){e.textContent!==g&&(r?(e.classList.add("fade"),setTimeout(()=>{e.textContent=g,e.classList.remove("fade")},180)):e.textContent=g)}function c(){let g,r;if(!window.DB||!window.state||!window.state.user)g="You can post once per day! Make it count!",r="info";else{let m=i();o&&m?(g=`Time left: ${m}`,r="countdown"):(g="You can post once per day! Make it count!",r="info")}let d=r!==n;n=r,a(g,d)}e.addEventListener("mouseenter",()=>{o=!0,c()}),e.addEventListener("mouseleave",()=>{o=!1,c()}),window.state||(window.state=R),window.DB||(window.DB=O),c(),setInterval(c,1e3)},0)});})();
//# sourceMappingURL=app.js.map
